{"version":3,"sources":["drawing/plugins/tools/Pan.js"],"names":["define","lang","oo","Plugin","registry","Pan","declare","options","_scrollTimeout","this","domNode","node","toolbar","scope","connect","onSetPan","keys","anchors","stencils","canvas","_blockScroll","clearTimeout","setTimeout","hitch","_mouseHandle","mouse","register","selected","keyScroll","type","onPanUp","obj","id","button","onKeyUp","evt","keyCode","clearInterval","_timer","onKeyDown","interval","onArrow","setInterval","parentNode","scrollLeft","x","scrollTop","y","bool","console","log","deselect","select","setEventMode","onPanDrag","last","move","onScroll","onUp","withinCanvas","onStencilUp","checkBounds","onStencilDrag","t","Infinity","r","b","l","sx","sy","mx","group","getTransform","dx","dy","sc","scrollOffset","ch","left","top","height","cw","width","z","zoom","pch","parentHeight","pcw","parentWidth","withSelected","m","o","getBounds","Math","min","y1","max","x2","y2","x1","withUnselected","xscroll","yscroll","getScrollWidth","applyTransform","transformPoints","setDimensions","setup","name","tooltip","iconClass","setObject"],"mappings":"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","file":"../../../../drawing/plugins/tools/Pan.js","sourcesContent":["define([\"dojo/_base/lang\", \"../../util/oo\", \"../_Plugin\", \"../../manager/_registry\"],\r\nfunction(lang, oo, Plugin, registry){\r\n\r\nvar Pan = oo.declare(\r\n\tPlugin,\r\n\tfunction(options){\r\n\t\tthis.domNode = options.node;\r\n\t\tvar _scrollTimeout;\r\n\t\tthis.toolbar = options.scope;\r\n\t\tthis.connect(this.toolbar, \"onToolClick\", this, function(){\r\n\t\t\tthis.onSetPan(false)\r\n\t\t});\r\n\t\tthis.connect(this.keys, \"onKeyUp\", this, \"onKeyUp\");\r\n\t\tthis.connect(this.keys, \"onKeyDown\", this, \"onKeyDown\");\r\n\t\tthis.connect(this.keys, \"onArrow\", this, \"onArrow\");\r\n\t\tthis.connect(this.anchors, \"onAnchorUp\", this, \"checkBounds\");\r\n\t\tthis.connect(this.stencils, \"register\", this, \"checkBounds\");\r\n\t\tthis.connect(this.canvas, \"resize\", this, \"checkBounds\");\r\n\t\tthis.connect(this.canvas, \"setZoom\", this, \"checkBounds\");\r\n\t\tthis.connect(this.canvas, \"onScroll\", this, function(){\r\n\t\t\tif(this._blockScroll){\r\n\t\t\t\tthis._blockScroll = false;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t_scrollTimeout && clearTimeout(_scrollTimeout);\r\n\t\t\t_scrollTimeout = setTimeout(lang.hitch(this, \"checkBounds\"), 200);\r\n\t\t});\r\n\t\tthis._mouseHandle = this.mouse.register(this);\r\n\t\t// This HAS to be called after setting initial objects or things get screwy.\r\n\t\t//this.checkBounds();\r\n\t\t\r\n\t},{\r\n\t\t// summary:\r\n\t\t//\t\tA plugin that allows for a scrolling canvas. An action\r\n\t\t//\t\ttool is added to the toolbar that allows for panning. Holding\r\n\t\t//\t\tthe space bar is a shortcut to that action. The canvas will\r\n\t\t//\t\tonly pan and scroll if there are objects out of the viewable\r\n\t\t//\t\tarea.\r\n\t\t// example:\r\n\t\t//\t\t|\t<div dojoType=\"dojox.drawing.Toolbar\" drawingId=\"drawingNode\" class=\"drawingToolbar vertical\">\r\n\t\t//\t\t|\t\t<div tool=\"dojox.drawing.tools.Line\" selected=\"true\">Line</div>\r\n\t\t//\t\t|\t\t<div plugin=\"dojox.drawing.plugins.tools.Pan\" options=\"{}\">Pan</div>\r\n\t\t//\t\t|\t</div>\r\n\r\n\t\tselected:false,\r\n\t\tkeyScroll:false,\r\n\t\ttype:\"dojox.drawing.plugins.tools.Pan\",\r\n\t\t\r\n\t\tonPanUp: function(obj){\r\n\t\t\tif(obj.id == this.button.id){\r\n\t\t\t\tthis.onSetPan(false);\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\tonKeyUp: function(evt){\r\n\t\t\tswitch(evt.keyCode){\r\n\t\t\t\tcase 32:\r\n\t\t\t\t\tthis.onSetPan(false);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 39: case 37: case 38: case 40:\r\n\t\t\t\t\tclearInterval(this._timer);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\tonKeyDown: function(evt){\r\n\t\t\tif(evt.keyCode == 32){\r\n\t\t\t\tthis.onSetPan(true);\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\tinterval: 20,\r\n\t\t\r\n\t\tonArrow: function(evt){\r\n\t\t\tif(this._timer){ clearInterval(this._timer); }\r\n\t\t\tthis._timer = setInterval(lang.hitch(this,function(evt){\r\n\t\t\t\tthis.canvas.domNode.parentNode.scrollLeft += evt.x*10;\r\n\t\t\t\tthis.canvas.domNode.parentNode.scrollTop += evt.y*10;\r\n\t\t\t},evt), this.interval);\r\n\t\t},\r\n\t\t\r\n\t\tonSetPan: function(/*Boolean|Event*/ bool){\r\n\t\t\tif(bool === true || bool === false){\r\n\t\t\t\tthis.selected = !bool;\r\n\t\t\t}\r\n\t\t\tconsole.log('ON SET PAN:', this.selected)\r\n\t\t\tif(this.selected){\r\n\t\t\t\tthis.selected = false;\r\n\t\t\t\tthis.button.deselect();\r\n\t\t\t}else{\r\n\t\t\t\tthis.selected = true;\r\n\t\t\t\tthis.button.select();\r\n\t\t\t}\r\n\t\t\tthis.mouse.setEventMode(this.selected ? \"pan\" : \"\");\r\n\t\t},\r\n\t\t\r\n\t\tonPanDrag: function(obj){\r\n\t\t\tvar x = obj.x - obj.last.x;\r\n\t\t\tvar y = obj.y - obj.last.y;\r\n\t\t\tthis.canvas.domNode.parentNode.scrollTop -= obj.move.y;\r\n\t\t\tthis.canvas.domNode.parentNode.scrollLeft -= obj.move.x;\r\n\t\t\tthis.canvas.onScroll();\r\n\t\t},\r\n\t\t\r\n\t\tonUp: function(obj){\r\n\t\t\tif(obj.withinCanvas){\r\n\t\t\t\tthis.keyScroll = true;\r\n\t\t\t}else{\r\n\t\t\t\tthis.keyScroll = false;\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\tonStencilUp: function(obj){\r\n\t\t\t// this gets called even on click-off because of the\r\n\t\t\t// issues with TextBlock deselection\r\n\t\t\tthis.checkBounds();\r\n\t\t},\r\n\t\tonStencilDrag: function(obj){\r\n\t\t\t// this gets called even on click-off because of the\r\n\t\t\t// issues with TextBlock deselection\r\n\t\t\t//this.checkBounds();\r\n\t\t},\r\n\t\t\r\n\t\tcheckBounds: function(){\r\n\t\t\t\r\n\t\t\t//watch(\"CHECK BOUNDS DISABLED\", true); return;\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t// summary:\r\n\t\t\t//\t\tScans all items on the canvas and checks if they are out of\r\n\t\t\t//\t\tbounds. If so, a scroll bar (in Canvas) is shown. If the position\r\n\t\t\t//\t\tis left or top, the canvas is scrolled all items are relocated\r\n\t\t\t//\t\tthe distance of the scroll. Ideally, it should look as if the\r\n\t\t\t//\t\titems do not move.\r\n\t\t\t\r\n\t\t\t// logging stuff here so it can be turned on and off. This method is\r\n\t\t\t// very high maintenance.\r\n\t\t\tvar log = function(){\r\n\t\t\t\t//console.log.apply(console, arguments);\r\n\t\t\t}\r\n\t\t\tvar warn = function(){\r\n\t\t\t\t//console.warn.apply(console, arguments);\r\n\t\t\t}\r\n\t\t\t//console.clear();\r\n\t\t\t//console.time(\"check bounds\");\r\n\t\t\t\r\n\t\t\t// initialize a shot-tin of vars\r\n\t\t\tvar t=Infinity, r=-Infinity, b=-10000, l=10000,\r\n\t\t\t\tsx=0, sy=0, dy=0, dx=0,\r\n\t\t\t\tmx = this.stencils.group ? this.stencils.group.getTransform() : {dx:0, dy:0},\r\n\t\t\t\tsc = this.mouse.scrollOffset(),\r\n\t\t\t\t// scY, scX: the scrollbar creates the need for extra dimension\r\n\t\t\t\tscY = sc.left ? 10 : 0,\r\n\t\t\t\tscX = sc.top ? 10 : 0,\r\n\t\t\t\t// ch, cw: the current size of the canvas\r\n\t\t\t\tch = this.canvas.height,\r\n\t\t\t\tcw = this.canvas.width,\r\n\t\t\t\tz = this.canvas.zoom,\r\n\t\t\t\t// pch, pcw: the normal size of the canvas (not scrolled)\r\n\t\t\t\t// these could change if the container resizes.\r\n\t\t\t\tpch = this.canvas.parentHeight,\r\n\t\t\t\tpcw = this.canvas.parentWidth;\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tthis.stencils.withSelected(function(m){\r\n\t\t\t\tvar o = m.getBounds();\r\n\t\t\t\twarn(\"SEL BOUNDS:\", o);\r\n\t\t\t\tt = Math.min(o.y1 + mx.dy, t);\r\n\t\t\t\tr = Math.max(o.x2 + mx.dx, r);\r\n\t\t\t\tb = Math.max(o.y2 + mx.dy, b);\r\n\t\t\t\tl = Math.min(o.x1 + mx.dx, l);\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tthis.stencils.withUnselected(function(m){\r\n\t\t\t\tvar o = m.getBounds();\r\n\t\t\t\twarn(\"UN BOUNDS:\", o);\r\n\t\t\t\tt = Math.min(o.y1, t);\r\n\t\t\t\tr = Math.max(o.x2, r);\r\n\t\t\t\tb = Math.max(o.y2, b);\r\n\t\t\t\tl = Math.min(o.x1, l);\r\n\t\t\t\tlog(\"----------- B:\", b, o.y2)\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tb *= z;\r\n\t\t\tvar xscroll = 0, yscroll = 0;\r\n\t\t\tlog(\"Bottom test\", \"b:\", b, \"z:\", z, \"ch:\", ch, \"pch:\", pch, \"top:\", sc.top, \"sy:\", sy, \"mx.dy:\", mx.dy);\r\n\t\t\tif(b > pch || sc.top ){\r\n\t\t\t\tlog(\"*bottom scroll*\");\r\n\t\t\t\t// item off bottom\r\n\t\t\t\tch = Math.max(b, pch + sc.top);\r\n\t\t\t\tsy = sc.top;\r\n\t\t\t\txscroll += this.canvas.getScrollWidth();\r\n\t\t\t}else if(!sy && ch>pch){\r\n\t\t\t\tlog(\"*bottom remove*\");\r\n\t\t\t\t// item moved from bottom\r\n\t\t\t\tch = pch;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tr *= z;\r\n\t\t\tif(r > pcw || sc.left){\r\n\t\t\t\t//log(\"*right scroll*\");\r\n\t\t\t\t// item off right\r\n\t\t\t\tcw = Math.max(r, pcw + sc.left);\r\n\t\t\t\tsx = sc.left;\r\n\t\t\t\tyscroll += this.canvas.getScrollWidth();\r\n\t\t\t}else if(!sx && cw>pcw){\r\n\t\t\t\t//log(\"*right remove*\");\r\n\t\t\t\t// item moved from right\r\n\t\t\t\tcw = pcw;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// add extra space for scrollbars\r\n\t\t\t// double it to give some breathing room\r\n\t\t\tcw += xscroll*2;\r\n\t\t\tch += yscroll*2;\r\n\t\t\t\r\n\t\t\tthis._blockScroll = true;\r\n\t\t\t\r\n\t\t\t// selected items are not transformed. The selection itself is\r\n\t\t\t// and the items are on de-select\r\n\t\t\tthis.stencils.group && this.stencils.group.applyTransform({dx:dx, dy:dy});\r\n\t\t\t\r\n\t\t\t// non-selected items are transformed\r\n\t\t\tthis.stencils.withUnselected(function(m){\r\n\t\t\t\tm.transformPoints({dx:dx, dy:dy});\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tthis.canvas.setDimensions(cw, ch, sx, sy);\r\n\t\t\t\r\n\t\t\t//console.timeEnd(\"check bounds\");\r\n\t\t}\r\n\t}\r\n);\r\n\r\nPan.setup = {\r\n\tname:\"dojox.drawing.plugins.tools.Pan\",\r\n\ttooltip:\"Pan Tool\",\r\n\ticonClass:\"iconPan\",\r\n\tbutton:false\r\n};\r\n\r\nlang.setObject(\"dojox.drawing.plugins.tools.Pan\", Pan);\r\nregistry.register(Pan.setup, \"plugin\");\r\nreturn Pan;\r\n\r\n});\r\n"]}