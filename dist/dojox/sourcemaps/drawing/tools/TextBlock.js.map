{"version":3,"sources":["drawing/tools/TextBlock.js"],"names":["define","dojo","dijit","oo","registry","StencilText","conEdit","addOnLoad","byId","parentNode","removeChild","console","error","TextBlock","declare","options","data","d","text","this","typesetter","w","width","Math","max","style","minWidth","h","_lineHeight","o","measureText","cleanText","_text","points","x","y","showEmpty","editMode","disconnect","_postRenderCon","connect","edit","render","setTimeout","hitch","connectMouse","draws","baseRender","type","_caretStart","_caretEnd","_blockExec","selectOnExec","onDrag","obj","showParent","s","_startdrag","e","page","_box","left","top","pad","toPx","onUp","_downOnCanvas","c","onRender","created","createTextField","connectTextField","pageX","pageY","doc","createElement","id","textMode","create","height","border","color","position","zIndex","nm","document","body","appendChild","txt","mouse","zoom","fontSize","textSize","fontFamily","family","innerHTML","_textConnected","greekPalette","greekHelp","undefined","mixin","_pushChangeTo","_textBlock","_dropMode","setEventMode","keys","kc1","kc2","kc3","kc4","self","_autoSet","exec","forEach","execText","evt","trim","length","keyCode","SPACE","stopEvent","onCancel","info","getSelection","insertText","show","around","orient","BL","UP_ARROW","DOWN_ARROW","LEFT_ARROW","RIGHT_ARROW","_navigateByArrow","ENTER","_onCellClick","BACKSPACE","DELETE","_onAnchor","target","blur","focus","createAnchors","onDown","disconnectMouse","marginBox","destroyAnchors","sc","scrollOffset","org","origin","log","_textArray","onChangeText","getText","replace","pointsToData","remove","shape","hit","setSelection","removeBreaks","br","RegExp","str","chars","&lt;","&gt;","&amp;","replaceHtmlCodes","r","el","test","ar","split","strAr","line","word","shift","push","i","join","dim","destroy","_anchors","anchors","b","size","p","backgroundColor","fill","isIE","paddingLeft","ss","right","bottom","mm","mu","isLeft","util","uid","a","clone","md","indexOf","orgX","orgW","cons","n","con","setSavedCaret","val","getSavedCaret","start","end","node","t","caret","substr","min","selection","createRange","rs","createTextRange","moveToElementText","re","duplicate","moveToBookmark","getBookmark","setEndPoint","warn","global","getRangeAt","startOffset","endOffset","what","collapse","moveStart","moveEnd","dif","select","getAllChildren","children","childNodes","nodeType","tagName","toLowerCase","removeAllRanges","nodes","textContent","setStart","setEnd","addRange","setObject","setup","name","tooltip","iconClass","register"],"mappings":";;;;;;;AAAAA,QAAQ,OAAQ,iBAAkB,aAAc,uBAAwB,mBACxE,SAASC,EAAMC,EAAOC,EAAIC,EAAUC,GAEnC,IAAIC,EACJL,EAAKM,UAAU,YASdD,EAAUL,EAAKO,KAAK,YAInBF,EAAQG,WAAWC,YAAYJ,GAF/BK,QAAQC,MAAM,kGAMhB,IAAIC,EAAYV,EAAGW,QAOlBT,EACA,SAASU,GAIR,GAAGA,EAAQC,KAAK,CACf,IAAIC,EAAIF,EAAQC,KACZE,EAAOD,EAAEC,KAAOC,KAAKC,WAAWH,EAAEC,MAAQD,EAAEC,KAC5CG,EAAKJ,EAAEK,MAA4C,QAATL,EAAEK,MAAgB,OAASC,KAAKC,IAAIP,EAAEK,MAAOH,KAAKM,MAAMP,KAAKQ,UAAxFP,KAAKM,MAAMP,KAAKQ,SAC/BC,EAAIR,KAAKS,YAEb,GAAGV,GAAW,QAAHG,EAAU,CACpB,IAAIQ,EAAIV,KAAKW,YAAYX,KAAKY,UAAUb,GAAM,GAAQG,GACtDA,EAAIQ,EAAER,EACNM,EAAIE,EAAEF,OAGNR,KAAKa,MAAQ,GAGdb,KAAKc,SACHC,EAAEjB,EAAEiB,EAAGC,EAAElB,EAAEkB,IACXD,EAAEjB,EAAEiB,EAAEb,EAAGc,EAAElB,EAAEkB,IACbD,EAAEjB,EAAEiB,EAAEb,EAAGc,EAAElB,EAAEkB,EAAER,IACfO,EAAEjB,EAAEiB,EAAGC,EAAElB,EAAEkB,EAAER,IAGZV,EAAEmB,WAAalB,GACjBC,KAAKkB,UAAW,EAGhBpC,EAAKqC,WAAWnB,KAAKoB,gBACrBpB,KAAKoB,eAAiB,KACtBpB,KAAKqB,QAAQrB,KAAM,SAAUA,KAAM,YAAY,GAE5CF,EAAEmB,WACJjB,KAAKa,MAAQd,GAAQ,GACrBC,KAAKsB,QACGvB,GAAQD,EAAEoB,UAClBlB,KAAKa,MAAQ,GACbb,KAAKsB,QACGvB,GACRC,KAAKuB,OAAOxB,GAEbyB,WAAW1C,EAAK2C,MAAMzB,KAAM,WAC3BA,KAAKkB,UAAW,IACd,MAIHlB,KAAKuB,cAINvB,KAAK0B,eACL1B,KAAKoB,eAAiBtC,EAAKuC,QAAQrB,KAAM,SAAUA,KAAM,mBAgB1D2B,OAAM,EACNC,YAAW,EACXC,KAAK,gCACLC,YAAa,EACbC,UAAW,EACXC,YAAY,EAuBZC,cAAa,EAKbhB,WAAW,EAEXiB,OAAQ,SAAwBC,GAC3BnC,KAAKV,YACRU,KAAKoC,WAAWD,GAEjB,IAAIE,EAAIrC,KAAKsC,WAAYC,EAAIJ,EAAIK,KACjCxC,KAAKyC,KAAKC,KAAQL,EAAEtB,EAAIwB,EAAExB,EAAIsB,EAAEtB,EAAIwB,EAAExB,EACtCf,KAAKyC,KAAKE,IAAMN,EAAErB,EAClBhB,KAAKyC,KAAKtC,OAASkC,EAAEtB,EAAIwB,EAAExB,EAAIwB,EAAExB,EAAEsB,EAAEtB,EAAIsB,EAAEtB,EAAEwB,EAAExB,GAAKf,KAAKM,MAAMP,KAAK6C,IAEpE9D,EAAKwB,MAAMN,KAAKV,WAAYU,KAAKyC,KAAKI,SAGvCC,KAAM,SAAwBX,GAC7B,GAAInC,KAAK+C,cAAT,CACA/C,KAAK+C,eAAgB,EAErB,IAAIC,EAAIlE,EAAKuC,QAAQrB,KAAM,SAAUA,KAAM,WAC1ClB,EAAKqC,WAAW6B,GAChBhD,KAAKiD,SAASjD,QAGfA,KAAKkB,UAAW,EAChBlB,KAAKoC,WAAWD,GAChBnC,KAAKkD,SAAU,EACflD,KAAKmD,kBACLnD,KAAKoD,qBAGNhB,WAAY,SAAwBD,GAKnC,IAAGnC,KAAKV,WAAR,CACA,IAAIyB,EAAIoB,EAAIkB,OAAS,GACjBrC,EAAImB,EAAImB,OAAS,GACrBtD,KAAKV,WAAaR,EAAKyE,IAAIC,cAAc,OACzCxD,KAAKV,WAAWmE,GAAKzD,KAAKyD,GAC1B,IAAI3D,EAAIE,KAAKM,MAAMoD,SAASC,OAC5B3D,KAAKyC,MACJC,KAAK3B,EACL4B,IAAI3B,EACJb,MAAMgC,EAAIhC,OAAS,EACnByD,OAAOzB,EAAIyB,QAAUzB,EAAIyB,OAAO,EAAIzB,EAAIyB,OAAS5D,KAAKS,YACtDoD,OAAO/D,EAAEK,MAAM,MAAML,EAAEQ,MAAM,IAAIR,EAAEgE,MACnCC,SAAS,WACTC,OAAO,IACPnB,KAAM,WACL,IAAInC,KACJ,IAAI,IAAIuD,KAAMjE,KACbU,EAAEuD,GAAwB,iBAAXjE,KAAKiE,IAAsB,UAAJA,EAAejE,KAAKiE,GAAM,KAAOjE,KAAKiE,GAE7E,OAAOvD,IAIT5B,EAAKwB,MAAMN,KAAKV,WAAYU,KAAKyC,MAEjCyB,SAASC,KAAKC,YAAYpE,KAAKV,cAEhC6D,gBAAiB,SAAmBkB,GAMnC,IAAIvE,EAAIE,KAAKM,MAAMoD,SAASpC,KAgB5B,OAfAtB,KAAKyC,KAAKoB,OAAS/D,EAAEK,MAAM,MAAML,EAAEQ,MAAM,IAAIR,EAAEgE,MAC/C9D,KAAKyC,KAAKmB,OAAS,OACnB5D,KAAKyC,KAAKtC,MAAQC,KAAKC,IAAIL,KAAKyC,KAAKtC,MAAOH,KAAKM,MAAMP,KAAKQ,SAASP,KAAKsE,MAAMC,MAChFzF,EAAKwB,MAAMN,KAAKV,WAAYU,KAAKyC,KAAKI,QAEtC7C,KAAKV,WAAW8E,YAAYjF,GAC5BL,EAAKwB,MAAMnB,GACVyE,OAAQS,EAAM,OAASrE,KAAKS,YAAY,KACxC+D,SAAUxE,KAAKyE,SAASzE,KAAKsE,MAAMC,KAAM,KACzCG,WAAW1E,KAAKM,MAAMP,KAAK4E,SAI5BxF,EAAQyF,UAAYP,GAAO,GAEpBlF,GAERiE,iBAAkB,WAKjB,IAAGpD,KAAK6E,eAAR,CAIA,IAAIC,EAAe/F,EAAMM,KAAK,gBAC1B0F,OAA0BC,GAAdF,EACbC,GAEFjG,EAAKmG,MAAMH,GACVI,cAAe/F,EACfgG,WAAYnF,OAIdA,KAAK6E,gBAAiB,EACtB7E,KAAKoF,WAAY,EACjBpF,KAAKsE,MAAMe,aAAa,QACxBrF,KAAKsF,KAAKpE,UAAS,GACnB,IAAIqE,EAAKC,EAAKC,EAAKC,EAAKC,EAAO3F,KAAM4F,GAAW,EAC/CC,EAAO,WACHF,EAAKP,YACRtG,EAAKgH,SAASP,EAAIC,EAAIC,EAAIC,GAAM,SAAS1C,GACxClE,EAAKqC,WAAW6B,KAEjB2C,EAAKd,gBAAiB,EACtBc,EAAKL,KAAKpE,UAAS,GACnByE,EAAKrB,MAAMe,eACXM,EAAKI,aAGPR,EAAMzG,EAAKuC,QAAQlC,EAAS,QAASa,KAAM,SAASgG,GAGhDlH,EAAKmH,KAAK9G,EAAQyF,aAAegB,GACnC9G,EAAKwB,MAAMnB,EAAS,SAAU,QAASyG,GAAW,GAC1C9G,EAAKmH,KAAK9G,EAAQyF,WAAWsB,OAAO,GAAKN,IACjD9G,EAAKwB,MAAMnB,EAAS,SAAUa,KAAKS,YAAY,MAAOmF,GAAW,GAG9D5F,KAAKgC,WAMLgE,EAAIG,SAASrH,EAAKwG,KAAKc,QACzBtH,EAAKuH,UAAUL,GACfjB,GAAaD,EAAawB,YAPX,IAAbN,EAAIG,SAA4B,IAAbH,EAAIG,UACzBrH,EAAKuH,UAAUL,GACfH,OASHL,EAAM1G,EAAKuC,QAAQlC,EAAS,UAAWa,KAAM,SAASgG,GAMrD,GALgB,IAAbA,EAAIG,SAA4B,IAAbH,EAAIG,SACzBrH,EAAKuH,UAAUL,GAIA,KAAbA,EAAIG,QAAa,CACnB,IAAIpB,EAEH,YADAvF,QAAQ+G,KAAK,uFAGdzH,EAAKuH,UAAUL,GACfhG,KAAKwG,aAAarH,GAGlBa,KAAKyG,WAAWtH,EAAQ,MACxBa,KAAKoF,WAAY,EACjBpF,KAAKgC,YAAa,EAClB8C,EAAa4B,MACZC,OAAO3G,KAAKV,WACZsH,QAAQC,GAAK,QAGf,GAAI7G,KAAKoF,UAIR,OAAOY,EAAIG,SACV,KAAKrH,EAAKwG,KAAKwB,SACf,KAAKhI,EAAKwG,KAAKyB,WACf,KAAKjI,EAAKwG,KAAK0B,WACf,KAAKlI,EAAKwG,KAAK2B,YACdnI,EAAKuH,UAAUL,GACflB,EAAaoC,iBAAiBlB,GAC9B,MACD,KAAKlH,EAAKwG,KAAK6B,MACdrI,EAAKuH,UAAUL,GACflB,EAAasC,aAAapB,GAC1B,MACD,KAAKlH,EAAKwG,KAAK+B,UACf,KAAKvI,EAAKwG,KAAKgC,OACdxI,EAAKuH,UAAUL,GACflB,EAAawB,gBAlBftG,KAAKgC,YAAa,IAyBpByD,EAAM3G,EAAKuC,QAAQ6C,SAAU,UAAWlE,KAAM,SAASgG,GAElDhG,KAAKuH,WAA8B,WAAjBvB,EAAIwB,OAAO/D,GAGP,WAAjBuC,EAAIwB,OAAO/D,IAAwC,IAArBtE,EAAQyF,YAG9CzF,EAAQsI,OACRjG,WAAW,WACVrC,EAAQuI,SACP,OARF5I,EAAKuH,UAAUL,GACfH,OAWF7F,KAAK2H,gBAELjC,EAAM5G,EAAKuC,QAAQrB,KAAKsE,MAAO,UAAWtE,KAAM,SAASgG,GACxDH,MAID1G,EAAQuI,QAER1H,KAAK4H,OAAS,aACd5H,KAAKkC,OAAS,aAEdV,WAAW1C,EAAK2C,MAAMzB,KAAM,WAE3Bb,EAAQuI,QAMR1H,KAAK8C,KAAO,YACP6C,EAAK4B,WAAavH,KAAKV,aAC1BqG,EAAKkC,kBACLhC,IACAF,EAAK7C,KAAO,iBAGX,OAILiD,SAAU,WAKT,IAAIjG,EAAIhB,EAAKgJ,UAAU9H,KAAKV,YACxBY,EAAIE,KAAKC,IAAIP,EAAEI,EAAGF,KAAKM,MAAMP,KAAKQ,UAElC8D,EAAMrE,KAAKY,UAAUzB,EAAQyF,WAAW,GAC5CzF,EAAQyF,UAAY,GACpBzF,EAAQsI,OACRzH,KAAK+H,iBAGL1D,EAAMrE,KAAKC,WAAWoE,GAEtB,IAAI3D,EAAIV,KAAKW,YAAY0D,EAAKnE,GAC1B8H,EAAKhI,KAAKsE,MAAM2D,eAChBC,EAAMlI,KAAKsE,MAAM6D,OAEjBpH,EAAIf,KAAKyC,KAAKC,KAAOsF,EAAGtF,KAAOwF,EAAInH,EACnCC,EAAIhB,KAAKyC,KAAKE,IAAMqF,EAAGrF,IAAMuF,EAAIlH,EAErCD,GAAKf,KAAKsE,MAAMC,KAChBvD,GAAKhB,KAAKsE,MAAMC,KAChBrE,GAAKF,KAAKsE,MAAMC,KAChB7D,EAAEF,GAAKR,KAAKsE,MAAMC,KAGlBvE,KAAKc,SACHC,EAAEA,EAAGC,EAAEA,IACPD,EAAEA,EAAEb,EAAGc,EAAEA,IACTD,EAAEA,EAAEb,EAAGc,EAAEA,EAAEN,EAAEF,IACbO,EAAEA,EAAGC,EAAEA,EAAEN,EAAEF,IAEbR,KAAKkB,UAAW,EAGhB1B,QAAQ4I,IAAI,gBAAiBpI,KAAKoB,gBAE9BV,EAAEX,OACLC,KAAKa,MAAQ,GACbb,KAAKqI,eAGNrI,KAAKuB,OAAOb,EAAEX,MACdC,KAAKsI,aAAatI,KAAKuI,YAGxBjH,KAAM,WAKLtB,KAAKkB,UAAW,EAChB,IAAInB,EAAOC,KAAKuI,WAAa,GAG7B,GAFA/I,QAAQ4I,IAAI,aAAarI,EAAM,IAAIA,EAAKyI,QAAQ,KAAM,OAEnDxI,KAAKV,YAAeU,KAAKc,OAA5B,CACA,IAAIhB,EAAIE,KAAKyI,eAETT,EAAKhI,KAAKsE,MAAM2D,eAChBC,EAAMlI,KAAKsE,MAAM6D,OAEjBhG,GACHkB,MAAQvD,EAAK,EAAIE,KAAKsE,MAAMC,KAAOyD,EAAGtF,KAAOwF,EAAInH,EACjDuC,MAAQxD,EAAK,EAAIE,KAAKsE,MAAMC,KAAMyD,EAAGrF,IAAMuF,EAAIlH,EAC/Cb,MAAML,EAAEK,MAAQH,KAAKsE,MAAMC,KAC3BX,OAAO9D,EAAE8D,OAAS5D,KAAKsE,MAAMC,MAG9BvE,KAAK0I,OAAO1I,KAAK2I,MAAO3I,KAAK4I,KAC7B5I,KAAKoC,WAAWD,GAChBnC,KAAKmD,gBAAgBpD,EAAKyI,QAAQ,KAAM,MACxCxI,KAAKoD,mBACFrD,GAEFC,KAAK6I,aAAa1J,EAAS,SAI7ByB,UAAW,SAAmByD,EAAgByE,GA0B7C,OAVGA,GACFhK,EAAKgH,SAAS,OAAQ,QAAS,SAAU,MAAO,OAAQ,SAASiD,GAChE1E,EAAMA,EAAImE,QAAQ,IAAIQ,OAAOD,EAAI,MAAO,OAI1C1E,EAlBuB,SAAS4E,GAC/B,IAAIC,GACHC,OAAO,IACPC,OAAO,IACPC,QAAQ,KAET,IAAI,IAAIpF,KAAMiF,EACbD,EAAMA,EAAIT,QAAQ,IAAIQ,OAAO/E,EAAI,MAAOiF,EAAMjF,IAE/C,OAAOgF,EASFK,CADNjF,EAAMA,EAAImE,QAAQ,UAAW,MAI7BnE,GAFAA,EAAMvF,EAAKmH,KAAK5B,IAENmE,QAAQ,UAAW,MAI9B7H,YAAa,SAAsBsI,EAAmB9I,GAkBrD,IAAIoJ,EAAI,2BACRvJ,KAAKoC,YAAYjC,MAAMA,GAAS,OAAQyD,OAAO,SAC/C5D,KAAKmD,gBAAgB8F,GACrB,IAAI5E,EAAM,GACNmF,EAAKrK,EACTqK,EAAG5E,UAAY,IACf,IAAIpE,EAAI1B,EAAKgJ,UAAU0B,GAAIhJ,EAI3B,GAFAgJ,EAAG5E,UAAYqE,GAEX9I,GAAS,IAAI6I,OAAOO,EAAG,MAAME,KAAKR,GAErC5E,EAAM4E,EAAIT,QAAQ,IAAIQ,OAAOO,EAAG,MAAO,MACvCC,EAAG5E,UAAYqE,EAAIT,QAAQ,IAAIQ,OAAOO,EAAG,MAAO,cAE3C,GAAGzK,EAAKgJ,UAAU0B,GAAIhJ,GAAKA,EAEhC6D,EAAM4E,MAEF,CAEJ,IAAIS,EAAKT,EAAIU,MAAM,KACfC,OACAC,EAAO,EAEX,IADAL,EAAG5E,UAAY,GACT8E,EAAGxD,QAAO,CACf,IAAI4D,EAAOJ,EAAGK,QACdP,EAAG5E,WAAakF,EAAK,IAClBhL,EAAKgJ,UAAU0B,GAAIhJ,EAAIA,IAEzBoJ,IADAC,MAEAL,EAAG5E,UAAYkF,EAAK,KAErBF,EAAMC,GAAMG,KAAKF,GAGlBhL,EAAKgH,QAAQ8D,EAAO,SAASF,EAAIO,GAChCL,EAAMK,GAAKP,EAAGQ,KAAK,OAEpB7F,EAAMuF,EAAMM,KAAK,MAGjBV,EAAG5E,UAAYP,EAAImE,QAAQ,KAAM,SAIlC,IAAI2B,EAAMrL,EAAKgJ,UAAU0B,GAMzB,OAJArK,EAAQG,WAAWC,YAAYJ,GAC/BL,EAAKsL,QAAQpK,KAAKV,YAClBU,KAAKV,WAAa,MAEVkB,EAAE2J,EAAI3J,EAAGN,EAAEiK,EAAIjK,EAAGH,KAAKsE,IAGhCtB,eAAc,EACd6E,OAAQ,SAAwBzF,GAC/BnC,KAAKsC,YACJvB,EAAGoB,EAAIkB,MACPrC,EAAGmB,EAAImB,OAERxE,EAAKqC,WAAWnB,KAAKoB,gBACrBpB,KAAKoB,eAAiB,KACtBpB,KAAK+C,eAAgB,GAGtB4E,cAAe,WAMd3H,KAAKqK,YACL,IAAI1E,EAAO3F,KACPF,EAAIE,KAAKM,MAAMgK,QAClBC,EAAIzK,EAAEK,MACND,EAAIJ,EAAE0K,KAAO,EAAFD,EACX/J,EAAIV,EAAE0K,KAAO,EAAFD,EACXE,EAAK3K,EAAM,KAAE,GAAG,EAAI,KAEjBuC,GACH0B,SAAS,WACT5D,MAAMD,EAAE,KACR0D,OAAOpD,EAAE,KACTkK,gBAAgB5K,EAAE6K,KAClB9G,OAAO0G,EAAE,MAAQzK,EAAEQ,MAAQ,IAAIR,EAAEgE,OAE/BhF,EAAK8L,OACPvI,EAAEwI,YAAc3K,EAAI,KACpBmC,EAAEmC,SAAWtE,EAAI,MAQlB,IANA,IAAI4K,IACFnI,IAAK8H,EAAG/H,KAAK+H,IACb9H,IAAI8H,EAAGM,MAAMN,IACbO,OAAOP,EAAGM,MAAMN,IAChBO,OAAOP,EAAE/H,KAAK+H,IAERR,EAAE,EAAEA,EAAE,EAAEA,IAAI,CACnB,IAMQgB,EAAIC,EANRC,EAAa,GAAHlB,GAAa,GAAHA,EACpBxG,EAAKzD,KAAKoL,KAAKC,IAAIF,EAAS,cAAgB,gBAE5CG,EAAIxM,EAAK6E,OAAO,OAAQF,GAAGA,GAAKzD,KAAKV,YACzCR,EAAKwB,MAAMgL,EAAGxM,EAAKmG,MAAMnG,EAAKyM,MAAMlJ,GAAIyI,EAAGb,KAG3C,IAAIuB,EAAK1M,EAAKuC,QAAQiK,EAAG,YAAatL,KAAM,SAASgG,GACpDmF,EAASnF,EAAIwB,OAAO/D,GAAGgI,QAAQ,SAAS,EACxC9F,EAAK4B,WAAY,EACjB,IAAImE,EAAO1F,EAAI3C,MACXsI,EAAO3L,KAAKyC,KAAKtC,MACrBrB,EAAKuH,UAAUL,GAGfiF,EAAKnM,EAAKuC,QAAQ6C,SAAU,YAAalE,KAAM,SAASgG,GACvD,IAAIjF,EAAIiF,EAAI3C,MACT8H,GACFnL,KAAKyC,KAAKC,KAAO3B,EACjBf,KAAKyC,KAAKtC,MAAQwL,EAAOD,EAAO3K,GAEhCf,KAAKyC,KAAKtC,MAAQY,EAAI4K,EAAOD,EAE9B5M,EAAKwB,MAAMN,KAAKV,WAAYU,KAAKyC,KAAKI,UAGvCqI,EAAKpM,EAAKuC,QAAQ6C,SAAU,UAAWlE,KAAM,SAASgG,GACrD0F,EAAO1L,KAAKyC,KAAKC,KACjBiJ,EAAO3L,KAAKyC,KAAKtC,MACjBrB,EAAKqC,WAAW8J,GAChBnM,EAAKqC,WAAW+J,GAChBvF,EAAK4B,WAAY,EACjBpI,EAAQuI,QACR5I,EAAKuH,UAAUL,OAIjBhG,KAAKqK,SAAS5G,IACb6H,EAAEA,EACFM,MAAMJ,MAKTzD,eAAgB,WAGf,IAAI,IAAI8D,KAAK7L,KAAKqK,SACjBvL,EAAKgH,QAAQ9F,KAAKqK,SAASwB,GAAGC,IAAKhN,EAAKqC,WAAYrC,GACpDA,EAAKsL,QAAQpK,KAAKqK,SAASwB,GAAGP,IAIhCS,cAAe,SAASC,GAIvBhM,KAAK8B,YAAc9B,KAAK+B,UAAYiK,GAGrCC,cAAe,WACd,OAAQC,MAAOlM,KAAK8B,YAAaqK,IAAKnM,KAAK+B,YAG5C0E,WAAY,SAAS2F,EAAKJ,GAMzB,IAAIK,EAAGtM,EAAOqM,EAAKxH,UACf0H,EAAQtM,KAAKiM,gBAGjBI,GADAtM,EAAOA,EAAKyI,QAAQ,UAAW,MACtB+D,OAAO,EAAED,EAAMJ,OAASF,EAAMjM,EAAKwM,OAAOD,EAAMH,KACzDE,EAAIrM,KAAKY,UAAUyL,GAAE,GACrBrM,KAAK+L,cAAc3L,KAAKoM,IAAIH,EAAEnG,OAAQoG,EAAMH,IAAMH,EAAI9F,SACtDkG,EAAKxH,UAAYyH,EACjBrM,KAAK6I,aAAauD,EAAK,WAGxB5F,aAAc,SAAS4F,GAOtB,IAAIF,EAAOC,EACX,GAAGrN,EAAKyE,IAAIkJ,UAAU,CACrB,IAAIlD,EAAIzK,EAAKyE,IAAIkJ,UAAUC,cACvBC,EAAK7N,EAAKqF,OAAOyI,kBACrBD,EAAGE,kBAAkBT,GACrB,IAAIU,EAAKH,EAAGI,YACZJ,EAAGK,eAAezD,EAAE0D,eACpBH,EAAGI,YAAY,aAAcP,GAC7BT,EAAQlM,KAAK8B,YAAcgL,EAAG/M,KAAKmG,OACnCiG,EAAMnM,KAAK+B,UAAY+K,EAAG/M,KAAKmG,OAAOqD,EAAExJ,KAAKmG,OAC7C1G,QAAQ2N,KAAK,gBAAgBjB,EAAM,SAASC,EAAI,YAAYW,EAAG/M,KAAKmG,OAAO,UAAU4G,EAAG/M,WAExFC,KAAK8B,YAAchD,EAAKsO,OAAO5G,eAAe6G,WAAWjB,GAAMkB,YAC/DtN,KAAK+B,UAAYjD,EAAKsO,OAAO5G,eAAe6G,WAAWjB,GAAMmB,UAC7D/N,QAAQ4I,IAAI,gBAAiBpI,KAAK8B,YAAY,SAAU9B,KAAK+B,YAI/D8G,aAAc,SAASuD,EAAMoB,GAO5B,GADAhO,QAAQ2N,KAAK,iBACVrO,EAAKyE,IAAIkJ,UAAU,CACrB,IAAIE,EAAK7N,EAAKqF,OAAOyI,kBAGrB,OAFAD,EAAGE,kBAAkBT,GAEdoB,GACN,IAAK,MACJb,EAAGc,UAAS,GACZ,MACD,IAAK,MACJd,EAAGc,WACH,MACD,IAAK,MACJd,EAAGc,WACHd,EAAGe,UAAU,YAAa,GAC1Bf,EAAGgB,QAAQ,YAAYvB,EAAKrM,KAAKmG,QACjC,MACD,IAAK,SACJyG,EAAGc,WACH,IAAIG,EAAM5N,KAAK8B,YAAY9B,KAAK+B,UAEhC4K,EAAGe,UAAU,YAAY1N,KAAK8B,aAC9B6K,EAAGgB,QAAQ,YAAYC,GAGzBjB,EAAGkB,aAEC,CACJ,IAAIC,EAAiB,SAAS1B,EAAM2B,GACnCA,EAAWA,MACX,IAAI,IAAI9D,EAAE,EAAEA,EAAEmC,EAAK4B,WAAW9H,OAAQ+D,IAAI,CACzC,IAAI4B,EAAIO,EAAK4B,WAAW/D,GACT,GAAZ4B,EAAEoC,SACJF,EAAS/D,KAAK6B,GACNA,EAAEqC,SAAoC,OAAzBrC,EAAEqC,QAAQC,eAC/BJ,EAAS/D,KAAK6B,GAGZA,EAAEmC,YAAcnC,EAAEmC,WAAW9H,QAC/B4H,EAAejC,EAAGkC,GAGpB,OAAOA,GAERvO,QAAQ4I,IAAI,WAAYgE,GACxBA,EAAK1E,QACL,IAAI+E,EAAY3N,EAAKsO,OAAO5G,eAC5BiG,EAAU2B,kBACV,IAAI7E,EAAIzK,EAAKyE,IAAImJ,cACb2B,EAAQP,EAAe1B,GAC3B,OAAOoB,GACN,IAAK,MACJhO,QAAQ4I,IAAI,OAAQiG,EAAMA,EAAMnI,OAAS,GAAGoI,YAAYpI,QACxDqD,EAAEgF,SAASF,EAAMA,EAAMnI,OAAS,GAAImI,EAAMA,EAAMnI,OAAS,GAAGoI,YAAYpI,QACxEqD,EAAEiF,OAAOH,EAAMA,EAAMnI,OAAS,GAAImI,EAAMA,EAAMnI,OAAS,GAAGoI,YAAYpI,QACtE,MACD,IAAK,MACJqD,EAAEgF,SAASF,EAAM,GAAI,GACrB9E,EAAEiF,OAAOH,EAAM,GAAI,GACnB,MACD,IAAK,MACJ9E,EAAEgF,SAASF,EAAM,GAAI,GACrB9E,EAAEiF,OAAOH,EAAMA,EAAMnI,OAAS,GAAImI,EAAMA,EAAMnI,OAAS,GAAGoI,YAAYpI,QACtE,MACD,IAAK,SACJ1G,QAAQ4I,IAAI,gBAAgBpI,KAAK8B,YAAY,eAAe9B,KAAK+B,WACjEwH,EAAEgF,SAASF,EAAM,GAAIrO,KAAK8B,aAC1ByH,EAAEiF,OAAOH,EAAM,GAAIrO,KAAK+B,WAE1B0K,EAAUgC,SAASlF,GACnB/J,QAAQ4I,IAAI,OAAQoF,EAAM,OAAQpB,OAatC,OARAtN,EAAK4P,UAAU,gCAAiChP,GAChDA,EAAUiP,OACTC,KAAK,gCACLC,QAAQ,YACRC,UAAU,YAEX7P,EAAS8P,SAASrP,EAAUiP,MAAO,QAE5BjP","file":"../../../drawing/tools/TextBlock.js","sourcesContent":["define([\"dojo\", \"dijit/registry\", \"../util/oo\", \"../manager/_registry\", \"../stencil/Text\"],\r\nfunction(dojo, dijit, oo, registry, StencilText){\r\n\r\n\tvar conEdit;\r\n\tdojo.addOnLoad(function(){\r\n\t\t//\t\tIn order to use VML in IE, it's necessary to remove the\r\n\t\t//\t\tDOCTYPE. But this has the side effect that causes a bug\r\n\t\t//\t\twhere contenteditable divs cannot be made dynamically.\r\n\t\t//\t\tThe solution is to include one in the main document\r\n\t\t//\t\tthat can be appended and removed as necessary:\r\n\t\t//\t\t<div id=\"conEdit\" contenteditable=\"true\"></div>\r\n\r\n\t\t// console.log(\"Removing conedit\");\r\n\t\tconEdit = dojo.byId(\"conEdit\");\r\n\t\tif(!conEdit){\r\n\t\t\tconsole.error(\"A contenteditable div is missing from the main document. See 'dojox.drawing.tools.TextBlock'\")\r\n\t\t}else{\r\n\t\t\tconEdit.parentNode.removeChild(conEdit);\r\n\t\t}\r\n\t});\r\n\t\r\n\tvar TextBlock = oo.declare(\r\n\t\t// TODO - disable zoom while showing?\r\n\r\n\t\t// FIXME:\r\n\t\t//\t\tHandles width: auto, align:middle, etc. but for\r\n\t\t//\t\tdisplay only, edit is out of whack\r\n\r\n\t\tStencilText,\r\n\t\tfunction(options){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tconstructor\r\n\r\n\t\t\tif(options.data){\r\n\t\t\t\tvar d = options.data;\r\n\t\t\t\tvar text = d.text ? this.typesetter(d.text) : d.text;\r\n\t\t\t\tvar w = !d.width ? this.style.text.minWidth : d.width==\"auto\" ? \"auto\" : Math.max(d.width, this.style.text.minWidth);\r\n\t\t\t\tvar h = this._lineHeight;\r\n\t\t\t\t\r\n\t\t\t\tif(text && w==\"auto\"){\r\n\t\t\t\t\tvar o = this.measureText(this.cleanText(text, false), w);\r\n\t\t\t\t\tw = o.w;\r\n\t\t\t\t\th = o.h;\r\n\t\t\t\t}else{\r\n\t\t\t\t\t// w = this.style.text.minWidth;\r\n\t\t\t\t\tthis._text = \"\";\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tthis.points = [\r\n\t\t\t\t\t{x:d.x, y:d.y},\r\n\t\t\t\t\t{x:d.x+w, y:d.y},\r\n\t\t\t\t\t{x:d.x+w, y:d.y+h},\r\n\t\t\t\t\t{x:d.x, y:d.y+h}\r\n\t\t\t\t];\r\n\t\t\t\t\r\n\t\t\t\tif(d.showEmpty || text){\r\n\t\t\t\t\tthis.editMode = true;\r\n\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\tdojo.disconnect(this._postRenderCon);\r\n\t\t\t\t\tthis._postRenderCon = null;\r\n\t\t\t\t\tthis.connect(this, \"render\", this, \"onRender\", true);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(d.showEmpty){\r\n\t\t\t\t\t\tthis._text = text || \"\";\r\n\t\t\t\t\t\tthis.edit();\r\n\t\t\t\t\t}else if(text && d.editMode){\r\n\t\t\t\t\t\tthis._text = \"\";\r\n\t\t\t\t\t\tthis.edit();\r\n\t\t\t\t\t}else if(text){\r\n\t\t\t\t\t\tthis.render(text);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tsetTimeout(dojo.hitch(this, function(){\r\n\t\t\t\t\t\tthis.editMode = false;\r\n\t\t\t\t\t}),100)\r\n\t\t\t\t\t\r\n\t\t\t\t}else{\r\n\t\t\t\t\t// Why make it if it won't render...\r\n\t\t\t\t\tthis.render();\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t}else{\r\n\t\t\t\tthis.connectMouse();\r\n\t\t\t\tthis._postRenderCon = dojo.connect(this, \"render\", this, \"_onPostRender\");\r\n\t\t\t}\r\n\t\t\t//console.log(\"TextBlock:\", this.id)\r\n\t\t},\r\n\t\t{\r\n\t\t\t// summary:\r\n\t\t\t//\t\tA tool to create text fields on a canvas.\r\n\t\t\t// description:\r\n\t\t\t//\t\tExtends stencil.Text by adding an HTML layer that\r\n\t\t\t//\t\tcan be dragged out to a certain size, and accept\r\n\t\t\t//\t\ta text entry. Will wrap text to the width of the\r\n\t\t\t//\t\thtml field.\r\n\t\t\t//\t\tWhen created programmtically, use 'auto' to shrink\r\n\t\t\t//\t\tthe width to the size of the text. Use line breaks\r\n\t\t\t//\t\t( \\n ) to create new lines.\r\n\r\n\t\t\tdraws:true,\r\n\t\t\tbaseRender:false,\r\n\t\t\ttype:\"dojox.drawing.tools.TextBlock\",\r\n\t\t\t_caretStart: 0,\r\n\t\t\t_caretEnd: 0,\r\n\t\t\t_blockExec: false,\r\n\t\t\t\r\n/*=====\r\nStencilData: {\r\n\t// summary:\r\n\t//\t\tThe data used to create the dojox.gfx Text\r\n\t// x: Number\r\n\t//\t\tLeft point x\r\n\t// y: Number\r\n\t//\t\tTop point y\r\n\t// width: Number|String?\r\n\t//\t\tOptional width of Text. Not required but recommended.\r\n\t//\t\tfor auto-sizing, use 'auto'\r\n\t// height: Number?\r\n\t//\t\tOptional height of Text. If not provided, _lineHeight is used.\r\n\t// text: String\r\n\t//\t\tThe string content. If not provided, may auto-delete depending on defaults.\r\n},\r\n=====*/\r\n\t\t\t\r\n\t\t\t// selectOnExec: Boolean\r\n\t\t\t//\t\tWhether the Stencil is selected when the text field\r\n\t\t\t//\t\tis executed or not\r\n\t\t\tselectOnExec:true,\r\n\r\n\t\t\t// showEmpty: Boolean\r\n\t\t\t//\t\tIf true and there is no text in the data, the TextBlock\r\n\t\t\t//\t\tIs displayed and focused and awaits input.\r\n\t\t\tshowEmpty: false,\r\n\t\t\t\r\n\t\t\tonDrag: function(/*EventObject*/obj){\r\n\t\t\t\tif(!this.parentNode){\r\n\t\t\t\t\tthis.showParent(obj);\r\n\t\t\t\t}\r\n\t\t\t\tvar s = this._startdrag, e = obj.page;\r\n\t\t\t\tthis._box.left = (s.x < e.x ? s.x : e.x);\r\n\t\t\t\tthis._box.top = s.y;\r\n\t\t\t\tthis._box.width = (s.x < e.x ? e.x-s.x : s.x-e.x) + this.style.text.pad;\r\n\t\t\t\t\r\n\t\t\t\tdojo.style(this.parentNode, this._box.toPx());\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tonUp: function(/*EventObject*/obj){\r\n\t\t\t\tif(!this._downOnCanvas){ return; }\r\n\t\t\t\tthis._downOnCanvas = false;\r\n\t\t\t\t\r\n\t\t\t\tvar c = dojo.connect(this, \"render\", this, function(){\r\n\t\t\t\t\tdojo.disconnect(c);\r\n\t\t\t\t\tthis.onRender(this);\r\n\t\t\t\t\t\r\n\t\t\t\t});\r\n\t\t\t\tthis.editMode = true;\r\n\t\t\t\tthis.showParent(obj);\r\n\t\t\t\tthis.created = true;\r\n\t\t\t\tthis.createTextField();\r\n\t\t\t\tthis.connectTextField();\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tshowParent: function(/*EventObject*/obj){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tInternal. Builds the parent node for the\r\n\t\t\t\t//\t\tcontenteditable HTML node.\r\n\r\n\t\t\t\tif(this.parentNode){ return; }\r\n\t\t\t\tvar x = obj.pageX || 10;\r\n\t\t\t\tvar y = obj.pageY || 10;\r\n\t\t\t\tthis.parentNode = dojo.doc.createElement(\"div\");\r\n\t\t\t\tthis.parentNode.id = this.id;\r\n\t\t\t\tvar d = this.style.textMode.create;\r\n\t\t\t\tthis._box = {\r\n\t\t\t\t\tleft:x,\r\n\t\t\t\t\ttop:y,\r\n\t\t\t\t\twidth:obj.width || 1,\r\n\t\t\t\t\theight:obj.height && obj.height>8 ? obj.height : this._lineHeight,\r\n\t\t\t\t\tborder:d.width+\"px \"+d.style+\" \"+d.color,\r\n\t\t\t\t\tposition:\"absolute\",\r\n\t\t\t\t\tzIndex:500,\r\n\t\t\t\t\ttoPx: function(){\r\n\t\t\t\t\t\tvar o = {};\r\n\t\t\t\t\t\tfor(var nm in this){\r\n\t\t\t\t\t\t\to[nm] = typeof(this[nm])==\"number\" && nm!=\"zIndex\" ? this[nm] + \"px\" : this[nm];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn o;\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\tdojo.style(this.parentNode, this._box);\r\n\t\t\t\t\r\n\t\t\t\tdocument.body.appendChild(this.parentNode);\r\n\t\t\t},\r\n\t\t\tcreateTextField: function(/*String*/txt){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tInternal. Inserts the contenteditable HTML node\r\n\t\t\t\t//\t\tinto its parent node, and styles it.\r\n\r\n\t\t\t\t// style parent\r\n\t\t\t\tvar d = this.style.textMode.edit;\r\n\t\t\t\tthis._box.border = d.width+\"px \"+d.style+\" \"+d.color;\r\n\t\t\t\tthis._box.height = \"auto\";\r\n\t\t\t\tthis._box.width = Math.max(this._box.width, this.style.text.minWidth*this.mouse.zoom);\r\n\t\t\t\tdojo.style(this.parentNode, this._box.toPx());\r\n\t\t\t\t// style input\r\n\t\t\t\tthis.parentNode.appendChild(conEdit);\r\n\t\t\t\tdojo.style(conEdit, {\r\n\t\t\t\t\theight: txt ? \"auto\" : this._lineHeight+\"px\",\r\n\t\t\t\t\tfontSize:(this.textSize/this.mouse.zoom)+\"px\",\r\n\t\t\t\t\tfontFamily:this.style.text.family\r\n\t\t\t\t});\r\n\t\t\t\t// FIXME:\r\n\t\t\t\t// In Safari, if the txt ends with '&' it gets stripped\r\n\t\t\t\tconEdit.innerHTML = txt || \"\";\r\n\t\t\t\t\r\n\t\t\t\treturn conEdit; //HTMLNode\r\n\t\t\t},\r\n\t\t\tconnectTextField: function(){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tInternal. Creates the connections to the\r\n\t\t\t\t//\t\tcontenteditable HTML node.\r\n\r\n\t\t\t\tif(this._textConnected){ return; } // good ol' IE and its double events\r\n\t\t\t\t// FIXME:\r\n\t\t\t\t// Ouch-getting greekPalette by id.  At the minimum this should\r\n\t\t\t\t// be from the plugin manager\r\n\t\t\t\tvar greekPalette = dijit.byId(\"greekPalette\");\r\n\t\t\t\tvar greekHelp = greekPalette==undefined ? false : true;\r\n\t\t\t\tif(greekHelp){\r\n\t\t\t\t\t//set it up\r\n\t\t\t\t\tdojo.mixin(greekPalette,{\r\n\t\t\t\t\t\t_pushChangeTo: conEdit,\r\n\t\t\t\t\t\t_textBlock: this\r\n\t\t\t\t\t});\r\n\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\tthis._textConnected = true;\r\n\t\t\t\tthis._dropMode = false;\r\n\t\t\t\tthis.mouse.setEventMode(\"TEXT\");\r\n\t\t\t\tthis.keys.editMode(true);\r\n\t\t\t\tvar kc1, kc2, kc3, kc4, self = this, _autoSet = false,\r\n\t\t\t\t\texec = function(){\r\n\t\t\t\t\t\tif(self._dropMode){ return; }\r\n\t\t\t\t\t\tdojo.forEach([kc1,kc2,kc3,kc4], function(c){\r\n\t\t\t\t\t\t\tdojo.disconnect(c)\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tself._textConnected = false;\r\n\t\t\t\t\t\tself.keys.editMode(false);\r\n\t\t\t\t\t\tself.mouse.setEventMode();\r\n\t\t\t\t\t\tself.execText();\r\n\t\t\t\t\t};\r\n\t\t\t\t\t\r\n\t\t\t\tkc1 = dojo.connect(conEdit, \"keyup\", this, function(evt){\r\n\t\t\t\t\t// \tif text is empty, we need a height so the field's height\r\n\t\t\t\t\t//\tdoesn't collapse\r\n\t\t\t\t\tif(dojo.trim(conEdit.innerHTML) && !_autoSet){\r\n\t\t\t\t\t\tdojo.style(conEdit, \"height\", \"auto\"); _autoSet = true;\r\n\t\t\t\t\t}else if(dojo.trim(conEdit.innerHTML).length<2 && _autoSet){\r\n\t\t\t\t\t\tdojo.style(conEdit, \"height\", this._lineHeight+\"px\"); _autoSet = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(!this._blockExec){\r\n\t\t\t\t\t\tif(evt.keyCode==13 || evt.keyCode==27){\r\n\t\t\t\t\t\t\tdojo.stopEvent(evt);\r\n\t\t\t\t\t\t\texec();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif(evt.keyCode==dojo.keys.SPACE){\r\n\t\t\t\t\t\t\tdojo.stopEvent(evt);\r\n\t\t\t\t\t\t\tgreekHelp && greekPalette.onCancel();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tkc2 = dojo.connect(conEdit, \"keydown\", this, function(evt){\r\n\t\t\t\t\tif(evt.keyCode==13 || evt.keyCode==27){ // TODO: make escape an option\r\n\t\t\t\t\t\tdojo.stopEvent(evt);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// if backslash, user is inputting a special character\r\n\t\t\t\t\t// This gives popup help.\r\n\t\t\t\t\tif(evt.keyCode==220){\r\n\t\t\t\t\t\tif(!greekHelp){\r\n\t\t\t\t\t\t\tconsole.info(\"For greek letter assistance instantiate: dojox.drawing.plugins.drawing.GreekPalette\");\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tdojo.stopEvent(evt);\r\n\t\t\t\t\t\tthis.getSelection(conEdit);\r\n\t\t\t\t\t\t// Differences in how browsers handle events made it necessary\r\n\t\t\t\t\t\t// to stop the evt and add the backslash here.\r\n\t\t\t\t\t\tthis.insertText(conEdit,\"\\\\\");\r\n\t\t\t\t\t\tthis._dropMode = true;\r\n\t\t\t\t\t\tthis._blockExec = true;\r\n\t\t\t\t\t\tgreekPalette.show({\r\n\t\t\t\t\t\t\taround:this.parentNode,\r\n\t\t\t\t\t\t\torient:{'BL':'TL'}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(!this._dropMode){\r\n\t\t\t\t\t\tthis._blockExec = false;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// Controls for when we have a character helper and it's active\r\n\t\t\t\t\t\tswitch(evt.keyCode){\r\n\t\t\t\t\t\t\tcase dojo.keys.UP_ARROW:\r\n\t\t\t\t\t\t\tcase dojo.keys.DOWN_ARROW:\r\n\t\t\t\t\t\t\tcase dojo.keys.LEFT_ARROW:\r\n\t\t\t\t\t\t\tcase dojo.keys.RIGHT_ARROW:\r\n\t\t\t\t\t\t\t\tdojo.stopEvent(evt);\r\n\t\t\t\t\t\t\t\tgreekPalette._navigateByArrow(evt);\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase dojo.keys.ENTER:\r\n\t\t\t\t\t\t\t\tdojo.stopEvent(evt);\r\n\t\t\t\t\t\t\t\tgreekPalette._onCellClick(evt);\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase dojo.keys.BACKSPACE:\r\n\t\t\t\t\t\t\tcase dojo.keys.DELETE:\r\n\t\t\t\t\t\t\t\tdojo.stopEvent(evt);\r\n\t\t\t\t\t\t\t\tgreekPalette.onCancel();\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t\t\tkc3 = dojo.connect(document, \"mouseup\", this, function(evt){\r\n\t\t\t\t\t// note: _onAnchor means an anchor has been clicked upon\r\n\t\t\t\t\tif(!this._onAnchor && evt.target.id != \"conEdit\"){\r\n\t\t\t\t\t\tdojo.stopEvent(evt);\r\n\t\t\t\t\t\texec();\r\n\t\t\t\t\t}else if(evt.target.id == \"conEdit\" && conEdit.innerHTML == \"\"){\r\n\t\t\t\t\t\t// wonky stuff happens when you click on the\r\n\t\t\t\t\t\t// field when its empty.\r\n\t\t\t\t\t\tconEdit.blur();\r\n\t\t\t\t\t\tsetTimeout(function(){\r\n\t\t\t\t\t\t\tconEdit.focus();\r\n\t\t\t\t\t\t},200)\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t\t\tthis.createAnchors();\r\n\t\t\t\t\r\n\t\t\t\tkc4 = dojo.connect(this.mouse, \"setZoom\", this, function(evt){\r\n\t\t\t\t\texec();\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tconEdit.focus();\r\n\t\t\t\t\r\n\t\t\t\tthis.onDown = function(){};\r\n\t\t\t\tthis.onDrag = function(){};\r\n\t\t\t\t\r\n\t\t\t\tsetTimeout(dojo.hitch(this, function(){\r\n\t\t\t\t\t// once again for Silverlight:\r\n\t\t\t\t\tconEdit.focus();\r\n\t\t\t\t\t\r\n\t\t\t\t\t// this is a pretty odd chunk of code here.\r\n\t\t\t\t\t// specifcally need to overwrite old onUp\r\n\t\t\t\t\t// however, this still gets called. its\r\n\t\t\t\t\t// not disconnecting.\r\n\t\t\t\t\tthis.onUp = function(){\r\n\t\t\t\t\t\tif(!self._onAnchor && this.parentNode){\r\n\t\t\t\t\t\t\tself.disconnectMouse();\r\n\t\t\t\t\t\t\texec();\r\n\t\t\t\t\t\t\tself.onUp = function(){}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}), 500);\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\t\r\n\t\t\texecText: function(){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tInternal. Method fired when text is executed,\r\n\t\t\t\t//\t\tvia mouse-click-off, ESC key or Enter key.\r\n\r\n\t\t\t\tvar d = dojo.marginBox(this.parentNode);\r\n\t\t\t\tvar w = Math.max(d.w, this.style.text.minWidth);\r\n\t\t\t\t\r\n\t\t\t\tvar txt = this.cleanText(conEdit.innerHTML, true);\r\n\t\t\t\tconEdit.innerHTML = \"\";\r\n\t\t\t\tconEdit.blur();\r\n\t\t\t\tthis.destroyAnchors();\r\n\r\n\t\t\t\t// need to convert characters before measuring width.\r\n\t\t\t\ttxt = this.typesetter(txt);\r\n\t\t\t\t\r\n\t\t\t\tvar o = this.measureText(txt, w);\r\n\t\t\t\tvar sc = this.mouse.scrollOffset();\r\n\t\t\t\tvar org = this.mouse.origin;\r\n\t\t\t\t\r\n\t\t\t\tvar x = this._box.left + sc.left - org.x;\r\n\t\t\t\tvar y = this._box.top + sc.top - org.y;\r\n\t\t\t\t\r\n\t\t\t\tx *= this.mouse.zoom;\r\n\t\t\t\ty *= this.mouse.zoom;\r\n\t\t\t\tw *= this.mouse.zoom;\r\n\t\t\t\to.h *= this.mouse.zoom;\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tthis.points = [\r\n\t\t\t\t\t{x:x, y:y},\r\n\t\t\t\t\t{x:x+w, y:y},\r\n\t\t\t\t\t{x:x+w, y:y+o.h},\r\n\t\t\t\t\t{x:x, y:y+o.h}\r\n\t\t\t\t];\r\n\t\t\t\tthis.editMode = false;\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tconsole.log(\"EXEC TEXT::::\", this._postRenderCon);\r\n\t\t\t\t\r\n\t\t\t\tif(!o.text){\r\n\t\t\t\t\tthis._text = \"\";\r\n\t\t\t\t\tthis._textArray = [];\r\n\t\t\t\t}\r\n\t\t\t\t// Only for Combo objects (vectors, rectangle, or ellipse).\r\n\t\t\t\tthis.render(o.text);\r\n\t\t\t\tthis.onChangeText(this.getText());\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tedit: function(){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tInternal?\r\n\t\t\t\t//\t\tMethod used to instantiate the contenteditable HTML node.\r\n\r\n\t\t\t\tthis.editMode = true;\r\n\t\t\t\tvar text = this.getText() || \"\";\r\n\t\t\t\tconsole.log(\"EDIT TEXT:\",text, \" \",text.replace(\"/n\", \" \"));\r\n\t\t\t\t// NOTE: no mouse obj\r\n\t\t\t\tif(this.parentNode || !this.points){ return; }\r\n\t\t\t\tvar d = this.pointsToData();\r\n\t\t\t\t\r\n\t\t\t\tvar sc = this.mouse.scrollOffset();\r\n\t\t\t\tvar org = this.mouse.origin;\r\n\t\t\t\t\r\n\t\t\t\tvar obj = {\r\n\t\t\t\t\tpageX: (d.x  ) / this.mouse.zoom - sc.left + org.x,\r\n\t\t\t\t\tpageY: (d.y  ) / this.mouse.zoom- sc.top + org.y,\r\n\t\t\t\t\twidth:d.width / this.mouse.zoom,\r\n\t\t\t\t\theight:d.height / this.mouse.zoom\r\n\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\tthis.remove(this.shape, this.hit);\r\n\t\t\t\tthis.showParent(obj);\r\n\t\t\t\tthis.createTextField(text.replace(\"/n\", \" \"));\r\n\t\t\t\tthis.connectTextField();\r\n\t\t\t\tif(text){\r\n\t\t\t\t\t//setTimeout(dojo.hitch(this, function(){\r\n\t\t\t\t\tthis.setSelection(conEdit, \"end\");\r\n\t\t\t\t\t//}), 500)\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tcleanText: function(/*String*/txt, /*Boolean*/removeBreaks){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tCleans text. Strings HTML chars and double spaces\r\n\t\t\t\t//\t\tand optionally removes line breaks.\r\n\t\t\t\tvar replaceHtmlCodes = function(str){\r\n\t\t\t\t\tvar chars = {\r\n\t\t\t\t\t\t\"&lt;\":\"<\",\r\n\t\t\t\t\t\t\"&gt;\":\">\",\r\n\t\t\t\t\t\t\"&amp;\":\"&\"\r\n\t\t\t\t\t};\r\n\t\t\t\t\tfor(var nm in chars){\r\n\t\t\t\t\t\tstr = str.replace(new RegExp(nm, \"gi\"), chars[nm])\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn str\r\n\t\t\t\t};\r\n\r\n\t\t\t\tif(removeBreaks){\r\n\t\t\t\t\tdojo.forEach(['<br>', '<br/>', '<br />', '\\\\n', '\\\\r'], function(br){\r\n\t\t\t\t\t\ttxt = txt.replace(new RegExp(br, 'gi'), \" \");\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\ttxt = txt.replace(/&nbsp;/g, \" \");\r\n\t\t\t\ttxt = replaceHtmlCodes(txt);\r\n\t\t\t\ttxt = dojo.trim(txt);\r\n\t\t\t\t// remove double spaces, since SVG doesn't show them anyway\r\n\t\t\t\ttxt = txt.replace(/\\s{2,}/g, \" \");\r\n\t\t\t\treturn txt; //String\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tmeasureText: function(/* String */ str, /* ? Number */width){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tMechanism for measuring text.\r\n\t\t\t\t//\t\tSVG nor VML have a way of determining the width or\r\n\t\t\t\t//\t\theight of a block of text. This method creates an\r\n\t\t\t\t//\t\tHTML text block and those measurements are used for\r\n\t\t\t\t//\t\tdisplaying the SVG/VML text.\r\n\t\t\t\t// str: String\r\n\t\t\t\t//\t\tThe text to display and measure.\r\n\t\t\t\t// width: [optional] Number\r\n\t\t\t\t//\t\tIf the width is not provided, it will be assumed\r\n\t\t\t\t//\t\tthat the text is one line and the width will be\r\n\t\t\t\t//\t\tmeasured and the _lineHeight used for th height.\r\n\t\t\t\t//\t\tIf width is provided, word-wrap is assumed, and\r\n\t\t\t\t//\t\tline breaks will be inserted into the text at each\r\n\t\t\t\t//\t\tpoint where a word wraps in the HTML. The height is\r\n\t\t\t\t//\t\tthen measured.\r\n\r\n\t\t\t\tvar r = \"(<br\\\\s*/*>)|(\\\\n)|(\\\\r)\";\r\n\t\t\t\tthis.showParent({width:width || \"auto\", height:\"auto\"});\r\n\t\t\t\tthis.createTextField(str);\r\n\t\t\t\tvar txt = \"\";\r\n\t\t\t\tvar el = conEdit;\r\n\t\t\t\tel.innerHTML = \"X\";\r\n\t\t\t\tvar h = dojo.marginBox(el).h;\r\n\t\t\t\t\r\n\t\t\t\tel.innerHTML = str;\r\n\t\t\t\t\r\n\t\t\t\tif(!width || new RegExp(r, \"gi\").test(str)){\r\n\t\t\t\t\t// has line breaks in text\r\n\t\t\t\t\ttxt = str.replace(new RegExp(r, \"gi\"), \"\\n\");\r\n\t\t\t\t\tel.innerHTML = str.replace(new RegExp(r, \"gi\"), \"<br/>\");\r\n\t\t\t\t\r\n\t\t\t\t}else if(dojo.marginBox(el).h == h){\r\n\t\t\t\t\t// one line\r\n\t\t\t\t\ttxt = str;\r\n\t\t\t\t\t\r\n\t\t\t\t}else{\r\n\t\t\t\t\t// text wraps\r\n\t\t\t\t\tvar ar = str.split(\" \");\r\n\t\t\t\t\tvar strAr = [[]];\r\n\t\t\t\t\tvar line = 0;\r\n\t\t\t\t\tel.innerHTML = \"\";\r\n\t\t\t\t\twhile(ar.length){\r\n\t\t\t\t\t\tvar word = ar.shift();\r\n\t\t\t\t\t\tel.innerHTML += word+\" \"; //urk, always an extra space\r\n\t\t\t\t\t\tif(dojo.marginBox(el).h > h){\r\n\t\t\t\t\t\t\tline++;\r\n\t\t\t\t\t\t\tstrAr[line] = [];\r\n\t\t\t\t\t\t\tel.innerHTML = word+\" \";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tstrAr[line].push(word)\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tdojo.forEach(strAr, function(ar, i){\r\n\t\t\t\t\t\tstrAr[i] = ar.join(\" \");\r\n\t\t\t\t\t});\r\n\t\t\t\t\ttxt = strAr.join(\"\\n\");\r\n\t\t\t\t\t\r\n\t\t\t\t\t// get the resultant height\r\n\t\t\t\t\tel.innerHTML = txt.replace(\"\\n\", \"<br/>\");\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tvar dim = dojo.marginBox(el);\r\n\t\t\t\t\r\n\t\t\t\tconEdit.parentNode.removeChild(conEdit);\r\n\t\t\t\tdojo.destroy(this.parentNode);\r\n\t\t\t\tthis.parentNode = null;\r\n\t\t\t\t\r\n\t\t\t\treturn {h:dim.h, w:dim.w, text:txt}; //Object\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\t_downOnCanvas:false,\r\n\t\t\tonDown: function(/*EventObject*/obj){\r\n\t\t\t\tthis._startdrag = {\r\n\t\t\t\t\tx: obj.pageX,\r\n\t\t\t\t\ty: obj.pageY\r\n\t\t\t\t};\r\n\t\t\t\tdojo.disconnect(this._postRenderCon);\r\n\t\t\t\tthis._postRenderCon = null;\r\n\t\t\t\tthis._downOnCanvas = true;\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tcreateAnchors: function(){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tInternal. Creates HTML nodes at each corner\r\n\t\t\t\t//\t\tof the contenteditable div. These nodes are\r\n\t\t\t\t//\t\tdraggable and will resize the div horizontally.\r\n\r\n\t\t\t\tthis._anchors = {};\r\n\t\t\t\tvar self = this;\r\n\t\t\t\tvar d = this.style.anchors,\r\n\t\t\t\t\tb = d.width,\r\n\t\t\t\t\tw = d.size-b*2,\r\n\t\t\t\t\th = d.size-b*2,\r\n\t\t\t\t\tp = (d.size)/2*-1 + \"px\";\r\n\t\t\t\t\r\n\t\t\t\tvar s = {\r\n\t\t\t\t\tposition:\"absolute\",\r\n\t\t\t\t\twidth:w+\"px\",\r\n\t\t\t\t\theight:h+\"px\",\r\n\t\t\t\t\tbackgroundColor:d.fill,\r\n\t\t\t\t\tborder:b+\"px \" + d.style + \" \"+d.color\r\n\t\t\t\t};\r\n\t\t\t\tif(dojo.isIE){\r\n\t\t\t\t\ts.paddingLeft = w + \"px\";\r\n\t\t\t\t\ts.fontSize = w + \"px\"\r\n\t\t\t\t}\r\n\t\t\t\tvar ss = [\r\n\t\t\t\t\t{top: p, left:p},\r\n\t\t\t\t\t{top:p, right:p},\r\n\t\t\t\t\t{bottom:p, right:p},\r\n\t\t\t\t\t{bottom:p,left:p}\r\n\t\t\t\t];\r\n\t\t\t\tfor(var i=0;i<4;i++){\r\n\t\t\t\t\tvar isLeft = (i==0) || (i==3);\r\n\t\t\t\t\tvar id = this.util.uid(isLeft ? \"left_anchor\" : \"right_anchor\");\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar a = dojo.create(\"div\", {id:id}, this.parentNode);\r\n\t\t\t\t\tdojo.style(a, dojo.mixin(dojo.clone(s), ss[i]));\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar md, mm, mu;\r\n\t\t\t\t\tvar md = dojo.connect(a, \"mousedown\", this, function(evt){\r\n\t\t\t\t\t\tisLeft = evt.target.id.indexOf(\"left\")>-1;\r\n\t\t\t\t\t\tself._onAnchor = true;\r\n\t\t\t\t\t\tvar orgX = evt.pageX;\r\n\t\t\t\t\t\tvar orgW = this._box.width;\r\n\t\t\t\t\t\tdojo.stopEvent(evt);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tmm = dojo.connect(document, \"mousemove\", this, function(evt){\r\n\t\t\t\t\t\t\tvar x = evt.pageX;\r\n\t\t\t\t\t\t\tif(isLeft){\r\n\t\t\t\t\t\t\t\tthis._box.left = x;\r\n\t\t\t\t\t\t\t\tthis._box.width = orgW + orgX - x;\r\n\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\tthis._box.width = x + orgW - orgX;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tdojo.style(this.parentNode, this._box.toPx());\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tmu = dojo.connect(document, \"mouseup\", this, function(evt){\r\n\t\t\t\t\t\t\torgX = this._box.left;\r\n\t\t\t\t\t\t\torgW = this._box.width;\r\n\t\t\t\t\t\t\tdojo.disconnect(mm);\r\n\t\t\t\t\t\t\tdojo.disconnect(mu);\r\n\t\t\t\t\t\t\tself._onAnchor = false;\r\n\t\t\t\t\t\t\tconEdit.focus();\r\n\t\t\t\t\t\t\tdojo.stopEvent(evt);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t\t\r\n\t\t\t\t\tthis._anchors[id] = {\r\n\t\t\t\t\t\ta:a,\r\n\t\t\t\t\t\tcons:[md]\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tdestroyAnchors: function(){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tInternal. Destroys HTML anchors.\r\n\t\t\t\tfor(var n in this._anchors){\r\n\t\t\t\t\tdojo.forEach(this._anchors[n].con, dojo.disconnect, dojo);\r\n\t\t\t\t\tdojo.destroy(this._anchors[n].a);\r\n\t\t\t\t};\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tsetSavedCaret: function(val){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tInternal, called when caret needs to\r\n\t\t\t\t//\t\tbe moved into position after text is added\r\n\t\t\t\tthis._caretStart = this._caretEnd = val;\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tgetSavedCaret: function(){\r\n\t\t\t\treturn {start: this._caretStart, end: this._caretEnd}\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tinsertText: function(node,val){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tUses saved caret position to insert text\r\n\t\t\t\t//\t\tinto position and place caret at the end of\r\n\t\t\t\t//\t\tinsertion\r\n\r\n\t\t\t\tvar t, text = node.innerHTML;\r\n\t\t\t\tvar caret = this.getSavedCaret();\r\n\t\t\t\t\r\n\t\t\t\ttext = text.replace(/&nbsp;/g, \" \");\r\n\t\t\t\tt = text.substr(0,caret.start) + val + text.substr(caret.end);\r\n\t\t\t\tt = this.cleanText(t,true);\r\n\t\t\t\tthis.setSavedCaret(Math.min(t.length,(caret.end + val.length)));\r\n\t\t\t\tnode.innerHTML = t;\r\n\t\t\t\tthis.setSelection(node,\"stored\");\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tgetSelection: function(node){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tThis gets and stores the caret position\r\n\t\t\t\t//\t\tin the contentEditable div (conEdit).\r\n\t\t\t\t//\t\tNOTE: Doesn't work with html nodes inside\r\n\t\t\t\t//\t\tthe div.\r\n\r\n\t\t\t\tvar start, end;\r\n\t\t\t\tif(dojo.doc.selection){\r\n\t\t\t\t\tvar r = dojo.doc.selection.createRange();\r\n\t\t\t\t\tvar rs = dojo.body().createTextRange();\r\n\t\t\t\t\trs.moveToElementText(node);\r\n\t\t\t\t\tvar re = rs.duplicate();\r\n\t\t\t\t\trs.moveToBookmark(r.getBookmark());\r\n\t\t\t\t\tre.setEndPoint('EndToStart', rs);\r\n\t\t\t\t\tstart = this._caretStart = re.text.length;\r\n\t\t\t\t\tend = this._caretEnd = re.text.length+r.text.length;\r\n\t\t\t\t\tconsole.warn(\"Caret start: \",start,\" end: \",end,\" length: \",re.text.length,\" text: \",re.text);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._caretStart = dojo.global.getSelection().getRangeAt(node).startOffset;\r\n\t\t\t\t\tthis._caretEnd = dojo.global.getSelection().getRangeAt(node).endOffset;\r\n\t\t\t\t\tconsole.log(\"Caret start: \", this._caretStart,\" end: \", this._caretEnd);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tsetSelection: function(node, what){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tUsed for placing the cursor during edits and character help.\r\n\t\t\t\t//\t\tTakes the values: end, beg, start, all or any numerical value\r\n\t\t\t\t//\t\t(in which case the number will constitute the caret position)\r\n\r\n\t\t\t\tconsole.warn(\"setSelection:\");\r\n\t\t\t\tif(dojo.doc.selection){ // IE\r\n\t\t\t\t\tvar rs = dojo.body().createTextRange();\r\n\t\t\t\t\trs.moveToElementText(node);\r\n\t\t\t\t\t\r\n\t\t\t\t\tswitch(what){\r\n\t\t\t\t\t\tcase \"end\":\r\n\t\t\t\t\t\t\trs.collapse(false);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase \"beg\" || \"start\":\r\n\t\t\t\t\t\t\trs.collapse();\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase \"all\":\r\n\t\t\t\t\t\t\trs.collapse();\r\n\t\t\t\t\t\t\trs.moveStart(\"character\", 0);\r\n\t\t\t\t\t\t\trs.moveEnd(\"character\",node.text.length);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase \"stored\":\r\n\t\t\t\t\t\t\trs.collapse();\r\n\t\t\t\t\t\t\tvar dif = this._caretStart-this._caretEnd;\r\n\t\t\t\t\t\t\t//console.log(\"start: \",this._caretStart, \" end: \",this._caretEnd,\" dif: \",dif);\r\n\t\t\t\t\t\t\trs.moveStart(\"character\",this._caretStart);\r\n\t\t\t\t\t\t\trs.moveEnd(\"character\",dif);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t\trs.select();\r\n\t\t\t\t\t\r\n\t\t\t\t}else{\r\n\t\t\t\t\tvar getAllChildren = function(node, children){\r\n\t\t\t\t\t\tchildren = children || [];\r\n\t\t\t\t\t\tfor(var i=0;i<node.childNodes.length; i++){\r\n\t\t\t\t\t\t\tvar n = node.childNodes[i];\r\n\t\t\t\t\t\t\tif(n.nodeType==3){\r\n\t\t\t\t\t\t\t\tchildren.push(n);\r\n\t\t\t\t\t\t\t}else if(n.tagName && n.tagName.toLowerCase()==\"img\"){\r\n\t\t\t\t\t\t\t\tchildren.push(n);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif(n.childNodes && n.childNodes.length){\r\n\t\t\t\t\t\t\t\tgetAllChildren(n, children);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn children;\r\n\t\t\t\t\t};\r\n\t\t\t\t\tconsole.log(\"ff node:\", node);\r\n\t\t\t\t\tnode.focus();\r\n\t\t\t\t\tvar selection = dojo.global.getSelection();\r\n\t\t\t\t\tselection.removeAllRanges();\r\n\t\t\t\t\tvar r = dojo.doc.createRange();\r\n\t\t\t\t\tvar nodes = getAllChildren(node);\r\n\t\t\t\t\tswitch(what){\r\n\t\t\t\t\t\tcase \"end\":\r\n\t\t\t\t\t\t\tconsole.log(\"len:\", nodes[nodes.length - 1].textContent.length);\r\n\t\t\t\t\t\t\tr.setStart(nodes[nodes.length - 1], nodes[nodes.length - 1].textContent.length);\r\n\t\t\t\t\t\t\tr.setEnd(nodes[nodes.length - 1], nodes[nodes.length - 1].textContent.length);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase \"beg\" || \"start\":\r\n\t\t\t\t\t\t\tr.setStart(nodes[0], 0);\r\n\t\t\t\t\t\t\tr.setEnd(nodes[0], 0);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase \"all\":\r\n\t\t\t\t\t\t\tr.setStart(nodes[0], 0);\r\n\t\t\t\t\t\t\tr.setEnd(nodes[nodes.length - 1], nodes[nodes.length - 1].textContent.length);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase \"stored\":\r\n\t\t\t\t\t\t\tconsole.log(\"Caret start: \",this._caretStart,\" caret end: \",this._caretEnd);\r\n\t\t\t\t\t\t\tr.setStart(nodes[0], this._caretStart);\r\n\t\t\t\t\t\t\tr.setEnd(nodes[0], this._caretEnd);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tselection.addRange(r);\r\n\t\t\t\t\tconsole.log(\"sel \", what, \" on \", node);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t);\r\n\tdojo.setObject(\"dojox.drawing.tools.TextBlock\", TextBlock);\r\n\tTextBlock.setup = {\r\n\t\tname:\"dojox.drawing.tools.TextBlock\",\r\n\t\ttooltip:\"Text Tool\",\r\n\t\ticonClass:\"iconText\"\r\n\t};\r\n\tregistry.register(TextBlock.setup, \"tool\");\r\n\r\n\treturn TextBlock;\r\n});\r\n"]}