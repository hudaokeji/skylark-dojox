{"version":3,"sources":["gfx/canvas.js"],"names":["define","g","lang","arr","declare","win","domGeom","dom","gs","pathLib","ga","m","decompose","bezierUtils","canvas","pattrnbuffer","mp","multiplyPoint","pi","Math","PI","twoPI","halfPI","extend","global","CanvasRenderingContext2D","ctx2d","doc","createElement","getContext","hasNativeDash","setLineDash","hasFillText","fillText","dasharray","solid","shortdash","shortdot","shortdashdot","shortdashdotdot","dot","dash","longdash","dashdot","longdashdot","longdashdotdot","drawDashedArc","ctx","cx","cy","r","sa","ea","ccw","apply","prevResidue","residue","angle","l","length","i","beginPath","arc","stroke","splitToDashedBezier","points","dashArray","newPoints","t","tAtLength","computeLength","curves","splitBezierAtT","push","toDashedCurveTo","shape","pts","last","x","y","concat","quadratic","Array","api","canvasDash","c","curve","moveTo","slice","toDashedLineTo","x1","y1","x2","y2","dal","tlength","distance","prevx","prevy","abs","lineTo","Shape","_render","save","this","_renderTransform","_renderClip","_renderShape","_renderFill","_renderStroke","restore","canvasClip","render","clip","canvasTransform","translate","dx","dy","rotate","angle2","scale","sx","sy","angle1","fs","fillStyle","w","width","h","height","iw","canvasFillImage","ih","s","min","copyctx","clearRect","drawImage","canvasFill","createPattern","type","fill","strokeStyle","color","toString","lineWidth","lineCap","cap","join","lineJoin","miterLimit","_renderDashedStroke","getEventSource","on","connect","disconnect","setClip","inherited","arguments","clipType","makeClip","parent","_makeDirty","geometry","canvasEllipse","makeEllipse","Ellipse","prototype","call","delegate","Rect","canvasPath","makeClipPath","canvasPolyline","Polyline","geo","p","dojox","gfx","Path","_setPath","d","modifyMethod","method","extra","old","matrix","f","surface","rawNode","createLinearGradient","createRadialGradient","forEach","colors","step","addColorStop","offset","normalizeColor","document","img","Image","downloadImage","src","st","da","style","toLowerCase","_needsDash","Group","constructor","Container","_init","children","destroy","clear","xl","xr","yt","yb","xl2","xr2","yt2","yb2","closePath","bezierCircle","u","curvePI4","c1","c2","e","a","rotateg","M","normalize","rx","ry","p1","_dashedPoints","setShape","setStroke","bezierCurveTo","j","Circle","startAngle","Line","bbox","_normalizePoints","canvasImage","Text","_setFont","fontStyle","canvasFont","makeFontString","getTextWidth","text","font","measureText","ta","align","textAlign","strokeText","getBoundingBox","pathRenderers","L","H","V","v","C","S","Q","q","T","A","Z","z","lastControl","_dashedPath","segmented","_confirmSegmented","_dashResidue","_updateWithSegment","segment","clone","action","args","_moveToA","result","doDash","_moveToR","_lineToA","_lineToR","_hLineToA","_hLineToR","_vLineToA","_vLineToR","_curveToA","_curveToR","_smoothCurveToA","valid","_smoothCurveToR","_qCurveToA","_qCurveToR","_qSmoothCurveToA","_qSmoothCurveToR","_arcTo","relative","arcs","arcAsBezier","_closePath","TextPath","_setText","Surface","pendingImageCount","makeDirty","setDimensions","normalizedLength","dirty","getDimensions","force","clearTimeout","pendingRender","pendingImagesCount","_batch","setTimeout","hitch","url","handler","onImageLoad","onload","onerror","onabort","onImagesLoaded","createSurface","parentNode","pos","position","byId","ownerDocument","appendChild","_parent","openBatch","closeBatch","add","remove","silently","_moveChildToFront","_moveChildToBack","Creator","createObject","shapeType","rawShape","fixTarget","event","gfxElement"],"mappings":"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","file":"../../gfx/canvas.js","sourcesContent":["define([\"./_base\", \"dojo/_base/lang\", \"dojo/_base/array\", \"dojo/_base/declare\", \"dojo/_base/window\", \"dojo/dom-geometry\",\r\n\t\t\"dojo/dom\", \"./shape\", \"./path\", \"./arc\", \"./matrix\", \"./decompose\", \"./bezierutils\"],\r\nfunction(g, lang, arr, declare, win, domGeom, dom, gs, pathLib, ga, m, decompose, bezierUtils ){\r\n\tvar canvas = g.canvas = {\r\n\t\t// summary:\r\n\t\t//\t\tThis the graphics rendering bridge for W3C Canvas compliant browsers.\r\n\t\t//\t\tSince Canvas is an immediate mode graphics api, with no object graph or\r\n\t\t//\t\teventing capabilities, use of this module alone will only add in drawing support.\r\n\t\t//\t\tThe additional module, canvasWithEvents extends this module with additional support\r\n\t\t//\t\tfor handling events on Canvas.  By default, the support for events is now included\r\n\t\t//\t\thowever, if only drawing capabilities are needed, canvas event module can be disabled\r\n\t\t//\t\tusing the dojoConfig option, canvasEvents:true|false.\r\n\t\t//\t\tThe id of the Canvas renderer is 'canvas'.  This id can be used when switch Dojo's\r\n\t\t//\t\tgraphics context between renderer implementations.  See dojox/gfx/_base.switchRenderer\r\n\t\t//\t\tAPI.\r\n\t};\r\n\tvar pattrnbuffer = null,\r\n\t\tmp = m.multiplyPoint,\r\n\t\tpi = Math.PI,\r\n\t\ttwoPI = 2 * pi,\r\n\t\thalfPI = pi /2,\r\n\t\textend = lang.extend;\r\n\r\n\tif(win.global.CanvasRenderingContext2D){\r\n\t\tvar ctx2d = win.doc.createElement(\"canvas\").getContext(\"2d\");\r\n\t\tvar hasNativeDash = typeof ctx2d.setLineDash == \"function\";\r\n\t\tvar hasFillText = typeof ctx2d.fillText == \"function\";\r\n\t}\r\n\r\n\tvar dasharray = {\r\n\t\tsolid:\t\t\t\t\"none\",\r\n\t\tshortdash:\t\t\t[4, 1],\r\n\t\tshortdot:\t\t\t[1, 1],\r\n\t\tshortdashdot:\t\t[4, 1, 1, 1],\r\n\t\tshortdashdotdot:\t[4, 1, 1, 1, 1, 1],\r\n\t\tdot:\t\t\t\t[1, 3],\r\n\t\tdash:\t\t\t\t[4, 3],\r\n\t\tlongdash:\t\t\t[8, 3],\r\n\t\tdashdot:\t\t\t[4, 3, 1, 3],\r\n\t\tlongdashdot:\t\t[8, 3, 1, 3],\r\n\t\tlongdashdotdot:\t\t[8, 3, 1, 3, 1, 3]\r\n\t};\r\n\r\n\tfunction drawDashedArc(/*CanvasRenderingContext2D*/ctx, /*Number[]*/dash,  /*int*/cx,  /*int*/cy,  /*int*/r, /*Number*/sa, /*Number*/ea, /*Boolean*/ccw, /*Boolean?*/apply, prevResidue){\r\n\t\tvar residue, angle, l = dash.length, i= 0;\r\n\t\t// if there's a previous dash residue from the previous arc, start with it.\r\n\t\tif(prevResidue){\r\n\t\t\tangle = prevResidue.l/r;\r\n\t\t\ti = prevResidue.i;\r\n\t\t}else{\r\n\t\t\tangle = dash[0]/r;\r\n\t\t}\r\n\t\twhile(sa < ea){\r\n\t\t\t// if the dash segment length is longer than what remains to stroke, keep it for next arc. (aka residue)\r\n\t\t\tif(sa+angle > ea){\r\n\t\t\t\tresidue = {l: (sa+angle-ea)*r, i: i};\r\n\t\t\t\tangle = ea-sa;\r\n\t\t\t}\r\n\t\t\tif(!(i%2)){\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tctx.arc(cx, cy, r, sa, sa+angle, ccw);\r\n\t\t\t\tif(apply) ctx.stroke();\r\n\t\t\t}\r\n\t\t\tsa += angle;\r\n\t\t\t++i;\r\n\t\t\tangle = dash[i%l]/r;\r\n\t\t}\r\n\t\treturn residue;\r\n\t}\r\n\r\n\tfunction splitToDashedBezier(/*Number[]*/points, /*Number[]*/dashArray, /*Number[]*/newPoints, /*Object*/prevResidue){\r\n\t\tvar residue = 0, t = 0, dash, i = 0;\r\n\t\tif(prevResidue){\r\n\t\t\tdash = prevResidue.l;\r\n\t\t\ti = prevResidue.i;\r\n\t\t}else{\r\n\t\t\tdash = dashArray[0];\r\n\t\t}\r\n\t\twhile(t<1){\r\n\t\t\t// get the 't' corresponding to the given dash value.\r\n\t\t\tt = bezierUtils.tAtLength(points, dash);\r\n\t\t\tif(t==1){\r\n\t\t\t\tvar rl = bezierUtils.computeLength(points);\r\n\t\t\t\tresidue = {l: dash-rl, i: i};\r\n\t\t\t}\r\n\t\t\t// split bezier at t: left part is the \"dash\" curve, right part is the remaining bezier points\r\n\t\t\tvar curves = bezierUtils.splitBezierAtT(points, t);\r\n\t\t\tif(!(i%2)){\r\n\t\t\t\t// only keep the \"dash\" curve\r\n\t\t\t\tnewPoints.push(curves[0]);\r\n\t\t\t}\r\n\t\t\tpoints = curves[1];\r\n\t\t\t++i;\r\n\t\t\tdash = dashArray[i%dashArray.length];\r\n\t\t}\r\n\t\treturn residue;\r\n\t}\r\n\r\n\tfunction toDashedCurveTo(/*Array||CanvasRenderingContext2D*/ctx, /*shape.Path*/shape, /*Number[]*/points, /*Object*/prevResidue){\r\n\t\t// summary:\r\n\t\t//\t\tBuilds a set of bezier (cubic || quadratic)curveTo' canvas instructions that represents a dashed stroke of the specified bezier geometry.\r\n\r\n\t\tvar pts = [shape.last.x, shape.last.y].concat(points),\r\n\t\t\tquadratic = points.length === 4, ctx2d = !(ctx instanceof Array),\r\n\t\t\tapi = quadratic ? \"quadraticCurveTo\" : \"bezierCurveTo\",\r\n\t\t\tcurves = [];\r\n\t\tvar residue = splitToDashedBezier(pts, shape.canvasDash, curves, prevResidue);\r\n\t\tfor(var c=0; c<curves.length;++c){\r\n\t\t\tvar curve = curves[c];\r\n\t\t\tif(ctx2d){\r\n\t\t\t\tctx.moveTo(curve[0], curve[1]);\r\n\t\t\t\tctx[api].apply(ctx, curve.slice(2));\r\n\t\t\t}else{\r\n\t\t\t\tctx.push(\"moveTo\", [curve[0], curve[1]]);\r\n\t\t\t\tctx.push(api, curve.slice(2));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn residue;\r\n\t}\r\n\r\n\tfunction toDashedLineTo(/*Array||CanvasRenderingContext2D*/ctx, /*shape.Shape*/shape, /*int*/x1, /*int*/y1, /*int*/x2, /*int*/y2, /*Object*/prevResidue){\r\n\t\t// summary:\r\n\t\t//\t\tBuilds a set of moveTo/lineTo' canvas instructions that represents a dashed stroke of the specified line geometry.\r\n\r\n\t\tvar residue = 0, r = 0, dal = 0, tlength = bezierUtils.distance(x1, y1, x2, y2), i = 0, dash = shape.canvasDash,\r\n\t\t\tprevx = x1, prevy = y1, x, y, ctx2d = !(ctx instanceof Array);\r\n\t\tif(prevResidue){\r\n\t\t\tdal=prevResidue.l;\r\n\t\t\ti = prevResidue.i;\r\n\t\t}else{\r\n\t\t\tdal += dash[0];\r\n\t\t}\r\n\t\twhile(Math.abs(1-r)>0.01){\r\n\t\t\tif(dal>tlength){\r\n\t\t\t\tresidue = {l:dal-tlength,i:i};\r\n\t\t\t\tdal=tlength;\r\n\t\t\t}\r\n\t\t\tr = dal/tlength;\r\n\t\t\tx = x1 + (x2-x1)*r;\r\n\t\t\ty = y1 + (y2-y1)*r;\r\n\t\t\tif(!(i++%2)){\r\n\t\t\t\tif(ctx2d){\r\n\t\t\t\t\tctx.moveTo(prevx, prevy);\r\n\t\t\t\t\tctx.lineTo(x, y);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tctx.push(\"moveTo\", [prevx, prevy]);\r\n\t\t\t\t\tctx.push(\"lineTo\", [x, y]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tprevx = x;\r\n\t\t\tprevy = y;\r\n\t\t\tdal += dash[i%dash.length];\r\n\t\t}\r\n\t\treturn residue;\r\n\t}\r\n\r\n\tcanvas.Shape = declare(\"dojox.gfx.canvas.Shape\", gs.Shape, {\r\n\t\t_render: function(/* Object */ ctx){\r\n\t\t\t// summary:\r\n\t\t\t//\t\trender the shape\r\n\t\t\tctx.save();\r\n\t\t\tthis._renderTransform(ctx);\r\n\t\t\tthis._renderClip(ctx);\r\n\t\t\tthis._renderShape(ctx);\r\n\t\t\tthis._renderFill(ctx, true);\r\n\t\t\tthis._renderStroke(ctx, true);\r\n\t\t\tctx.restore();\r\n\t\t},\r\n\t\t_renderClip: function(ctx){\r\n\t\t\tif (this.canvasClip){\r\n\t\t\t\tthis.canvasClip.render(ctx);\r\n\t\t\t\tctx.clip();\r\n\t\t\t}\r\n\t\t},\r\n\t\t_renderTransform: function(/* Object */ ctx){\r\n\t\t\tif(\"canvasTransform\" in this){\r\n\t\t\t\tvar t = this.canvasTransform;\r\n\t\t\t\tctx.translate(t.dx, t.dy);\r\n\t\t\t\tctx.rotate(t.angle2);\r\n\t\t\t\tctx.scale(t.sx, t.sy);\r\n\t\t\t\tctx.rotate(t.angle1);\r\n\t\t\t\t// The future implementation when vendors catch up with the spec:\r\n\t\t\t\t// var t = this.matrix;\r\n\t\t\t\t// ctx.transform(t.xx, t.yx, t.xy, t.yy, t.dx, t.dy);\r\n\t\t\t}\r\n\t\t},\r\n\t\t_renderShape: function(/* Object */ ctx){\r\n\t\t\t// nothing\r\n\t\t},\r\n\t\t_renderFill: function(/* Object */ ctx, /* Boolean */ apply){\r\n\t\t\tif(\"canvasFill\" in this){\r\n\t\t\t\tvar fs = this.fillStyle;\r\n\t\t\t\tif(\"canvasFillImage\" in this){\r\n\t\t\t\t\tvar w = fs.width, h = fs.height,\r\n\t\t\t\t\t\tiw = this.canvasFillImage.width, ih = this.canvasFillImage.height,\r\n\t\t\t\t\t\t// let's match the svg default behavior wrt. aspect ratio: xMidYMid meet\r\n\t\t\t\t\t\tsx = w == iw ? 1 : w / iw,\r\n\t\t\t\t\t\tsy = h == ih ? 1 : h / ih,\r\n\t\t\t\t\t\ts = Math.min(sx,sy), //meet->math.min , slice->math.max\r\n\t\t\t\t\t\tdx = (w - s * iw)/2,\r\n\t\t\t\t\t\tdy = (h - s * ih)/2;\r\n\t\t\t\t\t// the buffer used to scaled the image\r\n\t\t\t\t\tpattrnbuffer.width = w; pattrnbuffer.height = h;\r\n\t\t\t\t\tvar copyctx = pattrnbuffer.getContext(\"2d\");\r\n\t\t\t\t\tcopyctx.clearRect(0, 0, w, h);\r\n\t\t\t\t\tcopyctx.drawImage(this.canvasFillImage, 0, 0, iw, ih, dx, dy, s*iw, s*ih);\r\n\t\t\t\t\tthis.canvasFill = ctx.createPattern(pattrnbuffer, \"repeat\");\r\n\t\t\t\t\tdelete this.canvasFillImage;\r\n\t\t\t\t}\r\n\t\t\t\tctx.fillStyle = this.canvasFill;\r\n\t\t\t\tif(apply){\r\n\t\t\t\t\t// offset the pattern\r\n\t\t\t\t\tif (fs.type===\"pattern\" && (fs.x !== 0 || fs.y !== 0)) {\r\n\t\t\t\t\t\tctx.translate(fs.x,fs.y);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tctx.fill();\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\tctx.fillStyle = \"rgba(0,0,0,0.0)\";\r\n\t\t\t}\r\n\t\t},\r\n\t\t_renderStroke: function(/* Object */ ctx, /* Boolean */ apply){\r\n\t\t\tvar s = this.strokeStyle;\r\n\t\t\tif(s){\r\n\t\t\t\tctx.strokeStyle = s.color.toString();\r\n\t\t\t\tctx.lineWidth = s.width;\r\n\t\t\t\tctx.lineCap = s.cap;\r\n\t\t\t\tif(typeof s.join == \"number\"){\r\n\t\t\t\t\tctx.lineJoin = \"miter\";\r\n\t\t\t\t\tctx.miterLimit = s.join;\r\n\t\t\t\t}else{\r\n\t\t\t\t\tctx.lineJoin = s.join;\r\n\t\t\t\t}\r\n\t\t\t\tif(this.canvasDash){\r\n\t\t\t\t\tif(hasNativeDash){\r\n\t\t\t\t\t\tctx.setLineDash(this.canvasDash);\r\n\t\t\t\t\t\tif(apply){ ctx.stroke(); }\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tthis._renderDashedStroke(ctx, apply);\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tif(apply){ ctx.stroke(); }\r\n\t\t\t\t}\r\n\t\t\t}else if(!apply){\r\n\t\t\t\tctx.strokeStyle = \"rgba(0,0,0,0.0)\";\r\n\t\t\t}\r\n\t\t},\r\n\t\t_renderDashedStroke: function(ctx, apply){},\r\n\r\n\t\t// events are not implemented\r\n\t\tgetEventSource: function(){ return null; },\r\n\t\ton:\t\t\t\tfunction(){},\r\n\t\tconnect:\t\tfunction(){},\r\n\t\tdisconnect:\t\tfunction(){},\r\n\r\n\t\tcanvasClip:null,\r\n\t\tsetClip: function(/*Object*/clip){\r\n\t\t\tthis.inherited(arguments);\r\n\t\t\tvar clipType = clip ? \"width\" in clip ? \"rect\" :\r\n\t\t\t\t\t\t\t\"cx\" in clip ? \"ellipse\" :\r\n\t\t\t\t\t\t\t\"points\" in clip ? \"polyline\" : \"d\" in clip ? \"path\" : null : null;\r\n\t\t\tif(clip && !clipType){\r\n\t\t\t\treturn this;\r\n\t\t\t}\r\n\t\t\tthis.canvasClip = clip ? makeClip(clipType, clip) : null;\r\n\t\t\tif(this.parent){this.parent._makeDirty();}\r\n\t\t\treturn this;\r\n\t\t}\r\n\t});\r\n\r\n\tvar makeClip = function(clipType, geometry){\r\n\t\tswitch(clipType){\r\n\t\t\tcase \"ellipse\":\r\n\t\t\t\treturn {\r\n\t\t\t\t\tcanvasEllipse: makeEllipse({shape:geometry}),\r\n\t\t\t\t\trender: function(ctx){return canvas.Ellipse.prototype._renderShape.call(this, ctx);}\r\n\t\t\t\t};\r\n\t\t\tcase \"rect\":\r\n\t\t\t\treturn {\r\n\t\t\t\t\tshape: lang.delegate(geometry,{r:0}),\r\n\t\t\t\t\trender: function(ctx){return canvas.Rect.prototype._renderShape.call(this, ctx);}\r\n\t\t\t\t};\r\n\t\t\tcase \"path\":\r\n\t\t\t\treturn {\r\n\t\t\t\t\tcanvasPath: makeClipPath(geometry),\r\n\t\t\t\t\trender: function(ctx){this.canvasPath._renderShape(ctx);}\r\n\t\t\t\t};\r\n\t\t\tcase \"polyline\":\r\n\t\t\t\treturn {\r\n\t\t\t\t\tcanvasPolyline: geometry.points,\r\n\t\t\t\t\trender: function(ctx){return canvas.Polyline.prototype._renderShape.call(this, ctx);}\r\n\t\t\t\t};\r\n\t\t}\r\n\t\treturn null;\r\n\t};\r\n\r\n\tvar makeClipPath = function(geo){\r\n\t\tvar p = new dojox.gfx.canvas.Path();\r\n\t\tp.canvasPath = [];\r\n\t\tp._setPath(geo.d);\r\n\t\treturn p;\r\n\t};\r\n\r\n\tvar modifyMethod = function(shape, method, extra){\r\n\t\tvar old = shape.prototype[method];\r\n\t\tshape.prototype[method] = extra ?\r\n\t\t\tfunction(){\r\n\t\t\t\tif(this.parent){this.parent._makeDirty();}\r\n\t\t\t\told.apply(this, arguments);\r\n\t\t\t\textra.call(this);\r\n\t\t\t\treturn this;\r\n\t\t\t} :\r\n\t\t\tfunction(){\r\n\t\t\t\tif(this.parent){this.parent._makeDirty();}\r\n\t\t\t\treturn old.apply(this, arguments);\r\n\t\t\t};\r\n\t};\r\n\r\n\tmodifyMethod(canvas.Shape, \"setTransform\",\r\n\t\tfunction(){\r\n\t\t\t// prepare Canvas-specific structures\r\n\t\t\tif(this.matrix){\r\n\t\t\t\tthis.canvasTransform = g.decompose(this.matrix);\r\n\t\t\t}else{\r\n\t\t\t\tdelete this.canvasTransform;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\tmodifyMethod(canvas.Shape, \"setFill\",\r\n\t\tfunction(){\r\n\t\t\t// prepare Canvas-specific structures\r\n\t\t\tvar fs = this.fillStyle, f;\r\n\t\t\tif(fs){\r\n\t\t\t\tif(typeof(fs) == \"object\" && \"type\" in fs){\r\n\t\t\t\t\tvar ctx = this.surface.rawNode.getContext(\"2d\");\r\n\t\t\t\t\tswitch(fs.type){\r\n\t\t\t\t\t\tcase \"linear\":\r\n\t\t\t\t\t\tcase \"radial\":\r\n\t\t\t\t\t\t\tf = fs.type == \"linear\" ?\r\n\t\t\t\t\t\t\t\tctx.createLinearGradient(fs.x1, fs.y1, fs.x2, fs.y2) :\r\n\t\t\t\t\t\t\t\tctx.createRadialGradient(fs.cx, fs.cy, 0, fs.cx, fs.cy, fs.r);\r\n\t\t\t\t\t\t\tarr.forEach(fs.colors, function(step){\r\n\t\t\t\t\t\t\t\tf.addColorStop(step.offset, g.normalizeColor(step.color).toString());\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase \"pattern\":\r\n\t\t\t\t\t\t\tif (!pattrnbuffer) {\r\n\t\t\t\t\t\t\t\tpattrnbuffer = document.createElement(\"canvas\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t// no need to scale the image since the canvas.createPattern uses\r\n\t\t\t\t\t\t\t// the original image data and not the scaled ones (see spec.)\r\n\t\t\t\t\t\t\t// the scaling needs to be done at rendering time in a context buffer\r\n\t\t\t\t\t\t\tvar img =new Image();\r\n\t\t\t\t\t\t\tthis.surface.downloadImage(img, fs.src);\r\n\t\t\t\t\t\t\tthis.canvasFillImage = img;\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\t// Set fill color using CSS RGBA func style\r\n\t\t\t\t\tf = fs.toString();\r\n\t\t\t\t}\r\n\t\t\t\tthis.canvasFill = f;\r\n\t\t\t}else{\r\n\t\t\t\tdelete this.canvasFill;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\tmodifyMethod(canvas.Shape, \"setStroke\",\r\n\t\tfunction(){\r\n\t\t\tvar st = this.strokeStyle;\r\n\t\t\tif(st){\r\n\t\t\t\tvar da = this.strokeStyle.style.toLowerCase();\r\n\t\t\t\tif(da in dasharray){\r\n\t\t\t\t\tda = dasharray[da];\r\n\t\t\t\t}\r\n\t\t\t\tif(da instanceof Array){\r\n\t\t\t\t\tda = da.slice();\r\n\t\t\t\t\tthis.canvasDash = da;\r\n\t\t\t\t\tvar i;\r\n\t\t\t\t\tfor(i = 0; i < da.length; ++i){\r\n\t\t\t\t\t\tda[i] *= st.width;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(st.cap != \"butt\"){\r\n\t\t\t\t\t\tfor(i = 0; i < da.length; i += 2){\r\n\t\t\t\t\t\t\tda[i] -= st.width;\r\n\t\t\t\t\t\t\tif(da[i] < 1){ da[i] = 1; }\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tfor(i = 1; i < da.length; i += 2){\r\n\t\t\t\t\t\t\tda[i] += st.width;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tdelete this.canvasDash;\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\tdelete this.canvasDash;\r\n\t\t\t}\r\n\t\t\tthis._needsDash = !hasNativeDash && !!this.canvasDash;\r\n\t\t});\r\n\r\n\tmodifyMethod(canvas.Shape, \"setShape\");\r\n\r\n\tcanvas.Group = declare(\"dojox.gfx.canvas.Group\", canvas.Shape, {\r\n\t\t// summary:\r\n\t\t//\t\ta group shape (Canvas), which can be used\r\n\t\t//\t\tto logically group shapes (e.g, to propagate matricies)\r\n\t\tconstructor: function(){\r\n\t\t\tgs.Container._init.call(this);\r\n\t\t},\r\n\t\t_render: function(/* Object */ ctx){\r\n\t\t\t// summary:\r\n\t\t\t//\t\trender the group\r\n\t\t\tctx.save();\r\n\t\t\tthis._renderTransform(ctx);\r\n\t\t\tthis._renderClip(ctx);\r\n\t\t\tfor(var i = 0; i < this.children.length; ++i){\r\n\t\t\t\tthis.children[i]._render(ctx);\r\n\t\t\t}\r\n\t\t\tctx.restore();\r\n\t\t},\r\n\t\tdestroy: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tReleases all internal resources owned by this shape. Once this method has been called,\r\n\t\t\t//\t\tthe instance is considered disposed and should not be used anymore.\r\n\r\n\t\t\t// don't call canvas impl to avoid makeDirty'\r\n\t\t\tgs.Container.clear.call(this, true);\r\n\t\t\t// avoid this.inherited\r\n\t\t\tcanvas.Shape.prototype.destroy.apply(this, arguments);\r\n\t\t}\r\n\t});\r\n\r\n\r\n\r\n\tcanvas.Rect = declare(\"dojox.gfx.canvas.Rect\", [canvas.Shape, gs.Rect], {\r\n\t\t// summary:\r\n\t\t//\t\ta rectangle shape (Canvas)\r\n\t\t_renderShape: function(/* Object */ ctx){\r\n\t\t\tvar s = this.shape, r = Math.min(s.r, s.height / 2, s.width / 2),\r\n\t\t\t\txl = s.x, xr = xl + s.width, yt = s.y, yb = yt + s.height,\r\n\t\t\t\txl2 = xl + r, xr2 = xr - r, yt2 = yt + r, yb2 = yb - r;\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.moveTo(xl2, yt);\r\n\t\t\tif(r){\r\n\t\t\t\tctx.arc(xr2, yt2, r, -halfPI, 0, false);\r\n\t\t\t\tctx.arc(xr2, yb2, r, 0, halfPI, false);\r\n\t\t\t\tctx.arc(xl2, yb2, r, halfPI, pi, false);\r\n\t\t\t\tctx.arc(xl2, yt2, r, pi, pi + halfPI, false);\r\n\t\t\t}else{\r\n\t\t\t\tctx.lineTo(xr2, yt);\r\n\t\t\t\tctx.lineTo(xr, yb2);\r\n\t\t\t\tctx.lineTo(xl2, yb);\r\n\t\t\t\tctx.lineTo(xl, yt2);\r\n\t\t\t}\r\n\t\t\tctx.closePath();\r\n\t\t},\r\n\t\t_renderDashedStroke: function(ctx, apply){\r\n\t\t\tvar s = this.shape, residue, r = Math.min(s.r, s.height / 2, s.width / 2),\r\n\t\t\t\txl = s.x, xr = xl + s.width, yt = s.y, yb = yt + s.height,\r\n\t\t\t\txl2 = xl + r, xr2 = xr - r, yt2 = yt + r, yb2 = yb - r;\r\n\t\t\tif(r){\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tresidue = toDashedLineTo(ctx, this, xl2, yt, xr2, yt);\r\n\t\t\t\tif(apply) ctx.stroke();\r\n\t\t\t\tresidue = drawDashedArc(ctx, this.canvasDash, xr2, yt2, r, -halfPI, 0, false, apply, residue);\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tresidue = toDashedLineTo(ctx, this, xr, yt2, xr, yb2, residue);\r\n\t\t\t\tif(apply) ctx.stroke();\r\n\t\t\t\tresidue = drawDashedArc(ctx, this.canvasDash, xr2, yb2, r, 0, halfPI, false, apply, residue);\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tresidue = toDashedLineTo(ctx, this, xr2, yb, xl2, yb, residue);\r\n\t\t\t\tif(apply) ctx.stroke();\r\n\t\t\t\tresidue = drawDashedArc(ctx, this.canvasDash, xl2, yb2, r, halfPI, pi, false, apply, residue);\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tresidue = toDashedLineTo(ctx, this, xl, yb2, xl, yt2,residue);\r\n\t\t\t\tif(apply) ctx.stroke();\r\n\t\t\t\tdrawDashedArc(ctx, this.canvasDash, xl2, yt2, r, pi, pi + halfPI, false, apply, residue);\r\n\t\t\t}else{\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tresidue = toDashedLineTo(ctx, this, xl2, yt, xr2, yt);\r\n\t\t\t\tresidue = toDashedLineTo(ctx, this, xr2, yt, xr, yb2, residue);\r\n\t\t\t\tresidue = toDashedLineTo(ctx, this, xr, yb2, xl2, yb, residue);\r\n\t\t\t\ttoDashedLineTo(ctx, this, xl2, yb, xl, yt2, residue);\r\n\t\t\t\tif(apply) ctx.stroke();\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tvar bezierCircle = [];\r\n\t(function(){\r\n\t\tvar u = ga.curvePI4;\r\n\t\tbezierCircle.push(u.s, u.c1, u.c2, u.e);\r\n\t\tfor(var a = 45; a < 360; a += 45){\r\n\t\t\tvar r = m.rotateg(a);\r\n\t\t\tbezierCircle.push(mp(r, u.c1), mp(r, u.c2), mp(r, u.e));\r\n\t\t}\r\n\t})();\r\n\r\n\tvar makeEllipse = function(shape){\r\n\t\t// prepare Canvas-specific structures\r\n\t\tvar t, c1, c2, r = [], s = shape.shape,\r\n\t\t\tM = m.normalize([m.translate(s.cx, s.cy), m.scale(s.rx, s.ry)]);\r\n\t\tt = mp(M, bezierCircle[0]);\r\n\t\tr.push([t.x, t.y]);\r\n\t\tfor(var i = 1; i < bezierCircle.length; i += 3){\r\n\t\t\tc1 = mp(M, bezierCircle[i]);\r\n\t\t\tc2 = mp(M, bezierCircle[i + 1]);\r\n\t\t\tt  = mp(M, bezierCircle[i + 2]);\r\n\t\t\tr.push([c1.x, c1.y, c2.x, c2.y, t.x, t.y]);\r\n\t\t}\r\n\t\tif(shape._needsDash){\r\n\t\t\tvar points = [], p1 = r[0];\r\n\t\t\tfor(i = 1; i < r.length; ++i){\r\n\t\t\t\tvar curves = [];\r\n\t\t\t\tsplitToDashedBezier(p1.concat(r[i]), shape.canvasDash, curves);\r\n\t\t\t\tp1 = [r[i][4],r[i][5]];\r\n\t\t\t\tpoints.push(curves);\r\n\t\t\t}\r\n\t\t\tshape._dashedPoints = points;\r\n\t\t}\r\n\t\treturn r;\r\n\t};\r\n\r\n\tcanvas.Ellipse = declare(\"dojox.gfx.canvas.Ellipse\", [canvas.Shape, gs.Ellipse], {\r\n\t\t// summary:\r\n\t\t//\t\tan ellipse shape (Canvas)\r\n\t\tsetShape: function(){\r\n\t\t\tthis.inherited(arguments);\r\n\t\t\tthis.canvasEllipse = makeEllipse(this);\r\n\t\t\treturn this;\r\n\t\t},\r\n\t\tsetStroke: function(){\r\n\t\t\tthis.inherited(arguments);\r\n\t\t\tif(!hasNativeDash){\r\n\t\t\t\tthis.canvasEllipse = makeEllipse(this);\r\n\t\t\t}\r\n\t\t\treturn this;\r\n\t\t},\r\n\t\t_renderShape: function(/* Object */ ctx){\r\n\t\t\tvar r = this.canvasEllipse, i;\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.moveTo.apply(ctx, r[0]);\r\n\t\t\tfor(i = 1; i < r.length; ++i){\r\n\t\t\t\tctx.bezierCurveTo.apply(ctx, r[i]);\r\n\t\t\t}\r\n\t\t\tctx.closePath();\r\n\t\t},\r\n\t\t_renderDashedStroke: function(ctx, apply){\r\n\t\t\tvar r = this._dashedPoints;\r\n\t\t\tctx.beginPath();\r\n\t\t\tfor(var i = 0; i < r.length; ++i){\r\n\t\t\t\tvar curves = r[i];\r\n\t\t\t\tfor(var j=0;j<curves.length;++j){\r\n\t\t\t\t\tvar curve = curves[j];\r\n\t\t\t\t\tctx.moveTo(curve[0], curve[1]);\r\n\t\t\t\t\tctx.bezierCurveTo(curve[2],curve[3],curve[4],curve[5],curve[6],curve[7]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(apply) ctx.stroke();\r\n\t\t}\r\n\t});\r\n\r\n\tcanvas.Circle = declare(\"dojox.gfx.canvas.Circle\", [canvas.Shape, gs.Circle], {\r\n\t\t// summary:\r\n\t\t//\t\ta circle shape (Canvas)\r\n\t\t_renderShape: function(/* Object */ ctx){\r\n\t\t\tvar s = this.shape;\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.arc(s.cx, s.cy, s.r, 0, twoPI, 1);\r\n\t\t},\r\n\t\t_renderDashedStroke: function(ctx, apply){\r\n\t\t\tvar s = this.shape;\r\n\t\t\tvar startAngle = 0, angle, l = this.canvasDash.length; i=0;\r\n\t\t\twhile(startAngle < twoPI){\r\n\t\t\t\tangle = this.canvasDash[i%l]/s.r;\r\n\t\t\t\tif(!(i%2)){\r\n\t\t\t\t\tctx.beginPath();\r\n\t\t\t\t\tctx.arc(s.cx, s.cy, s.r, startAngle, startAngle+angle, 0);\r\n\t\t\t\t\tif(apply) ctx.stroke();\r\n\t\t\t\t}\r\n\t\t\t\tstartAngle+=angle;\r\n\t\t\t\t++i;\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tcanvas.Line = declare(\"dojox.gfx.canvas.Line\", [canvas.Shape, gs.Line], {\r\n\t\t// summary:\r\n\t\t//\t\ta line shape (Canvas)\r\n\t\t_renderShape: function(/* Object */ ctx){\r\n\t\t\tvar s = this.shape;\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.moveTo(s.x1, s.y1);\r\n\t\t\tctx.lineTo(s.x2, s.y2);\r\n\t\t},\r\n\t\t_renderDashedStroke: function(ctx, apply){\r\n\t\t\tvar s = this.shape;\r\n\t\t\tctx.beginPath();\r\n\t\t\ttoDashedLineTo(ctx, this, s.x1, s.y1, s.x2, s.y2);\r\n\t\t\tif(apply) ctx.stroke();\r\n\t\t}\r\n\t});\r\n\r\n\tcanvas.Polyline = declare(\"dojox.gfx.canvas.Polyline\", [canvas.Shape, gs.Polyline], {\r\n\t\t// summary:\r\n\t\t//\t\ta polyline/polygon shape (Canvas)\r\n\t\tsetShape: function(){\r\n\t\t\tthis.inherited(arguments);\r\n\t\t\tvar p = this.shape.points, f = p[0], r, c, i;\r\n\t\t\tthis.bbox = null;\r\n\t\t\t// normalize this.shape.points as array of points: [{x,y}, {x,y}, ...]\r\n\t\t\tthis._normalizePoints();\r\n\t\t\t// after _normalizePoints, if shape.points was [x1,y1,x2,y2,..], shape.points references a new array\r\n\t\t\t// and p references the original points array\r\n\t\t\t// prepare Canvas-specific structures, if needed\r\n\t\t\tif(p.length){\r\n\t\t\t\tif(typeof f == \"number\"){ // already in the canvas format [x1,y1,x2,y2,...]\r\n\t\t\t\t\tr = p;\r\n\t\t\t\t}else{ // convert into canvas-specific format\r\n\t\t\t\t\tr = [];\r\n\t\t\t\t\tfor(i=0; i < p.length; ++i){\r\n\t\t\t\t\t\tc = p[i];\r\n\t\t\t\t\t\tr.push(c.x, c.y);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\tr = [];\r\n\t\t\t}\r\n\t\t\tthis.canvasPolyline = r;\r\n\t\t\treturn this;\r\n\t\t},\r\n\t\t_renderShape: function(/* Object */ ctx){\r\n\t\t\tvar p = this.canvasPolyline;\r\n\t\t\tif(p.length){\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tctx.moveTo(p[0], p[1]);\r\n\t\t\t\tfor(var i = 2; i < p.length; i += 2){\r\n\t\t\t\t\tctx.lineTo(p[i], p[i + 1]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\t_renderDashedStroke: function(ctx, apply){\r\n\t\t\tvar p = this.canvasPolyline, residue = 0;\r\n\t\t\tctx.beginPath();\r\n\t\t\tfor(var i = 0; i < p.length; i += 2){\r\n\t\t\t\tresidue = toDashedLineTo(ctx, this, p[i], p[i + 1], p[i + 2], p[i + 3], residue);\r\n\t\t\t}\r\n\t\t\tif(apply) ctx.stroke();\r\n\t\t}\r\n\t});\r\n\r\n\tcanvas.Image = declare(\"dojox.gfx.canvas.Image\", [canvas.Shape, gs.Image], {\r\n\t\t// summary:\r\n\t\t//\t\tan image shape (Canvas)\r\n\t\tsetShape: function(){\r\n\t\t\tthis.inherited(arguments);\r\n\t\t\t// prepare Canvas-specific structures\r\n\t\t\tvar img = new Image();\r\n\t\t\tthis.surface.downloadImage(img, this.shape.src);\r\n\t\t\tthis.canvasImage = img;\r\n\t\t\treturn this;\r\n\t\t},\r\n\t\t_renderShape: function(/* Object */ ctx){\r\n\t\t\tvar s = this.shape;\r\n\t\t\tctx.drawImage(this.canvasImage, s.x, s.y, s.width, s.height);\r\n\t\t}\r\n\t});\r\n\r\n\tcanvas.Text = declare(\"dojox.gfx.canvas.Text\", [canvas.Shape, gs.Text], {\r\n\t\t_setFont:function(){\r\n\t\t\tif(this.fontStyle){\r\n\t\t\t\tthis.canvasFont = g.makeFontString(this.fontStyle);\r\n\t\t\t}else{\r\n\t\t\t\tdelete this.canvasFont;\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\tgetTextWidth: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tget the text width in pixels\r\n\t\t\tvar s = this.shape, w = 0, ctx;\r\n\t\t\tif(s.text){\r\n\t\t\t\tctx = this.surface.rawNode.getContext(\"2d\");\r\n\t\t\t\tctx.save();\r\n\t\t\t\tthis._renderTransform(ctx);\r\n\t\t\t\tthis._renderFill(ctx, false);\r\n\t\t\t\tthis._renderStroke(ctx, false);\r\n\t\t\t\tif (this.canvasFont)\r\n\t\t\t\t\tctx.font = this.canvasFont;\r\n\t\t\t\tw = ctx.measureText(s.text).width;\r\n\t\t\t\tctx.restore();\r\n\t\t\t}\r\n\t\t\treturn w;\r\n\t\t},\r\n\r\n\t\t// override to apply first fill and stroke (\r\n\t\t// the base implementation is for path-based shape that needs to first define the path then to fill/stroke it.\r\n\t\t// Here, we need the fillstyle or strokestyle to be set before calling fillText/strokeText.\r\n\t\t_render: function(/* Object */ctx){\r\n\t\t\t// summary:\r\n\t\t\t//\t\trender the shape\r\n\t\t\t// ctx: Object\r\n\t\t\t//\t\tthe drawing context.\r\n\t\t\tctx.save();\r\n\t\t\tthis._renderTransform(ctx);\r\n\t\t\tthis._renderFill(ctx, false);\r\n\t\t\tthis._renderStroke(ctx, false);\r\n\t\t\tthis._renderShape(ctx);\r\n\t\t\tctx.restore();\r\n\t\t},\r\n\r\n\t\t_renderShape: function(ctx){\r\n\t\t\t// summary:\r\n\t\t\t//\t\ta text shape (Canvas)\r\n\t\t\t// ctx: Object\r\n\t\t\t//\t\tthe drawing context.\r\n\t\t\tvar ta, s = this.shape;\r\n\t\t\tif(!s.text){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t// text align\r\n\t\t\tta = s.align === 'middle' ? 'center' : s.align;\r\n\t\t\tctx.textAlign = ta;\r\n\t\t\tif(this.canvasFont){\r\n\t\t\t\tctx.font = this.canvasFont;\r\n\t\t\t}\r\n\t\t\tif(this.canvasFill){\r\n\t\t\t\tctx.fillText(s.text, s.x, s.y);\r\n\t\t\t}\r\n\t\t\tif(this.strokeStyle){\r\n\t\t\t\tctx.beginPath(); // fix bug in FF3.6. Fixed in FF4b8\r\n\t\t\t\tctx.strokeText(s.text, s.x, s.y);\r\n\t\t\t\tctx.closePath();\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\tmodifyMethod(canvas.Text, \"setFont\");\r\n\r\n\tif(!hasFillText){\r\n\t\tcanvas.Text.extend({\r\n\t\t\tgetTextWidth: function(){\r\n\t\t\t\treturn 0;\r\n\t\t\t},\r\n\t\t\tgetBoundingBox: function(){\r\n\t\t\t\treturn null;\r\n\t\t\t},\r\n\t\t\t_renderShape: function(){\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tvar pathRenderers = {\r\n\t\t\tM: \"_moveToA\", m: \"_moveToR\",\r\n\t\t\tL: \"_lineToA\", l: \"_lineToR\",\r\n\t\t\tH: \"_hLineToA\", h: \"_hLineToR\",\r\n\t\t\tV: \"_vLineToA\", v: \"_vLineToR\",\r\n\t\t\tC: \"_curveToA\", c: \"_curveToR\",\r\n\t\t\tS: \"_smoothCurveToA\", s: \"_smoothCurveToR\",\r\n\t\t\tQ: \"_qCurveToA\", q: \"_qCurveToR\",\r\n\t\t\tT: \"_qSmoothCurveToA\", t: \"_qSmoothCurveToR\",\r\n\t\t\tA: \"_arcTo\", a: \"_arcTo\",\r\n\t\t\tZ: \"_closePath\", z: \"_closePath\"\r\n\t\t};\r\n\r\n\r\n\tcanvas.Path = declare(\"dojox.gfx.canvas.Path\", [canvas.Shape, pathLib.Path], {\r\n\t\t// summary:\r\n\t\t//\t\ta path shape (Canvas)\r\n\t\tconstructor: function(){\r\n\t\t\tthis.lastControl = {};\r\n\t\t},\r\n\t\tsetShape: function(){\r\n\t\t\tthis.canvasPath = [];\r\n\t\t\tthis._dashedPath= [];\r\n\t\t\treturn this.inherited(arguments);\r\n\t\t},\r\n\t\tsetStroke:function(){\r\n\t\t\tthis.inherited(arguments);\r\n\t\t\tif(!hasNativeDash){\r\n\t\t\t\tthis.segmented = false;\r\n\t\t\t\tthis._confirmSegmented();\r\n\t\t\t}\r\n\t\t\treturn this;\r\n\t\t},\r\n\t\t_setPath: function(){\r\n\t\t\tthis._dashResidue = null;\r\n\t\t\tthis.inherited(arguments);\r\n\t\t},\r\n\t\t_updateWithSegment: function(segment){\r\n\t\t\tvar last = lang.clone(this.last);\r\n\t\t\tthis[pathRenderers[segment.action]](this.canvasPath, segment.action, segment.args, this._needsDash ? this._dashedPath : null);\r\n\t\t\tthis.last = last;\r\n\t\t\tthis.inherited(arguments);\r\n\t\t},\r\n\t\t_renderShape: function(/* Object */ ctx){\r\n\t\t\tvar r = this.canvasPath;\r\n\t\t\tctx.beginPath();\r\n\t\t\tfor(var i = 0; i < r.length; i += 2){\r\n\t\t\t\tctx[r[i]].apply(ctx, r[i + 1]);\r\n\t\t\t}\r\n\t\t},\r\n\t\t_renderDashedStroke: hasNativeDash ? function(){} : function(ctx, apply){\r\n\t\t\tvar r = this._dashedPath;\r\n\t\t\tctx.beginPath();\r\n\t\t\tfor(var i = 0; i < r.length; i += 2){\r\n\t\t\t\tctx[r[i]].apply(ctx, r[i + 1]);\r\n\t\t\t}\r\n\t\t\tif(apply) ctx.stroke();\r\n\t\t},\r\n\t\t_moveToA: function(result, action, args, doDash){\r\n\t\t\tresult.push(\"moveTo\", [args[0], args[1]]);\r\n\t\t\tif(doDash) doDash.push(\"moveTo\", [args[0], args[1]]);\r\n\t\t\tfor(var i = 2; i < args.length; i += 2){\r\n\t\t\t\tresult.push(\"lineTo\", [args[i], args[i + 1]]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedLineTo(doDash, this, args[i - 2], args[i - 1], args[i], args[i + 1], this._dashResidue);\r\n\t\t\t}\r\n\t\t\tthis.last.x = args[args.length - 2];\r\n\t\t\tthis.last.y = args[args.length - 1];\r\n\t\t\tthis.lastControl = {};\r\n\t\t},\r\n\t\t_moveToR: function(result, action, args, doDash){\r\n\t\t\tvar pts;\r\n\t\t\tif(\"x\" in this.last){\r\n\t\t\t\tpts = [this.last.x += args[0], this.last.y += args[1]];\r\n\t\t\t\tresult.push(\"moveTo\", pts);\r\n\t\t\t\tif(doDash) doDash.push(\"moveTo\", pts);\r\n\t\t\t}else{\r\n\t\t\t\tpts = [this.last.x = args[0], this.last.y = args[1]];\r\n\t\t\t\tresult.push(\"moveTo\", pts);\r\n\t\t\t\tif(doDash) doDash.push(\"moveTo\", pts);\r\n\t\t\t}\r\n\t\t\tfor(var i = 2; i < args.length; i += 2){\r\n\t\t\t\tresult.push(\"lineTo\", [this.last.x += args[i], this.last.y += args[i + 1]]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedLineTo(doDash, this, doDash[doDash.length - 1][0], doDash[doDash.length - 1][1], this.last.x, this.last.y, this._dashResidue);\r\n\t\t\t}\r\n\t\t\tthis.lastControl = {};\r\n\t\t},\r\n\t\t_lineToA: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; i += 2){\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedLineTo(doDash, this, this.last.x, this.last.y, args[i], args[i + 1], this._dashResidue);\r\n\t\t\t\tresult.push(\"lineTo\", [args[i], args[i + 1]]);\r\n\t\t\t}\r\n\t\t\tthis.last.x = args[args.length - 2];\r\n\t\t\tthis.last.y = args[args.length - 1];\r\n\t\t\tthis.lastControl = {};\r\n\t\t},\r\n\t\t_lineToR: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; i += 2){\r\n\t\t\t\tresult.push(\"lineTo\", [this.last.x += args[i], this.last.y += args[i + 1]]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedLineTo(doDash, this, doDash[doDash.length - 1][0], doDash[doDash.length - 1][1], this.last.x, this.last.y, this._dashResidue);\r\n\t\t\t}\r\n\t\t\tthis.lastControl = {};\r\n\t\t},\r\n\t\t_hLineToA: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; ++i){\r\n\t\t\t\tresult.push(\"lineTo\", [args[i], this.last.y]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedLineTo(doDash, this, doDash[doDash.length - 1][0], doDash[doDash.length - 1][1], args[i], this.last.y, this._dashResidue);\r\n\t\t\t}\r\n\t\t\tthis.last.x = args[args.length - 1];\r\n\t\t\tthis.lastControl = {};\r\n\t\t},\r\n\t\t_hLineToR: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; ++i){\r\n\t\t\t\tresult.push(\"lineTo\", [this.last.x += args[i], this.last.y]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedLineTo(doDash, this, doDash[doDash.length - 1][0], doDash[doDash.length - 1][1], this.last.x, this.last.y, this._dashResidue);\r\n\t\t\t}\r\n\t\t\tthis.lastControl = {};\r\n\t\t},\r\n\t\t_vLineToA: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; ++i){\r\n\t\t\t\tresult.push(\"lineTo\", [this.last.x, args[i]]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedLineTo(doDash, this, doDash[doDash.length - 1][0], doDash[doDash.length - 1][1], this.last.x, args[i], this._dashResidue);\r\n\t\t\t}\r\n\t\t\tthis.last.y = args[args.length - 1];\r\n\t\t\tthis.lastControl = {};\r\n\t\t},\r\n\t\t_vLineToR: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; ++i){\r\n\t\t\t\tresult.push(\"lineTo\", [this.last.x, this.last.y += args[i]]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedLineTo(doDash, this, doDash[doDash.length - 1][0], doDash[doDash.length - 1][1], this.last.x, this.last.y, this._dashResidue);\r\n\t\t\t}\r\n\t\t\tthis.lastControl = {};\r\n\t\t},\r\n\t\t_curveToA: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; i += 6){\r\n\t\t\t\tresult.push(\"bezierCurveTo\", args.slice(i, i + 6));\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedCurveTo(doDash, this, result[result.length-1], this._dashResidue);\r\n\t\t\t}\r\n\t\t\tthis.last.x = args[args.length - 2];\r\n\t\t\tthis.last.y = args[args.length - 1];\r\n\t\t\tthis.lastControl.x = args[args.length - 4];\r\n\t\t\tthis.lastControl.y = args[args.length - 3];\r\n\t\t\tthis.lastControl.type = \"C\";\r\n\t\t},\r\n\t\t_curveToR: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; i += 6){\r\n\t\t\t\tresult.push(\"bezierCurveTo\", [\r\n\t\t\t\t\tthis.last.x + args[i],\r\n\t\t\t\t\tthis.last.y + args[i + 1],\r\n\t\t\t\t\tthis.lastControl.x = this.last.x + args[i + 2],\r\n\t\t\t\t\tthis.lastControl.y = this.last.y + args[i + 3],\r\n\t\t\t\t\tthis.last.x + args[i + 4],\r\n\t\t\t\t\tthis.last.y + args[i + 5]\r\n\t\t\t\t]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedCurveTo(doDash, this, result[result.length-1], this._dashResidue);\r\n\t\t\t\tthis.last.x += args[i + 4];\r\n\t\t\t\tthis.last.y += args[i + 5];\r\n\t\t\t}\r\n\t\t\tthis.lastControl.type = \"C\";\r\n\t\t},\r\n\t\t_smoothCurveToA: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; i += 4){\r\n\t\t\t\tvar valid = this.lastControl.type == \"C\";\r\n\t\t\t\tresult.push(\"bezierCurveTo\", [\r\n\t\t\t\t\tvalid ? 2 * this.last.x - this.lastControl.x : this.last.x,\r\n\t\t\t\t\tvalid ? 2 * this.last.y - this.lastControl.y : this.last.y,\r\n\t\t\t\t\targs[i],\r\n\t\t\t\t\targs[i + 1],\r\n\t\t\t\t\targs[i + 2],\r\n\t\t\t\t\targs[i + 3]\r\n\t\t\t\t]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedCurveTo(doDash, this, result[result.length-1], this._dashResidue);\r\n\t\t\t\tthis.lastControl.x = args[i];\r\n\t\t\t\tthis.lastControl.y = args[i + 1];\r\n\t\t\t\tthis.lastControl.type = \"C\";\r\n\t\t\t}\r\n\t\t\tthis.last.x = args[args.length - 2];\r\n\t\t\tthis.last.y = args[args.length - 1];\r\n\t\t},\r\n\t\t_smoothCurveToR: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; i += 4){\r\n\t\t\t\tvar valid = this.lastControl.type == \"C\";\r\n\t\t\t\tresult.push(\"bezierCurveTo\", [\r\n\t\t\t\t\tvalid ? 2 * this.last.x - this.lastControl.x : this.last.x,\r\n\t\t\t\t\tvalid ? 2 * this.last.y - this.lastControl.y : this.last.y,\r\n\t\t\t\t\tthis.last.x + args[i],\r\n\t\t\t\t\tthis.last.y + args[i + 1],\r\n\t\t\t\t\tthis.last.x + args[i + 2],\r\n\t\t\t\t\tthis.last.y + args[i + 3]\r\n\t\t\t\t]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedCurveTo(doDash, this, result[result.length-1], this._dashResidue);\r\n\t\t\t\tthis.lastControl.x = this.last.x + args[i];\r\n\t\t\t\tthis.lastControl.y = this.last.y + args[i + 1];\r\n\t\t\t\tthis.lastControl.type = \"C\";\r\n\t\t\t\tthis.last.x += args[i + 2];\r\n\t\t\t\tthis.last.y += args[i + 3];\r\n\t\t\t}\r\n\t\t},\r\n\t\t_qCurveToA: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; i += 4){\r\n\t\t\t\tresult.push(\"quadraticCurveTo\", args.slice(i, i + 4));\r\n\t\t\t}\r\n\t\t\tif(doDash)\r\n\t\t\t\tthis._dashResidue = toDashedCurveTo(doDash, this, result[result.length - 1], this._dashResidue);\r\n\t\t\tthis.last.x = args[args.length - 2];\r\n\t\t\tthis.last.y = args[args.length - 1];\r\n\t\t\tthis.lastControl.x = args[args.length - 4];\r\n\t\t\tthis.lastControl.y = args[args.length - 3];\r\n\t\t\tthis.lastControl.type = \"Q\";\r\n\t\t},\r\n\t\t_qCurveToR: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; i += 4){\r\n\t\t\t\tresult.push(\"quadraticCurveTo\", [\r\n\t\t\t\t\tthis.lastControl.x = this.last.x + args[i],\r\n\t\t\t\t\tthis.lastControl.y = this.last.y + args[i + 1],\r\n\t\t\t\t\tthis.last.x + args[i + 2],\r\n\t\t\t\t\tthis.last.y + args[i + 3]\r\n\t\t\t\t]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedCurveTo(doDash, this, result[result.length - 1], this._dashResidue);\r\n\t\t\t\tthis.last.x += args[i + 2];\r\n\t\t\t\tthis.last.y += args[i + 3];\r\n\t\t\t}\r\n\t\t\tthis.lastControl.type = \"Q\";\r\n\t\t},\r\n\t\t_qSmoothCurveToA: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; i += 2){\r\n\t\t\t\tvar valid = this.lastControl.type == \"Q\";\r\n\t\t\t\tresult.push(\"quadraticCurveTo\", [\r\n\t\t\t\t\tthis.lastControl.x = valid ? 2 * this.last.x - this.lastControl.x : this.last.x,\r\n\t\t\t\t\tthis.lastControl.y = valid ? 2 * this.last.y - this.lastControl.y : this.last.y,\r\n\t\t\t\t\targs[i],\r\n\t\t\t\t\targs[i + 1]\r\n\t\t\t\t]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedCurveTo(doDash, this, result[result.length - 1], this._dashResidue);\r\n\t\t\t\tthis.lastControl.type = \"Q\";\r\n\t\t\t}\r\n\t\t\tthis.last.x = args[args.length - 2];\r\n\t\t\tthis.last.y = args[args.length - 1];\r\n\t\t},\r\n\t\t_qSmoothCurveToR: function(result, action, args, doDash){\r\n\t\t\tfor(var i = 0; i < args.length; i += 2){\r\n\t\t\t\tvar valid = this.lastControl.type == \"Q\";\r\n\t\t\t\tresult.push(\"quadraticCurveTo\", [\r\n\t\t\t\t\tthis.lastControl.x = valid ? 2 * this.last.x - this.lastControl.x : this.last.x,\r\n\t\t\t\t\tthis.lastControl.y = valid ? 2 * this.last.y - this.lastControl.y : this.last.y,\r\n\t\t\t\t\tthis.last.x + args[i],\r\n\t\t\t\t\tthis.last.y + args[i + 1]\r\n\t\t\t\t]);\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedCurveTo(doDash, this, result[result.length - 1], this._dashResidue);\r\n\t\t\t\tthis.lastControl.type = \"Q\";\r\n\t\t\t\tthis.last.x += args[i];\r\n\t\t\t\tthis.last.y += args[i + 1];\r\n\t\t\t}\r\n\t\t},\r\n\t\t_arcTo: function(result, action, args, doDash){\r\n\t\t\tvar relative = action == \"a\";\r\n\t\t\tfor(var i = 0; i < args.length; i += 7){\r\n\t\t\t\tvar x1 = args[i + 5], y1 = args[i + 6];\r\n\t\t\t\tif(relative){\r\n\t\t\t\t\tx1 += this.last.x;\r\n\t\t\t\t\ty1 += this.last.y;\r\n\t\t\t\t}\r\n\t\t\t\tvar arcs = ga.arcAsBezier(\r\n\t\t\t\t\tthis.last, args[i], args[i + 1], args[i + 2],\r\n\t\t\t\t\targs[i + 3] ? 1 : 0, args[i + 4] ? 1 : 0,\r\n\t\t\t\t\tx1, y1\r\n\t\t\t\t);\r\n\t\t\t\tarr.forEach(arcs, function(p){\r\n\t\t\t\t\tresult.push(\"bezierCurveTo\", p);\r\n\t\t\t\t});\r\n\t\t\t\tif(doDash)\r\n\t\t\t\t\tthis._dashResidue = toDashedCurveTo(doDash, this, p, this._dashResidue);\r\n\t\t\t\tthis.last.x = x1;\r\n\t\t\t\tthis.last.y = y1;\r\n\t\t\t}\r\n\t\t\tthis.lastControl = {};\r\n\t\t},\r\n\t\t_closePath: function(result, action, args, doDash){\r\n\t\t\tresult.push(\"closePath\", []);\r\n\t\t\tif(doDash)\r\n\t\t\t\tthis._dashResidue = toDashedLineTo(doDash, this, this.last.x, this.last.y, doDash[1][0], doDash[1][1], this._dashResidue);\r\n\t\t\tthis.lastControl = {};\r\n\t\t}\r\n\t});\r\n\tarr.forEach([\"moveTo\", \"lineTo\", \"hLineTo\", \"vLineTo\", \"curveTo\",\r\n\t\t\"smoothCurveTo\", \"qCurveTo\", \"qSmoothCurveTo\", \"arcTo\", \"closePath\"],\r\n\t\tfunction(method){ modifyMethod(canvas.Path, method); }\r\n\t);\r\n\r\n\tcanvas.TextPath = declare(\"dojox.gfx.canvas.TextPath\", [canvas.Shape, pathLib.TextPath], {\r\n\t\t// summary:\r\n\t\t//\t\ta text shape (Canvas)\r\n\t\t_renderShape: function(/* Object */ ctx){\r\n\t\t\tvar s = this.shape;\r\n\t\t\t// nothing for the moment\r\n\t\t},\r\n\t\t_setText: function(){\r\n\t\t\t// not implemented\r\n\t\t},\r\n\t\t_setFont: function(){\r\n\t\t\t// not implemented\r\n\t\t}\r\n\t});\r\n\r\n\tcanvas.Surface = declare(\"dojox.gfx.canvas.Surface\", gs.Surface, {\r\n\t\t// summary:\r\n\t\t//\t\ta surface object to be used for drawings (Canvas)\r\n\t\tconstructor: function(){\r\n\t\t\tgs.Container._init.call(this);\r\n\t\t\tthis.pendingImageCount = 0;\r\n\t\t\tthis.makeDirty();\r\n\t\t},\r\n\t\tdestroy: function(){\r\n\t\t\tgs.Container.clear.call(this, true); // avoid makeDirty() from canvas.Container.clear impl.\r\n\t\t\tthis.inherited(arguments);\r\n\t\t},\r\n\t\tsetDimensions: function(width, height){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tsets the width and height of the rawNode\r\n\t\t\t// width: String\r\n\t\t\t//\t\twidth of surface, e.g., \"100px\"\r\n\t\t\t// height: String\r\n\t\t\t//\t\theight of surface, e.g., \"100px\"\r\n\t\t\tthis.width  = g.normalizedLength(width);\t// in pixels\r\n\t\t\tthis.height = g.normalizedLength(height);\t// in pixels\r\n\t\t\tif(!this.rawNode) return this;\r\n\t\t\tvar dirty = false;\r\n\t\t\tif (this.rawNode.width != this.width){\r\n\t\t\t\tthis.rawNode.width = this.width;\r\n\t\t\t\tdirty = true;\r\n\t\t\t}\r\n\t\t\tif (this.rawNode.height != this.height){\r\n\t\t\t\tthis.rawNode.height = this.height;\r\n\t\t\t\tdirty = true;\r\n\t\t\t}\r\n\t\t\tif (dirty)\r\n\t\t\t\tthis.makeDirty();\r\n\t\t\treturn this;\t// self\r\n\t\t},\r\n\t\tgetDimensions: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\treturns an object with properties \"width\" and \"height\"\r\n\t\t\treturn this.rawNode ? {width:  this.rawNode.width, height: this.rawNode.height} : null;\t// Object\r\n\t\t},\r\n\t\t_render: function(force){\r\n\t\t\t// summary:\r\n\t\t\t//\t\trender the all shapes\r\n\t\t\tif(!this.rawNode || (!force && this.pendingImageCount)){ return; }\r\n\t\t\tvar ctx = this.rawNode.getContext(\"2d\");\r\n\t\t\tctx.clearRect(0, 0, this.rawNode.width, this.rawNode.height);\r\n\t\t\tthis.render(ctx);\r\n\t\t\tif(\"pendingRender\" in this){\r\n\t\t\t\tclearTimeout(this.pendingRender);\r\n\t\t\t\tdelete this.pendingRender;\r\n\t\t\t}\r\n\t\t},\r\n\t\trender: function(ctx){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tRenders the gfx scene.\r\n\t\t\t// description:\r\n\t\t\t//\t\tthis method is called to render the gfx scene to the specified context.\r\n\t\t\t//\t\tThis method should not be invoked directly but should be used instead\r\n\t\t\t//\t\tas an extension point on which user can connect to with aspect.before/aspect.after\r\n\t\t\t//\t\tto implement pre- or post- image processing jobs on the drawing surface.\r\n\t\t\t// ctx: CanvasRenderingContext2D\r\n\t\t\t//\t\tThe surface Canvas rendering context.\r\n\t\t\tctx.save();\r\n\t\t\tfor(var i = 0; i < this.children.length; ++i){\r\n\t\t\t\tthis.children[i]._render(ctx);\r\n\t\t\t}\r\n\t\t\tctx.restore();\r\n\t\t},\r\n\t\tmakeDirty: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tinternal method, which is called when we may need to redraw\r\n\t\t\tif(!this.pendingImagesCount && !(\"pendingRender\" in this) && !this._batch){\r\n\t\t\t\tthis.pendingRender = setTimeout(lang.hitch(this, this._render), 0);\r\n\t\t\t}\r\n\t\t},\r\n\t\tdownloadImage: function(img, url){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tinternal method, which starts an image download and renders, when it is ready\r\n\t\t\t// img: Image\r\n\t\t\t//\t\tthe image object\r\n\t\t\t// url: String\r\n\t\t\t//\t\tthe url of the image\r\n\t\t\tvar handler = lang.hitch(this, this.onImageLoad);\r\n\t\t\tif(!this.pendingImageCount++ && \"pendingRender\" in this){\r\n\t\t\t\tclearTimeout(this.pendingRender);\r\n\t\t\t\tdelete this.pendingRender;\r\n\t\t\t}\r\n\t\t\timg.onload  = handler;\r\n\t\t\timg.onerror = handler;\r\n\t\t\timg.onabort = handler;\r\n\t\t\timg.src = url;\r\n\t\t},\r\n\t\tonImageLoad: function(){\r\n\t\t\tif(!--this.pendingImageCount){\r\n\t\t\t\tthis.onImagesLoaded();\r\n\t\t\t\tthis._render();\r\n\t\t\t}\r\n\t\t},\r\n\t\tonImagesLoaded: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tAn extension point called when all pending images downloads have been completed.\r\n\t\t\t// description:\r\n\t\t\t//\t\tThis method is invoked when all pending images downloads have been completed, just before\r\n\t\t\t//\t\tthe gfx scene is redrawn. User can connect to this method to get notified when a\r\n\t\t\t//\t\tgfx scene containing images is fully resolved.\r\n\t\t},\r\n\r\n\t\t// events are not implemented\r\n\t\tgetEventSource: function(){ return null; },\r\n\t\tconnect:\t\tfunction(){},\r\n\t\tdisconnect:\t\tfunction(){},\r\n\t\ton:\t\t\t\tfunction(){}\r\n\t});\r\n\r\n\tcanvas.createSurface = function(parentNode, width, height){\r\n\t\t// summary:\r\n\t\t//\t\tcreates a surface (Canvas)\r\n\t\t// parentNode: Node\r\n\t\t//\t\ta parent node\r\n\t\t// width: String\r\n\t\t//\t\twidth of surface, e.g., \"100px\"\r\n\t\t// height: String\r\n\t\t//\t\theight of surface, e.g., \"100px\"\r\n\r\n\t\tif(!width && !height){\r\n\t\t\tvar pos = domGeom.position(parentNode);\r\n\t\t\twidth  = width  || pos.w;\r\n\t\t\theight = height || pos.h;\r\n\t\t}\r\n\t\tif(typeof width == \"number\"){\r\n\t\t\twidth = width + \"px\";\r\n\t\t}\r\n\t\tif(typeof height == \"number\"){\r\n\t\t\theight = height + \"px\";\r\n\t\t}\r\n\r\n\t\tvar s = new canvas.Surface(),\r\n\t\t\tp = dom.byId(parentNode),\r\n\t\t\tc = p.ownerDocument.createElement(\"canvas\");\r\n\r\n\t\tc.width  = g.normalizedLength(width);\t// in pixels\r\n\t\tc.height = g.normalizedLength(height);\t// in pixels\r\n\r\n\t\tp.appendChild(c);\r\n\t\ts.rawNode = c;\r\n\t\ts._parent = p;\r\n\t\ts.surface = s;\r\n\t\treturn s;\t// dojox/gfx.Surface\r\n\t};\r\n\r\n\t// Extenders\r\n\r\n\tvar C = gs.Container, Container = {\r\n\t\topenBatch: function() {\r\n\t\t\t// summary:\r\n\t\t\t//\t\tstarts a new batch, subsequent new child shapes will be held in\r\n\t\t\t//\t\tthe batch instead of appending to the container directly.\r\n\t\t\t// description:\r\n\t\t\t//\t\tBecause the canvas renderer has no DOM hierarchy, the canvas implementation differs\r\n\t\t\t//\t\tsuch that it suspends the repaint requests for this container until the current batch is closed by a call to closeBatch().\r\n\t\t\t++this._batch;\r\n\t\t\treturn this;\r\n\t\t},\r\n\t\tcloseBatch: function() {\r\n\t\t\t// summary:\r\n\t\t\t//\t\tsubmits the current batch.\r\n\t\t\t// description:\r\n\t\t\t//\t\tOn canvas, this method flushes the pending redraws queue.\r\n\t\t\tthis._batch = this._batch > 0 ? --this._batch : 0;\r\n\t\t\tthis._makeDirty();\r\n\t\t\treturn this;\r\n\t\t},\r\n\t\t_makeDirty: function(){\r\n\t\t\tif(!this._batch){\r\n\t\t\t\tthis.surface.makeDirty();\r\n\t\t\t}\r\n\t\t},\r\n\t\tadd: function(shape){\r\n\t\t\tthis._makeDirty();\r\n\t\t\treturn C.add.apply(this, arguments);\r\n\t\t},\r\n\t\tremove: function(shape, silently){\r\n\t\t\tthis._makeDirty();\r\n\t\t\treturn C.remove.apply(this, arguments);\r\n\t\t},\r\n\t\tclear: function(){\r\n\t\t\tthis._makeDirty();\r\n\t\t\treturn C.clear.apply(this, arguments);\r\n\t\t},\r\n\t\tgetBoundingBox: C.getBoundingBox,\r\n\t\t_moveChildToFront: function(shape){\r\n\t\t\tthis._makeDirty();\r\n\t\t\treturn C._moveChildToFront.apply(this, arguments);\r\n\t\t},\r\n\t\t_moveChildToBack: function(shape){\r\n\t\t\tthis._makeDirty();\r\n\t\t\treturn C._moveChildToBack.apply(this, arguments);\r\n\t\t}\r\n\t};\r\n\r\n\tvar Creator = {\r\n\t\t// summary:\r\n\t\t//\t\tCanvas shape creators\r\n\t\tcreateObject: function(shapeType, rawShape) {\r\n\t\t\t// summary:\r\n\t\t\t//\t\tcreates an instance of the passed shapeType class\r\n\t\t\t// shapeType: Function\r\n\t\t\t//\t\ta class constructor to create an instance of\r\n\t\t\t// rawShape: Object\r\n\t\t\t//\t\tproperties to be passed in to the classes \"setShape\" method\r\n\t\t\t// overrideSize: Boolean\r\n\t\t\t//\t\tset the size explicitly, if true\r\n\t\t\tvar shape = new shapeType();\r\n\t\t\tshape.surface = this.surface;\r\n\t\t\tshape.setShape(rawShape);\r\n\t\t\tthis.add(shape);\r\n\t\t\treturn shape;\t// dojox/gfx/shape.Shape\r\n\t\t}\r\n\t};\r\n\r\n\textend(canvas.Group, Container);\r\n\textend(canvas.Group, gs.Creator);\r\n\textend(canvas.Group, Creator);\r\n\r\n\textend(canvas.Surface, Container);\r\n\textend(canvas.Surface, gs.Creator);\r\n\textend(canvas.Surface, Creator);\r\n\r\n\t// no event support -> nothing to fix.\r\n\tcanvas.fixTarget = function(event, gfxElement){\r\n\t\t// tags:\r\n\t\t//\t\tprivate\r\n\t\treturn true;\r\n\t};\r\n\r\n\treturn canvas;\r\n});\r\n"]}