{"version":3,"sources":["gfx3d/lighting.js"],"names":["define","lang","Color","declare","gfx","gfx3d","lite","lighting","black","r","g","b","a","white","toStdColor","c","normalizeColor","fromStdColor","Math","round","scaleColor","s","addColor","multiplyColor","saturateColor","mixColor","c1","c2","diff2Color","length2Color","dot","x","y","z","scale","v","add","saturate","min","max","length","sqrt","normalize","faceforward","n","i","p","reflect","diffuse","normal","lights","l","d","direction","color","specular","roughness","h","pow","phong","size","constructor","incident","ambient","this","push","intensity","npr_cool","npr_warm","npr_alpha","npr_beta","npr_scale","constant","finish","pigment","alpha","matte","Ka","shadow","Kd","metal","Ks","phong_size","plastic","npr","cool","warm","defaults","dull","shiny","glossy","phong_dull","phong_shiny","phong_glossy","luminous","metalA","metalB","metalC","metalD","metalE"],"mappings":"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","file":"../../gfx3d/lighting.js","sourcesContent":["define([\r\n\t\"dojo/_base/lang\",\r\n\t\"dojo/_base/Color\",\t// dojo.Color\r\n\t\"dojo/_base/declare\",\t// declare\r\n\t\"dojox/gfx/_base\",\r\n\t\"./_base\"\r\n],function(lang,Color,declare,gfx,gfx3d) {\r\n\r\n\tvar lite = gfx3d.lighting = {\r\n\t\t// color utilities\r\n\t\tblack: function(){\r\n\t\t\treturn {r: 0, g: 0, b: 0, a: 1};\r\n\t\t},\r\n\t\twhite: function(){\r\n\t\t\treturn {r: 1, g: 1, b: 1, a: 1};\r\n\t\t},\r\n\t\ttoStdColor: function(c){\r\n\t\t\tc = gfx.normalizeColor(c);\r\n\t\t\treturn {r: c.r / 255, g: c.g / 255, b: c.b / 255, a: c.a};\r\n\t\t},\r\n\t\tfromStdColor: function(c){\r\n\t\t\treturn new Color([Math.round(255 * c.r), Math.round(255 * c.g), Math.round(255 * c.b), c.a]);\r\n\t\t},\r\n\t\tscaleColor: function(s, c){\r\n\t\t\treturn {r: s * c.r, g: s * c.g, b: s * c.b, a: s * c.a};\r\n\t\t},\r\n\t\taddColor: function(a, b){\r\n\t\t\treturn {r: a.r + b.r, g: a.g + b.g, b: a.b + b.b, a: a.a + b.a};\r\n\t\t},\r\n\t\tmultiplyColor: function(a, b){\r\n\t\t\treturn {r: a.r * b.r, g: a.g * b.g, b: a.b * b.b, a: a.a * b.a};\r\n\t\t},\r\n\t\tsaturateColor: function(c){\r\n\t\t\treturn {\r\n\t\t\t\tr: c.r < 0 ? 0 : c.r > 1 ? 1 : c.r,\r\n\t\t\t\tg: c.g < 0 ? 0 : c.g > 1 ? 1 : c.g,\r\n\t\t\t\tb: c.b < 0 ? 0 : c.b > 1 ? 1 : c.b,\r\n\t\t\t\ta: c.a < 0 ? 0 : c.a > 1 ? 1 : c.a\r\n\t\t\t};\r\n\t\t},\r\n\t\tmixColor: function(c1, c2, s){\r\n\t\t\treturn lite.addColor(lite.scaleColor(s, c1), lite.scaleColor(1 - s, c2));\r\n\t\t},\r\n\t\tdiff2Color: function(c1, c2){\r\n\t\t\tvar r = c1.r - c2.r;\r\n\t\t\tvar g = c1.g - c2.g;\r\n\t\t\tvar b = c1.b - c2.b;\r\n\t\t\tvar a = c1.a - c2.a;\r\n\t\t\treturn r * r + g * g + b * b + a * a;\r\n\t\t},\r\n\t\tlength2Color: function(c){\r\n\t\t\treturn c.r * c.r + c.g * c.g + c.b * c.b + c.a * c.a;\r\n\t\t},\r\n\t\t\r\n\t\t// vector utilities\r\n\t\t//TODO: move vector utilities from this file to vector.js\r\n\t\tdot: function(a, b){\r\n\t\t\treturn a.x * b.x + a.y * b.y + a.z * b.z;\r\n\t\t},\r\n\t\tscale: function(s, v){\r\n\t\t\treturn {x: s * v.x, y: s * v.y, z: s * v.z};\r\n\t\t},\r\n\t\tadd: function(a, b){\r\n\t\t\treturn {x: a.x + b.x, y: a.y + b.y, z: a.z + b.z};\r\n\t\t},\r\n\t\tsaturate: function(v){\r\n\t\t\treturn Math.min(Math.max(v, 0), 1);\r\n\t\t},\r\n\t\tlength: function(v){\r\n\t\t\treturn Math.sqrt(gfx3d.lighting.dot(v, v));\r\n\t\t},\r\n\t\tnormalize: function(v){\r\n\t\t\treturn lite.scale(1 / lite.length(v), v);\r\n\t\t},\r\n\t\tfaceforward: function(n, i){\r\n\t\t\tvar p = gfx3d.lighting;\r\n\t\t\tvar s = p.dot(i, n) < 0 ? 1 : -1;\r\n\t\t\treturn p.scale(s, n);\r\n\t\t},\r\n\t\treflect: function(i, n){\r\n\t\t\tvar p = gfx3d.lighting;\r\n\t\t\treturn p.add(i, p.scale(-2 * p.dot(i, n), n));\r\n\t\t},\r\n\t\t\r\n\t\t// lighting utilities\r\n\t\tdiffuse: function(normal, lights){\r\n\t\t\tvar c = lite.black();\r\n\t\t\tfor(var i = 0; i < lights.length; ++i){\r\n\t\t\t\tvar l = lights[i],\r\n\t\t\t\t\td = lite.dot(lite.normalize(l.direction), normal);\r\n\t\t\t\tc = lite.addColor(c, lite.scaleColor(d, l.color));\r\n\t\t\t}\r\n\t\t\treturn lite.saturateColor(c);\r\n\t\t},\r\n\t\tspecular: function(normal, v, roughness, lights){\r\n\t\t\tvar c = lite.black();\r\n\t\t\tfor(var i = 0; i < lights.length; ++i){\r\n\t\t\t\tvar l = lights[i],\r\n\t\t\t\t\th = lite.normalize(lite.add(lite.normalize(l.direction), v)),\r\n\t\t\t\t\ts = Math.pow(Math.max(0, lite.dot(normal, h)), 1 / roughness);\r\n\t\t\t\tc = lite.addColor(c, lite.scaleColor(s, l.color));\r\n\t\t\t}\r\n\t\t\treturn lite.saturateColor(c);\r\n\t\t},\r\n\t\tphong: function(normal, v, size, lights){\r\n\t\t\tnormal = lite.normalize(normal);\r\n\t\t\tvar c = lite.black();\r\n\t\t\tfor(var i = 0; i < lights.length; ++i){\r\n\t\t\t\tvar l = lights[i],\r\n\t\t\t\t\tr = lite.reflect(lite.scale(-1, lite.normalize(v)), normal),\r\n\t\t\t\t\ts = Math.pow(Math.max(0, lite.dot(r, lite.normalize(l.direction))), size);\r\n\t\t\t\tc = lite.addColor(c, lite.scaleColor(s, l.color));\r\n\t\t\t}\r\n\t\t\treturn lite.saturateColor(c);\r\n\t\t}\r\n\t};\r\n\r\n\t// this lighting model is derived from RenderMan Interface Specification Version 3.2\r\n\r\n\tdeclare(\"dojox.gfx3d.lighting.Model\", null, {\r\n\t\tconstructor: function(incident, lights, ambient, specular){\r\n\t\t\tthis.incident = lite.normalize(incident);\r\n\t\t\tthis.lights = [];\r\n\t\t\tfor(var i = 0; i < lights.length; ++i){\r\n\t\t\t\tvar l = lights[i];\r\n\t\t\t\tthis.lights.push({direction: lite.normalize(l.direction), color: lite.toStdColor(l.color)});\r\n\t\t\t}\r\n\t\t\tthis.ambient = lite.toStdColor(ambient.color ? ambient.color : \"white\");\r\n\t\t\tthis.ambient = lite.scaleColor(ambient.intensity, this.ambient);\r\n\t\t\tthis.ambient = lite.scaleColor(this.ambient.a, this.ambient);\r\n\t\t\tthis.ambient.a = 1;\r\n\t\t\tthis.specular = lite.toStdColor(specular ? specular : \"white\");\r\n\t\t\tthis.specular = lite.scaleColor(this.specular.a, this.specular);\r\n\t\t\tthis.specular.a = 1;\r\n\t\t\tthis.npr_cool = {r: 0,   g: 0,   b: 0.4, a: 1};\r\n\t\t\tthis.npr_warm = {r: 0.4, g: 0.4, b: 0.2, a: 1};\r\n\t\t\tthis.npr_alpha = 0.2;\r\n\t\t\tthis.npr_beta  = 0.6;\r\n\t\t\tthis.npr_scale = 0.6;\r\n\t\t},\r\n\t\tconstant: function(normal, finish, pigment){\r\n\t\t\tpigment   = lite.toStdColor(pigment);\r\n\t\t\tvar alpha = pigment.a, color = lite.scaleColor(alpha, pigment);\r\n\t\t\tcolor.a   = alpha;\r\n\t\t\treturn lite.fromStdColor(lite.saturateColor(color));\r\n\t\t},\r\n\t\tmatte: function(normal, finish, pigment){\r\n\t\t\tif(typeof finish == \"string\"){ finish = lite.finish[finish]; }\r\n\t\t\tpigment = lite.toStdColor(pigment);\r\n\t\t\tnormal  = lite.faceforward(lite.normalize(normal), this.incident);\r\n\t\t\tvar ambient = lite.scaleColor(finish.Ka, this.ambient),\r\n\t\t\t\tshadow  = lite.saturate(-4 * lite.dot(normal, this.incident)),\r\n\t\t\t\tdiffuse = lite.scaleColor(shadow * finish.Kd, lite.diffuse(normal, this.lights)),\r\n\t\t\t\tcolor   = lite.scaleColor(pigment.a, lite.multiplyColor(pigment, lite.addColor(ambient, diffuse)));\r\n\t\t\tcolor.a = pigment.a;\r\n\t\t\treturn lite.fromStdColor(lite.saturateColor(color));\r\n\t\t},\r\n\t\tmetal: function(normal, finish, pigment){\r\n\t\t\tif(typeof finish == \"string\"){ finish = lite.finish[finish]; }\r\n\t\t\tpigment = lite.toStdColor(pigment);\r\n\t\t\tnormal  = lite.faceforward(lite.normalize(normal), this.incident);\r\n\t\t\tvar v = lite.scale(-1, this.incident), specular, color,\r\n\t\t\t\tambient = lite.scaleColor(finish.Ka, this.ambient),\r\n\t\t\t\tshadow  = lite.saturate(-4 * lite.dot(normal, this.incident));\r\n\t\t\tif(\"phong\" in finish){\r\n\t\t\t\tspecular = lite.scaleColor(shadow * finish.Ks * finish.phong, lite.phong(normal, v, finish.phong_size, this.lights));\r\n\t\t\t}else{\r\n\t\t\t\tspecular = lite.scaleColor(shadow * finish.Ks, lite.specular(normal, v, finish.roughness, this.lights));\r\n\t\t\t}\r\n\t\t\tcolor = lite.scaleColor(pigment.a, lite.addColor(lite.multiplyColor(pigment, ambient), lite.multiplyColor(this.specular, specular)));\r\n\t\t\tcolor.a = pigment.a;\r\n\t\t\treturn lite.fromStdColor(lite.saturateColor(color));\r\n\t\t},\r\n\t\tplastic: function(normal, finish, pigment){\r\n\t\t\tif(typeof finish == \"string\"){ finish = lite.finish[finish]; }\r\n\t\t\tpigment = lite.toStdColor(pigment);\r\n\t\t\tnormal  = lite.faceforward(lite.normalize(normal), this.incident);\r\n\t\t\tvar v = lite.scale(-1, this.incident), specular, color,\r\n\t\t\t\tambient = lite.scaleColor(finish.Ka, this.ambient),\r\n\t\t\t\tshadow  = lite.saturate(-4 * lite.dot(normal, this.incident)),\r\n\t\t\t\tdiffuse = lite.scaleColor(shadow * finish.Kd, lite.diffuse(normal, this.lights));\r\n\t\t\tif(\"phong\" in finish){\r\n\t\t\t\tspecular = lite.scaleColor(shadow * finish.Ks * finish.phong, lite.phong(normal, v, finish.phong_size, this.lights));\r\n\t\t\t}else{\r\n\t\t\t\tspecular = lite.scaleColor(shadow * finish.Ks, lite.specular(normal, v, finish.roughness, this.lights));\r\n\t\t\t}\r\n\t\t\tcolor = lite.scaleColor(pigment.a, lite.addColor(lite.multiplyColor(pigment, lite.addColor(ambient, diffuse)), lite.multiplyColor(this.specular, specular)));\r\n\t\t\tcolor.a = pigment.a;\r\n\t\t\treturn lite.fromStdColor(lite.saturateColor(color));\r\n\t\t},\r\n\t\tnpr: function(normal, finish, pigment){\r\n\t\t\tif(typeof finish == \"string\"){ finish = lite.finish[finish]; }\r\n\t\t\tpigment = lite.toStdColor(pigment);\r\n\t\t\tnormal  = lite.faceforward(lite.normalize(normal), this.incident);\r\n\t\t\tvar ambient  = lite.scaleColor(finish.Ka, this.ambient),\r\n\t\t\t\tshadow   = lite.saturate(-4 * lite.dot(normal, this.incident)),\r\n\t\t\t\tdiffuse  = lite.scaleColor(shadow * finish.Kd, lite.diffuse(normal, this.lights)),\r\n\t\t\t\tcolor = lite.scaleColor(pigment.a, lite.multiplyColor(pigment, lite.addColor(ambient, diffuse))),\r\n\t\t\t\tcool = lite.addColor(this.npr_cool, lite.scaleColor(this.npr_alpha, color)),\r\n\t\t\t\twarm = lite.addColor(this.npr_warm, lite.scaleColor(this.npr_beta,  color)),\r\n\t\t\t\td = (1 + lite.dot(this.incident, normal)) / 2,\r\n\t\t\t\tcolor = lite.scaleColor(this.npr_scale, lite.addColor(color, lite.mixColor(cool, warm, d)));\r\n\t\t\tcolor.a = pigment.a;\r\n\t\t\treturn lite.fromStdColor(lite.saturateColor(color));\r\n\t\t}\r\n\t});\r\n\r\n\r\n\t// POV-Ray basic finishes\r\n\t\r\n\tgfx3d.lighting.finish = {\r\n\t\r\n\t\t// Default\r\n\t\t\r\n\t\tdefaults: {Ka: 0.1, Kd: 0.6, Ks: 0.0, roughness: 0.05},\r\n\t\t\r\n\t\tdull:     {Ka: 0.1, Kd: 0.6, Ks: 0.5, roughness: 0.15},\r\n\t\tshiny:    {Ka: 0.1, Kd: 0.6, Ks: 1.0, roughness: 0.001},\r\n\t\tglossy:   {Ka: 0.1, Kd: 0.6, Ks: 1.0, roughness: 0.0001},\r\n\t\t\r\n\t\tphong_dull:   {Ka: 0.1, Kd: 0.6, Ks: 0.5, phong: 0.5, phong_size: 1},\r\n\t\tphong_shiny:  {Ka: 0.1, Kd: 0.6, Ks: 1.0, phong: 1.0, phong_size: 200},\r\n\t\tphong_glossy: {Ka: 0.1, Kd: 0.6, Ks: 1.0, phong: 1.0, phong_size: 300},\r\n\t\r\n\t\tluminous: {Ka: 1.0, Kd: 0.0, Ks: 0.0, roughness: 0.05},\r\n\t\r\n\t\t// Metals\r\n\t\r\n\t\t// very soft and dull\r\n\t\tmetalA: {Ka: 0.35, Kd: 0.3, Ks: 0.8, roughness: 1/20},\r\n\t\t// fairly soft and dull\r\n\t\tmetalB: {Ka: 0.30, Kd: 0.4, Ks: 0.7, roughness: 1/60},\r\n\t\t// medium reflectivity, holds color well\r\n\t\tmetalC: {Ka: 0.25, Kd: 0.5, Ks: 0.8, roughness: 1/80},\r\n\t\t// highly hard and polished, high reflectivity\r\n\t\tmetalD: {Ka: 0.15, Kd: 0.6, Ks: 0.8, roughness: 1/100},\r\n\t\t// very highly polished and reflective\r\n\t\tmetalE: {Ka: 0.10, Kd: 0.7, Ks: 0.8, roughness: 1/120}\r\n\t};\r\n\r\n\treturn lite;\r\n});\r\n"]}