{"version":3,"sources":["secure/DOM.js"],"names":["dojo","provide","require","dojox","secure","DOM","element","wrap","result","nodeType","wrapped","nodeObserver","style","styleObserver","ownerDocument","safeDoc","childNodes","__get__","i","length","__observable","Array","data__","unwrap","arguments","apply","this","safetyCheck","safeCSS","css","match","Error","id","Math","random","substring","replace","t","a","b","safeURL","url","safeElement","el","tagName","src","parentNode","removeChild","xhrGet","addCallback","evaluate","script","innerHTML","setCSS","cssStr","styleSheet","cssText","doc","createTextNode","replaceChild","appendChild","alert","href","attr","attributes","name","value","children","l","safeHTML","html","div","document","createElement","getElementById","node","parent","safeNode","write","str","open","close","setters","console","log","domChanger","newNodeArg","args","outerHTML","invokers","insertBefore","cloneNode","addEventListener","connect","event","window","call","makeObserver","setter","lang","makeObservable","prop","wrapper","methodName","blockedStyles","behavior","MozBinding"],"mappings":"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","file":"../../secure/DOM.js","sourcesContent":["dojo.provide(\"dojox.secure.DOM\");\r\ndojo.require(\"dojox.lang.observable\");\r\n\r\ndojox.secure.DOM = function(element){\r\n\tfunction safeNode(node){\r\n\t\tif(!node){\r\n\t\t\treturn node;\r\n\t\t}\r\n\t\tvar parent = node;\r\n\t\tdo {\r\n\t\t\tif(parent == element){\r\n\t\t\t\treturn wrap(node);\r\n\t\t\t}\r\n\t\t} while((parent = parent.parentNode));\r\n\t\treturn null;\r\n\t}\r\n\tfunction wrap(result){\r\n\t\tif(result){\r\n\t\t\tif(result.nodeType){\r\n\t\t\t\t// wrap the node\r\n\t\t\t\tvar wrapped = nodeObserver(result);\r\n\t\t\t\tif(result.nodeType == 1 && typeof wrapped.style == 'function'){ // if it is a function, that means it is holding a slot for us, now we will override it\r\n\t\t\t\t\twrapped.style = styleObserver(result.style);\r\n\t\t\t\t\twrapped.ownerDocument = safeDoc;\r\n\t\t\t\t\twrapped.childNodes = {__get__:function(i){\r\n\t\t\t\t\t\treturn wrap(result.childNodes[i]);\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tlength:0\r\n\t\t\t\t\t};\r\n\t\t\t\t\t//TODO: maybe add attributes\r\n\t\t\t\t}\r\n\t\t\t\treturn wrapped;\r\n\t\t\t}\r\n\t\t\tif(result && typeof result == 'object'){\r\n\t\t\t\tif(result.__observable){\r\n\t\t\t\t\t// we have already wrapped it, this helps prevent circular/infinite loops\r\n\t\t\t\t\treturn result.__observable;\r\n\t\t\t\t}\r\n\t\t\t\t// wrap the node list\r\n\t\t\t\twrapped = result instanceof Array ? [] : {};\r\n\t\t\t\tresult.__observable = wrapped;\r\n\t\t\t\tfor(var i in result){\r\n\t\t\t\t\tif (i != '__observable'){\r\n\t\t\t\t\t\twrapped[i] = wrap(result[i]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\twrapped.data__ = result;\r\n\t\t\t\t\r\n\t\t\t\treturn wrapped;\r\n\t\t\t}\r\n\t\t\tif(typeof result == 'function'){\r\n\t\t\t\tvar unwrap = function(result){\r\n\t\t\t\t\tif(typeof result == 'function'){\r\n\t\t\t\t\t\t// if untrusted code passes a function to trusted code, we want the trusted code to be\r\n\t\t\t\t\t\t// able to execute it and have the arguments automatically wrapped\r\n\t\t\t\t\t\treturn function(){\r\n\t\t\t\t\t\t\tfor (var i = 0; i < arguments.length; i++){\r\n\t\t\t\t\t\t\t\targuments[i] = wrap(arguments[i]);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\treturn unwrap(result.apply(wrap(this),arguments));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn dojox.secure.unwrap(result);\r\n\t\t\t\t};\r\n\t\t\t\t// when we wrap a function we make it so that we can untrusted code can execute\r\n\t\t\t\t// the function and the arguments will be unwrapped for the trusted code\r\n\t\t\t\treturn function(){\r\n\t\t\t\t\tif(result.safetyCheck){\r\n\t\t\t\t\t\tresult.safetyCheck.apply(unwrap(this),arguments);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfor (var i = 0; i < arguments.length; i++){\r\n\t\t\t\t\t\targuments[i] = unwrap(arguments[i]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn wrap(result.apply(unwrap(this),arguments));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\tunwrap = dojox.secure.unwrap;\r\n\t\r\n\tfunction safeCSS(css){\r\n\t\tcss += ''; // make sure it is a string\r\n\t\tif(css.match(/behavior:|content:|javascript:|binding|expression|\\@import/)){\r\n\t\t\tthrow new Error(\"Illegal CSS\");\r\n\t\t}\r\n\t\tvar id = element.id || (element.id = \"safe\" + ('' + Math.random()).substring(2));\r\n\t\treturn css.replace(/(\\}|^)\\s*([^\\{]*\\{)/g,function(t,a,b){ // put all the styles in the context of the id of the sandbox\r\n\t\t\treturn a + ' #' + id + ' ' + b; // need to remove body and html references something like: .replace(/body/g,''); but that would break mybody...\r\n\t\t});\r\n\t}\r\n\tfunction safeURL(url){\r\n\t\t// test a url to see if it is safe\r\n\t\tif(url.match(/:/) && !url.match(/^(http|ftp|mailto)/)){\r\n\t\t\tthrow new Error(\"Unsafe URL \" + url);\r\n\t\t}\r\n\t}\r\n\tfunction safeElement(el){\r\n\t\t// test an element to see if it is safe\r\n\t\tif(el && el.nodeType == 1){\r\n\t\t\tif(el.tagName.match(/script/i)){\r\n\t\t\t\tvar src = el.src;\r\n\t\t\t\tif (src && src != \"\"){\r\n\t\t\t\t\t// load the src and evaluate it safely\r\n\t\t\t\t\tel.parentNode.removeChild(el);\r\n\t\t\t\t\tdojo.xhrGet({url:src,secure:true}).addCallback(function(result){\r\n\t\t\t\t\t\tsafeDoc.evaluate(result);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\t//evaluate the script safely and remove it\r\n\t\t\t\t\tvar script = el.innerHTML;\r\n\t\t\t\t\tel.parentNode.removeChild(el);\r\n\t\t\t\t\twrap.evaluate(script);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(el.tagName.match(/link/i)){\r\n\t\t\t\tthrow new Error(\"illegal tag\");\r\n\t\t\t}\r\n\t\t\tif(el.tagName.match(/style/i)){\r\n\t\t\t\tvar setCSS = function(cssStr){\r\n\t\t\t\t\tif(el.styleSheet){// IE\r\n\t\t\t\t\t\tel.styleSheet.cssText = cssStr;\r\n\t\t\t\t\t} else {// w3c\r\n\t\t\t\t\t\tvar cssText = doc.createTextNode(cssStr);\r\n\t\t\t\t\t\tif (el.childNodes[0])\r\n\t\t\t\t\t\t\tel.replaceChild(cssText,el.childNodes[0])\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tel.appendChild(cssText);\r\n\t\t\t\t\t }\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\tsrc = el.src;\r\n\t\t\t\tif(src && src != \"\"){\r\n\t\t\t\t\talert('src' + src);\r\n\t\t\t\t\t// try to load it by url and safely load it\r\n\t\t\t\t\tel.src = null;\r\n\t\t\t\t\tdojo.xhrGet({url:src,secure:true}).addCallback(function(result){\r\n\t\t\t\t\t\tsetCSS(safeCSS(result));\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\tsetCSS(safeCSS(el.innerHTML));\r\n\t\t\t}\r\n\t\t\tif(el.style){\r\n\t\t\t\tsafeCSS(el.style.cssText);\r\n\t\t\t}\r\n\t\t\tif(el.href){\r\n\t\t\t\tsafeURL(el.href);\r\n\t\t\t}\r\n\t\t\tif(el.src){\r\n\t\t\t\tsafeURL(el.src);\r\n\t\t\t}\r\n\t\t\tvar attr,i = 0;\r\n\t\t\twhile ((attr=el.attributes[i++])){\r\n\t\t\t\tif(attr.name.substring(0,2)== \"on\" && attr.value != \"null\" && attr.value != \"\"){ // must remove all the event handlers\r\n\t\t\t\t\tthrow new Error(\"event handlers not allowed in the HTML, they must be set with element.addEventListener\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tvar children = el.childNodes;\r\n\t\t\tfor (var i =0, l = children.length; i < l; i++){\r\n\t\t\t\tsafeElement(children[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tfunction safeHTML(html){\r\n\t\tvar div = document.createElement(\"div\");\r\n\t\tif(html.match(/<object/i))\r\n\t\t\tthrow new Error(\"The object tag is not allowed\");\r\n\t\tdiv.innerHTML = html; // this is safe with an unattached node\r\n\t\tsafeElement(div);\r\n\t\treturn div;\r\n\t}\r\n\tvar doc = element.ownerDocument;\r\n\tvar safeDoc = {\r\n\t\tgetElementById : function(id){\r\n\t\t\treturn safeNode(doc.getElementById(id));\r\n\t\t},\r\n\t\tcreateElement : function(name){\r\n\t\t\treturn wrap(doc.createElement(name));\r\n\t\t},\r\n\t\tcreateTextNode : function(name){\r\n\t\t\treturn wrap(doc.createTextNode(name));\r\n\t\t},\r\n\t\twrite : function(str){\r\n\t\t\tvar div = safeHTML(str);\r\n\t\t\twhile (div.childNodes.length){\r\n\t\t\t\t// move all these children to the main node\r\n\t\t\t\telement.appendChild(div.childNodes[0]);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\tsafeDoc.open = safeDoc.close = function(){}; // no-op functions\r\n\tvar setters = {\r\n\t\tinnerHTML : function(node,value){\r\n\t\t\tconsole.log('setting innerHTML');\r\n\t\t\tnode.innerHTML = safeHTML(value).innerHTML;\r\n\t\t}\r\n\t};\r\n\tsetters.outerHTML = function(node,value){\r\n\t\tthrow new Error(\"Can not set this property\");\r\n\t}; // blocked\r\n\tfunction domChanger(name,newNodeArg){\r\n\t\treturn function(node,args){\r\n\t\t\tsafeElement(args[newNodeArg]);  // check to make sure the new node is safe\r\n\t\t\treturn node[name](args[0]);// execute the method\r\n\t\t};\r\n\t}\r\n\tvar invokers = {\r\n\t\tappendChild : domChanger(\"appendChild\",0),\r\n\t\tinsertBefore : domChanger(\"insertBefore\",0),\r\n\t\treplaceChild : domChanger(\"replaceChild\",1),\r\n\t\tcloneNode : function(node,args){\r\n\t\t\treturn node.cloneNode(args[0]);\r\n\t\t},\r\n\t\taddEventListener : function(node,args){\r\n\t\t\tdojo.connect(node,'on' + args[0],this,function(event){\r\n\t\t\t\tevent = nodeObserver(event || window.event);\r\n\t\t\t\targs[1].call(this,event);\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\tinvokers.childNodes = invokers.style = invokers.ownerDocument = function(){}; // this is a trick to get these property slots available, they will be overridden\r\n\tfunction makeObserver(setter){ // we make two of these, but the setter for style nodes is different\r\n\t\treturn dojox.lang.makeObservable(\r\n\t\t\tfunction(node, prop){\r\n\t\t\t\tvar result;\r\n\t\t\t\treturn node[prop];\r\n\t\t\t},setter,\r\n\t\t\tfunction(wrapper, node, methodName, args){\r\n\t\t\t\tfor (var i = 0; i < args.length; i++){\r\n\t\t\t\t\targs[i] = unwrap(args[i]);\r\n\t\t\t\t}\r\n\t\t\t\tif(invokers[methodName]){\r\n\t\t\t\t\treturn wrap(invokers[methodName].call(wrapper,node,args));\r\n\t\t\t\t}\r\n\t\t\t\treturn wrap(node[methodName].apply(node,args));\r\n\t\t\t},invokers);\r\n\t}\r\n\tvar nodeObserver = makeObserver(function(node, prop, value){\r\n\t\t\tif(setters[prop]){\r\n\t\t\t\tsetters[prop](node,value);\r\n\t\t\t}\r\n\t\t\tnode[prop] = value;\r\n\t\t});\r\n\tvar blockedStyles = {behavior:1,MozBinding:1};\r\n\tvar styleObserver = makeObserver(function(node, prop, value){\r\n\t\t\tif(!blockedStyles[prop]){\r\n\t\t\t\tnode[prop] = safeCSS(value);\r\n\t\t\t}\r\n\t\t});\r\n\twrap.safeHTML = safeHTML;\r\n\twrap.safeCSS = safeCSS;\r\n\treturn wrap;\r\n};\r\ndojox.secure.unwrap = function unwrap(result){\r\n\treturn (result && result.data__) || result;\r\n};\r\n"]}