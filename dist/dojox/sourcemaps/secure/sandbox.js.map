{"version":3,"sources":["secure/sandbox.js"],"names":["dojo","provide","require","oldTimeout","setTimeout","oldInterval","setInterval","__proto__","fixMozArrayFunction","name","method","Array","prototype","fixed","this","window","TypeError","apply","arguments","xhrGet","dojox","secure","sandbox","element","wrap","DOM","document","ownerDocument","mixin","_safeDojoFunctions","imports","safeCalls","i","push","get","obj","prop","badProps","test","Error","__get__","set","value","__set","forEach","fun","len","call","length","Class","superclass","properties","classProperties","proto","superConstructor","ourConstructor","arg","l","F","j","callee","__rawMethod__","hasOwnProperty","constructor","checkString","func","time","evaluate","script","eval","join","load","url","match","_Url","rootUrl","capability","validate","result","loadJS","addCallback","loadHTML","innerHTML","safeFunctions","unwrap","NodeList","addContent","safetyCheck","content","safeHTML","style","safeCSS","attr","safe","query","root","connect","el","event","substring","body","byId","id","getElementById","fromJson","str"],"mappings":"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","file":"../../secure/sandbox.js","sourcesContent":["dojo.provide(\"dojox.secure.sandbox\");\r\ndojo.require(\"dojox.secure.DOM\");\r\ndojo.require(\"dojox.secure.capability\");\r\ndojo.require(\"dojo.NodeList-fx\");\r\ndojo.require(\"dojo._base.url\");\r\n\r\n(function() {\r\n\tvar oldTimeout = setTimeout;\r\n\tvar oldInterval = setInterval;\r\n\tif({}.__proto__){\r\n\t\t// mozilla has unsafe methods on array\r\n\t\tvar fixMozArrayFunction = function (name) {\r\n\t\t\tvar method = Array.prototype[name];\r\n\t\t\tif(method && !method.fixed){\r\n\t\t\t\t(Array.prototype[name] = function () {\r\n\t\t\t\t\tif (this == window) {\r\n\t\t\t\t\t\tthrow new TypeError(\"Called with wrong this\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn method.apply(this, arguments);\r\n\t\t\t\t}).fixed = true;\r\n\t\t\t}\r\n\t\t};\r\n\t\t// these are not safe in mozilla\r\n\t\tfixMozArrayFunction('concat');\r\n\t\tfixMozArrayFunction('reverse');\r\n\t\tfixMozArrayFunction('sort');\r\n\t\tfixMozArrayFunction(\"slice\");\r\n\t\tfixMozArrayFunction(\"forEach\");\r\n\t\tfixMozArrayFunction(\"filter\");\r\n\t\tfixMozArrayFunction(\"reduce\");\r\n\t\tfixMozArrayFunction(\"reduceRight\");\r\n\t\tfixMozArrayFunction(\"every\");\r\n\t\tfixMozArrayFunction(\"map\");\r\n\t\tfixMozArrayFunction(\"some\");\r\n\t}\r\n\tvar xhrGet = function(){\r\n\t\treturn dojo.xhrGet.apply(dojo,arguments);\r\n\t};\r\n\tdojox.secure.sandbox = function(element) {\r\n\t\t// summary:\r\n\t\t//\t\tCreates a secure sandbox from which scripts and HTML can be loaded that\r\n\t\t//\t\twill only be able to access the provided element and it's descendants, the\r\n\t\t//\t\trest of the DOM and JS environment will not be accessible to the sandboxed\r\n\t\t//\t\tscripts and HTML.\r\n\t\t//\r\n\t\t// element:\r\n\t\t//\t\tThe DOM element to use as the container for the sandbox\r\n\t\t//\r\n\t\t// description:\r\n\t\t//\t\tThis function will create and return a sandbox object (see dojox.secure.__Sandbox)\r\n\t\t//\t\tfor the provided element.\r\n\t\tvar wrap = dojox.secure.DOM(element);\r\n\t\telement = wrap(element);\r\n\t\tvar document = element.ownerDocument;\r\n\t\tvar mixin, dojo = dojox.secure._safeDojoFunctions(element,wrap);\r\n\t\tvar imports= [];\r\n\t\tvar safeCalls = [\"isNaN\",\"isFinite\",\"parseInt\",\"parseFloat\",\"escape\",\"unescape\",\r\n\t\t\t\t\t\t\t\t\t\t\"encodeURI\",\"encodeURIComponent\",\"decodeURI\",\"decodeURIComponent\",\r\n\t\t\t\t\t\t\t\t\t\t\"alert\",\"confirm\",\"prompt\", // some people may not want to allow these to be called, but they don't break capability-limiting\r\n\t\t\t\t\t\t\t\t\t\t\"Error\",\"EvalError\",\"RangeError\",\"ReferenceError\",\"SyntaxError\",\"TypeError\",\r\n\t\t\t\t\t\t\t\t\t\t\"Date\",\"RegExp\",\"Number\",\"Object\",\"Array\",\"String\",\"Math\",\r\n\t\t\t\t\t\t\t\t\t\t//\"ADSAFE\", // not using ADSAFE runtime for the time being\r\n\t\t\t\t\t\t\t\t\t\t\"setTimeout\",\"setInterval\",\"clearTimeout\",\"clearInterval\", // we make these safe below\r\n\t\t\t\t\t\t\t\t\t\t\"dojo\",\"get\",\"set\",\"forEach\",\"load\",\"evaluate\"];\r\n\t   \tfor(var i in dojo){\r\n\t   \t\tsafeCalls.push(i); // add the safe dojo functions to as available global top level functions\r\n\t    \timports.push(\"var \" + i + \"=dojo.\" + i); // add to the list of imports\r\n\t    }\r\n\t\t// open the dojo namespace (namespaces are pretty silly in an environment where you can't set globals)\r\n\t   \teval(imports.join(\";\"));\r\n\t\tfunction get(obj,prop) {\r\n\t\t\t// basic access by index function\r\n\t\t\tprop = '' + prop;\r\n\t\t\tif(dojox.secure.badProps.test(prop)) {\r\n\t\t\t\tthrow new Error(\"bad property access\");\r\n\t\t\t}\r\n\t\t\tif(obj.__get__) {\r\n\t\t\t\treturn obj.__get__(prop);\r\n\t\t\t}\r\n\t\t\treturn obj[prop];\r\n\t\t}\r\n\t\tfunction set(obj,prop,value) {\r\n\t\t\t// basic set by index function\r\n\t\t\tprop = '' + prop;\r\n\t\t\tget(obj,prop); // test it\r\n\t\t\tif(obj.__set) {\r\n\t\t\t\treturn obj.__set(prop);\r\n\t\t\t}\r\n\t\t\tobj[prop] = value;\r\n\t\t\treturn value;\r\n\t\t}\r\n\t\tfunction forEach(obj,fun) {\r\n\t\t\t//\tshort syntax iterator function\r\n\t\t\tif(typeof fun != \"function\"){\r\n\t\t\t\tthrow new TypeError();\r\n\t\t\t}\r\n\t\t\tif(\"length\" in obj) {\r\n\t\t\t\t// do arrays the fast way\r\n\t\t\t\tif(obj.__get__) {\r\n\t\t\t\t\t// use the catch getter\r\n\t\t\t\t\tvar len = obj.__get__('length');\r\n\t\t\t\t\tfor (var i = 0; i < len; i++) {\r\n\t\t\t\t\t\tif(i in obj) {\r\n\t\t\t\t\t\t\tfun.call(obj, obj.__get__(i), i, obj);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\t// fast\r\n\t\t\t\t\tlen = obj.length;\r\n\t\t\t\t\tfor (i = 0; i < len; i++) {\r\n\t\t\t\t\t\tif(i in obj) {\r\n\t\t\t\t\t\t\tfun.call(obj, obj[i], i, obj);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\t// for each an object\r\n\t\t\t\tfor (i in obj) {\r\n\t\t\t\t\tfun.call(obj, get(obj,i), i, obj);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tfunction Class(/*Function*/superclass, /*Object*/properties, /*Object*/classProperties) {\r\n\t\t\t// summary:\r\n\t\t\t//\t\tA safe class constructor\r\n\t\t\t//\r\n\t\t\t// superclass:\r\n\t\t\t//\t\tThere may be zero or more superclass arguments. The constructed class\r\n\t\t\t//\t\twill inherit from any provided superclasses, protypically from the first,\r\n\t\t\t//\t\tvia mixin for the subsequent. Later arguments\r\n\t\t\t//\t\twill override properties/methods from earlier arguments\r\n\t\t\t//\r\n\t\t\t// properties:\r\n\t\t\t//\t\tThe constructed\r\n\t\t\t//\t\t\"class\" will also have the methods/properties defined in this argument.\r\n\t\t\t//\t\tThese methods may utilize the <em>this</em> operator, and they\r\n\t\t\t//\t\tare only the code that has access to <em>this</em>. Inner functions\r\n\t\t\t//\t\tare also prohibited from using <em>this</em>.\r\n\t\t\t//\r\n\t\t\t//\t\tIf no superclasses are provided, this object will be the prototype of the\r\n\t\t\t//\t\tconstructed class (no copying\r\n\t\t\t//\t\twill be done). Consequently you can \"beget\" by calling new (Class(obj)).\r\n\t\t\t//\t\tAll methods are \"bound\", each call results in |this| safety checking call.\r\n\t\t\t//\r\n\t\t\t// classProperties:\r\n\t\t\t//\t\tThis properties will be copied to the new class function.\r\n\t\t\t//\r\n\t\t\t//\t\tNote that neither dojo.declare nor dojo.extend are acceptable class constructors as\r\n\t\t\t//\t\tthey are completely unsecure. This class constructor is conceptually based on declare\r\n\t\t\t//\t\tbut also somewhat influenced by base2, prototype, YUI, resig's patterns, etc.\r\n\t\t\t//\r\n\t\t\t// example:\r\n\t\t\t// |\tvar Car = Class({drive:function(speed) { ... } ); // create a Car class with a \"drive\" method\r\n\t\t\t// |\tvar FastCar = Class(Car,{driveFast: function(speed) { return this.drive(2 * speed); } }); // create a FastCar that extends Car\r\n\t\t\t// |\tvar fastCar = new FastCar; // instantiate\r\n\t\t\t// |\tfastCar.driveFast(50); // call a method\r\n\t\t\t// |\tvar driveFast = fastCar.driveFast;\r\n\t\t\t// |\tvar driveFast(50); // this will throw an error, the method can be used with an object that is not an instance of FastCar\r\n\t\t\tvar proto,superConstructor,ourConstructor;\r\n\t\t\tvar arg;\r\n\t\t\tfor (var i = 0, l = arguments.length; typeof (arg = arguments[i]) == 'function' && i < l; i++) {\r\n\t\t\t\t// go through each superclass argument\r\n\t\t\t\tif(proto) { // we have a prototype now, we must mixin now\r\n\t\t\t\t\tmixin(proto,arg.prototype);\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\t// this is the first argument, so we can define the prototype ourselves\r\n\t\t\t\t\t// link up the prototype chain to the superclass's prototype, so we are a subtype\r\n\t\t\t\t\tsuperConstructor = arg;\r\n\t\t\t\t\tvar F = function() {};\r\n\t\t\t\t\tF.prototype = arg.prototype;\r\n\t\t\t\t\tproto = new F;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(arg) { // the next object should be the properties\r\n\t\t\t\t// apply binding checking on all the functions\r\n\t\t\t\tfor (var j in arg) {\r\n\t\t\t\t\t// TODO: check on non-enumerables?\r\n\t\t\t\t\tvar value = arg[j];\r\n\t\t\t\t\tif(typeof value == 'function') {\r\n\t\t\t\t\t\targ[j] = function() {\r\n\t\t\t\t\t\t\tif(this instanceof Class){\r\n\t\t\t\t\t\t\t\treturn arguments.callee.__rawMethod__.apply(this,arguments);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tthrow new Error(\"Method called on wrong object\");\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\targ[j].__rawMethod__ = value; // may want to use this for reconstruction and toString,valueOf\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif(arg.hasOwnProperty('constructor')) {\r\n\t\t\t\t\tourConstructor = arg.constructor;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tproto = proto ? mixin(proto,arg) : arg; // if there is no proto yet, we can use the provided object\r\n\t\t\tfunction Class() {\r\n\t\t\t\t// the super class may not have been constructed using the same technique, we will just call the constructor\r\n\t\t\t\tif(superConstructor){\r\n\t\t\t\t\tsuperConstructor.apply(this,arguments);\r\n\t\t\t\t}\r\n\t\t\t\tif(ourConstructor){\r\n\t\t\t\t\tourConstructor.apply(this,arguments);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tmixin(Class,arguments[i]); // the optional second object adds properties to the class\r\n\t\t\tproto.constructor = Class;\r\n\t\t\tClass.prototype = proto;\r\n\t\t\treturn Class;\r\n\t\t}\r\n\t\tfunction checkString(func){\r\n\t\t\tif(typeof func != 'function') {\r\n\t\t\t\tthrow new Error(\"String is not allowed in setTimeout/setInterval\");\r\n\t\t\t}\r\n\t\t}\r\n\t\tfunction setTimeout(func,time) {\r\n\t\t\t// sandboxed setTimeout\r\n\t\t\tcheckString(func);\r\n\t\t\treturn oldTimeout(func,time);\r\n\t\t}\r\n\t\tfunction setInterval(func,time) {\r\n\t\t\t// sandboxed setInterval\r\n\t\t\tcheckString(func);\r\n\t\t\treturn oldInterval(func,time);\r\n\t\t}\r\n\t\tfunction evaluate(script){\r\n\t\t\t// sandboxed eval\r\n\t\t\treturn wrap.evaluate(script);\r\n\t\t}\r\n\t\tvar load = wrap.load = function(url){\r\n\t\t\t// provides a loader function for the sandbox\r\n\t\t\tif (url.match(/^[\\w\\s]*:/)){\r\n\t\t\t\tthrow new Error(\"Access denied to cross-site requests\");\r\n\t\t\t}\r\n\t\t\treturn xhrGet({url:(new dojo._Url(wrap.rootUrl,url))+'',secure:true});\r\n\t\t}\r\n\t\twrap.evaluate = function(script){\r\n\t\t\t//if(!alreadyValidated) {\r\n\t\t\tdojox.secure.capability.validate(script,safeCalls, // the safe dojo library and standard operators\r\n\t\t\t\t\t\t\t\t\t\t\t{document:1,element:1}); // these are secured DOM starting points\r\n\r\n\t\t\t//}\r\n\t\t\tif(script.match(/^\\s*[\\[\\{]/)) {\r\n\t\t\t\tvar result = eval('(' + script + ')');\r\n\t\t\t\t// TODO: call render on result?\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\teval(script);\r\n\t\t\t}\r\n\t\t\t//eval('wrap.evaluate=('+arguments.callee.toString()+')'); // yeah, recursive scoping;\r\n\t\t};\r\n\t\treturn /*===== dojo.declare(\"dojox.secure.__Sandbox\", null, =====*/ { // dojox.secure.__Sandbox\r\n\t\t\tloadJS : function(url){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tLoads the script from the given URL using XHR (assuming\r\n\t\t\t\t//\t\ta plugin system is in place for cross-site requests) within the sandbox\r\n\t\t\t\t//\r\n\t\t\t\t// url:\r\n\t\t\t\t//\t\tThe url of the script to load\r\n\t\t\t\twrap.rootUrl = url;\r\n\t\t\t\treturn xhrGet({url:url,secure:true}).addCallback(function(result) {\r\n\t\t\t\t\tevaluate(result,element /*If we get the results with a secure proxy, we would call put true here */);\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tloadHTML : function(url){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tLoads the web page from the provided URL using XHR (assuming the\r\n\t\t\t\t//\t\tplugin system is in place) within the sandbox. All scripts within the web\r\n\t\t\t\t//\t\tpage will also be sandboxed.\r\n\t\t\t\t//\r\n\t\t\t\t// url:\r\n\t\t\t\t//\t\tThe url of the web page to load\r\n\r\n\t\t\t\twrap.rootUrl = url;\r\n\t\t\t\treturn xhrGet({url:url,secure:true}).addCallback(function(result){\r\n\t\t\t\t\telement.innerHTML = result;\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tevaluate : function(script){\r\n\t\t\t\t// summary:\r\n\t\t\t\t//\t\tEvaluates the given script within the sandbox\r\n\t\t\t\t//\r\n\t\t\t\t// script:\r\n\t\t\t\t//\t\tThe JavaScript text to evaluate\r\n\t\t\t\treturn wrap.evaluate(script);\r\n\t\t\t}\r\n\t\t\t// TODO: could add something for pre-validated scripts\r\n\t\t}/*===== ) =====*/;\r\n\t};\r\n})();\r\ndojox.secure._safeDojoFunctions = function(element,wrap) {\r\n\t//\tCreates a safe subset of Dojo core library\r\n\tvar safeFunctions = [\"mixin\",\"require\",\"isString\",\"isArray\",\"isFunction\",\"isObject\",\"isArrayLike\",\"isAlien\",\r\n\t\"hitch\",\"delegate\",\"partial\",\"trim\",\"disconnect\",\"subscribe\",\"unsubscribe\",\"Deferred\",\"toJson\",\"style\",\"attr\"];\r\n\t//var domFunctions = [\"clone\",\"byId\"];\r\n\tvar doc = element.ownerDocument;\r\n\tvar unwrap = dojox.secure.unwrap;\r\n\tdojo.NodeList.prototype.addContent.safetyCheck = function(content){\r\n\t\twrap.safeHTML(content);\r\n\t};\r\n\tdojo.NodeList.prototype.style.safetyCheck = function(name,value){\r\n\t\tif(name=='behavior'){\r\n\t\t\tthrow new Error(\"Can not set behavior\");\r\n\t\t}\r\n\t\twrap.safeCSS(value);\r\n\t};\r\n\tdojo.NodeList.prototype.attr.safetyCheck = function(name,value){\r\n\t\tif (value && (name == 'src' || name == 'href' || name=='style')){\r\n\t\t\tthrow new Error(\"Illegal to set \" + name);\r\n\t\t}\r\n\t};\r\n\tvar safe = {\r\n\t\tquery : function(query,root) {\r\n\t\t\treturn wrap(dojo.query(query,unwrap(root || element))); // wrap the NodeList\r\n\t\t},\r\n\t\tconnect: function(el,event) {\r\n\t\t\tvar obj = el;\r\n\t\t\targuments[0] = unwrap(el);\r\n\t\t\tif(obj!=arguments[0] && event.substring(0,2) != 'on'){\r\n\t\t\t\t// it is probably an element, and it doesn't look like an event handler, probably not safe\r\n\t\t\t\tthrow new Error(\"Invalid event name for element\");\r\n\t\t\t}\r\n\t\t\treturn dojo.connect.apply(dojo,arguments);\r\n\t\t},\r\n\t\tbody : function() {\r\n\t\t\treturn element;\r\n\t\t},\r\n\t\tbyId : function(id) {\r\n\t\t\treturn element.ownerDocument.getElementById(id); // use the safe document\r\n\t\t},\r\n\t\tfromJson : function(str) {\r\n\t\t\t// make sure it is safe before passing it to the unsafe dojo.fromJson\r\n\t\t\tdojox.secure.capability.validate(str,[],{});\r\n\t\t\treturn dojo.fromJson(str);\r\n\t\t}\r\n\t};\r\n\tfor (var i = 0; i < safeFunctions.length; i++) {\r\n\t\tsafe[safeFunctions[i]] = dojo[safeFunctions[i]];\r\n\t}\r\n\treturn safe;\r\n};\r\n\r\n"]}