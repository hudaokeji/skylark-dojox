{"version":3,"sources":["storage/BehaviorStorageProvider.js"],"names":["dojo","provide","require","declare","dojox","storage","Provider","store","storeName","keys","initialize","this","_createStore","load","e","Error","get","initialized","manager","loaded","isAvailable","isIE","storeNode","create","id","style","display","query","addBehavior","put","key","value","resultsHandler","namespace","_assertIsValidKey","DEFAULT_NAMESPACE","_assertIsValidNamespace","fullKey","getFullKey","toJson","setAttribute","save","success","getAttribute","_addKey","SUCCESS","FAILED","fromJson","getKeys","i","length","currentKey","_beginsWith","substring","push","clear","forEach","removeAttribute","_removeKey","remove","getNamespaces","results","found","tester","test","currentNS","match","isPermanent","getMaximumSize","hasSettingsUI","isValidKey","keyName","undefined","isValidNamespace","haystack","needle","filter","item","register","BehaviorStorageProvider"],"mappings":"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","file":"../../storage/BehaviorStorageProvider.js","sourcesContent":["dojo.provide(\"dojox.storage.BehaviorStorageProvider\");\r\n\r\ndojo.require(\"dojox.storage.Provider\");\r\ndojo.require(\"dojox.storage.manager\");\r\n\r\ndojo.declare(\r\n\t\"dojox.storage.BehaviorStorageProvider\",\r\n\t[dojox.storage.Provider],\r\n\t{\r\n\t\tstore: null,\r\n\r\n\t\tstoreName: '__dojox_BehaviorStorage',\r\n\r\n\t\tkeys: [],\r\n\r\n\t\tinitialize: function(){\r\n\t\t\ttry{\r\n\t\t\t\tthis.store = this._createStore();\r\n\t\t\t\tthis.store.load(this.storeName);\r\n\t\t\t}catch(e){\r\n\t\t\t\tthrow new Error(\"Store is not available: \" + e);\r\n\t\t\t}\r\n\r\n\t\t\tvar keys = this.get('keys','dojoxSystemNS');\r\n\t\t\tthis.keys = keys || [];\r\n\r\n\t\t\tthis.initialized = true;\r\n\t\t\tdojox.storage.manager.loaded();\r\n\r\n\t\t},\r\n\r\n\t\tisAvailable: function(){ /*Boolean*/\r\n\t\t\t// This is not completely true. UserData may\r\n\t\t\t// be disabled in security settings. To *really*\r\n\t\t\t// check if this is available, one needs to wait\r\n\t\t\t// until the store is successfully initialized...\r\n\t\t\treturn dojo.isIE && dojo.isIE >= 5;\r\n\t\t},\r\n\r\n\t\t_createStore: function() {\r\n\t\t\tvar storeNode = dojo.create(\r\n\t\t\t\t'link',\r\n\t\t\t\t{id: this.storeName + 'Node', style: {'display':'none'}},\r\n\t\t\t\tdojo.query('head')[0]\r\n\t\t\t);\r\n\t\t\tstoreNode.addBehavior('#default#userdata');\r\n\r\n\t\t\treturn storeNode;\r\n\t\t},\r\n\r\n\t\tput: function(\t/*string*/ key,\r\n\t\t\t\t\t\t/*object*/ value,\r\n\t\t\t\t\t\t/*function*/ resultsHandler,\r\n\t\t\t\t\t\t/*string?*/ namespace){\r\n\r\n\t\t\tthis._assertIsValidKey(key);\r\n\r\n\t\t\tnamespace = namespace||this.DEFAULT_NAMESPACE;\r\n\t\t\tthis._assertIsValidNamespace(namespace);\r\n\r\n\t\t\tvar fullKey = this.getFullKey(key,namespace);\r\n\t\t\tvalue = dojo.toJson(value);\r\n\r\n\t\t\tthis.store.setAttribute(fullKey, value);\r\n\t\t\tthis.store.save(this.storeName);\r\n\r\n\t\t\tvar success = this.store.getAttribute(fullKey) === value;\r\n\t\t\tif(success){\r\n\t\t\t\tthis._addKey(fullKey);\r\n\t\t\t\tthis.store.setAttribute('__dojoxSystemNS_keys', dojo.toJson(this.keys));\r\n\t\t\t\tthis.store.save(this.storeName);\r\n\t\t\t}\r\n\r\n\t\t\tif(resultsHandler){\r\n\t\t\t\tresultsHandler(success ? this.SUCCESS : this.FAILED, key, null, namespace);\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\tget: function(/*string*/ key, /*string?*/ namespace){ /*Object*/\r\n\t\t\tthis._assertIsValidKey(key);\r\n\r\n\t\t\tnamespace = namespace||this.DEFAULT_NAMESPACE;\r\n\t\t\tthis._assertIsValidNamespace(namespace);\r\n\r\n\t\t\tkey = this.getFullKey(key, namespace);\r\n\r\n\t\t\treturn dojo.fromJson(this.store.getAttribute(key));\r\n\t\t},\r\n\r\n\t\tgetKeys: function(/*string?*/ namespace){ /*Array*/\r\n\t\t\tnamespace = namespace||this.DEFAULT_NAMESPACE;\r\n\t\t\tthis._assertIsValidNamespace(namespace);\r\n\r\n\t\t\tnamespace = '__'+namespace+'_';\r\n\r\n\t\t\tvar keys = [];\r\n\t\t\tfor(var i = 0; i < this.keys.length; i++){\r\n\t\t\t\tvar currentKey = this.keys[i];\r\n\t\t\t\tif(this._beginsWith(currentKey,namespace)){\r\n\t\t\t\t\tcurrentKey = currentKey.substring(namespace.length);\r\n\t\t\t\t\tkeys.push(currentKey);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn keys;\r\n\t\t},\r\n\r\n\t\tclear: function(/*string?*/ namespace){\r\n\t\t\tnamespace = namespace||this.DEFAULT_NAMESPACE;\r\n\t\t\tthis._assertIsValidNamespace(namespace);\r\n\r\n\t\t\tnamespace = '__'+namespace+'_';\r\n\r\n\t\t\tvar keys = [];\r\n\t\t\tfor(var i = 0; i < this.keys.length; i++){\r\n\t\t\t\tvar currentKey = this.keys[i];\r\n\t\t\t\tif(this._beginsWith(currentKey,namespace)){\r\n\t\t\t\t\tkeys.push(currentKey);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tdojo.forEach(keys, function(key){\r\n\t\t\t\tthis.store.removeAttribute(key);\r\n\t\t\t\tthis._removeKey(key);\r\n\t\t\t}, this);\r\n\r\n\t\t\tthis.put('keys', this.keys, null, 'dojoxSystemNS');\r\n\t\t\tthis.store.save(this.storeName);\r\n\t\t},\r\n\r\n\t\tremove: function(/*string*/ key, /*string?*/ namespace){\r\n\t\t\tthis._assertIsValidKey(key);\r\n\r\n\t\t\tnamespace = namespace||this.DEFAULT_NAMESPACE;\r\n\t\t\tthis._assertIsValidNamespace(namespace);\r\n\r\n\t\t\tkey = this.getFullKey(key, namespace);\r\n\t\t\tthis.store.removeAttribute(key);\r\n\r\n\t\t\tthis._removeKey(key);\r\n\t\t\tthis.put('keys', this.keys, null, 'dojoxSystemNS');\r\n\t\t\tthis.store.save(this.storeName);\r\n\r\n\t\t},\r\n\r\n\t\tgetNamespaces: function(){ /*string[]*/\r\n\r\n\r\n\t\t\tvar results = [ this.DEFAULT_NAMESPACE];\r\n\r\n\t\t\tvar found = {};\r\n\t\t\tfound[this.DEFAULT_NAMESPACE] = true;\r\n\t\t\tvar tester = /^__([^_]*)_/;\r\n\r\n\t\t\tfor(var i = 0; i < this.keys.length; i++){\r\n\t\t\t\tvar currentKey = this.keys[i];\r\n\t\t\t\tif(tester.test(currentKey) == true){\r\n\t\t\t\t\tvar currentNS = currentKey.match(tester)[1];\r\n\t\t\t\t\tif(typeof found[currentNS] == \"undefined\"){\r\n\t\t\t\t\t\tfound[currentNS] = true;\r\n\t\t\t\t\t\tresults.push(currentNS);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn results;\r\n\r\n\t\t},\r\n\r\n\t\tisPermanent: function(){ /*Boolean*/\r\n\t\t\treturn true;\r\n\t\t},\r\n\r\n\t\tgetMaximumSize: function(){ /* mixed */\r\n\t\t\t// this *might* be more, depending on the zone\r\n\t\t\t// of the current site. But 64k is guaranteed.\r\n\t\t\treturn 64;\r\n\t\t},\r\n\r\n\t\thasSettingsUI: function(){ /*Boolean*/\r\n\t\t\treturn false;\r\n\t\t},\r\n\r\n\t\tisValidKey: function(/*string*/ keyName){ /*Boolean*/\r\n\t\t\tif(keyName === null || keyName === undefined){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\r\n\t\t\treturn /^[0-9A-Za-z_-]*$/.test(keyName);\r\n\t\t},\r\n\r\n\t\tisValidNamespace: function(/*string*/ keyName){ /*Boolean*/\r\n\r\n\t\t\tif(keyName === null || keyName === undefined){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\r\n\t\t\treturn /^[0-9A-Za-z-]*$/.test(keyName);\r\n\t\t},\r\n\r\n\t\tgetFullKey: function(key, namespace){\r\n\t\t\t// checks for valid namespace and\r\n\t\t\t// key are already performed.\r\n\t\t\treturn \"__\" + namespace + \"_\" + key;\r\n\t\t},\r\n\r\n\t\t_beginsWith: function(/* string */ haystack, /* string */ needle) {\r\n\t\t\tif(needle.length > haystack.length) {\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\treturn haystack.substring(0,needle.length) === needle;\r\n\t\t},\r\n\r\n\t\t_assertIsValidNamespace: function(/* string */ namespace){\r\n\t\t\tif(this.isValidNamespace(namespace) === false){\r\n\t\t\t\tthrow new Error(\"Invalid namespace given: \" + namespace);\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\t_assertIsValidKey: function(/* string */ key){\r\n\t\t\tif(this.isValidKey(key) === false){\r\n\t\t\t\tthrow new Error(\"Invalid key given: \" + key);\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\t_addKey: function(key){\r\n\t\t\tthis._removeKey(key);\r\n\t\t\tthis.keys.push(key);\r\n\t\t},\r\n\r\n\t\t_removeKey: function(key){\r\n\t\t\tthis.keys = dojo.filter(this.keys,function(item){ return item !== key;},this);\r\n\t\t}\r\n\t}\r\n);\r\n\r\ndojox.storage.manager.register(\"dojox.storage.BehaviorStorageProvider\", new dojox.storage.BehaviorStorageProvider());"]}