{"version":3,"sources":["sketch/Figure.js"],"names":["define","dojo","experimental","ta","dojox","sketch","tools","registerTool","type","fn","Figure","mixin","self","this","annCounter","shapes","image","imageSrc","size","w","h","surface","group","node","zoomFactor","obj","selected","hasSelections","length","isSelected","i","select","clearSelections","setMode","Annotation","Modes","View","Edit","deselect","idx","splice","replaceSelection","n","o","_c","_ctr","_lp","_action","_prevState","_startPoint","_ctool","_start","_end","_absEnd","_cshape","_dblclick","e","_fromEvt","onDblClickShape","_keydown","prevent","ctrlKey","keyCode","undo","redo","_delete","stopEvent","_md","gfx","renderer","focus","x","pageX","y","pageY","position","scroll","scrollLeft","scrollTop","X","clientX","Y","clientY","_sameShapeSelected","beginEdit","onMouseDown","_mm","shape","dx","dy","setBinding","rect","Math","min","width","abs","height","onMouseMove","_clearMouse","_mu","endEdit","onMouseUp","initUndoStack","p","prototype","history","UndoStack","setTool","t","gridSize","_calCol","v","round","arr","noundo","destroy","remove","_remove","onRemove","onDblClick","onCreateShape","onBeforeCreateShape","initialize","createSurface","createGroup","_cons","es","getEventSource","push","connect","createImage","imageSize","src","isLoading","_subscribed","unsubscribe","forEach","disconnect","empty","nextKey","draw","zoom","pct","setDimensions","setTransform","matrix","scale","getFit","wF","parentNode","offsetWidth","hF","offsetHeight","unzoom","_add","_key","_get","key","indexOf","replace","_keyFromEvt","target","id","add","annotation","getAnnotator","convert","ann","ctor","start","end","control","transform","label","mode","tokenId","token","lang","shallowCopy","setValue","text","xml","DomParser","parse","load","documentElement","parseFloat","getAttribute","g","childrenByName","img","_loadAnnotation","_loadDeferred","callback","onLoad","onClick","a","onUndo","onBeforeUndo","onRedo","onBeforeRedo","serialize","s","getValue"],"mappings":"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","file":"../../sketch/Figure.js","sourcesContent":["define([\r\n\t\"dojo/_base/kernel\",\r\n\t\"dojo/_base/lang\",\r\n\t\"dojo/_base/connect\",\r\n\t\"dojo/_base/html\",\r\n\t\"../gfx\",\r\n\t\"../xml/DomParser\",\r\n\t\"./UndoStack\"\r\n], function(dojo){\r\n\tdojo.experimental(\"dojox.sketch\");\r\n\r\n\tvar ta=dojox.sketch;\r\n\tta.tools={};\r\n\tta.registerTool=function(type, fn){ ta.tools[type]=fn; };\r\n\tta.Figure = function(mixin){\r\n\t\tvar self=this;\r\n\t\tthis.annCounter=1;\r\n\r\n\t\tthis.shapes=[];\r\n\t\tthis.image=null;\r\n\t\tthis.imageSrc=null;\r\n\t\tthis.size={ w:0, h:0 };\r\n\t\tthis.surface=null;\r\n\t\tthis.group=null;\r\n\t\t//node should have tabindex set, otherwise keyboard action does not work\r\n\t\tthis.node=null;\r\n\r\n\t\tthis.zoomFactor=1;\t//\tmultiplier for zooming.\r\n\t\t\r\n\t\tthis.tools=null;\t//\ttoolbar reference.\r\n\r\n\t\tthis.obj={};\t\t//\tlookup table for shapes.  Not keen on this solution.\r\n\r\n\t\tdojo.mixin(this,mixin);\r\n\r\n\t\t//\twhat is selected.\r\n\t\tthis.selected=[];\r\n\t\tthis.hasSelections=function(){ return this.selected.length>0 };\r\n\t\tthis.isSelected=function(obj){\r\n\t\t\tfor(var i=0; i<self.selected.length; i++){\r\n\t\t\t\tif(self.selected[i]==obj){ return true; }\r\n\t\t\t}\r\n\t\t\treturn false;\r\n\t\t};\r\n\t\tthis.select=function(obj){\r\n\t\t\t//\tTODO: deal with multiple vs. single selections.\r\n\t\t\tif(!self.isSelected(obj)){\r\n\t\t\t\t//\tforce single select\r\n\t\t\t\tself.clearSelections();\r\n\t\t\t\tself.selected=[ obj ];\r\n\t\t\t}\r\n\t\t\t//\tforce a bbox update, regardless\r\n\t\t\tobj.setMode(ta.Annotation.Modes.View);\r\n\t\t\tobj.setMode(ta.Annotation.Modes.Edit);\r\n\t\t};\r\n\t\tthis.deselect=function(obj){\r\n\t\t\tvar idx=-1;\r\n\t\t\tfor(var i=0; i<self.selected.length; i++){\r\n\t\t\t\tif(self.selected[i]==obj){\r\n\t\t\t\t\tidx=i;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(idx>-1){\r\n\t\t\t\tobj.setMode(ta.Annotation.Modes.View);\r\n\t\t\t\tself.selected.splice(idx,1);\r\n\t\t\t}\r\n\t\t\treturn obj;\r\n\t\t};\r\n\t\tthis.clearSelections=function(){\r\n\t\t\tfor(var i=0; i<self.selected.length; i++){\r\n\t\t\t\tself.selected[i].setMode(ta.Annotation.Modes.View);\r\n\t\t\t}\r\n\t\t\tself.selected=[];\r\n\t\t};\r\n\t\tthis.replaceSelection=function(n, o){\r\n\t\t\tif(!self.isSelected(o)){\r\n\t\t\t\tself.select(n);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tvar idx=-1;\r\n\t\t\tfor(var i=0; i<self.selected.length; i++){\r\n\t\t\t\tif(self.selected[i]==o){\r\n\t\t\t\t\tidx=i;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(idx>-1){\r\n\t\t\t\tself.selected.splice(idx,1,n);\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\t//\tfor the drag and drop handlers.\r\n\t\tthis._c=null;\t\t//\tcurrent shape\r\n\t\tthis._ctr=null;\t//\tcontainer measurements\r\n\t\tthis._lp=null;\t\t//\tlast position\r\n\t\tthis._action=null;\r\n\t\tthis._prevState=null;\r\n\t\tthis._startPoint=null;\t//\ttest to record a move.\r\n\r\n\t\t//\tif an object isn't selected and we're dragging anyways.\r\n\t\tthis._ctool=null;\t//\thard code it.\r\n\t\tthis._start=null;\r\n\t\tthis._end=null;\r\n\t\tthis._absEnd=null;\r\n\t\tthis._cshape=null;\r\n\r\n\t\tthis._dblclick=function(e){\r\n\t\t\tvar o=self._fromEvt(e);\r\n\t\t\tif(o){\r\n\t\t\t\tself.onDblClickShape(o,e);\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tthis._keydown=function(e){\r\n\t\t\tvar prevent=false;\r\n\t\t\tif(e.ctrlKey){\r\n\t\t\t\tif(e.keyCode===90 || e.keyCode===122){ //ctrl+z\r\n\t\t\t\t\tself.undo();\r\n\t\t\t\t\tprevent = true;\r\n\t\t\t\t}\r\n\t\t\t\telse if(e.keyCode===89 || e.keyCode===121){ //ctrl+y\r\n\t\t\t\t\tself.redo();\r\n\t\t\t\t\tprevent = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(e.keyCode===46 || e.keyCode===8){ //delete or backspace\r\n\t\t\t\tself._delete(self.selected);\r\n\t\t\t\tprevent = true;\r\n\t\t\t}\r\n\r\n\t\t\tif(prevent){\r\n\t\t\t\tdojo.stopEvent(e);\r\n\t\t\t}\r\n\t\t};\r\n\t\r\n\t\t//\tdrag handlers.\r\n\t\tthis._md=function(e){\r\n\t\t\t//in IE, when clicking into the drawing canvas, the node does not get focused,\r\n\t\t\t//do it manually here to force it, otherwise the keydown event listener is\r\n\t\t\t//never triggered in IE.\r\n\t\t\tif(dojox.gfx.renderer=='vml'){\r\n\t\t\t\tself.node.focus();\r\n\t\t\t}\r\n\t\t\tvar o=self._fromEvt(e);\r\n\t\t\tself._startPoint={ x:e.pageX, y:e.pageY };\r\n\r\n\t\t\tself._ctr=dojo.position(self.node);\r\n\t\t\t//\tfigure out the coordinates taking scroll into account\r\n\t\t\tvar scroll={x:self.node.scrollLeft,y:self.node.scrollTop};\r\n\t\t\t//var win = dojo.window.get(self.node.ownerDocument);\r\n\t\t\t//var scroll=dojo.withGlobal(win,dojo._docScroll);\r\n\t\t\tself._ctr={x:self._ctr.x-scroll.x, y:self._ctr.y-scroll.y};\r\n\t\t\tvar X=e.clientX-self._ctr.x, Y=e.clientY-self._ctr.y;\r\n\t\t\tself._lp={ x:X, y:Y };\r\n\r\n\t\t\t//\tcapture it separately\r\n\t\t\tself._start={ x:X, y:Y };\r\n\t\t\tself._end={ x:X, y:Y };\r\n\t\t\tself._absEnd={ x:X, y:Y };\r\n\t\t\tif(!o){\r\n\t\t\t\tself.clearSelections();\r\n\t\t\t\tself._ctool.onMouseDown(e);\r\n\t\t\t}else{\r\n\t\t\t\tif(o.type && o.type()!=\"Anchor\"){\r\n\t\t\t\t\tif(!self.isSelected(o)){\r\n\t\t\t\t\t\tself.select(o);\r\n\t\t\t\t\t\tself._sameShapeSelected=false;\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tself._sameShapeSelected=true;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\to.beginEdit();\r\n\t\t\t\tself._c=o;\r\n\t\t\t}\r\n\t\t};\r\n\t\tthis._mm=function(e){\r\n\t\t\tif(!self._ctr){ return; }\r\n\t\t\tif(self._c && !self._c.shape){\r\n\t\t\t\t//the selected item is gone, cancel editing mode\r\n\t\t\t\tself._clearMouse();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tvar x=e.clientX-self._ctr.x;\r\n\t\t\tvar y=e.clientY-self._ctr.y;\r\n\t\t\tvar dx=x-self._lp.x;\r\n\t\t\tvar dy=y-self._lp.y;\r\n\t\t\tself._absEnd={x:x, y:y};\r\n\t\t\tif(self._c){\r\n\t\t\t\t//self._c.doChange({dx:dx, dy:dy});\r\n\t\t\t\tself._c.setBinding({dx:dx/self.zoomFactor, dy:dy/self.zoomFactor});\r\n\t\t\t\tself._lp={x:x, y:y};\r\n\t\t\t} else {\r\n\t\t\t\tself._end={x:dx, y:dy};\r\n\t\t\t\tvar rect={\r\n\t\t\t\t\tx:Math.min(self._start.x,self._absEnd.x),\r\n\t\t\t\t\ty:Math.min(self._start.y,self._absEnd.y),\r\n\t\t\t\t\twidth:Math.abs(self._start.x-self._absEnd.x),\r\n\t\t\t\t\theight:Math.abs(self._start.y-self._absEnd.y)\r\n\t\t\t\t}\r\n\t\t\t\tif(rect.width && rect.height){\r\n\t\t\t\t\tself._ctool.onMouseMove(e,rect);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\t\tthis._mu=function(e){\r\n\t\t\tif(self._c){\r\n\t\t\t\t//\trecord the event.\r\n\t\t\t\tif(self._c.shape){\r\n\t\t\t\t\tself._c.endEdit(); //make sure it's not deleted\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\tself._ctool.onMouseUp(e);\r\n\t\t\t}\r\n\t\t\tself._clearMouse();\r\n\t\t};\r\n\t\tthis._clearMouse=function(){\r\n\t\t\t//\tclear the stuff out.\r\n\t\t\tself._c=self._ctr=self._lp=self._action=self._prevState=self._startPoint=null;\r\n\t\t\tself._cshape=self._start=self._end=self._absEnd=null;\r\n\t\t};\r\n\r\n\t\tthis.initUndoStack();\r\n\t};\r\n\r\n\tvar p=ta.Figure.prototype;\r\n\tp.initUndoStack=function(){\r\n\t\tthis.history=new ta.UndoStack(this);\r\n\t};\r\n\tp.setTool=function(/*dojox.sketch._Plugin*/t){\r\n\t\tthis._ctool=t;\r\n\t};\r\n    //gridSize: int\r\n    //\t\tif it is greater than 0, all new shapes placed on the drawing will have coordinates\r\n    //\t\tsnapped to the gridSize. For example, if gridSize is set to 10, all coordinates\r\n    //\t\t(only including coordinates which specifies the x/y position of shape are affected\r\n    //\t\tby this parameter) will be dividable by 10\r\n    p.gridSize=0;\r\n    p._calCol=function(v){\r\n        return this.gridSize?(Math.round(v/this.gridSize)*this.gridSize):v;\r\n    };\r\n\tp._delete=function(arr,noundo){\r\n\t\tfor(var i=0; i<arr.length; i++){\r\n\t\t\t//var before=arr[i].serialize();\r\n\t\t\tarr[i].setMode(ta.Annotation.Modes.View);\r\n\t\t\tarr[i].destroy(noundo);\r\n\t\t\tthis.remove(arr[i]);\r\n\t\t\tthis._remove(arr[i]);\r\n\t\t\tif(!noundo){\r\n\t\t\t\tarr[i].onRemove();\r\n\t\t\t}\r\n\t\t}\r\n\t\tarr.splice(0,arr.length);\r\n\t};\r\n\tp.onDblClickShape=function(shape,e){\r\n\t\tif(shape['onDblClick']){\r\n\t\t\tshape.onDblClick(e);\r\n\t\t}\r\n\t};\r\n\r\n\tp.onCreateShape=function(shape){};\r\n\tp.onBeforeCreateShape=function(shape){};\r\n\tp.initialize=function(node){\r\n\t\tthis.node=node;\r\n\t\tthis.surface=dojox.gfx.createSurface(node, this.size.w, this.size.h);\r\n\t\t//this.backgroundRect=this.surface.createRect({ x:0, y:0, width:this.size.w, height:this.size.h })\r\n\t\t//\t.setFill(\"white\");\r\n\t\tthis.group=this.surface.createGroup();\r\n\r\n\t\tthis._cons=[];\r\n\t\tvar es=this.surface.getEventSource();\r\n\t\tthis._cons.push(\r\n\t\t\t//\tkill any dragging events.\r\n\t\t\t//\t\tfor FF\r\n\t\t\tdojo.connect(es, \"ondraggesture\", dojo.stopEvent),\r\n\t\t\tdojo.connect(es, \"ondragenter\", dojo.stopEvent),\r\n\t\t\tdojo.connect(es, \"ondragover\", dojo.stopEvent),\r\n\t\t\tdojo.connect(es, \"ondragexit\", dojo.stopEvent),\r\n\t\t\tdojo.connect(es, \"ondragstart\", dojo.stopEvent),\r\n\t\t\t//\t\tfor IE\r\n\t\t\tdojo.connect(es, \"onselectstart\", dojo.stopEvent),\r\n\t\t\t//\thook up the drag system.\r\n\t\t\tdojo.connect(es, 'onmousedown', this._md),\r\n\t\t\tdojo.connect(es, 'onmousemove', this._mm),\r\n\t\t\tdojo.connect(es, 'onmouseup', this._mu),\r\n\t\t\t// misc hooks\r\n\t\t\tdojo.connect(es, 'onclick', this, 'onClick'),\r\n\t\t\tdojo.connect(es, 'ondblclick', this._dblclick),\r\n\t\t\tdojo.connect(node, 'onkeydown', this._keydown));\r\n\t\t\r\n\t\tthis.image=this.group.createImage({ width:this.imageSize.w, height:this.imageSize.h, src:this.imageSrc });\r\n\t};\r\n\r\n\tp.destroy=function(isLoading){\r\n\t\tif(!this.node){ return; }\r\n\t\tif(!isLoading){\r\n\t\t\tif(this.history){ this.history.destroy(); }\r\n\t\t\tif(this._subscribed){\r\n\t\t\t\tdojo.unsubscribe(this._subscribed);\r\n\t\t\t\tdelete this._subscribed;\r\n\t\t\t}\r\n\t\t}\r\n\t\tdojo.forEach(this._cons, dojo.disconnect);\r\n\t\tthis._cons=[];\r\n\r\n\t\t//TODO: how to destroy a surface properly?\r\n\t\tdojo.empty(this.node);\r\n\r\n\t\t//this.node.removeChild(this.surface.getEventSource());\r\n\t\tthis.group=this.surface=null;\r\n\t\tthis.obj={};\r\n\t\tthis.shapes=[];\r\n\t};\r\n\tp.nextKey=function(){ return \"annotation-\"+this.annCounter++; };\r\n\tp.draw=function(){ };\r\n\tp.zoom=function(pct){\r\n\t\t//\tfirst get the new dimensions\r\n\t\tthis.zoomFactor=pct/100;\r\n\t\tvar w=this.size.w*this.zoomFactor;\r\n\t\tvar h=this.size.h*this.zoomFactor;\r\n\t\tthis.surface.setDimensions(w, h);\r\n\t\t//\tthen scale it.\r\n\t\tthis.group.setTransform(dojox.gfx.matrix.scale(this.zoomFactor, this.zoomFactor));\r\n\r\n\t\tfor(var i=0; i<this.shapes.length; i++){\r\n\t\t\tthis.shapes[i].zoom(this.zoomFactor);\r\n\t\t}\r\n\t};\r\n\tp.getFit=function(){\r\n\t\t//\tassume fitting the parent node.\r\n//\t\tvar box=dojo.html.getContentBox(this.node.parentNode);\r\n\t\t//the following should work under IE and FF, not sure about others though\r\n\t\tvar wF=(this.node.parentNode.offsetWidth-5)/this.size.w;\r\n\t\tvar hF=(this.node.parentNode.offsetHeight-5)/this.size.h;\r\n\t\treturn Math.min(wF, hF)*100;\r\n\t};\r\n\tp.unzoom=function(){\r\n\t\t//\trestore original size.\r\n\t\tthis.zoomFactor=1;\r\n\t\tthis.surface.setDimensions(this.size.w, this.size.h);\r\n\t\tthis.group.setTransform();\r\n\t};\r\n\r\n\t//\tobject registry for drag handling.\r\n\tp._add=function(obj){ this.obj[obj._key]=obj; };\r\n\tp._remove=function(obj){\r\n\t\tif(this.obj[obj._key]){\r\n\t\t\tdelete this.obj[obj._key];\r\n\t\t}\r\n\t};\r\n\tp._get=function(key){\r\n\t\tif(key&&key.indexOf(\"bounding\")>-1){\r\n\t\t\tkey=key.replace(\"-boundingBox\",\"\");\r\n\t\t}else if(key&&key.indexOf(\"-labelShape\")>-1){\r\n\t\t\tkey=key.replace(\"-labelShape\",\"\");\r\n\t\t}\r\n\t\treturn this.obj[key];\r\n\t};\r\n\tp._keyFromEvt=function(e){\r\n\t\tvar key=e.target.id+\"\";\r\n\t\tif(key.length==0){\r\n\t\t\t//\tancestor tree until you get to the end (meaning this.surface)\r\n\t\t\tvar p=e.target.parentNode;\r\n\t\t\tvar node=this.surface.getEventSource();\r\n\t\t\twhile(p && p.id.length==0 && p!=node){\r\n\t\t\t\tp=p.parentNode;\r\n\t\t\t}\r\n\t\t\tkey=p.id;\r\n\t\t}\r\n\t\treturn key;\r\n\t};\r\n\tp._fromEvt=function(e){\r\n\t\treturn this._get(this._keyFromEvt(e));\r\n\t};\r\n\r\n\tp.add=function(annotation){\r\n\t\tfor(var i=0; i<this.shapes.length; i++){\r\n\t\t\tif(this.shapes[i]==annotation){ return true; }\r\n\t\t}\r\n\t\tthis.shapes.push(annotation);\r\n\t\treturn true;\r\n\t};\r\n\tp.remove=function(annotation){\r\n\t\tvar idx=-1;\r\n\t\tfor(var i=0; i<this.shapes.length; i++){\r\n\t\t\tif(this.shapes[i]==annotation){\r\n\t\t\t\tidx=i;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(idx>-1){ this.shapes.splice(idx, 1); }\r\n\t\treturn annotation;\r\n\t};\r\n\tp.getAnnotator=function(id){\r\n\t\tfor(var i=0; i<this.shapes.length; i++){\r\n\t\t\tif(this.shapes[i].id==id) {\r\n\t\t\t\treturn this.shapes[i];\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn null;\r\n\t};\r\n\r\n\tp.convert=function(ann, t){\r\n\t\t//\tconvert an existing annotation to a different kind of annotation\r\n\t\tvar ctor=t+\"Annotation\";\r\n\t\tif(!ta[ctor]){ return; }\r\n\t\tvar type=ann.type(), id=ann.id, label=ann.label, mode=ann.mode, tokenId=ann.tokenId;\r\n\t\tvar start, end, control, transform;\r\n\t\tswitch(type){\r\n\t\t\tcase \"Preexisting\":\r\n\t\t\tcase \"Lead\":{\r\n\t\t\t\ttransform={dx:ann.transform.dx, dy:ann.transform.dy };\r\n\t\t\t\tstart={x:ann.start.x, y:ann.start.y};\r\n\t\t\t\tend={x:ann.end.x, y:ann.end.y };\r\n\t\t\t\tvar cx=end.x-((end.x-start.x)/2);\r\n\t\t\t\tvar cy=end.y-((end.y-start.y)/2);\r\n\t\t\t\tcontrol={x:cx, y:cy};\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase \"SingleArrow\":\r\n\t\t\tcase \"DoubleArrow\":{\r\n\t\t\t\ttransform={dx:ann.transform.dx, dy:ann.transform.dy };\r\n\t\t\t\tstart={x:ann.start.x, y:ann.start.y};\r\n\t\t\t\tend={x:ann.end.x, y:ann.end.y };\r\n\t\t\t\tcontrol={x:ann.control.x, y:ann.control.y};\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase \"Underline\":{\r\n\t\t\t\ttransform={dx:ann.transform.dx, dy:ann.transform.dy };\r\n\t\t\t\tstart={x:ann.start.x, y:ann.start.y};\r\n\t\t\t\tcontrol={x:start.x+50, y:start.y+50 };\r\n\t\t\t\tend={x:start.x+100, y:start.y+100 };\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase \"Brace\":{ }\r\n\t\t}\r\n\t\tvar n=new ta[ctor](this, id);\r\n\r\n\t\tif(n.type()==\"Underline\"){\r\n\t\t\t//\tspecial handling, since we never move the start point.\r\n\t\t\tn.transform={dx:transform.dx+start.x, dy:transform.dy+start.y };\r\n\t\t} else {\r\n\t\t\tif(n.transform){ n.transform=transform; }\r\n\t\t\tif(n.start){ n.start=start; }\r\n\t\t}\r\n\t\tif(n.end){ n.end=end; }\r\n\t\tif(n.control){ n.control=control; }\r\n\t\tn.label=label;\r\n\t\tn.token=dojo.lang.shallowCopy(ann.token);\r\n\t\tn.initialize();\r\n\r\n\t\tthis.replaceSelection(n, ann);\r\n\t\tthis._remove(ann);\r\n\t\tthis.remove(ann);\r\n\t\tann.destroy();\r\n\r\n\t\t//\tthis should do all the things we need it to do for getting it registered.\r\n\t\tn.setMode(mode);\r\n\t};\r\n\tp.setValue=function(text){\r\n\t\tvar obj=dojox.xml.DomParser.parse(text);\r\n\t\tvar node=this.node;\r\n\t\tthis.load(obj,node);\r\n\t\t//this.zoom(this.zoomFactor*100); //zoom to original scale\r\n\t};\r\n\tp.load=function(obj, n){\r\n\t\t//\tcreate from pseudo-DOM\r\n\t\tif(this.surface){ this.destroy(true); }\r\n\t\tvar node=obj.documentElement;\t//\tshould be either the document or the docElement\r\n\t\tthis.size={\r\n\t\t\tw:parseFloat(node.getAttribute('width'),10),\r\n\t\t\th:parseFloat(node.getAttribute('height'),10)\r\n\t\t};\r\n\t\tvar g=node.childrenByName(\"g\")[0];\r\n\t\tvar img=g.childrenByName(\"image\")[0];\r\n\t\tthis.imageSize={\r\n\t\t\tw:parseFloat(img.getAttribute('width'),10),\r\n\t\t\th:parseFloat(img.getAttribute('height'),10)\r\n\t\t};\r\n\t\tthis.imageSrc=img.getAttribute(\"xlink:href\");\r\n\t\tthis.initialize(n);\r\n\r\n\t\t//\tnow let's do the annotations.\r\n\t\tvar ann=g.childrenByName(\"g\");\r\n\t\tfor(var i=0; i<ann.length; i++){ this._loadAnnotation(ann[i]); }\r\n\t\tif(this._loadDeferred){\r\n\t\t\tthis._loadDeferred.callback(this);\r\n\t\t\tthis._loadDeferred=null;\r\n\t\t}\r\n\t\tthis.onLoad();\r\n\t};\r\n\tp.onLoad=function(){};\r\n\tp.onClick=function(){};\r\n\tp._loadAnnotation=function(obj){\r\n\t\tvar ctor=obj.getAttribute('dojoxsketch:type')+\"Annotation\";\r\n\t\tif(ta[ctor]){\r\n\t\t\tvar a=new ta[ctor](this, obj.id);\r\n\t\t\ta.initialize(obj);\r\n\t\t\tthis.nextKey();\r\n\t\t\ta.setMode(ta.Annotation.Modes.View);\r\n\t\t\tthis._add(a);\r\n\t\t\treturn a;\r\n\t\t}\r\n\t\treturn null;\r\n\t};\r\n\t\r\n\tp.onUndo=function(){};\r\n\tp.onBeforeUndo=function(){};\r\n\tp.onRedo=function(){};\r\n\tp.onBeforeRedo=function(){};\r\n\tp.undo=function(){\r\n\t\tif(this.history){\r\n\t\t\tthis.onBeforeUndo();\r\n\t\t\tthis.history.undo();\r\n\t\t\tthis.onUndo();\r\n\t\t}\r\n\t};\r\n\tp.redo=function(){\r\n\t\tif(this.history){\r\n\t\t\tthis.onBeforeRedo();\r\n\t\t\tthis.history.redo();\r\n\t\t\tthis.onRedo();\r\n\t\t}\r\n\t};\r\n\tp.serialize=function(){\r\n\t\tvar s='<svg xmlns=\"http://www.w3.org/2000/svg\" '\r\n\t\t\t+ 'xmlns:xlink=\"http://www.w3.org/1999/xlink\" '\r\n\t\t\t+ 'xmlns:dojoxsketch=\"http://dojotoolkit.org/dojox/sketch\" '\r\n\t\t\t+ 'width=\"' + this.size.w + '\" height=\"' + this.size.h + '\">'\r\n\t\t\t+ '<g>'\r\n\t\t\t+ '<image xlink:href=\"' + this.imageSrc + '\" x=\"0\" y=\"0\" width=\"'\r\n\t\t\t+ this.size.w + '\" height=\"' + this.size.h + '\" />';\r\n\t\tfor(var i=0; i<this.shapes.length; i++){ s+= this.shapes[i].serialize(); }\r\n\t\ts += '</g></svg>';\r\n\t\treturn s;\r\n\t};\r\n\tp.getValue=p.serialize;\r\n\r\n\treturn dojox.sketch.Figure;\r\n});\r\n"]}