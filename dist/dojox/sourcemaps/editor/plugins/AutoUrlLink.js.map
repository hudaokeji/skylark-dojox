{"version":3,"sources":["editor/plugins/AutoUrlLink.js"],"names":["define","dojo","dijit","dojox","_Plugin","AutoUrlLink","declare","_template","setEditor","editor","this","isIE","some","_plugins","plugin","isInstanceOf","_editor","plugins","EnterKeyHandling","blockNodeForEnter","connect","_keyPress","evt","ks","keys","kc","keyCode","cc","charCode","SPACE","ctrlKey","setTimeout","hitch","ENTER","_recognize","enter","_saved","window","getSelection","anchorNode","args","template","isEnter","ed","selection","console","log","_findLastEditingNode","node","bm","bmOff","anchorOffset","nodeType","_inLink","item","linked","result","_findUrls","range","document","createRange","cost","isSameNode","shift","setStart","start","setEnd","end","removeAllRanges","addRange","execCommand","string","substitute","url","toString","_sCall","e","editNode","parentNode","tagName","toLowerCase","blockNode","blockTagNames","BlockTagNames","getBlockAncestor","toUpperCase","previousSibling","match","lastChild","trim","nodeValue","ch","pattern","list","baseIndex","value","length","substr","exec","index","charAt","push","subscribe","_scopeName","o","name"],"mappings":"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","file":"../../../editor/plugins/AutoUrlLink.js","sourcesContent":["define([\r\n\t\"dojo\",\r\n\t\"dijit\",\r\n\t\"dojox\",\r\n\t\"dijit/_editor/_Plugin\",\r\n\t\"dijit/form/Button\",\r\n\t\"dojo/_base/declare\",\r\n\t\"dojo/string\"\r\n], function(dojo, dijit, dojox, _Plugin) {\r\n\r\nvar AutoUrlLink = dojo.declare(\"dojox.editor.plugins.AutoUrlLink\", [_Plugin], {\r\n\t// summary:\r\n\t//\t\tThis plugin can recognize a URL like string\r\n\t//\t\t(such as http://www.website.com) and turn it into\r\n\t//\t\ta hyperlink that points to that URL.\r\n\t\r\n\t// _template: [private] String\r\n\t//\t\tThe link template\r\n\t_template: \"<a _djrealurl='${url}' href='${url}'>${url}</a>\",\r\n\t\r\n\tsetEditor: function(/*dijit.Editor*/ editor){\r\n\t\t// summary:\r\n\t\t//\t\tCalled by the editor it belongs to.\r\n\t\t// editor:\r\n\t\t//\t\tThe editor it belongs to.\r\n\t\tthis.editor = editor;\r\n\t\tif(!dojo.isIE){\r\n\t\t\t// IE will recognize URL as a link automatically\r\n\t\t\t// No need to re-invent the wheel.\r\n\t\t\tdojo.some(editor._plugins, function(plugin){\r\n\t\t\t\t// Need to detect which enter key mode it is now\r\n\t\t\t\tif(plugin.isInstanceOf(dijit._editor.plugins.EnterKeyHandling)){\r\n\t\t\t\t\tthis.blockNodeForEnter = plugin.blockNodeForEnter;\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t\treturn false;\r\n\t\t\t}, this);\r\n\t\t\tthis.connect(editor, \"onKeyPress\", \"_keyPress\");\r\n\t\t\tthis.connect(editor, \"onClick\", \"_recognize\");\r\n\t\t\tthis.connect(editor, \"onBlur\", \"_recognize\");\r\n\t\t}\r\n\t},\r\n\t\r\n\t_keyPress: function(evt){\r\n\t\t// summary:\r\n\t\t//\t\tHandle the keypress event and dispatch it to the target handler\r\n\t\t// evt:\r\n\t\t//\t\tThe keypress event object.\r\n\t\t// tags:\r\n\t\t//\t\tprotected\r\n\t\tvar ks = dojo.keys, v = 118, V = 86,\r\n\t\t\tkc = evt.keyCode, cc = evt.charCode;\r\n\t\tif(cc == ks.SPACE || (evt.ctrlKey && (cc == v || cc == V))){\r\n\t\t\tsetTimeout(dojo.hitch(this, \"_recognize\"), 0);\r\n\t\t}else if(kc == ks.ENTER){\r\n\t\t\t// Handle the enter event after EnterKeyHandling finishes its job\r\n\t\t\tsetTimeout(dojo.hitch(this, function(){\r\n\t\t\t\tthis._recognize({enter: true});\r\n\t\t\t}), 0);\r\n\t\t}else{\r\n\t\t\t// _saved: The previous dom node when the cursor is at a new dom node.\r\n\t\t\t// When we click elsewhere, the previous dom node\r\n\t\t\t// should be examed to see if there is any URL need to be activated\r\n\t\t\tthis._saved = this.editor.window.getSelection().anchorNode;\r\n\t\t}\r\n\t},\r\n\t\r\n\t_recognize: function(args){\r\n\t\t// summary:\r\n\t\t//\t\tRecognize the URL like strings and turn them into a link\r\n\t\t// tags:\r\n\t\t//\t\tprivate\r\n\t\tvar template = this._template,\r\n\t\t\tisEnter = args ? args.enter : false,\r\n\t\t\ted = this.editor,\r\n\t\t\tselection = ed.window.getSelection();\r\n\t\tconsole.log(\"_recognize: isEnter = \", isEnter, \", selection is \", selection,  selection.anchorNode, this._findLastEditingNode(selection.anchorNode))\r\n\t\t\tif(selection){\r\n\t\t\t\tvar node = isEnter ? this._findLastEditingNode(selection.anchorNode) :\r\n\t\t\t\t\t\t\t\t(this._saved || selection.anchorNode),\r\n\t\t\t\tbm = this._saved = selection.anchorNode,\r\n\t\t\t\tbmOff = selection.anchorOffset;\r\n\t\t\t\r\n\t\t\tif(node.nodeType == 3 && !this._inLink(node)){\r\n\t\t\t\tvar linked = false, result = this._findUrls(node, bm, bmOff),\r\n\t\t\t\t\trange = ed.document.createRange(),\r\n\t\t\t\t\titem, cost = 0, isSameNode = (bm == node);\r\n\t\t\t\t\t\t\r\n\t\t\t\titem = result.shift();\r\n\t\t\t\twhile(item){\r\n\t\t\t\t\t// Covert a URL to a link.\r\n\t\t\t\t\trange.setStart(node, item.start);\r\n\t\t\t\t\trange.setEnd(node, item.end);\r\n\t\t\t\t\tselection.removeAllRanges();\r\n\t\t\t\t\tselection.addRange(range);\r\n\t\t\t\t\ted.execCommand(\"insertHTML\", dojo.string.substitute(template, {url: range.toString()}));\r\n\t\t\t\t\tcost += item.end;\r\n\t\t\t\t\titem = result.shift();\r\n\t\t\t\t\tlinked = true;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// If bm and node are the some dom node, caculate the actual bookmark offset\r\n\t\t\t\t// If the position of the cursor is modified (turned into a link, etc.), no\r\n\t\t\t\t// need to recover the cursor position\r\n\t\t\t\tif(isSameNode && (bmOff = bmOff - cost) <= 0){ return; }\r\n\t\r\n\t\t\t\t// We didn't update anything, so don't collapse selections.\r\n\t\t\t\tif(!linked) { return ; }\r\n\t\t\t\ttry{\r\n\t\t\t\t\t// Try to recover the cursor position\r\n\t\t\t\t\trange.setStart(bm, 0);\r\n\t\t\t\t\trange.setEnd(bm, bmOff);\r\n\t\t\t\t\tselection.removeAllRanges();\r\n\t\t\t\t\tselection.addRange(range);\r\n\t\t\t\t\ted._sCall(\"collapse\", []);\r\n\t\t\t\t}catch(e){}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\t\r\n\t_inLink: function(/*DomNode*/ node){\r\n\t\t// summary:\r\n\t\t//\t\tCheck if the node is already embraced within a `<a>...</a>` tag.\r\n\t\t// node:\r\n\t\t//\t\tThe node to be examined.\r\n\t\t// tags:\r\n\t\t//\t\tprivate\r\n\t\tvar editNode = this.editor.editNode,\r\n\t\t\tresult = false, tagName;\r\n\t\t\t\r\n\t\tnode = node.parentNode;\r\n\t\twhile(node && node !== editNode){\r\n\t\t\ttagName = node.tagName ? node.tagName.toLowerCase() : \"\";\r\n\t\t\tif(tagName == \"a\"){\r\n\t\t\t\tresult = true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tnode = node.parentNode;\r\n\t\t}\r\n\t\treturn result;\r\n\t},\r\n\t\r\n\t_findLastEditingNode: function(/*DomNode*/ node){\r\n\t\t// summary:\r\n\t\t//\t\tFind the last node that was edited so that we can\r\n\t\t//\t\tget the last edited text.\r\n\t\t// node:\r\n\t\t//\t\tThe current node that the cursor is at.\r\n\t\t// tags:\r\n\t\t//\t\tprivate\r\n\t\tvar blockTagNames = dijit.range.BlockTagNames,\r\n\t\t\teditNode = this.editor.editNode, blockNode;\r\n\r\n\t\tif(!node){ return node; }\r\n\t\tif(this.blockNodeForEnter == \"BR\" &&\r\n\t\t\t\t(!(blockNode = dijit.range.getBlockAncestor(node, null, editNode).blockNode) ||\r\n\t\t\t\tblockNode.tagName.toUpperCase() != \"LI\")){\r\n\t\t\twhile((node = node.previousSibling) && node.nodeType != 3){}\r\n\t\t}else{\r\n\t\t\t// EnterKeyHandling is under \"DIV\" or \"P\" mode or\r\n\t\t\t// it's in a LI element. Find the last editing block\r\n\t\t\tif((blockNode || (blockNode = dijit.range.getBlockAncestor(node, null, editNode).blockNode)) &&\r\n\t\t\t\t\tblockNode.tagName.toUpperCase() == \"LI\"){\r\n\t\t\t\tnode = blockNode;\r\n\t\t\t}else{\r\n\t\t\t\tnode = dijit.range.getBlockAncestor(node, null, editNode).blockNode;\r\n\t\t\t}\r\n\t\t\t// Find the last editing text node\r\n\t\t\twhile((node = node.previousSibling) && !(node.tagName && node.tagName.match(blockTagNames))){}\r\n\t\t\tif(node){\r\n\t\t\t\tnode = node.lastChild;\r\n\t\t\t\twhile(node){\r\n\t\t\t\t\tif(node.nodeType == 3 && dojo.trim(node.nodeValue) != \"\"){\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}else if(node.nodeType == 1){\r\n\t\t\t\t\t\tnode = node.lastChild;\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tnode = node.previousSibling;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn node;\r\n\t},\r\n\t\r\n\t_findUrls: function(/*DomNode*/ node, /*DomNode*/ bm, /*Number*/ bmOff){\r\n\t\t// summary:\r\n\t\t//\t\tFind the occurrace of the URL strings.\r\n\t\t//\t\tFF, Chrome && Safri have a behavior that when insertHTML is executed,\r\n\t\t//\t\tthe original referrence to the text node will be the text node next to\r\n\t\t//\t\tthe inserted anchor automatically. So we have to re-caculate the index of\r\n\t\t//\t\tthe following URL occurrence.\r\n\t\t// value:\r\n\t\t//\t\tA text to be scanned.\r\n\t\t// tags:\r\n\t\t//\t\tprivate\r\n\t\tvar pattern = /(http|https|ftp):\\/\\/[^\\s]+/ig,\r\n\t\t\tlist = [], baseIndex = 0,\r\n\t\t\tvalue = node.nodeValue, result, ch;\r\n\t\t\r\n\t\tif(node === bm && bmOff < value.length){\r\n\t\t\t// Break the text so that it may not grab extra words.\r\n\t\t\t// Such as if you type:\r\n\t\t\t// foo http://foo.com|bar (And | is where you press enter).\r\n\t\t\t// It will grab the bar word as part of the link. That's annoying/bad.\r\n\t\t\t// Also it prevents recognizing the text after the cursor.\r\n\t\t\tvalue = value.substr(0, bmOff);\r\n\t\t}\r\n\t\t\r\n\t\twhile((result = pattern.exec(value)) != null){\r\n\t\t\tif(result.index == 0 || (ch = value.charAt(result.index - 1)) == \" \" || ch == \"\\xA0\"){\r\n\t\t\t\tlist.push({start: result.index - baseIndex, end: result.index + result[0].length - baseIndex});\r\n\t\t\t\tbaseIndex = result.index + result[0].length;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn list;\r\n\t}\r\n});\r\n\r\n// Register this plugin.\r\ndojo.subscribe(dijit._scopeName + \".Editor.getPlugin\",null,function(o){\r\n\tif(o.plugin){ return; }\r\n\tvar name = o.args.name.toLowerCase();\r\n\tif(name ===  \"autourllink\"){\r\n\t\to.plugin = new AutoUrlLink();\r\n\t}\r\n});\r\n\r\nreturn AutoUrlLink;\r\n\r\n});\r\n"]}