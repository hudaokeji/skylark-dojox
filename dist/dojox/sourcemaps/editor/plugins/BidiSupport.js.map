{"version":3,"sources":["editor/plugins/BidiSupport.js"],"names":["define","declare","array","aspect","lang","domAttr","domClass","domConstruct","i18n","listDom","listTraverse","domStyle","has","query","dijit","dojox","_Plugin","rangeapi","EnterKeyHandling","FontChoice","NormIndentOutdent","ToggleButton","BidiSupport","useDefaultCommand","buttonClass","iconClassPrefix","command","blockMode","shortcutonly","bogusHtmlContent","buttonLtr","buttonRtl","_indentBy","_lineTextArray","_lineStyledTextArray","_tableContainers","_blockContainers","_initButton","this","_createButton","direction","mixin","label","getLocalization","dir","editor","showLabel","iconClass","onClick","hitch","params","setToolbar","toolbar","isLeftToRight","addChild","updateState","isLoaded","set","disabled","sel","getSelection","window","rangeCount","node","range","getRangeAt","startContainer","editNode","hasChildNodes","startNode","startOffset","_isBlockElement","childNodes","length","_getBlockAncestor","cDir","get","setEditor","contentPreFilters","push","_preFilterNewLines","postDomFilterSetDirExplicitly","_changeStateOfBlocks","contentDomPostFilters","_justifyleftImpl","_changeState","_justifyrightImpl","_justifycenterImpl","_insertorderedlistImpl","_insertunorderedlistImpl","_indentImpl","_outdentImpl","_formatblockImpl","onLoadDeferred","addCallback","i","p","edPlugins","_plugins","ind","h","hl","hr","addKeyHandler","constructor","destroy","_normalizeIndentOutdent","own","before","button","addPlugin","ctor","blockNodeForEnter","blockNodes","after","_checkNewLine","curBlock","getBlockAncestor","blockNode","innerHTML","previousSibling","style","cssText","_handleNoFormat","choice","arguments","_execNativeCmd","cmd","arg","info","_isSimpleInfo","result","document","execCommand","prev","forEach","x","arr","_hasTag","parentNode","removeChild","tempRange","cloneRange","endContainer","endOffset","groups","group","eOffs","setStart","setEnd","removeAllRanges","addRange","table","selection","getParentOfType","returnValue","focus","internalRange","e","_insertLists","_cleanLists","_mergeLists","_indentAndOutdent","oldValue","queryCommandValue","_formatBlocks","charAt","endNode","isCollapsed","_hasTagFrom","_getClosestBlock","supList","nodeType","nodeValue","commonAncestor","getCommonAncestor","nodesInfo","display","_isInlineOrTextElement","_isElement","_isBlockWithText","point","firstSibling","lastSibling","parent","createOwnBlock","removeOffset","sibling","nextSibling","origStartOffset","origEndOffset","origStartContainer","origEndContainer","divs","_repackInlineElements","div","nodes","firstChild","_rebuildBlock","lastChild","_collectNodes","cells","toString","_execDirAndAlignment","_prepareLists","_execInsertLists","_prepareOutdent","_prepareIndent","_execIndent","_execOutdent","_execNormalizedIndent","_execNormalizedOutdent","_prepareFormat","_execFormatBlocks","console","error","onDisplayChanged","curTD","saveNodesAndGroups","cell","supLI","nd","unshift","curDir","getComputedStyle","realDir","curAlign","textAlign","marginLeft","isNaN","parseInt","marginRight","remove","indexOf","_refineLIMargins","margin","level","tNode","_getMargins","styleMargin","cMargin","cIndent","tagName","align","_refineAlignment","idx","listTD","first","last","index","_getParentFrom","create","tempRole","styledSpan","name","_tag","_hasStyledTextLineTag","savedName","place","bogusFormat","_isListTypeChanged","val","_getLIIndent","span","_getLILevel","bogusIEFormat","mLeft","_getIntStyleValue","mRight","leftMargin","rightMargin","trim","contains","child","toUpperCase","pre","nDiv","insertBefore","appendChild","_recountLIMargins","hasBogusSpan","indentWithMargin","hasBogusAlign","marginVal","mStyle","mVal","bogusStyles","split","savedStyles","j","tag","block","pDiv","offs","indent","supBq","isFormatted","marginStyle","ownerDocument","createElement","isNan","hasOwnBlock","newDiv","cssTxt","isEditNode","replaceChild","tSibling","html","inPre","search","replace","join","liDir","pDir","addValue","valPx","parentMargin","_getListMargins","newList","reselect","wasMerged","wasMoved","registry","args"],"mappings":"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","file":"../../../editor/plugins/BidiSupport.js","sourcesContent":["define([\r\n\t\"dojo/_base/declare\",\r\n\t\"dojo/_base/array\",\r\n\t\"dojo/aspect\",\r\n\t\"dojo/_base/lang\",\r\n\t\"dojo/dom-attr\",\r\n\t\"dojo/dom-class\",\r\n\t\"dojo/dom-construct\",\r\n\t\"dojo/i18n\",\r\n\t\"dojo/NodeList-dom\",\r\n\t\"dojo/NodeList-traverse\",\r\n\t\"dojo/dom-style\",\r\n\t\"dojo/sniff\",\r\n\t\"dojo/query\",\r\n\t\"dijit\",\r\n\t\"dojox\",\r\n\t\"dijit/_editor/_Plugin\",\r\n\t\"dijit/_editor/range\",\r\n\t\"dijit/_editor/plugins/EnterKeyHandling\",\r\n\t\"dijit/_editor/plugins/FontChoice\",\r\n\t\"./NormalizeIndentOutdent\",\r\n\t\"dijit/form/ToggleButton\",\r\n\t\"dojo/i18n!./nls/BidiSupport\"\r\n], function(declare,array,aspect,lang,domAttr,domClass,domConstruct,i18n,listDom,listTraverse,domStyle,has,query,dijit,dojox,_Plugin,rangeapi,EnterKeyHandling,FontChoice,NormIndentOutdent,ToggleButton){\r\n\r\n\t// module:\r\n\t//\t\trtebidi/BidiSupport\r\n\t\r\n\tvar BidiSupport = declare(\"dojox.editor.plugins.BidiSupport\", _Plugin, {\r\n\t\t// summary:\r\n\t\t//\t\tThis plugin provides some advanced BiDi support for \r\n\t\t//\t\trich text editing widget. It adds several bidi-specific commands,\r\n\t\t//\t\twhich are not released in native RTE's ('set text direction to left-to-right', \r\n\t\t//\t\t'set text direction to right-to-left', 'change text direction to opposite') \r\n\t\t//\t\tand overrides some existing native commands.\r\n\t\t\r\n\t\t// Override _Plugin.useDefaultCommand.\r\n\t\tuseDefaultCommand: false,\r\n\t\t\r\n\t\t// Override _Plugin.buttonClass. Plugin uses two buttons, defined below.\r\n\t\tbuttonClass: null,\r\n\r\n\t\t// iconClassPrefix: [const] String\r\n\t\t//\t\tThe CSS class name for the button node icon.\r\n\t\ticonClassPrefix: \"dijitAdditionalEditorIcon\",\r\n\r\n\t\tcommand: \"bidiSupport\",\r\n\r\n\t\t// blockMode: [const] String\r\n\t\t//\t\tThis property decides the behavior of Enter key, actually released by EnterKeyHandling \r\n\t\t//\t\tplugin. Possible values are 'P' and 'DIV'. Used when EnterKeyHandling isn't included \r\n\t\t//\t\tinto the list of the base plugins, loaded with the current Editor, as well as in case,  \r\n\t\t//\t\tif blockNodeForEnter property of EnterKeyHandling plugin isn't set to 'P' or 'DIV'.\r\n\t\t//\t\tThe default value is \"DIV\".\r\n\t\tblockMode: \"DIV\",\r\n\r\n\t\t// shortcutonly: [const] Boolean\r\n\t\t//\t\tIf this property is set to 'false', plugin handles all text direction commands\r\n\t\t//\t\tand its behavior is controlled both by buttons and by shortcut (Ctrl+Shift+X). \r\n\t\t//\t\tIn opposite case only command 'change text direction to opposite', controlled by shortcut, \r\n\t\t//\t\tis supported, and buttons don't appear in the toolbar.\r\n\t\t//\t\tDefaults to false.\r\n\t\tshortcutonly: false,\r\n\r\n\t\t// bogusHtmlContent: [private] String\r\n\t\t//\t\tHTML to stick into a new empty block\t\r\n\t\tbogusHtmlContent: '&nbsp;',\r\n\r\n\t\t// buttonLtr: [private] dijit/form/ToggleButton\r\n\t\t//\t\tUsed to set direction of the selected text to left-to-right.\r\n\t\tbuttonLtr: null,\r\n\t\t\r\n\t\t// buttonRtl: [private] dijit/form/ToggleButton\r\n\t\t//\t\tUsed to set direction of the selected text to right-to-left.\r\n\t\tbuttonRtl: null,\r\n\r\n\t\t_indentBy: 40,\r\n\t\t_lineTextArray: [\"DIV\",\"P\",\"LI\",\"H1\",\"H2\",\"H3\",\"H4\",\"H5\",\"H6\",\"ADDRESS\",\"PRE\",\"DT\",\"DE\",\"TD\"],\r\n\t\t_lineStyledTextArray: [\"H1\",\"H2\",\"H3\",\"H4\",\"H5\",\"H6\",\"ADDRESS\",\"PRE\",\"P\"],\r\n\t\t_tableContainers: [\"TABLE\",\"THEAD\",\"TBODY\",\"TR\"],\r\n\t\t_blockContainers: [\"TABLE\",\"OL\",\"UL\",\"BLOCKQUOTE\"],\r\n\t\t\r\n\t\t_initButton: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tOverride _Plugin._initButton(). Creates two buttons, used for\r\n\t\t\t//\t\tsetting text direction to left-to-right and right-to-left.\r\n\t\t\tif(this.shortcutonly){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif(!this.buttonLtr){\r\n\t\t\t\tthis.buttonLtr = this._createButton(\"ltr\");\r\n\t\t\t}\r\n\t\t\tif(!this.buttonRtl){\t\t\r\n\t\t\t\tthis.buttonRtl = this._createButton(\"rtl\");\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\t_createButton: function(direction){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tInitialize specific button. \r\n\t\t\treturn ToggleButton(lang.mixin({\r\n\t\t\t\tlabel: i18n.getLocalization(\"dojox.editor.plugins\", \"BidiSupport\")[direction],\r\n\t\t\t\tdir: this.editor.dir,\r\n\t\t\t\tlang: this.editor.lang,\r\n\t\t\t\tshowLabel: false,\r\n\t\t\t\ticonClass: this.iconClassPrefix+\" \"+this.iconClassPrefix + (direction == \"ltr\"? \"ParaLeftToRight\" : \"ParaRightToLeft\"),\r\n\t\t\t\tonClick: lang.hitch(this, \"_changeState\", [direction])\r\n\t\t\t}, this.params || {}));\t\t\t\r\n\t\t},\r\n\r\n\t\tsetToolbar: function(/*dijit.Toolbar*/ toolbar){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tOverride _Plugin.setToolbar(). Adds buttons so, that 'ltr' button \r\n\t\t\t//\t\twill appear from the left of 'rtl' button regardless of the editor's \r\n\t\t\t//\t\torientation.\r\n\t\t\tif(this.shortcutonly){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif(this.editor.isLeftToRight()){\r\n\t\t\t\ttoolbar.addChild(this.buttonLtr);\r\n\t\t\t\ttoolbar.addChild(this.buttonRtl);\r\n\t\t\t}else{\r\n\t\t\t\ttoolbar.addChild(this.buttonRtl);\r\n\t\t\t\ttoolbar.addChild(this.buttonLtr);\t\t\t\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\tupdateState: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tOverride _Plugin.updateState(). Determines direction of the text in the \r\n\t\t\t//\t\tstart point of the current selection. Changes state of the buttons\r\n\t\t\t//\t\tcorrespondingly.\r\n\t\t\tif(!this.editor || !this.editor.isLoaded || this.shortcutonly){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tthis.buttonLtr.set(\"disabled\", !!this.disabled);\r\n\t\t\tthis.buttonRtl.set(\"disabled\", !!this.disabled);\r\n\t\t\tif(this.disabled){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tvar sel = rangeapi.getSelection(this.editor.window);\r\n\t\t\tif(!sel || sel.rangeCount == 0){\r\n\t\t\t\treturn;\r\n\t\t\t}\t\r\n\t\t\tvar range = sel.getRangeAt(0), node;\r\n\t\t\tif(range.startContainer === this.editor.editNode && !range.startContainer.hasChildNodes()){\r\n\t\t\t\tnode = range.startContainer;\r\n\t\t\t}else{\r\n\t\t\t\tvar startNode = range.startContainer,\r\n\t\t\t\t\tstartOffset = range.startOffset;\r\n\t\t\t\tif(this._isBlockElement(startNode)){\r\n\t\t\t\t\twhile(startNode.hasChildNodes()){\r\n\t\t\t\t\t\tif(startOffset == startNode.childNodes.length){\r\n\t\t\t\t\t\t\tstartOffset--;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tstartNode = startNode.childNodes[startOffset];\r\n\t\t\t\t\t\tstartOffset = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tnode = this._getBlockAncestor(startNode);\r\n\t\t\t}\r\n\t\t\tvar cDir = domStyle.get(node,\"direction\");\r\n\t\t\tthis.buttonLtr.set(\"checked\", \"ltr\" == cDir);\r\n\t\t\tthis.buttonRtl.set(\"checked\", \"rtl\" == cDir);\r\n\t\t},\r\n\t\t\r\n\t\tsetEditor: function(/*dijit.Editor*/ editor){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tOverride _Plugin.setEditor().\r\n\t\t\t// description:\r\n\t\t\t//\t\tSets editor's flag 'advancedBidi' to true, which may be used by other plugins \r\n\t\t\t//\t\tas a switch to bidi-specific behaviour. Adds bidi-specific filters, including \r\n\t\t\t//\t\tpostDom filter, which provides explicit direction settings for the blocks \r\n\t\t\t//\t\tof the text, direction of which isn't defined. Overrides some native commands,\r\n\t\t\t//\t\twhich should be changed or expanded in accordance with bidi-specific needs.\r\n\t\t\t//\t\tLoads EnterKeyHandling plugin, if it was not loaded, and changes its \r\n\t\t\t//\t\tblockNodeForEnter property, if it is needed. Defines shortcut, which will cause\r\n\t\t\t//\t\texecution of 'change text direction to opposite' ('mirror') command.\r\n\t\t\tthis.editor = editor;\r\n\t\t\tif(this.blockMode != \"P\" && this.blockMode != \"DIV\"){\r\n\t\t\t\tthis.blockMode = \"DIV\";\r\n\t\t\t}\r\n\t\t\tthis._initButton();\r\n\t\t\tvar isLtr = this.editor.dir == \"ltr\";\r\n\t\t\t// FF: RTL-oriented DIV's, containing new lines and/or tabs,  can't be converted to lists (exception in native execCommand)\r\n\t\t\t// Delete new lines and tabs from everywhere excluding contents of PRE elements.\r\n\t\t\tthis.editor.contentPreFilters.push(this._preFilterNewLines);\r\n\t\t\t// Explicit direction setting\r\n\t\t\tvar postDomFilterSetDirExplicitly = lang.hitch(this, function(node){\t\t\t\r\n\t\t\t\tif(this.disabled || !node.hasChildNodes()){\r\n\t\t\t\t\treturn node;\r\n\t\t\t\t}\r\n\t\t\t\tthis._changeStateOfBlocks(this.editor.editNode, this.editor.editNode, this.editor.editNode, \"explicitdir\", null);\r\n\t\t\t\treturn this.editor.editNode;\r\n\t\t\t});\r\n\t\t\tthis.editor.contentDomPostFilters.push(postDomFilterSetDirExplicitly);\r\n\t\t\t// FF: Native change alignment command for more then one DIV doesn't change actually alignment, but damages \r\n\t\t\t// markup so, that selected DIV's are converted into sequence of text elements, separated by <br>'s.\r\n\t\t\t// Override native command\r\n\t\t\tthis.editor._justifyleftImpl = lang.hitch(this, function(){\r\n\t\t\t\tthis._changeState(\"left\");\r\n\t\t\t\treturn true;\r\n\t\t\t});\r\n\t\t\tthis.editor._justifyrightImpl = lang.hitch(this, function(){\r\n\t\t\t\tthis._changeState(\"right\");\r\n\t\t\t\treturn true;\r\n\t\t\t});\r\n\t\t\tthis.editor._justifycenterImpl = lang.hitch(this, function(){\r\n\t\t\t\tthis._changeState(\"center\");\r\n\t\t\t\treturn true;\r\n\t\t\t});\r\n\t\t\t// FF:\tWhen blocks are converted into list items, their attributes are lost.\r\n\t\t\t// IE:\t1)Instead of converting regular block into list item, IE includes block into the newly created item,\r\n\t\t\t//\t\tso attributes and styles don't appear in the item.\r\n\t\t\t//\t\t2)IE always converts list item into <P>.\r\n\t\t\t// Expand native command\t\t\r\n\t\t\tthis.editor._insertorderedlistImpl = lang.hitch(this, \"_insertLists\", \"insertorderedlist\"); \r\n\t\t\tthis.editor._insertunorderedlistImpl = lang.hitch(this, \"_insertLists\", \"insertunorderedlist\");\r\n\r\n\t\t\t// IE:\tDirection of newly created blockquotes is set explicitly,\r\n\t\t\t//\t\twhich creates problems for further editing of the text.\r\n\t\t\t//\tExpand native command\r\n\t\t\tthis.editor._indentImpl = lang.hitch(this, \"_indentAndOutdent\", \"indent\");\r\n\t\t\t\r\n\t\t\t// FF:\tOutdent for the list items from the first level's list converts them into sequence of \r\n\t\t\t//\t\ttext elements, separated by <BR>s. Attributes of list items are lost.\r\n\t\t\t//\tExpand native command\r\n\t\t\tthis.editor._outdentImpl = lang.hitch(this, \"_indentAndOutdent\", \"outdent\");\r\n\r\n\t\t\t// FF:\t1)Instead of converting <div> to some other block, FF includes newly created block into \r\n\t\t\t//\t\told <div>. Excessive nesting blocks creates problems for further working with the text.\r\n\t\t\t//\t\t2)Formatting contents of more then one list item (but less then all items in the list) \r\n\t\t\t//\t\tcaused unexpected merge of their contents.\r\n\t\t\t//\tExpand native command\r\n\t\t\tthis.editor._formatblockImpl = lang.hitch(this, \"_formatBlocks\");\r\n\t\t\t\r\n\t\t\tthis.editor.onLoadDeferred.addCallback(lang.hitch(this, function(){\r\n\t\t\t\tvar edPlugins = this.editor._plugins,\r\n\t\t\t\t\ti, p, ind = edPlugins.length, f = false,\r\n\t\t\t\t\th = lang.hitch(this, \"_changeState\", \"mirror\"),\r\n\t\t\t\t\thl = lang.hitch(this, \"_changeState\", \"ltr\"),\r\n\t\t\t\t\thr = lang.hitch(this, \"_changeState\", \"rtl\");\r\n\t\t\t\t\r\n\t\t\t\tthis.editor.addKeyHandler('9', 1, 0, h); //Ctrl-9\r\n\t\t\t\tthis.editor.addKeyHandler('8', 1, 0, hl); //Ctrl-8\r\n\t\t\t\tthis.editor.addKeyHandler('0', 1, 0, hr); //Ctrl-0\r\n\t\t\t\tfor(i = 0; i < edPlugins.length; i++){\r\n\t\t\t\t\tp = edPlugins[i];\r\n\t\t\t\t\tif (!p){\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(p.constructor === EnterKeyHandling){\t\t\t\t\t\t\r\n\t\t\t\t\t\tp.destroy();\r\n\t\t\t\t\t\tp = null;\r\n\t\t\t\t\t\tind = i;\r\n\t\t\t\t\t}else if(p.constructor === NormIndentOutdent){\r\n\t\t\t\t\t\tthis.editor._normalizeIndentOutdent = true;\r\n\t\t\t\t\t\tthis.editor._indentImpl = lang.hitch(this, \"_indentAndOutdent\", \"indent\");\r\n\t\t\t\t\t\tthis.editor._outdentImpl = lang.hitch(this, \"_indentAndOutdent\", \"outdent\");\r\n\t\t\t\t\t}else if(p.constructor === FontChoice && p.command === \"formatBlock\"){\r\n\t\t\t\t\t\tthis.own(aspect.before(p.button, \"_execCommand\", lang.hitch(this, \"_handleNoFormat\")));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.editor.addPlugin({ctor: EnterKeyHandling, blockNodeForEnter: this.blockMode, blockNodes: /^(?:P|H1|H2|H3|H4|H5|H6|LI|DIV)$/}, ind);\r\n\t\t\t\tp = this.editor._plugins[ind];\r\n\t\t\t\tthis.own(aspect.after(p, \"handleEnterKey\", lang.hitch(this, \"_checkNewLine\"), true));\r\n\t\t\t}));\r\n\t\t\tthis.own(aspect.after(this.editor, \"onNormalizedDisplayChanged\", lang.hitch(this, \"updateState\"), true));\r\n\t\t},\r\n\r\n\t\t_checkNewLine: function(){\r\n\t\t\tvar range = rangeapi.getSelection(this.editor.window).getRangeAt(0);\r\n\t\t\tvar curBlock = rangeapi.getBlockAncestor(range.startContainer, null, this.editor.editNode).blockNode;\r\n\t\t\tif (curBlock.innerHTML === this.bogusHtmlContent && curBlock.previousSibling){\r\n\t\t\t\tcurBlock.style.cssText = curBlock.previousSibling.style.cssText;\r\n\t\t\t}else if(curBlock.innerHTML !== this.bogusHtmlContent && curBlock.previousSibling && curBlock.previousSibling.innerHTML === this.bogusHtmlContent){\r\n\t\t\t\t curBlock.previousSibling.style.cssText = curBlock.style.cssText;\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\t_handleNoFormat: function(editor, command, choice){\r\n\t\t\tif (choice === \"noFormat\"){\r\n\t\t\t\treturn [editor, command, \"DIV\"];\r\n\t\t\t}\r\n\t\t\treturn arguments;\r\n\t\t},\r\n\t\t\r\n\t\t_execNativeCmd: function(cmd, arg, info){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tCall native command for nodes inside selection\r\n\t\t\t// cmd:\r\n\t\t\t//\t\tName of the command (like \"insertorderedlist\" or \"indent\")\r\n\t\t\t// arg:\r\n\t\t\t//\t\tArguments of the command\r\n\t\t\t// info:\r\n\t\t\t//\t\tObject containing\r\n\t\t\t//\t\t\tnodes:  array of all block nodes, which should be handled by this command\r\n\t\t\t//\t\t\tgroups: array containing groups of nodes. Nodes from each group should be handled by separate \r\n\t\t\t//\t\t\t\t\texecution of current command\r\n\t\t\t//\t\t\tcells:\tarray of cells, contents of which should be handled by current command\r\n\t\t\t// description:\r\n\t\t\t//\t\t\tSometimes native commands \"insertorderedlist\", \"insertunorderedlist\", \"indent\",\r\n\t\t\t//\t\t\"outdent\" and \"formatblocks\" are the cause of various problems. These problems have \r\n\t\t\t//\t\tdifferent levels of severity - from crashing of their executing or damage of the editor's \r\n\t\t\t//\t\tcontent to creating visually correct results, which however can cause the future problems,  \r\n\t\t\t//\t\tnot always bidi-specific. For example, Webkit fails with insertlist commands, if selection  \r\n\t\t\t//\t\tcontains some block element (like <H1> or <DIV>), followed by the table, and few cells of  \r\n\t\t\t//\t\tthis table.IE fails,when try to handle insertlist command for list items, containing <PRE>.  \r\n\t\t\t//\t\tMozilla and IE produce wrong results for selection,containing more then one cell. Mozilla  \r\n\t\t\t//\t\tmerges contents of some listitems with \"formatblock\" command. Safari places DIV's in the \r\n\t\t\t//\t\tsame list with newly created list items. Webkit creates multilevel blocks to format the text.   \r\n\t\t\t//\t\tIE adds to the list lines of the text,which are outside the selection. Webkit put whole table  \r\n\t\t\t//\t\tinto list item. All browsers lose direction and alignment styles with outdent command,    \r\n\t\t\t//\t\texecuted for items from one-level list. Etc.\r\n\t\t\t//\t\t\tWe try to avoid these problems and produce correct (and more or less similar) results for     \r\n\t\t\t//\t\tall supported browsers. This is achieved by separating the each above-mentioned command into \r\n\t\t\t//\t\tthree parts.\r\n\t\t\t//\t\t\tThe first (\"preparelist\",\"prepareindent\",\"prepareoutdent\" and \"prepareformat\") is performed \r\n\t\t\t//\t\tbefore corresponding native call. It prepares selected region of the editor's content by \r\n\t\t\t//\t\trebuilding it with strong block structure and keeps info about each group of selected  \r\n\t\t\t//\t\telements. Separate groups are created for contents of each table cell, as well as for lines of \r\n\t\t\t//\t\ttext that are before, after and between tables. In case of webkit and insertlist or formatblocks\r\n\t\t\t//\t\tcommands, each selected block element is placed into separate \"group\".\r\n\t\t\t//\t\t\tThe second part of the command is native call itself. Native calls are executed separately\r\n\t\t\t//\t\tfor each group of nodes. This requires to reset a selection, each time limiting it to only   \r\n\t\t\t//\t\tthe elements of the current group. \r\n\t\t\t//\t\t\tThe third part is perfomed after native call. Its role is to restore missing styles,  \r\n\t\t\t//\t\tto delete bogus elements, created in the previous steps, to merge sibling lists etc.  \r\n\t\t\t//\t\tCorresponding commands have the same names, as native (e.g., \"insertorderedlist',  \r\n\t\t\t//\t\t\"insertunorderedlist\", \"indent\", \"outdent\" and \"formatblocks\"), because just they produce \r\n\t\t\t//\t\tthe final result. For IE and Mozilla we call one \"post\" command per native call. For webkit \r\n\t\t\t//\t\twe call one \"post\" command per group of elements.\r\n\t\t\t\r\n\t\t\t// If info contains only one group of elements, we, as usually, perform one native call per selection  \r\n\t\t\tif(this._isSimpleInfo(info)){\r\n\t\t\t\tvar result = this.editor.document.execCommand(cmd, false, arg);\r\n\t\t\t\t// After some operations (like insert lists into cells of tables) webkit inserts BR before table\r\n\t\t\t\tif(has(\"webkit\")){\r\n\t\t\t\t\tquery(\"table\",this.editor.editNode).prev().forEach(function(x,ind,arr){\r\n\t\t\t\t\t\tif(this._hasTag(x,\"BR\")){\r\n\t\t\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},this);\r\n\t\t\t\t}\r\n\t\t\t\treturn result;\r\n\t\t\t}\r\n\t\t\tvar sel = rangeapi.getSelection(this.editor.window);\r\n\t\t\tif(!sel || sel.rangeCount == 0){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\tvar range = sel.getRangeAt(0), tempRange = range.cloneRange();\r\n\t\t\tvar startContainer = range.startContainer, startOffset = range.startOffset,\r\n\t\t\tendContainer = range.endContainer, endOffset = range.endOffset;\r\n\t\t\tfor(var i = 0; i < info.groups.length; i++){\r\n\t\t\t\tvar group = info.groups[i];\r\n\t\t\t\t// Set selection for currrent group of elements\r\n\t\t\t\tvar eOffs = group[group.length-1].childNodes.length;\r\n\t\t\t\ttempRange.setStart(group[0],0);\r\n\t\t\t\ttempRange.setEnd(group[group.length-1],eOffs);\r\n\t\t\t\tsel.removeAllRanges();\r\n\t\t\t\tsel.addRange(tempRange);\r\n\t\t\t\tvar table = this.editor.selection.getParentOfType(group[0],[\"TABLE\"]);\r\n\t\t\t\t// Execute native command for current group\r\n\t\t\t\tvar returnValue = this.editor.document.execCommand(cmd, false, arg);\r\n\t\t\t\tif(has(\"webkit\")){\r\n\t\t\t\t\tif(table && this._hasTag(table.previousSibling, \"BR\")){\r\n\t\t\t\t\t\ttable.parentNode.removeChild(table.previousSibling);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.editor.focus();\r\n\t\t\t\t\t// Keep info about entire selection\r\n\t\t\t\t\tsel = rangeapi.getSelection(this.editor.window);\r\n\t\t\t\t\tvar internalRange = sel.getRangeAt(0);\r\n\t\t\t\t\tif(i == 0){\r\n\t\t\t\t\t\tstartContainer = internalRange.endContainer;\r\n\t\t\t\t\t\tstartOffset = internalRange.endOffset;\r\n\t\t\t\t\t}else if(i == info.groups.length-1){\r\n\t\t\t\t\t\tendContainer = internalRange.endContainer;\r\n\t\t\t\t\t\tendOffset = internalRange.endOffset;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif(!returnValue){\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\t// For webkit we execute \"post\" command for each group of elements. \r\n\t\t\t\tif(has(\"webkit\")){\r\n\t\t\t\t\tthis._changeState(cmd);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// Restore selection\r\n\t\t\tsel.removeAllRanges();\r\n\t\t\ttry{\r\n\t\t\t\ttempRange.setStart(startContainer, startOffset);\r\n\t\t\t\ttempRange.setEnd(endContainer, endOffset);\r\n\t\t\t\tsel.addRange(tempRange);\r\n\t\t\t}catch(e){\r\n\t\t\t}\r\n\t\t\treturn true;\r\n\t\t},\r\n\t\t\r\n\t\t_insertLists: function(cmd){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tOverrides native insertorderlist and insertunorderlist commands.\r\n\t\t\t// cmd: \r\n\t\t\t//\t\tName of the command, one of \"insertorderedlist\" or \"insertunorderedlist\"\r\n\t\t\t// description:\r\n\t\t\t//\t\tOverrides native insertorderlist and insertunorderlist commands with the goal \r\n\t\t\t//\t\tto avoid some bidi-specific problems that arise when these commands are executed. \r\n\t\t\t//\t\tPerformed in three steps:\r\n\t\t\t//\t\t1)\tprepares selected fragment of the document to execution of native command. \r\n\t\t\t//\t\t2)\texecutes corresponding native command\r\n\t\t\t//\t\t3)\tupdates contents of selected fragment of the document after execution of\r\n\t\t\t//\t\t\tnative comand.\r\n\t\t\tvar info = this._changeState(\"preparelists\",cmd);\r\n\t\t\tvar returnValue = this._execNativeCmd(cmd, null, info);\r\n\t\t\tif(!returnValue){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\t// For webkit \"post\" command executed separately for each group of elements.  \r\n\t\t\tif(!has(\"webkit\") || this._isSimpleInfo(info)){\r\n\t\t\t\tthis._changeState(cmd);\r\n\t\t\t} \r\n\t\t\tthis._cleanLists();\r\n\t\t\tthis._mergeLists();\r\n\t\t\treturn true;\r\n\t\t},\r\n\t\t\r\n\t\t_indentAndOutdent: function(cmd){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tOverrides native indent and outdent commands.\r\n\t\t\t// cmd:\r\n\t\t\t//\t\tName of the command, of of \"indent\" or \"outdent\"\r\n\t\t\t// description:\r\n\t\t\t//\t\tOverrides native indent and outdent commands with the goal to avoid some \r\n\t\t\t//\t\tbidi-specific problems that arise when these commands are executed. \r\n\t\t\t//\t\tPerformed in three steps:\r\n\t\t\t//\t\t1)\tprepares selected fragment of the document to execution of native command\r\n\t\t\t//\t\t\t(outdent only).\r\n\t\t\t//\t\t2)\texecutes corresponding native command\r\n\t\t\t//\t\t3)\tupdates contents of selected fragment of the document after execution of\r\n\t\t\t//\t\t\tnative comand.\r\n\t\t\tif(this.editor._normalizeIndentOutdent){\r\n\t\t\t\t// To emulate NormalizeIndentOutdent\r\n\t\t\t\tthis._changeState(\"normalize\" + cmd);\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t\tvar info = this._changeState(\"prepare\" + cmd);\r\n\t\t\t\r\n\t\t\t// If useCSS and styleWithCSS both set to false, mozilla creates blockquotes\r\n\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\tvar oldValue;\r\n\t\t\t\ttry{\r\n\t\t\t\t\toldValue = this.editor.document.queryCommandValue(\"styleWithCSS\");\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\toldValue = false;\r\n\t\t\t\t}\r\n\t\t\t\tthis.editor.document.execCommand(\"styleWithCSS\", false, true);\r\n\t\t\t}\r\n\r\n\t\t\tvar returnValue = this._execNativeCmd(cmd, null, info);\r\n\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\tthis.editor.document.execCommand(\"styleWithCSS\", false, oldValue);\r\n\t\t\t}\r\n\t\t\tif(!returnValue){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\tthis._changeState(cmd);\r\n\t\t\tthis._mergeLists();\r\n\t\t\treturn true;\t\t\r\n\t\t},\r\n\r\n\t\t_formatBlocks: function(arg){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tOverrides native formatblock command.\r\n\t\t\t// arg:\r\n\t\t\t//\t\tTag name of block type, like H1, DIV or P.\r\n\t\t\t// description:\r\n\t\t\t//\t\tOverrides native formatblock command with the goal to avoid some \r\n\t\t\t//\t\tbidi-specific problems that arise when this command is executed. \r\n\t\t\t//\t\tPerformed in three steps:\r\n\t\t\t//\t\t1)\tprepares selected fragment of the document to execution of native command\r\n\t\t\t//\t\t\t(Mozilla only).\r\n\t\t\t//\t\t2)\texecutes native command\r\n\t\t\t//\t\t3)\tupdates contents of selected fragment of the document after execution of\r\n\t\t\t//\t\t\tnative comand.\r\n\t\t\tvar info;\r\n\t\t\tif(has(\"mozilla\") || has(\"webkit\")){\r\n\t\t\t\tinfo = this._changeState(\"prepareformat\", arg);\r\n\t\t\t}\r\n\t\t\tif(has(\"ie\") && arg && arg.charAt(0) != \"<\"){\r\n\t\t\t\targ = \"<\" + arg + \">\";\r\n\t\t\t}\r\n\t\t\tvar returnValue = this._execNativeCmd(\"formatblock\", arg, info);\t\t\t\r\n\t\t\tif(!returnValue){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\tif(!has(\"webkit\") || this._isSimpleInfo(info)){\r\n\t\t\t\tthis._changeState(\"formatblock\", arg);\r\n\t\t\t}\r\n\t\t\tthis._mergeLists();\r\n\t\t\treturn true;\t\t\r\n\t\t},\r\n\t\t\r\n\t\t_changeState: function(cmd,arg){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tDetermines and refines current selection and calls method \r\n\t\t\t//\t\t_changeStateOfBlocks(), where given action is actually done\r\n\t\t\t// description:\r\n\t\t\t//\t\tThe main goal of this method is correctly identify the block elements,\r\n\t\t\t//\t\tthat are at the beginning and end of the current selection. \r\n\t\t\t// return: nodesInfo\r\n\t\t\t//\t\tObject containing\r\n\t\t\t//\t\t\tnodes:  array of all block nodes, which should be handled by this command\r\n\t\t\t//\t\t\tgroups: array containing groups of nodes. Nodes from each group should be handled by separate \r\n\t\t\t//\t\t\t\t\texecution of current command\r\n\t\t\t//\t\t\tcells:\tarray of cells, contents of which should be handled by current command\r\n\t\t\tif(!this.editor.window){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tthis.editor.focus();\r\n\t\t\tvar sel = rangeapi.getSelection(this.editor.window);\r\n\t\t\tif(!sel || sel.rangeCount == 0){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tvar range = sel.getRangeAt(0), tempRange = range.cloneRange(),\r\n\t\t\t\tstartNode, endNode, startOffset, endOffset;\r\n\t\t\tstartNode = range.startContainer;\r\n\t\t\tstartOffset = range.startOffset;\r\n\t\t\tendNode = range.endContainer;\r\n\t\t\tendOffset = range.endOffset;\r\n\t\t\tvar isCollapsed = startNode === endNode && startOffset == endOffset;\r\n\t\t\tif(this._isBlockElement(startNode) || this._hasTagFrom(startNode,this._tableContainers)){\r\n\t\t\t\twhile(startNode.hasChildNodes()){\r\n\t\t\t\t\tif(startOffset == startNode.childNodes.length){\r\n\t\t\t\t\t\tstartOffset--;\r\n\t\t\t\t\t}\t\r\n\t\t\t\t\tstartNode = startNode.childNodes[startOffset];\r\n\t\t\t\t\tstartOffset = 0;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\ttempRange.setStart(startNode, startOffset);\r\n\t\t\tstartNode = this._getClosestBlock(startNode,\"start\",tempRange);\r\n\t\t\tvar supList = rangeapi.getBlockAncestor(startNode, /li/i, this.editor.editNode).blockNode;\r\n\t\t\tif(supList && supList !== startNode){\r\n\t\t\t\tstartNode = supList;\r\n\t\t\t}\r\n\t\t\tendNode = tempRange.endContainer;\r\n\t\t\tendOffset = tempRange.endOffset;\r\n\t\t\tif(this._isBlockElement(endNode) || this._hasTagFrom(endNode,this._tableContainers)){\r\n\t\t\t\twhile(endNode.hasChildNodes()){\r\n\t\t\t\t\tif(endOffset == endNode.childNodes.length){\r\n\t\t\t\t\t\tendOffset--;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tendNode = endNode.childNodes[endOffset];\r\n\t\t\t\t\tif(endNode.hasChildNodes()){\r\n\t\t\t\t\t\tendOffset = endNode.childNodes.length;\r\n\t\t\t\t\t}else if(endNode.nodeType == 3 && endNode.nodeValue){\r\n\t\t\t\t\t\tendOffset = endNode.nodeValue.length;\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tendOffset = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\ttempRange.setEnd(endNode, endOffset);\r\n\t\t\tendNode = this._getClosestBlock(endNode,\"end\",tempRange);\r\n\t\t\tsupList = rangeapi.getBlockAncestor(endNode, /li/i, this.editor.editNode).blockNode;\r\n\t\t\tif(supList && supList !== endNode){\r\n\t\t\t\tendNode = supList;\r\n\t\t\t}\r\n\t\t\tsel = rangeapi.getSelection(this.editor.window, true);\r\n\t\t\tsel.removeAllRanges();\r\n\t\t\tsel.addRange(tempRange);\r\n\t\t\tvar commonAncestor = rangeapi.getCommonAncestor(startNode, endNode);\r\n\t\t\tvar nodesInfo = this._changeStateOfBlocks(startNode, endNode, commonAncestor, cmd, arg, tempRange);\r\n\t\t\tif(isCollapsed){\r\n\t\t\t\tendNode = tempRange.startContainer;\r\n\t\t\t\tendOffset = tempRange.startOffset;\r\n\t\t\t\ttempRange.setEnd(endNode, endOffset);\r\n\t\t\t\tsel = rangeapi.getSelection(this.editor.window, true);\r\n\t\t\t\tsel.removeAllRanges();\r\n\t\t\t\tsel.addRange(tempRange);\t\t\t\t\r\n\t\t\t}\r\n\t\t\treturn nodesInfo;\r\n\t\t},\r\n\r\n\t\t_isBlockElement: function(node){\r\n\t\t\tif(!node || node.nodeType != 1){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\tvar display = domStyle.get(node,\"display\");\r\n\t\t\treturn (display == 'block' || display == \"list-item\" || display == \"table-cell\");\r\n\t\t},\r\n\t\t\r\n\t\t_isInlineOrTextElement: function(node){\r\n\t\t\treturn !this._isBlockElement(node) && (node.nodeType == 1 || node.nodeType == 3 || node.nodeType == 8);\r\n\t\t},\r\n\t\t\r\n\t\t_isElement: function(node){\r\n\t\t\treturn node && (node.nodeType == 1 || node.nodeType == 3);\r\n\t\t},\r\n\t\t\r\n\t\t_isBlockWithText: function(node){\r\n\t\t\treturn node !== this.editor.editNode && this._hasTagFrom(node,this._lineTextArray);\r\n\t\t},\r\n\t\t\r\n\t\t_getBlockAncestor: function(node){\r\n\t\t\twhile(node.parentNode && !this._isBlockElement(node)){\r\n\t\t\t\tnode = node.parentNode;\r\n\t\t\t}\r\n\t\t\treturn node;\r\n\t\t},\r\n\t\t\r\n\t\t_getClosestBlock: function(node, point, tempRange){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tSearches for a closest block element containing the text which \r\n\t\t\t//\t\tis at a given point of current selection. Refines current\r\n\t\t\t//\t\tselection, if text element from start or end point was merged \r\n\t\t\t//\t\twith its neighbors.\r\n\t\t\tif(this._isBlockElement(node)){\r\n\t\t\t\treturn node;\r\n\t\t\t}\r\n\t\t\tvar parent = node.parentNode,\r\n\t\t\t\tfirstSibling, lastSibling,\r\n\t\t\t\tcreateOwnBlock = false,\r\n\t\t\t\tmultiText = false;\r\n\t\t\t\tremoveOffset = false;\r\n\t\t\twhile(true){\r\n\t\t\t\tvar sibling = node;\r\n\t\t\t\tcreateOwnBlock = false;\r\n\t\t\t\twhile(true){\r\n\t\t\t\t\tif(this._isInlineOrTextElement(sibling)){\r\n\t\t\t\t\t\tfirstSibling = sibling;\r\n\t\t\t\t\t\tif(!lastSibling){\r\n\t\t\t\t\t\t\tlastSibling = sibling;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tsibling = sibling.previousSibling;\r\n\t\t\t\t\tif(!sibling){\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}else if(this._isBlockElement(sibling) || this._hasTagFrom(sibling,this._blockContainers) || this._hasTag(sibling,\"BR\")){\r\n\t\t\t\t\t\tcreateOwnBlock = true;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}else if(sibling.nodeType == 3 && sibling.nextSibling.nodeType == 3){\r\n\t\t\t\t\t\t// Merge neighboring text elements\r\n\t\t\t\t\t\tsibling.nextSibling.nodeValue = sibling.nodeValue + sibling.nextSibling.nodeValue;\r\n\t\t\t\t\t\tmultiText = true;\r\n\t\t\t\t\t\tif(point == \"start\" && sibling === tempRange.startContainer){\r\n\t\t\t\t\t\t\ttempRange.setStart(sibling.nextSibling, 0);\r\n\t\t\t\t\t\t}else if(point == \"end\" && (sibling === tempRange.endContainer || sibling.nextSibling === tempRange.endContainer)){\r\n\t\t\t\t\t\t\ttempRange.setEnd(sibling.nextSibling, sibling.nextSibling.nodeValue.length);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsibling = sibling.nextSibling;\r\n\t\t\t\t\t\tsibling.parentNode.removeChild(sibling.previousSibling);\r\n\t\t\t\t\t\tif(!sibling.previousSibling){\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tsibling = node;\r\n\t\t\t\twhile(true){\r\n\t\t\t\t\tif(this._isInlineOrTextElement(sibling)){\r\n\t\t\t\t\t\tif(!firstSibling){\r\n\t\t\t\t\t\t\tfirstSibling = sibling;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tlastSibling = sibling;\r\n\t\t\t\t\t}\t\r\n\t\t\t\t\tsibling = sibling.nextSibling;\r\n\t\t\t\t\tif(!sibling){\r\n\t\t\t\t\t\tbreak;\t\t\t\t\r\n\t\t\t\t\t}else if(this._isBlockElement(sibling) || this._hasTagFrom(sibling,this._blockContainers)){\r\n\t\t\t\t\t\tcreateOwnBlock = true;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}else if(this._hasTag(sibling,\"BR\") && sibling.nextSibling && !(this._isBlockElement(sibling.nextSibling) || \r\n\t\t\t\t\t\t\tthis._hasTagFrom(sibling.nextSibling,this._blockContainers))){\r\n\t\t\t\t\t\tlastSibling = sibling;\r\n\t\t\t\t\t\tcreateOwnBlock = true;\r\n\t\t\t\t\t\tbreak;\t\t\t\t\t\t\r\n\t\t\t\t\t}else if(sibling.nodeType == 3 && sibling.previousSibling.nodeType == 3){\r\n\t\t\t\t\t\t// Merge neighboring text elements\r\n\t\t\t\t\t\tsibling.previousSibling.nodeValue += sibling.nodeValue;\r\n\t\t\t\t\t\tmultiText = true;\r\n\t\t\t\t\t\tif(point == \"start\" && sibling === tempRange.startContainer){\r\n\t\t\t\t\t\t\ttempRange.setStart(sibling.previousSibling, 0);\r\n\t\t\t\t\t\t}else if(point == \"end\" && (sibling === tempRange.endContainer || sibling.previousSibling === tempRange.endContainer)){\r\n\t\t\t\t\t\t\ttempRange.setEnd(sibling.previousSibling, sibling.previousSibling.nodeValue.length);\r\n\t\t\t\t\t\t}\t\t\t\t\t\r\n\t\t\t\t\t\tsibling = sibling.previousSibling;\r\n\t\t\t\t\t\tsibling.parentNode.removeChild(sibling.nextSibling);\r\n\t\t\t\t\t\tif(!sibling.nextSibling){\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t// If text in the start or end point of the current selection doesn't placed in some block element \r\n\t\t\t\t// or if it has block siblings, new block, containing this text element (and its inline siblings) is created.\r\n\t\t\t\tif(createOwnBlock || (this._isBlockElement(parent) && \r\n\t\t\t\t\t\t!this._isBlockWithText(parent) && firstSibling)){\r\n\t\t\t\t\tvar origStartOffset = tempRange? tempRange.startOffset : 0,\r\n\t\t\t\t\t\torigEndOffset = tempRange? tempRange.endOffset : 0,\r\n\t\t\t\t\t\torigStartContainer = tempRange? tempRange.startContainer : null,\r\n\t\t\t\t\t\torigEndContainer = tempRange? tempRange.endContainer : null,\r\n\t\t\t\t\t\tdivs = this._repackInlineElements(firstSibling, lastSibling, parent),\r\n\t\t\t\t\t\tdiv = divs[point == \"start\"? 0 : divs.length-1];\r\n\t\t\t\t\t\tif(tempRange && div && firstSibling === origStartContainer && this._hasTag(firstSibling,\"BR\")){\r\n\t\t\t\t\t\t\torigStartContainer = div;\r\n\t\t\t\t\t\t\torigStartOffset = 0;\r\n\t\t\t\t\t\t\tif(lastSibling === firstSibling){\r\n\t\t\t\t\t\t\t\torigEndContainer = origStartContainer;\r\n\t\t\t\t\t\t\t\torigEndOffset = 0;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\tif(tempRange){\r\n\t\t\t\t\t\ttempRange.setStart(origStartContainer, origStartOffset);\r\n\t\t\t\t\t\ttempRange.setEnd(origEndContainer, origEndOffset);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn div;\r\n\t\t\t\t}\r\n\t\t\t\tif(this._isBlockElement(parent)){\r\n\t\t\t\t\treturn parent;\r\n\t\t\t\t}\r\n\t\t\t\tnode = parent;\r\n\t\t\t\tremoveOffset = true;\r\n\t\t\t\tparent = parent.parentNode;\r\n\t\t\t\tfirstSibling = lastSibling = null;\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\t_changeStateOfBlocks: function(startNode, endNode, commonAncestor, cmd, arg, tempRange){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tCollects all block elements, containing text, which are inside of current selection,\r\n\t\t\t//\t\tand performs for each of them given action.\r\n\t\t\t//\t\tPossible commands and corresponding actions:\r\n\t\t\t//\t\t\t- \"ltr\":\t\t\t\t\tchange direction to left-to-right\r\n\t\t\t//\t\t\t- \"rtl\":\t\t\t\t\tchange direction to right-to-left\r\n\t\t\t//\t\t\t- \"mirror\":\t\t\t\t\tchange direction to opposite\r\n\t\t\t//\t\t\t- \"explicitdir\":\t\t\texplicit direction setting\r\n\t\t\t//\t\t\t- \"left\":\t\t\t\t\tchange alignment to left\r\n\t\t\t//\t\t\t- \"right\":\t\t\t\t\tchange alignment to right\r\n\t\t\t//\t\t\t- \"center\":\t\t\t\t\tchange alignment to center\r\n\t\t\t//\t\t\t- \"preparelists\":\t\t\taction should be done before executing native insert[un]orderedlist\r\n\t\t\t//\t\t\t- \"prepareoutdent\":\t\t\taction should be done before executing native outdent\r\n\t\t\t//\t\t\t- \"prepareindent\":\t\t\taction should be done before executing native indent\r\n\t\t\t//\t\t\t- \"prepareformat\":\t\t\taction should be done before executing native formatblock\r\n\t\t\t//\t\t\t- \"insertunorderedlist\":\taction should be done after executing native insertunorderedlist\r\n\t\t\t//\t\t\t- \"insertorderedlist\":\t\taction should be done after executing native insertorderedlist\r\n\t\t\t//\t\t\t- \"indent\":\t\t\t\t\taction should be done after executing native indent\r\n\t\t\t//\t\t\t- \"outdent\":\t\t\t\taction should be done after executing native outdent\r\n\t\t\t//\t\t\t- \"normalizeindent\":\t\temulate indent done by NormalizeIndentOutdent plugin\r\n\t\t\t//\t\t\t- \"normalizeoutdent\":\t\temulate outdent done by NormalizeIndentOutdent plugin\r\n\t\t\t//\t\t\t- \"formatblock\":\t\t\taction should be done after executing native formatblock\r\n\t\t\tvar nodes = [];\r\n\t\t\t// Refine selection, needed for 'explicitdir' command (full selection)\r\n\t\t\tif(startNode === this.editor.editNode){\r\n\t\t\t\tif(!startNode.hasChildNodes()){\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif(this._isInlineOrTextElement(startNode.firstChild)){\r\n\t\t\t\t\tthis._rebuildBlock(startNode);\r\n\t\t\t\t}\r\n\t\t\t\tstartNode = this._getClosestBlock(startNode.firstChild, \"start\", null);\r\n\t\t\t}\r\n\t\t\tif(endNode === this.editor.editNode){\r\n\t\t\t\tif(!endNode.hasChildNodes()){\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif(this._isInlineOrTextElement(endNode.lastChild)){\r\n\t\t\t\t\tthis._rebuildBlock(endNode);\r\n\t\t\t\t}\r\n\t\t\t\tendNode = this._getClosestBlock(endNode.lastChild, \"end\", null);\t\t\t\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Collect all selected block elements, which contain or can contain text.\r\n\t\t\t// Walk through DOM tree between start and end points of current selection.\r\n\t\t\tvar origStartOffset = tempRange? tempRange.startOffset : 0,\r\n\t\t\t\torigEndOffset = tempRange? tempRange.endOffset : 0,\r\n\t\t\t\torigStartContainer = tempRange? tempRange.startContainer : null,\r\n\t\t\t\torigEndContainer = tempRange? tempRange.endContainer : null;\t\t\r\n\t\t\tvar info = this._collectNodes(startNode, endNode, commonAncestor, tempRange, nodes, \r\n\t\t\t\t\torigStartContainer, origStartOffset, origEndContainer, origEndOffset, cmd);\r\n\t\t\tvar nodesInfo = {nodes: nodes, groups: info.groups, cells: info.cells};\r\n\t\t\tcmd = cmd.toString();\r\n\t\t\t// Execution of specific action for each element from collection\r\n\t\t\tswitch(cmd){\r\n\t\t\t\t//change direction\r\n\t\t\t\tcase \"mirror\":\r\n\t\t\t\tcase \"ltr\":\r\n\t\t\t\tcase \"rtl\":\r\n\t\t\t\t//change alignment\r\n\t\t\t\tcase \"left\":\r\n\t\t\t\tcase \"right\":\r\n\t\t\t\tcase \"center\":\r\n\t\t\t\t//explicit direction setting\r\n\t\t\t\tcase \"explicitdir\":\r\n\t\t\t\t\tthis._execDirAndAlignment(nodesInfo, cmd, arg);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t//before executing 'insert list' native command\r\n\t\t\t\tcase \"preparelists\":\r\n\t\t\t\t\tthis._prepareLists(nodesInfo, arg);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t//after executing 'insert list' native command\r\n\t\t\t\tcase \"insertorderedlist\":\r\n\t\t\t\tcase \"insertunorderedlist\":\r\n\t\t\t\t\tthis._execInsertLists(nodesInfo);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t//before executing 'outdent' native command\r\n\t\t\t\tcase \"prepareoutdent\":\r\n\t\t\t\t\tthis._prepareOutdent(nodesInfo);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t//before executing 'indent' native command\r\n\t\t\t\tcase \"prepareindent\":\r\n\t\t\t\t\tthis._prepareIndent(nodesInfo);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t//after executing 'indent' native command\r\n\t\t\t\tcase \"indent\":\r\n\t\t\t\t\tthis._execIndent(nodesInfo);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t//after executing 'outdent' native command\r\n\t\t\t\tcase \"outdent\":\r\n\t\t\t\t\tthis._execOutdent(nodesInfo);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t//replace native 'indent' and 'outdent' commands\r\n\t\t\t\tcase \"normalizeindent\":\r\n\t\t\t\t\tthis._execNormalizedIndent(nodesInfo);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"normalizeoutdent\":\r\n\t\t\t\t\tthis._execNormalizedOutdent(nodesInfo);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t//before 'formatblock' native command\r\n\t\t\t\tcase \"prepareformat\":\r\n\t\t\t\t\tthis._prepareFormat(nodesInfo, arg);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t//after executing 'formatblock' native command\r\n\t\t\t\tcase \"formatblock\":\r\n\t\t\t\t\tthis._execFormatBlocks(nodesInfo, arg);\r\n\t\t\t\t\tbreak;\t\t\t\t\r\n\t\t\t\tdefault: console.error(\"Command \" + cmd + \" isn't handled\");\r\n\t\t\t}\r\n\t\t\t// Refine selection after changes\r\n\t\t\tif(tempRange){\t\t\r\n\t\t\t\ttempRange.setStart(origStartContainer, origStartOffset);\r\n\t\t\t\ttempRange.setEnd(origEndContainer, origEndOffset);\t\t\t\t\r\n\t\t\t\tsel = rangeapi.getSelection(this.editor.window, true);\r\n\t\t\t\tsel.removeAllRanges();\r\n\t\t\t\tsel.addRange(tempRange);\r\n\t\t\t\tthis.editor.onDisplayChanged();\r\n\t\t\t}\r\n\t\t\treturn nodesInfo;\r\n\t\t},\r\n\r\n\t\t_collectNodes: function(startNode, endNode, commonAncestor, tempRange, nodes, origStartContainer, origStartOffset, origEndContainer, origEndOffset, cmd){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tCollect all selected block elements, which contain or can contain text.\r\n\t\t\t//\t\tWalk through DOM tree between start and end points of current selection.\r\n\t\t\tvar node = startNode, sibling, child, parent = node.parentNode, divs = [],\r\n\t\t\t\tfirstSibling, lastSibling, groups = [], group = [], cells = [], curTD = this.editor.editNode;\r\n\t\t\tvar saveNodesAndGroups = lang.hitch(this, function(x){\r\n\t\t\t\tnodes.push(x);\r\n\t\t\t\tvar cell = this.editor.selection.getParentOfType(x,[\"TD\"]);\r\n\t\t\t\tif(curTD !== cell || has(\"webkit\") && (cmd === \"prepareformat\" || cmd === \"preparelists\")){\r\n\t\t\t\t\tif(group.length){\r\n\t\t\t\t\t\tgroups.push(group);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tgroup = [];\t\t\t\t\t\r\n\t\t\t\t\tif(curTD != cell){\r\n\t\t\t\t\t\tcurTD = cell;\r\n\t\t\t\t\t\tif(curTD){\r\n\t\t\t\t\t\t\tcells.push(curTD);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tgroup.push(x);\r\n\t\t\t});\r\n\t\t\tthis._rebuildBlock(parent);\r\n\t\t\twhile(true){\r\n\t\t\t\tif(this._hasTagFrom(node,this._tableContainers)){\r\n\t\t\t\t\tif(node.firstChild){\r\n\t\t\t\t\t\tparent = node;\r\n\t\t\t\t\t\tnode = node.firstChild;\r\n\t\t\t\t\t\tcontinue;\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t}else if(this._isBlockElement(node)){\t\t\t\t\r\n\t\t\t\t\tvar supLI = rangeapi.getBlockAncestor(node, /li/i, this.editor.editNode).blockNode;\r\n\t\t\t\t\tif(supLI && supLI !== node){\r\n\t\t\t\t\t\tnode = supLI;\r\n\t\t\t\t\t\tparent = node.parentNode;\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(!this._hasTag(node,\"LI\")){\t\t\r\n\t\t\t\t\t\tif(node.firstChild){\r\n\t\t\t\t\t\t\tthis._rebuildBlock(node);\r\n\t\t\t\t\t\t\tif(this._isBlockElement(node.firstChild) || this._hasTagFrom(node.firstChild,this._tableContainers)){\r\n\t\t\t\t\t\t\t\tparent = node;\r\n\t\t\t\t\t\t\t\tnode = node.firstChild;\r\n\t\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(this._hasTagFrom(node,this._lineTextArray)){\r\n\t\t\t\t\t\tsaveNodesAndGroups(node);\r\n\t\t\t\t\t}\r\n\t\t\t\t}else if(this._isInlineOrTextElement(node) && !this._hasTagFrom(node.parentNode,this._tableContainers)){\r\n\t\t\t\t\tfirstSibling = node;\r\n\t\t\t\t\twhile(node){\r\n\t\t\t\t\t\tvar nextSibling = node.nextSibling;\r\n\t\t\t\t\t\tif(this._isInlineOrTextElement(node)){\r\n\t\t\t\t\t\t\tlastSibling = node;\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif(this._hasTag(node,\"BR\")){\r\n\t\t\t\t\t\t\t\tif(!(this._isBlockElement(parent) && node === parent.lastChild)){\r\n\t\t\t\t\t\t\t\t\tdivs = this._repackInlineElements(firstSibling, lastSibling, parent);\r\n\t\t\t\t\t\t\t\t\tnode = divs[divs.length-1];\r\n\t\t\t\t\t\t\t\t\tfor(var nd = 0; nd < divs.length; nd++){\r\n\t\t\t\t\t\t\t\t\t\tsaveNodesAndGroups(divs[nd]);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tfirstSibling = lastSibling = null;\r\n\t\t\t\t\t\t\t\t\tif(nextSibling && this._isInlineOrTextElement(nextSibling)){\r\n\t\t\t\t\t\t\t\t\t\tfirstSibling = nextSibling;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}else if(this._isBlockElement(node)){\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\t\r\n\t\t\t\t\t\tnode = nextSibling;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(!firstSibling){\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tdivs = this._repackInlineElements(firstSibling, lastSibling, parent);\r\n\t\t\t\t\tnode = divs[divs.length-1];\r\n\t\t\t\t\tfor(var nd = 0; nd < divs.length; nd++){\r\n\t\t\t\t\t\tsaveNodesAndGroups(divs[nd]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif(node === endNode){\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tif(node.nextSibling){\r\n\t\t\t\t\tnode = node.nextSibling;\r\n\t\t\t\t}else if(parent !== commonAncestor){\r\n\t\t\t\t\twhile(!parent.nextSibling){\r\n\t\t\t\t\t\tnode = parent;\r\n\t\t\t\t\t\tparent = node.parentNode;\r\n\t\t\t\t\t\tif(parent === commonAncestor){\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(parent !== commonAncestor && parent.nextSibling){\r\n\t\t\t\t\t\tnode = parent.nextSibling;\r\n\t\t\t\t\t\tparent = parent.parentNode;\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{ \r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(group.length){\r\n\t\t\t\tif(has(\"webkit\") || curTD){\r\n\t\t\t\t\tgroups.push(group);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tgroups.unshift(group);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn {groups: groups, cells: cells};\r\n\t\t},\r\n\r\n\t\t_execDirAndAlignment: function(nodesInfo, cmd,arg){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tChange direction and/or alignment of each node from the given array.\r\n\t\t\tswitch(cmd){\r\n\t\t\t//change direction\r\n\t\t\tcase \"mirror\":\r\n\t\t\tcase \"ltr\":\r\n\t\t\tcase \"rtl\":\r\n\t\t\t\tarray.forEach(nodesInfo.nodes, function(x){\r\n\t\t\t\t\tvar style = domStyle.getComputedStyle(x),\r\n\t\t\t\t\t\tcurDir = style.direction,\r\n\t\t\t\t\t\toppositeDir = curDir == \"ltr\"? \"rtl\" : \"ltr\",\r\n\t\t\t\t\t\trealDir = (cmd != \"mirror\"? cmd : oppositeDir),\r\n\t\t\t\t\t\tcurAlign = style.textAlign,\r\n\t\t\t\t\t\tmarginLeft = isNaN(parseInt(style.marginLeft))? 0 : parseInt(style.marginLeft),\r\n\t\t\t\t\t\tmarginRight = isNaN(parseInt(style.marginRight))? 0 : parseInt(style.marginRight);\r\n\t\t\t\t\tdomAttr.remove(x,\"dir\");\r\n\t\t\t\t\tdomAttr.remove(x,\"align\");\t\t\t\t\t\r\n\t\t\t\t\tdomStyle.set(x, {direction: realDir, textAlign: \"\"});\r\n\t\t\t\t\tif(this._hasTag(x,\"CENTER\")){\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(curAlign.indexOf(\"center\") >= 0){\r\n\t\t\t\t\t\tdomStyle.set(x,\"textAlign\",\"center\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\tthis._refineLIMargins(x);\r\n\t\t\t\t\t\tvar margin = curDir === \"rtl\"? marginRight : marginLeft; \r\n\t\t\t\t\t\tvar level = 0, tNode = x.parentNode, name;\r\n\t\t\t\t\t\tif(curDir != domStyle.get(tNode,\"direction\")){\r\n\t\t\t\t\t\t\twhile(tNode !== this.editor.editNode){\r\n\t\t\t\t\t\t\t\tif(this._hasTagFrom(tNode,[\"OL\",\"UL\"])){\r\n\t\t\t\t\t\t\t\t\tlevel++;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\ttNode = tNode.parentNode;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tmargin -= this._getMargins(level);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar styleMargin = realDir == \"rtl\"? \"marginRight\" : \"marginLeft\";\r\n\t\t\t\t\t\tvar cMargin = domStyle.get(x,styleMargin);\r\n\t\t\t\t\t\tvar cIndent = isNaN(cMargin)? 0 : parseInt(cMargin);\r\n\t\t\t\t\t\tdomStyle.set(x,styleMargin,\"\" + (cIndent + margin) + \"px\");\r\n\t\t\t\t\t\tif(has(\"webkit\")){\r\n\t\t\t\t\t\t\tif(curAlign.indexOf(\"center\") < 0){\r\n\t\t\t\t\t\t\t\tdomStyle.set(x, \"textAlign\", (realDir == \"rtl\"? \"right\" : \"left\"));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}else if(x.firstChild && x.firstChild.tagName){\r\n\t\t\t\t\t\t\tif(this._hasTagFrom(x.firstChild,this._lineStyledTextArray)){\r\n\t\t\t\t\t\t\t\tvar style = domStyle.getComputedStyle(x),\r\n\t\t\t\t\t\t\t\t\talign = this._refineAlignment(style.direction, style.textAlign);\r\n\t\t\t\t\t\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\t\t\t\t\t\tdomStyle.set(x.firstChild, {textAlign: align});\r\n\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\tdomStyle.set(x.firstChild, {direction : realDir, textAlign: align});\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tif(realDir == \"rtl\" && marginLeft != 0){\r\n\t\t\t\t\t\t\tdomStyle.set(x, {marginLeft: \"\", marginRight: \"\" + marginLeft + \"px\"});\r\n\t\t\t\t\t\t}else if(realDir == \"ltr\" && marginRight != 0){\r\n\t\t\t\t\t\t\tdomStyle.set(x, {marginRight: \"\", marginLeft: \"\" + marginRight + \"px\"});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},this);\r\n\t\t\t\tquery(\"table\",this.editor.editNode).forEach(function(table,idx,array){\r\n\t\t\t\t\tvar dir = cmd;\r\n\t\t\t\t\tif(cmd === \"mirror\"){\r\n\t\t\t\t\t\tdir = domStyle.get(table,\"direction\") === \"ltr\"? \"rtl\" : \"ltr\";\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar listTD = query(\"td\",table), first = false, last = false;\r\n\t\t\t\t\tfor(var i = 0; i < nodesInfo.cells.length; i++){\r\n\t\t\t\t\t\tif(!first && listTD[0] === nodesInfo.cells[i]){\r\n\t\t\t\t\t\t\tfirst = true;\r\n\t\t\t\t\t\t}else if(listTD[listTD.length-1] === nodesInfo.cells[i]){\r\n\t\t\t\t\t\t\tlast = true;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(first && last){\r\n\t\t\t\t\t\tdomStyle.set(table,\"direction\",dir);\r\n\t\t\t\t\t\tfor(i = 0; i < listTD.length; i++){\r\n\t\t\t\t\t\t\tdomStyle.set(listTD[i],\"direction\",dir);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},this);\r\n\t\t\t\tbreak;\r\n\t\t\t//change alignment\r\n\t\t\tcase \"left\":\r\n\t\t\tcase \"right\":\r\n\t\t\tcase \"center\":\r\n\t\t\t\tarray.forEach(nodesInfo.nodes, function(x){\r\n\t\t\t\t\tif(this._hasTag(x,\"CENTER\")){\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tdomAttr.remove(x,\"align\");\r\n\t\t\t\t\tdomStyle.set(x,\"textAlign\",cmd);\r\n\t\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\tif(x.firstChild && x.firstChild.tagName){\r\n\t\t\t\t\t\t\tif(this._hasTagFrom(x.firstChild,this._lineStyledTextArray)){\r\n\t\t\t\t\t\t\t\tvar style = domStyle.getComputedStyle(x),\r\n\t\t\t\t\t\t\t\t\talign = this._refineAlignment(style.direction, style.textAlign);\r\n\t\t\t\t\t\t\t\tdomStyle.set(x.firstChild, \"textAlign\", align);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t}\t\t\t\t\t\r\n\t\t\t\t},this);\r\n\t\t\t\tbreak;\r\n\t\t\t//explicit direction setting\r\n\t\t\tcase \"explicitdir\":\r\n\t\t\t\tarray.forEach(nodesInfo.nodes, function(x){\r\n\t\t\t\t\tvar style = domStyle.getComputedStyle(x),\r\n\t\t\t\t\t\tcurDir = style.direction;\r\n\t\t\t\t\tdomAttr.remove(x,\"dir\");\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tdomStyle.set(x, {direction: curDir});\r\n\t\t\t\t},this);\r\n\t\t\t\tbreak;\r\n\t\t\t}\t\t\r\n\t\t},\r\n\r\n\t\t_prepareLists: function(nodesInfo, arg){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tPerform changes before native insertorderedlist and \r\n\t\t\t//\t\tinsertunorderedlist commands for each node from the given array.\r\n\t\t\tarray.forEach(nodesInfo.nodes, function(x,index,arr){\r\n\t\t\t\tif(has(\"mozilla\") || has(\"webkit\")){\r\n\t\t\t\t\t//Mozilla not always handles the only block inside cell\r\n\t\t\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\t\t\tvar cell = this._getParentFrom(x,[\"TD\"]);\r\n\t\t\t\t\t\tif(cell && query(\"div[tempRole]\",cell).length == 0){\r\n\t\t\t\t\t\t\tdomConstruct.create(\"div\",{innerHTML: \"<span tempRole='true'>\" + this.bogusHtmlContent + \"</span\", tempRole: \"true\"},cell);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar name = this._tag(x);\r\n\t\t\t\t\tvar styledSpan;\r\n\t\t\t\t\tif(has(\"webkit\") && this._hasTagFrom(x,this._lineStyledTextArray) || \r\n\t\t\t\t\t\t\t(this._hasTag(x,\"LI\") && this._hasStyledTextLineTag(x.firstChild))){\t\r\n\t\t\t\t\t\tvar savedName = this._hasTag(x,\"LI\")? this._tag(x.firstChild) : name;\r\n\t\t\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\t\twhile(x.firstChild.lastChild){\r\n\t\t\t\t\t\t\t\tdomConstruct.place(x.firstChild.lastChild,x.firstChild,\"after\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tstyledSpan = domConstruct.create(\"span\",{innerHTML: this.bogusHtmlContent, bogusFormat: savedName},x,\"first\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(!has(\"webkit\") && name != \"DIV\" && name != \"P\" && name != \"LI\"){\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// In some cases, when one of insertlists command is executed for list of another type, and selection\r\n\t\t\t\t\t// includes the last item of this list, webkit loses current selection after native call.\r\n\t\t\t\t\t// To avoid this we append the list with bogus item, which finally will be removed by \"post\" action. \r\n\t\t\t\t\tif(has(\"webkit\") && this._isListTypeChanged(x, arg) && x === x.parentNode.lastChild){\r\n\t\t\t\t\t\tdomConstruct.create(\"li\",{tempRole: \"true\"},x,\"after\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(name == \"LI\" && x.firstChild && x.firstChild.tagName){\r\n\t\t\t\t\t\tif(this._hasTagFrom(x.firstChild,this._lineStyledTextArray)){\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// When blocks are converted into list items, their attributes are lost.\r\n\t\t\t\t\t// We save attributes in some bogus inline element with the goal to restore \r\n\t\t\t\t\t// them after execution the command. \t\t\t\t\t\t\r\n\t\t\t\t\tvar style = domStyle.getComputedStyle(x),curDir = style.direction,curAlign = style.textAlign;\r\n\t\t\t\t\tcurAlign = this._refineAlignment(curDir, curAlign);\r\n\t\t\t\t\tvar val = this._getLIIndent(x);\r\n\t\t\t\t\tvar margin = val == 0? \"\" : \"\" + val + \"px\"; \r\n\t\t\t\t\tif(has(\"webkit\") && name == \"LI\"){\r\n\t\t\t\t\t\tdomStyle.set(x,\"textAlign\",\"\");\r\n\t\t\t\t\t}\t\t\t\t\t\t\r\n\t\t\t\t\tvar span = styledSpan? x.firstChild : domConstruct.create(\"span\",{innerHTML: this.bogusHtmlContent},x,\"first\");\r\n\t\t\t\t\tdomAttr.set(span,\"bogusDir\",curDir);\r\n\t\t\t\t\tif(curAlign != \"\"){\r\n\t\t\t\t\t\tdomAttr.set(span,\"bogusAlign\",curAlign);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(margin){\r\n\t\t\t\t\t\tdomAttr.set(span,\"bogusMargin\",margin);\r\n\t\t\t\t\t}\r\n\t\t\t\t}else if(has(\"ie\")){\r\n\t\t\t\t\t// When IE executes insertlist command for list item, containing block,\r\n\t\t\t\t\t// it saves styles of list item in this block. We should then remove \r\n\t\t\t\t\t// bogus margins, if list item is converted into the block.\r\n\t\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\tvar dir = domStyle.getComputedStyle(x).direction;\r\n\t\t\t\t\t\tdomStyle.set(x,\"marginRight\",\"\");\r\n\t\t\t\t\t\tdomStyle.set(x,\"marginLeft\",\"\");\r\n\t\t\t\t\t\tif(this._getLILevel(x) == 1 && !this._isListTypeChanged(x,cmd)){\r\n\t\t\t\t\t\t\tif(x.firstChild && this._hasTagFrom(x.firstChild,[\"P\",\"PRE\"])){\r\n\t\t\t\t\t\t\t\tdomConstruct.create(\"span\",{bogusIEFormat: this._tag(x.firstChild)},x.firstChild,\"first\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t//IE fais, when try to handle list items, containing PRE \r\n\t\t\t\t\t\t\tif(this._hasTag(x.firstChild,\"PRE\")){\r\n\t\t\t\t\t\t\t\tvar p = domConstruct.create(\"p\",null,x.firstChild,\"after\");\r\n\t\t\t\t\t\t\t\twhile(x.firstChild.firstChild){\r\n\t\t\t\t\t\t\t\t\tdomConstruct.place(x.firstChild.firstChild,p,\"last\");\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tp.style.cssText = x.style.cssText;\r\n\t\t\t\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\t\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t},this);\r\n\t\t\t// If selection includes some cells of table and some items of one-level list, which is the table's next sibling,\r\n\t\t\t// webkit doesn't complete the action. For example, having <table>...</table><ul><li>One</li><li>Two</li></ul>,\r\n\t\t\t// after executing \"insertunorderedlist\" command, we get <table>...</table><ul><li>One</li>Two.\r\n\t\t\t// To avoid this, we add after the table some bogus list, which will be deleted after executing \"post native\" action.\r\n\t\t\tif(has(\"webkit\")){\r\n\t\t\t\tquery(\"table\",this.editor.editNode).forEach(function(x,ind,arr){\r\n\t\t\t\t\tvar sibling = x.nextSibling;\r\n\t\t\t\t\tif(sibling && this._hasTagFrom(sibling,[\"UL\",\"OL\"])){\r\n\t\t\t\t\t\tdomConstruct.create(\"UL\",{tempRole: \"true\"},x,\"after\");\r\n\t\t\t\t\t}\r\n\t\t\t\t},this);\t\r\n\t\t\t}\t\t\t\r\n\t\t},\r\n\t\t\r\n\t\t_execInsertLists: function(nodesInfo){\r\n\t\t\tarray.forEach(nodesInfo.nodes, function(x,index){\r\n\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t//If one of \"styled\" text blocks, like <h*> or <pre>, is converted\r\n\t\t\t\t\t//into list item, it actually is included into new list item, \r\n\t\t\t\t\t//created without attributes. This causes problems in subsequent changes \r\n\t\t\t\t\t//of orientation or alignment of this list item.\t\r\n\t\t\t\t\tif(x.firstChild && x.firstChild.tagName){\r\n\t\t\t\t\t\tif(this._hasTagFrom(x.firstChild,this._lineStyledTextArray)){\r\n\t\t\t\t\t\t\tvar style = domStyle.getComputedStyle(x.firstChild),\r\n\t\t\t\t\t\t\t\talign = this._refineAlignment(style.direction, style.textAlign);\r\n\t\t\t\t\t\t\tdomStyle.set(x,{direction: style.direction, textAlign: align});\r\n\t\t\t\t\t\t\tvar mLeft = this._getIntStyleValue(x,\"marginLeft\") + this._getIntStyleValue(x.firstChild,\"marginLeft\");\r\n\t\t\t\t\t\t\tvar mRight = this._getIntStyleValue(x,\"marginRight\") + this._getIntStyleValue(x.firstChild,\"marginRight\");\r\n\t\t\t\t\t\t\tvar leftMargin = mLeft? \"\" + mLeft + \"px\" : \"\";\r\n\t\t\t\t\t\t\tvar rightMargin = mRight? \"\" + mRight + \"px\" : \"\";\r\n\t\t\t\t\t\t\tdomStyle.set(x,{marginLeft: leftMargin, marginRight: rightMargin});\r\n\t\t\t\t\t\t\tdomStyle.set(x.firstChild,{direction: \"\", textAlign: \"\"});\r\n\t\t\t\t\t\t\tif(!has(\"mozilla\")){\r\n\t\t\t\t\t\t\t\tdomStyle.set(x.firstChild,{marginLeft: \"\", marginRight: \"\"});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//Mozilla sometimes includes few empty text nodes (or text nodes, containing spaces)\r\n\t\t\t\t\t//to the end of newly created list item\r\n\t\t\t\t\twhile(x.childNodes.length > 1){\r\n\t\t\t\t\t\tif(!(x.lastChild.nodeType == 3 && x.lastChild.previousSibling && x.lastChild.previousSibling.nodeType == 3 && lang.trim(x.lastChild.nodeValue) == \"\")){\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\t\r\n\t\t\t\t\t\tx.removeChild(x.lastChild);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(has(\"safari\")){\r\n\t\t\t\t\t\tif(this._hasTag(x.firstChild,\"SPAN\") && domClass.contains(x.firstChild,\"Apple-style-span\")){\r\n\t\t\t\t\t\t\tvar child = x.firstChild;\r\n\t\t\t\t\t\t\tif(this._hasTag(child.firstChild,\"SPAN\") && domAttr.has(child.firstChild,\"bogusFormat\")){\r\n\t\t\t\t\t\t\t\twhile(child.lastChild){\r\n\t\t\t\t\t\t\t\t\tdomConstruct.place(child.lastChild,child,\"after\");\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tx.removeChild(child);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}else if(this._hasTag(x,\"DIV\") && x.childNodes.length == 0){\r\n\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\t\t\t\t\r\n\t\t\t\tif(has(\"ie\")){\r\n\t\t\t\t\t// IE always converts list items to <P>\r\n\t\t\t\t\tif(this._hasTag(x,\"P\") && this.blockMode.toUpperCase() == \"DIV\"){\r\n\t\t\t\t\t\tif(this._hasTag(x.firstChild,\"SPAN\") && domAttr.has(x.firstChild,\"bogusIEFormat\")){\r\n\t\t\t\t\t\t\tif(domAttr.get(x.firstChild,\"bogusIEFormat\").toUpperCase() === \"PRE\"){\r\n\t\t\t\t\t\t\t\tvar pre = domConstruct.create(\"pre\",{innerHTML: x.innerHTML},x,\"before\");\r\n\t\t\t\t\t\t\t\tpre.style.cssText = x.style.cssText;\r\n\t\t\t\t\t\t\t\tpre.removeChild(pre.firstChild);\r\n\t\t\t\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar nDiv = domConstruct.create(\"div\");\r\n\t\t\t\t\t\tnDiv.style.cssText = x.style.cssText;\r\n\t\t\t\t\t\tx.parentNode.insertBefore(nDiv,x);\r\n\t\t\t\t\t\twhile(x.firstChild){\r\n\t\t\t\t\t\t\tnDiv.appendChild(x.firstChild);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t\t}\t\r\n\t\t\t\t\tif(!this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis._refineLIMargins(x);\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t// Instead of converting regular block into list item, IE includes block into the newly created item\r\n\t\t\t\t\tvar div = x.firstChild;\r\n\t\t\t\t\tif(!this._hasTag(div,\"DIV\")){\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(!(div === x.lastChild)){\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar style = domStyle.getComputedStyle(div), dir = style.direction, align = style.textAlign,\r\n\t\t\t\t\t\tcurAlign = domStyle.getComputedStyle(x).textAlign;\r\n\t\t\t\t\tdomStyle.set(x,\"direction\",dir);\r\n\t\t\t\t\talign = this._refineAlignment(dir, align);\r\n\t\t\t\t\tdomStyle.set(x,\"textAlign\",align);\r\n\t\t\t\t\twhile(div.firstChild){\r\n\t\t\t\t\t\tx.insertBefore(div.firstChild, div);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tx.removeChild(div);\r\n\t\t\t\t}else if(!this._hasTag(x.firstChild,\"SPAN\")){\r\n\t\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\tthis._refineLIMargins(x);\r\n\t\t\t\t\t\tif(has(\"mozilla\") && this._hasStyledTextLineTag(x.firstChild)){\r\n\t\t\t\t\t\t\tthis._recountLIMargins(x);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\t\r\n\t\t\t\t// Restore attributes and remove bogus elments\r\n\t\t\t\tvar hasBogusSpan = false;\r\n\t\t\t\tvar indentWithMargin = false;\r\n\t\t\t\tvar hasBogusAlign = false;\r\n\t\t\t\tvar marginVal = 0; \r\n\t\t\t\tif(domAttr.has(x.firstChild,\"bogusDir\")){\r\n\t\t\t\t\thasBogusSpan = true;\r\n\t\t\t\t\tvar dir = domAttr.get(x.firstChild,\"bogusDir\");\r\n\t\t\t\t\tdomStyle.set(x,\"direction\",dir);\r\n\t\t\t\t}\r\n\t\t\t\tif(domAttr.has(x.firstChild,\"bogusAlign\")){\r\n\t\t\t\t\thasBogusSpan = true;\r\n\t\t\t\t\thasBogusAlign = true;\r\n\t\t\t\t\tvar align = domAttr.get(x.firstChild,\"bogusAlign\");\r\n\t\t\t\t\tdomStyle.set(x,\"textAlign\",align);\r\n\t\t\t\t\tvar sibling = x.firstChild.nextSibling;\r\n\t\t\t\t\tif(this._hasTag(sibling,\"SPAN\") && domStyle.get(sibling,\"textAlign\") === align){\r\n\t\t\t\t\t\tdomStyle.set(sibling,\"textAlign\",\"\");\r\n\t\t\t\t\t\tif(sibling.style.cssText == \"\"){\r\n\t\t\t\t\t\t\twhile(sibling.lastChild){\r\n\t\t\t\t\t\t\t\tdomConstruct.place(sibling.lastChild,sibling,\"after\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tx.removeChild(sibling);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif(domAttr.has(x.firstChild,\"bogusMargin\")){\r\n\t\t\t\t\thasBogusSpan = true;\r\n\t\t\t\t\tindentWithMargin = true;\r\n\t\t\t\t\tmarginVal = parseInt(domAttr.get(x.firstChild,\"bogusMargin\"));\r\n\t\t\t\t\tif(!this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\tvar mStyle = domStyle.get(x,\"direction\") === \"rtl\"? \"marginRight\" : \"marginLeft\";\r\n\t\t\t\t\t\tvar mVal = this._getIntStyleValue(x,mStyle) + marginVal;\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tdomStyle.set(x,mStyle,(mVal == 0? \"\" : \"\" + mVal + \"px\"));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\t\t\t\t\t\r\n\t\t\t\tif(domAttr.has(x.firstChild,\"bogusFormat\")){\r\n\t\t\t\t\thasBogusSpan = false;\r\n\t\t\t\t\tdomAttr.remove(x.firstChild,\"bogusDir\");\r\n\t\t\t\t\tif(x.firstChild.nextSibling && this._hasTag(x.firstChild.nextSibling,\"SPAN\")){\r\n\t\t\t\t\t\tvar bogusStyles = x.firstChild.style.cssText.trim().split(\";\");\r\n\t\t\t\t\t\tvar savedStyles = x.firstChild.nextSibling.style.cssText.trim().split(\";\");\r\n\t\t\t\t\t\tfor(var i = 0; i < bogusStyles.length; i++){\r\n\t\t\t\t\t\t\tif(bogusStyles[i]){\r\n\t\t\t\t\t\t\t\tfor(var j = 0; j < savedStyles.length; j++){\r\n\t\t\t\t\t\t\t\t\tif(bogusStyles[i].trim() == savedStyles[j].trim()){\r\n\t\t\t\t\t\t\t\t\t\tvar style = bogusStyles[i].trim().split(\":\")[0];\r\n\t\t\t\t\t\t\t\t\t\tdomStyle.set(x.firstChild.nextSibling,style,\"\");\r\n\t\t\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif(x.firstChild.nextSibling.style.cssText === \"\"){\r\n\t\t\t\t\t\t\twhile(x.firstChild.nextSibling.firstChild){\r\n\t\t\t\t\t\t\t\tdomConstruct.place(x.firstChild.nextSibling.firstChild,x.firstChild.nextSibling,\"after\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tx.removeChild(x.firstChild.nextSibling);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar tag = domAttr.get(x.firstChild,\"bogusFormat\");\r\n\t\t\t\t\tvar block = domConstruct.create(tag,null,x.firstChild,\"after\");\r\n\t\t\t\t\twhile(block.nextSibling){\r\n\t\t\t\t\t\tdomConstruct.place(block.nextSibling,block,\"last\");\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t\tif(has(\"webkit\")){\r\n\t\t\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\t\tvar parent = x.parentNode.parentNode;\r\n\t\t\t\t\t\t\tif(this._hasTag(parent,tag)){\r\n\t\t\t\t\t\t\t\tdomAttr.set(parent,\"tempRole\",\"true\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(x.childNodes.length == 1 && !this._hasTag(x,\"TD\")){\r\n\t\t\t\t\t\tif(!has(\"mozilla\") && !this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\t\tblock.style.cssText = x.style.cssText;\r\n\t\t\t\t\t\t\tdomAttr.set(x,\"tempRole\",\"true\");\r\n\t\t\t\t\t\t}else if(!this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\t\tblock.style.cssText = x.style.cssText;\r\n\t\t\t\t\t\t\tdomConstruct.place(block,x,\"after\");\r\n\t\t\t\t\t\t\tdomAttr.set(x,\"tempRole\",\"true\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif(hasBogusSpan){\r\n\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t}\r\n\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t// Chrome: if direction of list item is differ from default orientation, text alignment \r\n\t\t\t\t\t// of this item should be set explicitly\r\n\t\t\t\t\tif(has(\"webkit\") && !hasBogusAlign && domStyle.get(x,\"textAlign\") != \"center\"){\r\n\t\t\t\t\t\tdomStyle.set(x,\"textAlign\",(domStyle.get(x,\"direction\") == \"rtl\"? \"right\" : \"left\"));\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// Safari: when type of the list, having differently directed items, is changed, Safari inserts sometimes\r\n\t\t\t\t\t// into this list DIV with the contents of previous list item. \r\n\t\t\t\t\tif(has(\"safari\") && this._hasTag(x,\"DIV\")){\r\n\t\t\t\t\t\tx.innerHTML = x.nextSibling.innerHTML;\r\n\t\t\t\t\t\tx.parentNode.removeChild(x.nextSibling);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar pDiv = x.parentNode.parentNode;\r\n\t\t\t\t\tif(pDiv !== this.editor.editNode && this._hasTag(pDiv,\"DIV\")){\r\n\t\t\t\t\t\tif(pDiv.childNodes.length == 1){\r\n\t\t\t\t\t\t\tpDiv.parentNode.insertBefore(x.parentNode,pDiv);\r\n\t\t\t\t\t\t\tpDiv.parentNode.removeChild(pDiv);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis._refineLIMargins(x);\t\t\t\t\t\t\r\n\t\t\t\t\tif(indentWithMargin){\t\r\n\t\t\t\t\t\tthis._recountLIMargins(x, marginVal);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},this);\r\n\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\tquery(\"*[tempRole]\",this.editor.editNode).forEach(function(x,index,arr){\r\n\t\t\t\t\tif(this._hasTag(x,\"SPAN\")){\r\n\t\t\t\t\t\tif(domAttr.get(x.parentNode,\"tempRole\")){\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}else if(this._hasTag(x.parentNode,\"LI\")){\r\n\t\t\t\t\t\t\tx.parentNode.parentNode.removeChild(x.parentNode);\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t},this);\r\n\t\t\t}else if(has(\"webkit\")){\r\n\t\t\t\tquery(\"*[tempRole]\",this.editor.editNode).forEach(function(x,index,arr){\r\n\t\t\t\t\tif(this._hasTag(x, \"LI\") || this._hasTag(x,\"UL\")){\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\twhile(x.lastChild){\r\n\t\t\t\t\t\tdomConstruct.place(x.lastChild,x,\"after\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t},this);\r\n\t\t\t}\t\t\t\r\n\t\t},\r\n\t\t\r\n\t\t_execNormalizedIndent: function(nodesInfo){\r\n\t\t\tarray.forEach(nodesInfo.nodes, function(x){\r\n\t\t\t\tvar style = domStyle.get(x,\"direction\") === \"rtl\"? \"marginRight\" : \"marginLeft\";\r\n\t\t\t\tvar cMargin = domStyle.get(x,style);\r\n\t\t\t\tvar cIndent = isNaN(cMargin)? 0 : parseInt(cMargin);\r\n\t\t\t\tdomStyle.set(x,style,\"\" + (cIndent + this._indentBy) + \"px\");\r\n\t\t\t},this);\r\n\t\t},\r\n\r\n\t\t_execNormalizedOutdent: function(nodesInfo){\r\n\t\t\tarray.forEach(nodesInfo.nodes, function(x){\r\n\t\t\t\tvar style = domStyle.get(x,\"direction\") === \"rtl\"? \"marginRight\" : \"marginLeft\";\r\n\t\t\t\tvar cMargin = domStyle.get(x,style)\r\n\t\t\t\tvar cIndent = isNaN(cMargin)? 0 : parseInt(cMargin);\r\n\t\t\t\tvar offs = 0;\r\n\t\t\t\tif(x.tagName.toUpperCase() === \"LI\"){\r\n\t\t\t\t\tvar level = 0, tNode = x.parentNode, name;\r\n\t\t\t\t\tif(domStyle.get(x,\"direction\") != domStyle.get(tNode,\"direction\")){\r\n\t\t\t\t\t\twhile(tNode !== this.editor.editNode){\r\n\t\t\t\t\t\t\tif(this._hasTagFrom(tNode,[\"OL\",\"UL\"])){\r\n\t\t\t\t\t\t\t\tlevel++;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\ttNode = tNode.parentNode;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\toffs = this._getMargins(level);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif(cIndent >= this._indentBy + offs){\r\n\t\t\t\t\tdomStyle.set(x,style,(cIndent == this._indentBy? \"\" : \"\" + (cIndent - this._indentBy) + \"px\"));\r\n\t\t\t\t}\r\n\t\t\t},this);\t\t\t\r\n\t\t},\r\n\r\n\t\t_prepareIndent: function(nodesInfo){\r\n\t\t\tarray.forEach(nodesInfo.nodes, function(x){\r\n\t\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\t\tvar cell = this._getParentFrom(x,[\"TD\"]);\r\n\t\t\t\t\tif(!!cell && (query(\"div[tempRole]\",cell).length == 0)){\r\n\t\t\t\t\t\tdomConstruct.create(\"div\",{innerHTML: this.bogusHtmlContent, tempRole: \"true\"},cell);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\tvar indent = this._getLIIndent(x);\r\n\t\t\t\t\t\tdomAttr.set(x,\"tempIndent\",indent);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif(has(\"webkit\") && this._hasTag(x,\"LI\") && this._hasStyledTextLineTag(x.firstChild)){\t\r\n\t\t\t\t\tvar name = this._tag(x.firstChild);\r\n\t\t\t\t\twhile(x.firstChild.lastChild){\r\n\t\t\t\t\t\tdomConstruct.place(x.firstChild.lastChild,x.firstChild,\"after\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t\tdomConstruct.create(\"span\",{innerHTML: this.bogusHtmlContent, bogusFormat: name},x,\"first\");\r\n\t\t\t\t}\r\n\t\t\t},this);\t\t\t\r\n\t\t},\r\n\r\n\t\t_prepareOutdent: function(nodesInfo){\r\n\t\t\tarray.forEach(nodesInfo.nodes, function(x){\r\n\t\t\t\tif(has(\"mozilla\") || has(\"webkit\")){\r\n\t\t\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\t\t\tvar cell = this._getParentFrom(x,[\"TD\"]);\r\n\t\t\t\t\t\tif(!!cell && (query(\"div[tempRole]\",cell).length == 0)){\r\n\t\t\t\t\t\t\tdomConstruct.create(\"div\",{innerHTML: this.bogusHtmlContent, tempRole: \"true\"},cell);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// FF: Outdent for the list items from first level's list converts them into sequence of \r\n\t\t\t\t\t// text elements, separated by <BR>s. Attributes of list items are lost.\r\n\t\t\t\t\t// Webkit: Attributes of items, placed into blockquote, are lost after outdent.\r\n\t\t\t\t\t// We save attributes in some bogus inline element with the goal to restore \r\n\t\t\t\t\t// them after execution the command. \t\t\t\t\t\r\n\t\t\t\t\tvar name = this._tag(x);\r\n\t\t\t\t\tif(has(\"mozilla\") && name !== \"LI\"){\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar styledSpan = null;\r\n\t\t\t\t\tif(has(\"webkit\")){\r\n\t\t\t\t\t\tif(this._hasTag(x,\"LI\") && this._hasStyledTextLineTag(x.firstChild)){\r\n\t\t\t\t\t\t\tname = this._tag(x.firstChild);\r\n\t\t\t\t\t\t\tvar child = x.firstChild;\r\n\t\t\t\t\t\t\twhile(child.lastChild){\r\n\t\t\t\t\t\t\t\tdomConstruct.place(child.lastChild,child,\"after\");\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t\t\t\tstyledSpan = domConstruct.create(\"span\",{innerHTML: this.bogusHtmlContent, bogusFormat: name},x,\"first\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(x.firstChild && x.firstChild.tagName){     \r\n\t\t\t\t\t\tif(this._hasTagFrom(x.firstChild,this._lineStyledTextArray)){\r\n\t\t\t\t\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\t\t\t\t\tx.firstChild.style.cssText = x.style.cssText;\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tvar margin = domStyle.get(x,\"direction\") === \"rtl\"? \"marginRight\" : \"marginLeft\";\r\n\t\t\t\t\t\t\t\tvar indent = this._getLIIndent(x);\r\n\t\t\t\t\t\t\t\tif(indent > 0){\r\n\t\t\t\t\t\t\t\t\tdomStyle.set(x.firstChild,margin,\"\" + indent + \"px\");\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar style = domStyle.getComputedStyle(x),curDir = style.direction,curAlign = style.textAlign;\r\n\t\t\t\t\tcurAlign = this._refineAlignment(curDir, curAlign);\r\n\t\t\t\t\tif(has(\"webkit\") && name == \"LI\"){\r\n\t\t\t\t\t\tdomStyle.set(x,\"textAlign\",\"\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar span = styledSpan? x.firstChild : domConstruct.create(\"span\",{innerHTML: this.bogusHtmlContent},x,\"first\");\r\n\t\t\t\t\tdomAttr.set(span,\"bogusDir\",curDir);\r\n\t\t\t\t\tif(curAlign != \"\"){\r\n\t\t\t\t\t\tdomAttr.set(span,\"bogusAlign\",curAlign);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\t\t\tvar indent = this._getLIIndent(x);\r\n\t\t\t\t\t\tdomAttr.set(span,\"bogusIndent\",indent);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif(has(\"ie\")){\r\n\t\t\t\t\tif(x.tagName.toUpperCase() == \"LI\"){\r\n\t\t\t\t\t\tdomStyle.set(x,\"marginLeft\",\"\");\r\n\t\t\t\t\t\tdomStyle.set(x,\"marginRight\",\"\");\r\n\t\t\t\t\t\tif(this._getLILevel(x) == 1){\r\n\t\t\t\t\t\t\tif(x.firstChild && this._hasTagFrom(x.firstChild,[\"P\",\"PRE\"])){\r\n\t\t\t\t\t\t\t\tdomConstruct.create(\"span\",{bogusIEFormat: this._tag(x.firstChild)},x.firstChild,\"first\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t//IE fais, when try to handle first level list items, containing PRE \r\n\t\t\t\t\t\t\tif(this._hasTag(x.firstChild,\"PRE\")){\r\n\t\t\t\t\t\t\t\tvar p = domConstruct.create(\"p\",null,x.firstChild,\"after\");\r\n\t\t\t\t\t\t\t\twhile(x.firstChild.firstChild){\r\n\t\t\t\t\t\t\t\t\tdomConstruct.place(x.firstChild.firstChild,p,\"last\");\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tp.style.cssText = x.style.cssText;\r\n\t\t\t\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\t\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},this);\t\t\t\r\n\t\t},\r\n\r\n\t\t_execIndent: function(nodesInfo){\r\n\t\t\tarray.forEach(nodesInfo.nodes, function(x){\r\n\t\t\t\tif(!has(\"mozilla\")){\r\n\t\t\t\t\tdomStyle.set(x,\"margin\",\"\");\r\n\t\t\t\t}\r\n\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\tvar indent = 0;\r\n\t\t\t\t\tif(has(\"mozilla\") && domAttr.has(x,\"tempIndent\")){\r\n\t\t\t\t\t\tindent = parseInt(domAttr.get(x,\"tempIndent\"));\r\n\t\t\t\t\t\tdomAttr.remove(x,\"tempIndent\");\r\n\t\t\t\t\t}\t\t\t\t\t\t\t\r\n\t\t\t\t\tthis._refineLIMargins(x);\r\n\t\t\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\t\t\tthis._recountLIMargins(x,indent);\r\n\t\t\t\t\t}\t\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\tif(domAttr.has(x.firstChild,\"bogusFormat\")){\r\n\t\t\t\t\tvar tag = domAttr.get(x.firstChild,\"bogusFormat\");\r\n\t\t\t\t\tvar block = domConstruct.create(tag,null,x.firstChild,\"after\");\r\n\t\t\t\t\twhile(block.nextSibling){\r\n\t\t\t\t\t\tdomConstruct.place(block.nextSibling,block,\"last\");\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t}\r\n\t\t\t\tif(has(\"ie\") || has(\"webkit\")){\r\n\t\t\t\t\t// Remove attribute dir from newly created blockquotes\r\n\t\t\t\t\tvar supBq = x.parentNode;\r\n\t\t\t\t\twhile(supBq !== this.editor.editNode){\r\n\t\t\t\t\t\tsupBq = rangeapi.getBlockAncestor(supBq, /blockquote/i, this.editor.editNode).blockNode;\r\n\t\t\t\t\t\tif(!supBq){\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif(domAttr.has(supBq, \"dir\")){\r\n\t\t\t\t\t\t\tdomAttr.remove(supBq, \"dir\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tdomStyle.set(supBq,\"marginLeft\",\"\");\r\n\t\t\t\t\t\tdomStyle.set(supBq,\"marginRight\",\"\");\r\n\t\t\t\t\t\tdomStyle.set(supBq,\"margin\",\"\");\r\n\t\t\t\t\t\tsupBq = supBq.parentNode;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},this);\r\n\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\tquery(\"div[tempRole]\",this.editor.editNode).forEach(function(x,index,arr){\r\n\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t});\r\n\t\t\t\tquery(\"ul,ol\",this.editor.editNode).forEach(function(x,index,arr){\t\t\t\t\t\t\r\n\t\t\t\t\tdomStyle.set(x,\"marginLeft\",\"\");\r\n\t\t\t\t\tdomStyle.set(x,\"marginRight\",\"\");\r\n\t\t\t\t});\t\t\t\t\t\r\n\t\t\t}\t\t\t\t\r\n\t\t},\r\n\r\n\t\t_execOutdent: function(nodesInfo){\r\n\t\t\tarray.forEach(nodesInfo.nodes, function(x){\r\n\t\t\t\tif(has(\"mozilla\") || has(\"webkit\")){\r\n\t\t\t\t\tif(!this._hasTag(x.firstChild,\"SPAN\")){\r\n\t\t\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\t\tthis._refineLIMargins(x);\r\n\t\t\t\t\t\t\tif(has(\"mozilla\") && this._hasStyledTextLineTag(x.firstChild)){\r\n\t\t\t\t\t\t\t\tthis._recountLIMargins(x);\r\n\t\t\t\t\t\t\t\tx.firstChild.style.cssText = \"\";\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\t\t\t\t\t\t\t\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// Restore attributes and remove bogus elments\r\n\t\t\t\t\tvar hasBogusSpan = false;\r\n\t\t\t\t\tvar isFormatted = false;\r\n\t\t\t\t\tvar indent = 0;\r\n\t\t\t\t\tif(domAttr.has(x.firstChild,\"bogusDir\")){\r\n\t\t\t\t\t\thasBogusSpan = true;\r\n\t\t\t\t\t\tvar dir = domAttr.get(x.firstChild,\"bogusDir\");\r\n\t\t\t\t\t\tdomStyle.set(x,\"direction\",dir);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(domAttr.has(x.firstChild,\"bogusAlign\")){\r\n\t\t\t\t\t\thasBogusSpan = true;\r\n\t\t\t\t\t\tvar align = domAttr.get(x.firstChild,\"bogusAlign\");\r\n\t\t\t\t\t\tdomStyle.set(x,\"textAlign\",align);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(domAttr.has(x.firstChild,\"bogusIndent\")){\r\n\t\t\t\t\t\thasBogusSpan = true;\r\n\t\t\t\t\t\tindent = parseInt(domAttr.get(x.firstChild,\"bogusIndent\"));\r\n\t\t\t\t\t\tif(!this._hasTag(x, \"LI\")){\r\n\t\t\t\t\t\t\tvar marginStyle = domStyle.get(x,\"direction\") === \"rtl\"? \"marginRight\" : \"marginLeft\";\r\n\t\t\t\t\t\t\tvar marginVal = \"\" + (this._getIntStyleValue(x,marginStyle) + indent) + \"px\";\r\n\t\t\t\t\t\t\tdomStyle.set(x,marginStyle,marginVal);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\t\t\t\t\t\t\r\n\t\t\t\t\tif(domAttr.has(x.firstChild,\"bogusFormat\")){\r\n\t\t\t\t\t\thasBogusSpan = true;\r\n\t\t\t\t\t\tvar tag = domAttr.get(x.firstChild,\"bogusFormat\");\r\n\t\t\t\t\t\tvar block = domConstruct.create(tag,null,x.firstChild,\"after\");\r\n\t\t\t\t\t\twhile(block.nextSibling){\r\n\t\t\t\t\t\t\tdomConstruct.place(block.nextSibling,block,\"last\");\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif(!this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\t\tblock.style.cssText = x.style.cssText;\r\n\t\t\t\t\t\t\tisFormatted = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\t\t\t\t\t\t\r\n\t\t\t\t\tif(hasBogusSpan){\r\n\t\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t\t\tif(isFormatted){\r\n\t\t\t\t\t\t\twhile(x.lastChild){\r\n\t\t\t\t\t\t\t\tdomConstruct.place(x.lastChild,x,\"after\");\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tdomAttr.set(x,\"tempRole\",\"true\");\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(has(\"webkit\") && this._hasTag(x,\"LI\") && domStyle.get(x,\"textAlign\") != \"center\"){\r\n\t\t\t\t\t\tdomStyle.set(x,\"textAlign\",(domStyle.get(x,\"direction\") == \"rtl\"? \"right\" : \"left\"));\r\n\t\t\t\t\t}\t\t\t\t\t\t\r\n\t\t\t\t\tif(has(\"mozilla\") && this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\tvar pDiv = x.parentNode.parentNode;\r\n\t\t\t\t\t\tif(pDiv !== this.editor.editNode && this._hasTag(pDiv,\"DIV\")){\r\n\t\t\t\t\t\t\tif(pDiv.childNodes.length == 1){\r\n\t\t\t\t\t\t\t\tpDiv.parentNode.insertBefore(x.parentNode,pDiv);\r\n\t\t\t\t\t\t\t\tpDiv.parentNode.removeChild(pDiv);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif(has(\"ie\")){\r\n\t\t\t\t\t// IE always converts list items to <P>\r\n\t\t\t\t\tif(this._hasTag(x,\"P\") && this.blockMode.toUpperCase() == \"DIV\"){\r\n\t\t\t\t\t\tif(this._hasTag(x.firstChild,\"SPAN\") && domAttr.has(x.firstChild,\"bogusIEFormat\")){\r\n\t\t\t\t\t\t\tif(domAttr.get(x.firstChild,\"bogusIEFormat\").toUpperCase() === \"PRE\"){\r\n\t\t\t\t\t\t\t\tvar pre = domConstruct.create(\"pre\",{innerHTML: x.innerHTML},x,\"before\");\r\n\t\t\t\t\t\t\t\tpre.style.cssText = x.style.cssText;\r\n\t\t\t\t\t\t\t\tpre.removeChild(pre.firstChild);\r\n\t\t\t\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tvar nDiv = domConstruct.create(\"div\");\r\n\t\t\t\t\t\tnDiv.style.cssText = x.style.cssText;\r\n\t\t\t\t\t\tx.parentNode.insertBefore(nDiv,x);\r\n\t\t\t\t\t\twhile(x.firstChild){\r\n\t\t\t\t\t\t\tnDiv.appendChild(x.firstChild);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t\t}\t\r\n\t\t\t\t}\r\n\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\tthis._refineLIMargins(x);\r\n\t\t\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\t\t\tthis._recountLIMargins(x,indent);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t},this);\r\n\t\t\tif(has(\"mozilla\") || has(\"webkit\")){\r\n\t\t\t\tquery(\"div[tempRole]\",this.editor.editNode).forEach(function(x,index,arr){\r\n\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t});\r\n\t\t\t}\t\t\t\r\n\t\t},\r\n\r\n\t\t_prepareFormat: function(nodesInfo, arg){\r\n\t\t\tarray.forEach(nodesInfo.nodes, function(x){\r\n\t\t\t\t// In some cases Mozill'a native 'formatblock' command mistakely merges contents of list items.\r\n\t\t\t\t// For example, for list with three items, containing some text like \"one\", \"two\", \"three\" and first two items selected, \r\n\t\t\t\t// after changing their format from \"None\" to \"Paragraph\" we get from <li>one</li><li>two<li> something like \r\n\t\t\t\t// <li><p>Onetwo</p></li><li><br></li>. Problem can be solved by 'manual' formatting, \r\n\t\t\t\t// so with given example we create <li><p>...</p></li> for each list item.\r\n\t\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\tif(x.firstChild && !this._isBlockElement(x.firstChild)){\r\n\t\t\t\t\t\t\tvar div = x.ownerDocument.createElement(arg), sibling = x.firstChild;\r\n\t\t\t\t\t\t\tx.insertBefore(div, x.firstChild);\r\n\t\t\t\t\t\t\twhile(sibling){\r\n\t\t\t\t\t\t\t\tdiv.appendChild(sibling);\r\n\t\t\t\t\t\t\t\tsibling = sibling.nextSibling;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar indent = this._getLIIndent(x);\r\n\t\t\t\t\t\tdomAttr.set(x,\"tempIndent\",indent);\r\n\t\t\t\t\t}\t\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\tif(has(\"webkit\")){\r\n\t\t\t\t\tvar styledSpan;\r\n\t\t\t\t\t// If \"fomatblocks\" command is executed for list items, which already contain some blocks,\r\n\t\t\t\t\t// webkit merges contents of items. For example, after calling \"formatblocks\" with argument \"P\"\r\n\t\t\t\t\t// for two items <ul><li><h3>Hello</h3></li><li><h3>World</h3></li></ul> we get one item \r\n\t\t\t\t\t// <ul><li><p>Hello<br>World<p></li></ul>. To avoid this, we move contents of each block into \r\n\t\t\t\t\t// its parent,delete empty blocks and save info about required format in some bogus spans with \r\n\t\t\t\t\t// empty contents. Action, executed after native call, will recreate blocks in required format  \r\n\t\t\t\t\t// and remove bogus spans.\r\n\t\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\t\tvar savedName = arg;\r\n\t\t\t\t\t\tif(this._hasStyledTextLineTag(x.firstChild)){\r\n\t\t\t\t\t\t\twhile(x.firstChild.lastChild){\r\n\t\t\t\t\t\t\t\tdomConstruct.place(x.firstChild.lastChild,x.firstChild,\"after\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tstyledSpan = domConstruct.create(\"span\",{innerHTML: this.bogusHtmlContent, bogusFormat: savedName},x,\"first\");\r\n\t\t\t\t\t}\r\n \t\t\t\t\t// Webkit lose 'direction' and 'textAlign' styles of reformatted blocks. \r\n\t\t\t\t\t// We save info about these styles in attributes of some bogus SPANs with empty contents.\t\t\t\t\t\r\n\t\t\t\t\t// Action, executed after native call, will restore styles of these blocks and remove bogus spans. \r\n\t\t\t\t\tvar style = domStyle.getComputedStyle(x),curDir = style.direction,curAlign = style.textAlign;\r\n\t\t\t\t\tcurAlign = this._refineAlignment(curDir, curAlign);\r\n\t\t\t\t\tvar span = styledSpan? x.firstChild : domConstruct.create(\"span\",{innerHTML: this.bogusHtmlContent},x,\"first\");\r\n\t\t\t\t\tdomAttr.set(span,\"bogusDir\",curDir);\r\n\t\t\t\t\tif(curAlign != \"\"){\r\n\t\t\t\t\t\tdomAttr.set(span,\"bogusAlign\",curAlign);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},this);\t\t\t\r\n\t\t},\r\n\t\t\r\n\t\t_execFormatBlocks: function(nodesInfo, arg){\r\n\t\t\tarray.forEach(nodesInfo.nodes, function(x){\r\n\t\t\t\tif(this._hasTagFrom(x, this._lineTextArray)){\r\n\t\t\t\t\t//FF adds empty text nodes or nodes, containing spaces, after last converted block\r\n\t\t\t\t\tif(this._hasTag(x.parentNode,\"DIV\") && x.parentNode !== this.editor.editNode){\r\n\t\t\t\t\t\twhile(x.parentNode.lastChild){\r\n\t\t\t\t\t\t\tif(!(x.parentNode.lastChild.nodeType == 3 && lang.trim(x.parentNode.lastChild.nodeValue) == \"\" ||\r\n\t\t\t\t\t\t\t\t\tthis._hasTag(x.parentNode.lastChild,\"BR\"))){\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t}\t\r\n\t\t\t\t\t\t\tx.parentNode.removeChild(x.parentNode.lastChild);\r\n\t\t\t\t\t\t}\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(this._hasTag(x.parentNode,\"DIV\") && x.parentNode !== this.editor.editNode && x.parentNode.childNodes.length == 1){\r\n\t\t\t\t\t\tvar\tdiv = x.parentNode, \r\n\t\t\t\t\t\t\tstyle = domStyle.getComputedStyle(div),\r\n\t\t\t\t\t\t\talign = this._refineAlignment(style.direction, style.textAlign);\r\n\t\t\t\t\t\tdomStyle.set(x, {direction: style.direction, textAlign: align});\r\n\t\t\t\t\t\tvar margin = style.direction === \"rtl\"? \"marginRight\" : \"marginLeft\";\r\n\t\t\t\t\t\tvar marginVal = parseInt(domStyle.get(div,margin));\r\n\t\t\t\t\t\tif(marginVal != 0 && !isNan(marginVal)){\r\n\t\t\t\t\t\t\tdomStyle.set(x,margin,marginVal);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tdiv.parentNode.insertBefore(x, div);\r\n\t\t\t\t\t\tdiv.parentNode.removeChild(div);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif(this._hasTag(x,\"LI\")){\r\n\t\t\t\t\tvar indent = 0;\r\n\t\t\t\t\tif(domAttr.has(x,\"tempIndent\")){\r\n\t\t\t\t\t\tindent = parseInt(domAttr.get(x,\"tempIndent\"));\r\n\t\t\t\t\t\tdomAttr.remove(x,\"tempIndent\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis._refineLIMargins(x);\r\n\t\t\t\t\tif(indent){\r\n\t\t\t\t\t\tthis._recountLIMargins(x,indent);\r\n\t\t\t\t\t}\r\n\t\t\t\t\twhile(x.childNodes.length > 1){\r\n\t\t\t\t\t\tif(!(x.lastChild.nodeType == 3 && lang.trim(x.lastChild.nodeValue) == \"\")){\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\t\r\n\t\t\t\t\t\tx.removeChild(x.lastChild);\r\n\t\t\t\t\t}\t\t\t\t\t\t\r\n\t\t\t\t\tif(this._hasTagFrom(x.firstChild,this._lineStyledTextArray)){\r\n\t\t\t\t\t\tvar style = domStyle.getComputedStyle(x),\r\n\t\t\t\t\t\t\talign = this._refineAlignment(style.direction, style.textAlign);\r\n\t\t\t\t\t\tif(!has(\"mozilla\") && !(has(\"ie\") && this._hasTag(x,\"LI\"))){\r\n\t\t\t\t\t\t\tdomStyle.set(x.firstChild, {direction : style.direction, textAlign: align});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}else if(this._hasTag(x.firstChild,\"DIV\")){\r\n\t\t\t\t\t\tvar div = x.firstChild;\r\n\t\t\t\t\t\twhile(div.firstChild){\r\n\t\t\t\t\t\t\tx.insertBefore(div.firstChild, div);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tx.removeChild(div);\r\n\t\t\t\t\t}\t\r\n\t\t\t\t\t// IE doesn't format list items with not formatted content into paragraphs \r\n\t\t\t\t\tif(has(\"ie\") && !this._hasTag(x.firstChild,\"P\") && arg === \"<p>\"){\r\n\t\t\t\t\t\tvar p = domConstruct.create(\"p\");\r\n\t\t\t\t\t\tvar block = this._hasTagFrom(p.nextSibling,this._lineStyledTextArray)? p.nextSibling : x;\r\n\t\t\t\t\t\twhile(block.firstChild){\r\n\t\t\t\t\t\t\tdomConstruct.place(block.firstChild,p,\"last\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tdomConstruct.place(p,x,\"first\");\r\n\t\t\t\t\t\tif(block !== x){\r\n\t\t\t\t\t\t\tx.removeChild(block);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\t\r\n\t\t\t\tif(has(\"webkit\")){\r\n\t\t\t\t\t// When \"formatblocks\" with argument \"div\" is executed for list items, containing blocks like <h1>\r\n\t\t\t\t\t// or <pre>, Safari loads contents of these blocks into newly created DIVs, and places these DIVs \r\n\t\t\t\t\t// into the same list as next siblings of source items. For example, if we have something like\r\n\t\t\t\t\t// <li><h3>Hello</h3></li>, we get <li><br></li><div>Hello</div>. So we move contents of these DIV's\r\n\t\t\t\t\t// into items and set special attributes for future deleting.\r\n\t\t\t\t\tif(this._hasTag(x,\"DIV\")){\r\n\t\t\t\t\t\tif(domAttr.has(x,\"tempRole\")){\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}else if(this._hasTag(x.previousSibling,\"LI\")){\r\n\t\t\t\t\t\t\twhile(x.firstChild){\r\n\t\t\t\t\t\t\t\tdomConstruct.place(x.firstChild,x.previousSibling,\"last\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tdomAttr.set(x,\"tempRole\",true);\r\n\t\t\t\t\t\t\tx = x.previousSibling;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// Restore attributes and remove bogus elments\r\n\t\t\t\t\tvar hasBogusSpan = false;\r\n\t\t\t\t\tif(domAttr.has(x.firstChild,\"bogusDir\")){\r\n\t\t\t\t\t\thasBogusSpan = true;\r\n\t\t\t\t\t\tvar dir = domAttr.get(x.firstChild,\"bogusDir\");\r\n\t\t\t\t\t\tdomStyle.set(x,\"direction\",dir);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(domAttr.has(x.firstChild,\"bogusAlign\")){\r\n\t\t\t\t\t\thasBogusSpan = true;\r\n\t\t\t\t\t\tvar align = domAttr.get(x.firstChild,\"bogusAlign\");\r\n\t\t\t\t\t\tdomStyle.set(x,\"textAlign\",align);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(domAttr.has(x.firstChild,\"bogusFormat\")){\r\n\t\t\t\t\t\thasBogusSpan = true;\r\n\t\t\t\t\t\tvar tag = domAttr.get(x.firstChild,\"bogusFormat\");\r\n\t\t\t\t\t\tvar block;\r\n\t\t\t\t\t\tif(tag.toUpperCase() !== \"DIV\"){\r\n\t\t\t\t\t\t\tblock = domConstruct.create(tag,null,x.firstChild,\"after\");\r\n\t\t\t\t\t\t\twhile(block.nextSibling){\r\n\t\t\t\t\t\t\t\tdomConstruct.place(block.nextSibling,block,\"last\");\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tblock = x;\r\n\t\t\t\t\t\t}\t\t\t\t\t\t\r\n\t\t\t\t\t\tif(has(\"safari\") && this._hasTag(x.nextSibling,\"DIV\")){\r\n\t\t\t\t\t\t\twhile(x.nextSibling.firstChild){\r\n\t\t\t\t\t\t\t\tdomConstruct.place(x.nextSibling.firstChild,block,\"last\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tdomAttr.set(x.nextSibling,\"tempRole\",\"true\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(hasBogusSpan){\r\n\t\t\t\t\t\tx.removeChild(x.firstChild);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(tag && this._hasTag(x, \"LI\")){\r\n\t\t\t\t\t\tvar parent = x.parentNode.parentNode;\r\n\t\t\t\t\t\tif(this._hasTag(parent,tag)){\r\n\t\t\t\t\t\t\tdomAttr.set(parent,\"tempRole\",\"true\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},this);\r\n\t\t\t// Safari in some cases put ito lists unnecessary divs. They already empty and marked with 'tempRole' attribute.  \r\n\t\t\t// Both Chrome and Safari create for each formatted list item its own list and place such lists \r\n\t\t\t// into top-level block elements. In this method above, needed \"styled\" blocks are already recreated inside \r\n\t\t\t// list items, so corresponding top-level elements become unnecessary. They already marked with 'tempRole' attribute.\r\n\t\t\t// Now all elements having 'tempRole' attribute should be removed.\r\n\t\t\tif(has(\"webkit\")){\r\n\t\t\t\tquery(\"*[tempRole]\",this.editor.editNode).forEach(function(x,index,arr){\r\n\t\t\t\t\twhile(x.lastChild){\r\n\t\t\t\t\t\tdomConstruct.place(x.lastChild,x,\"after\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t},this);\r\n\t\t\t}\t\t\t\r\n\t\t},\r\n\t\t\r\n\t\t_rebuildBlock: function(block){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tFinds a sequences of inline elements that are placed \r\n\t\t\t//\t\twithin a top-level block element or have block siblings.\r\n\t\t\t//\t\tCalls _repackInlneElements(), which moves this sequences \r\n\t\t\t//\t\tinto newly created block.\r\n\t\t\tvar node = block.firstChild, firstSibling, lastSibling;\r\n\t\t\tvar hasOwnBlock = false;  \r\n\t\t\twhile(node){\r\n\t\t\t\tif(this._isInlineOrTextElement(node) && !this._hasTagFrom(node,this._tableContainers)){\r\n\t\t\t\t\thasOwnBlock = !this._hasTagFrom(block,this._lineTextArray);\r\n\t\t\t\t\tif(!firstSibling){\r\n\t\t\t\t\t\tfirstSibling = node;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlastSibling = node;\r\n\t\t\t\t}else if(this._isBlockElement(node) || this._hasTagFrom(node,this._tableContainers)){\r\n\t\t\t\t\tif(firstSibling){\r\n\t\t\t\t\t\tthis._repackInlineElements(firstSibling, lastSibling, block);\r\n\t\t\t\t\t\tfirstSibling = null;\r\n\t\t\t\t\t}\r\n\t\t\t\t\thasOwnBlock = true;\r\n\t\t\t\t}\r\n\t\t\t\tnode = node.nextSibling;\r\n\t\t\t}\r\n\t\t\tif(hasOwnBlock && firstSibling){\r\n\t\t\t\tthis._repackInlineElements(firstSibling, lastSibling, block);\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\t_repackInlineElements: function(firstSibling, lastSibling, parent){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tMoves sequences of inline elements into \r\n\t\t\t//\t\tnewly created blocks\r\n\t\t\t// description:\r\n\t\t\t//\t\tThis method handles sequences of inline elements, which are recognized by the user as \r\n\t\t\t// \t\tseparate line(s) of the text, but are not placed into their own block element. Text direction\r\n\t\t\t//\t\tor alignment can't be set for such lines.\r\n\t\t\t//\t\tPossibles cases: \r\n\t\t\t//\t\t\ta) sequence directly belongs to editor's editNode;\r\n\t\t\t//\t\t\tb) sequence has block-level siblings;\r\n\t\t\t//\t\t\tc) sequence has BR in the start or in the middle of it.\r\n\t\t\t//\t\tFor all these cases we create new block and move elements from the sequence into it.\r\n\t\t\t//\t\tWe try to preserve explicitly defined styles, which have effect on this line. In case of\r\n\t\t\t//\t\tsequences, which directly belong to editNode, it is only direction of the text.\r\n\t\t\tvar divs = [], div = parent.ownerDocument.createElement(this.blockMode), newDiv;\r\n\t\t\tvar cssTxt = firstSibling.previousSibling && firstSibling.previousSibling.nodeType == 1? firstSibling.previousSibling.style.cssText : parent.style.cssText;\r\n\t\t\tvar isEditNode = parent === this.editor.editNode;\r\n\t\t\tdivs.push(div);\r\n\t\t\tfirstSibling = parent.replaceChild(div,firstSibling);\r\n\t\t\tdomConstruct.place(firstSibling,div,\"after\");\r\n\t\t\tif(isEditNode){\r\n\t\t\t\tdomStyle.set(div,'direction',domStyle.get(this.editor.editNode,\"direction\"));\r\n\t\t\t}else{\r\n\t\t\t\tdiv.style.cssText = cssTxt;\t\r\n\t\t\t}\r\n\t\t\tfor(var sibling = firstSibling; sibling;){\r\n\t\t\t\tvar tSibling = sibling.nextSibling;\r\n\t\t\t\tif(this._isInlineOrTextElement(sibling)){\r\n\t\t\t\t\tif(this._hasTag(sibling,\"BR\") && sibling !== lastSibling){\r\n\t\t\t\t\t\tnewDiv = parent.ownerDocument.createElement(this.blockMode);\r\n\t\t\t\t\t\tdivs.push(newDiv);\r\n\t\t\t\t\t\tsibling = parent.replaceChild(newDiv,sibling);\r\n\t\t\t\t\t\tdomConstruct.place(sibling,newDiv,\"after\");\r\n\t\t\t\t\t\tif(isEditNode){\r\n\t\t\t\t\t\t\tdomStyle.set(newDiv,'direction',domStyle.get(this.editor.editNode,\"direction\"));\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tnewDiv.style.cssText = cssTxt;\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif((this._hasTag(sibling,\"BR\") || sibling.nodeType == 8) && !div.hasChildNodes())\r\n\t\t\t\t\t\tdiv.innerHTML = this.bogusHtmlContent;\r\n\t\t\t\t\tif(this._hasTag(sibling,\"BR\") && has(\"ie\")){\r\n\t\t\t\t\t\tsibling.parentNode.removeChild(sibling);\r\n\t\t\t\t\t}else if(sibling.nodeType != 8){\r\n\t\t\t\t\t\tdiv.appendChild(sibling);\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tsibling.parentNode.removeChild(sibling);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(sibling.nodeType == 3 && sibling.previousSibling && sibling.previousSibling.nodeType == 3){\r\n\t\t\t\t\t\tsibling.previousSibling.nodeValue += sibling.nodeValue;\r\n\t\t\t\t\t\tsibling.parentNode.removeChild(sibling);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(newDiv){\r\n\t\t\t\t\t\tdiv = newDiv;\r\n\t\t\t\t\t\tnewDiv = null;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif(sibling === lastSibling){\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tsibling = tSibling;\r\n\t\t\t}\r\n\t\t\treturn divs;\t\t\t\t\t\t\r\n\t\t},\r\n\r\n\t\t_preFilterNewLines: function(html){\r\n\t\t\tvar result = html.split(/(<\\/?pre.*>)/i), inPre = false;\r\n\t\t\tfor(var i = 0; i < result.length; i++){\r\n\t\t\t\tif(result[i].search(/<\\/?pre/i) < 0 && !inPre){\r\n\t\t\t\t\tresult[i] = result[i].replace(/\\n/g,\"\").replace(/\\t+/g,\"\\xA0\").replace(/^\\s+/,\"\\xA0\").replace(/\\xA0\\xA0+$/,\"\");\r\n\t\t\t\t}else if(result[i].search(/<\\/?pre/i) >= 0){\r\n\t\t\t\t\tinPre = !inPre;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn result.join(\"\");\r\n\t\t},\r\n\t\t\r\n\t\t_refineAlignment: function(dir, align){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tRefine the value, which should be used as textAlign style.\r\n\t\t\t// description:\r\n\t\t\t//\t\tThis method allows to keep textAlign styles only for cases,\r\n\t\t\t//\t\twhen it is defined explicitly.\r\n\t\t\tif(align.indexOf(\"left\") >= 0 && dir == \"rtl\"){\r\n\t\t\t\talign = \"left\";\r\n\t\t\t}else if(align.indexOf(\"right\") >= 0 && dir == \"ltr\"){\r\n\t\t\t\talign = \"right\";\r\n\t\t\t}else if(align.indexOf(\"center\") >= 0){\r\n\t\t\t\talign = \"center\";\r\n\t\t\t}else{ \r\n\t\t\t\talign = \"\";\r\n\t\t\t}\r\n\t\t\treturn align;\r\n\t\t},\r\n\r\n\t\t_refineLIMargins: function(node){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tLine items, orientation of which is differ from their parents,\r\n\t\t\t//\t\tarn't shown correctly by all browsers.\r\n\t\t\t//\t\tProblem is solved by adding corresponding margins.\r\n\t\t\tvar liDir = domStyle.get(node,\"direction\"),\r\n\t\t\t\tpDir = domStyle.get(node.parentNode,\"direction\"),\r\n\t\t\t\tlevel = 0, tNode = node.parentNode, name, style, offs, val;\r\n\t\t\tif(has(\"webkit\")){\r\n\t\t\t\tpDir = domStyle.get(this.editor.editNode,\"direction\");\r\n\t\t\t}\r\n\t\t\twhile(tNode !== this.editor.editNode){\r\n\t\t\t\tif(this._hasTagFrom(tNode,[\"OL\",\"UL\"])){\r\n\t\t\t\t\tlevel++;\r\n\t\t\t\t}\r\n\t\t\t\ttNode = tNode.parentNode;\r\n\t\t\t}\r\n\t\t\tdomStyle.set(node,\"marginRight\",\"\");\r\n\t\t\tdomStyle.set(node,\"marginLeft\",\"\");\r\n\t\t\tstyle = liDir == \"rtl\"? \"marginRight\" : \"marginLeft\";\r\n\t\t\toffs = this._getMargins(level);\r\n\t\t\tval = \"\" + offs + \"px\";\r\n\t\t\tif(liDir != pDir){\r\n\t\t\t\tdomStyle.set(node,style,val);\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\t_getMargins: function(level){\r\n\t\t\tif(level == 0){\r\n\t\t\t\treturn 0;\r\n\t\t\t}\r\n\t\t\tvar margin = 35;\r\n\t\t\tif(has(\"mozilla\")){\r\n\t\t\t\tmargin = 45;\r\n\t\t\t}else if(has(\"ie\")){\r\n\t\t\t\tmargin = 25;\r\n\t\t\t}\r\n\t\t\treturn margin + (level-1)*40;\r\n\t\t},\r\n\t\t\r\n\t\t_recountLIMargins: function(node, addValue){\r\n\t\t\tvar liDir = domStyle.get(node,\"direction\"), pDir = domStyle.get(node.parentNode,\"direction\");\r\n\t\t\tvar margin = liDir == \"rtl\"? \"marginRight\" : \"marginLeft\";\r\n\t\t\tvar valPx = domStyle.get(node,margin);\r\n\t\t\tvar val = (isNaN(parseInt(valPx))? 0 : parseInt(valPx)) + (addValue? addValue : 0);\r\n\t\t\tif(node.firstChild && node.firstChild.nodeType == 1){\r\n\t\t\t\tvalPx = domStyle.get(node.firstChild,margin);\r\n\t\t\t\tval += isNaN(parseInt(valPx))? 0 : parseInt(valPx);\r\n\t\t\t\tdomStyle.set(node.firstChild, {marginLeft: \"\", marginRight: \"\"});\r\n\t\t\t}\t\t\t\r\n\t\t\tif(liDir != pDir){\r\n\t\t\t\tval -= this._getMargins(this._getLILevel(node));\r\n\t\t\t}\r\n\t\t\tvar parentMargin = this._getListMargins(node);\r\n\t\t\tif(parentMargin){\r\n\t\t\t\tfor(var i = 0; i < parentMargin/40; i++){\r\n\t\t\t\t\tvar newList = domConstruct.create(this._tag(node.parentNode),null,node,\"before\");\r\n\t\t\t\t\tdomConstruct.place(node,newList,\"last\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(liDir != pDir){\r\n\t\t\t\tval += this._getMargins(this._getLILevel(node));\r\n\t\t\t}\t\t\t\t\t\t\t\r\n\t\t\tif(val){\r\n\t\t\t\tdomStyle.set(node,margin, \"\" + (val) + \"px\");\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\t_getLILevel: function(node){\r\n\t\t\tvar parent = node.parentNode;\r\n\t\t\tvar level = 0;\r\n\t\t\twhile(this._hasTagFrom(parent,[\"UL\",\"OL\"])){\r\n\t\t\t\tlevel++;\r\n\t\t\t\tparent = parent.parentNode;\r\n\t\t\t}\r\n\t\t\treturn level;\r\n\t\t},\r\n\r\n\t\t_getLIIndent: function(node){\r\n\t\t\tvar parent = node.parentNode,\r\n\t\t\t\tliDir = domStyle.get(node,\"direction\"), pDir = domStyle.get(parent,\"direction\"),\r\n\t\t\t\tmargin = liDir === \"rtl\"? \"marginRight\" : \"marginLeft\";\r\n\t\t\tvar marginVal = this._getIntStyleValue(node,margin);\r\n\t\t\tvar liMargin = liDir === pDir? 0 : this._getMargins(this._getLILevel(node));\r\n\t\t\treturn marginVal - liMargin;\r\n\t\t\t\t\r\n\t\t},\r\n\t\t\r\n\t\t_getListMargins: function(node){\r\n\t\t\tvar parent = node.parentNode;\r\n\t\t\tvar margin, val = 0, valPx;\r\n\t\t\twhile(this._hasTagFrom(parent,[\"UL\",\"OL\"])){\r\n\t\t\t\tvar pDir = domStyle.get(parent,\"direction\");\r\n\t\t\t\tmargin = pDir == \"rtl\"? \"marginRight\" : \"marginLeft\";\r\n\t\t\t\tvalPx = domStyle.get(parent,margin);\r\n\t\t\t\tval += isNaN(parseInt(valPx))? 0 : parseInt(valPx);\r\n\t\t\t\tparent = parent.parentNode;\r\n\t\t\t}\r\n\t\t\treturn val;\t\t\t\r\n\t\t},\r\n\t\t\r\n\t\t_tag: function(node){\r\n\t\t\treturn node && node.tagName && node.tagName.toUpperCase();\r\n\t\t},\r\n\t\t\r\n\t\t_hasTag: function(node,tag){\r\n\t\t\treturn (node && tag && node.tagName && node.tagName.toUpperCase() === tag.toUpperCase());\r\n\t\t},\r\n\r\n\t\t_hasStyledTextLineTag: function(node){\r\n\t\t\treturn this._hasTagFrom(node, this._lineStyledTextArray);\r\n\t\t},\r\n\t\t\r\n\t\t_hasTagFrom: function(node,arr){\r\n\t\t\treturn node && arr && node.tagName && array.indexOf(arr, node.tagName.toUpperCase()) >= 0;\r\n\t\t},\r\n\t\t\r\n\t\t_getParentFrom: function(node,arr){\r\n\t\t\tif(!node || !arr || !arr.length){\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t\tvar x = node;\r\n\t\t\twhile(x !== this.editor.editNode){\r\n\t\t\t\tif(this._hasTagFrom(x,arr)){\r\n\t\t\t\t\treturn x;\r\n\t\t\t\t}\r\n\t\t\t\tx = x.parentNode;\r\n\t\t\t}\r\n\t\t\treturn null;\r\n\t\t},\r\n\r\n\t\t_isSimpleInfo: function(info){\r\n\t\t\t// summary:\r\n\t\t\t// \treturns true, if all nodes, for which current action should be executed,\r\n\t\t\t//  may be handled in the same time (so, all nodes are in the same group)\r\n\t\t\treturn !info || info.groups.length < 2;\r\n\t\t},\r\n\t\t\r\n\t\t_isListTypeChanged: function(node, cmd){\r\n\t\t\t// summary:\r\n\t\t\t//\tReturns true, if command \"insertorderedlist\" executed for item from unordered list and \r\n\t\t\t//\tif command \"insertunorderedlist\" executed for item from ordered list\r\n\t\t\tif(!this._hasTag(node,\"LI\")){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\tvar parent = node.parentNode;\r\n\t\t\treturn (this._hasTag(parent,\"UL\") && cmd === \"insertorderedlist\" || this._hasTag(parent,\"OL\") && cmd === \"insertunorderedlist\");\r\n\t\t},\r\n\t\t\r\n\t\t_getIntStyleValue: function(node, style){\r\n\t\t\tvar val = parseInt(domStyle.get(node,style));\r\n\t\t\treturn isNaN(val)? 0 : val;\r\n\t\t},\r\n\t\t\r\n\t\t_mergeLists: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\tIn some cases (like \"formatblocks\" for list items) lists of the the same type \r\n\t\t\t//\tare created as a siblings inside the same parent. These  lists should be merged.\r\n\t\t\tvar sel = rangeapi.getSelection(this.editor.window);\r\n\t\t\tvar reselect = sel && sel.rangeCount > 0;\r\n\t\t\tif(reselect){\r\n\t\t\t\tvar range = sel.getRangeAt(0).cloneRange();\r\n\t\t\t\tvar startContainer = range.startContainer, startOffset = range.startOffset,\r\n\t\t\t\t\tendContainer = range.endContainer, endOffset = range.endOffset;\r\n\t\t\t}\r\n\t\t\tvar wasMerged = false;\r\n\t\t\tquery(\"ul,ol\",this.editor.editNode).forEach(function(x,ind,arr){\r\n\t\t\t\tif(domAttr.has(x,\"tempRole\")){\r\n\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tvar sibling = x.nextSibling;\r\n\t\t\t\twhile(this._hasTag(sibling,this._tag(x))){\r\n\t\t\t\t\twhile(sibling.firstChild){\r\n\t\t\t\t\t\tdomConstruct.place(sibling.firstChild,x,\"last\");\r\n\t\t\t\t\t\twasMerged = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tdomAttr.set(sibling,\"tempRole\",\"true\");\r\n\t\t\t\t\tsibling = sibling.nextSibling;\r\n\t\t\t\t}\t\t\t\t\t\r\n\t\t\t},this);\r\n\t\t\tif(reselect && wasMerged){\r\n\t\t\t\t// Restore selection\r\n\t\t\t\tsel.removeAllRanges();\r\n\t\t\t\ttry{\r\n\t\t\t\t\trange.setStart(startContainer, startOffset);\r\n\t\t\t\t\trange.setEnd(endContainer, endOffset);\r\n\t\t\t\t\tsel.addRange(range);\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t}\t\t\t\t\r\n\t\t\t}\t\t\t\r\n\t\t},\r\n\t\t\r\n\t\t_cleanLists: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\tRemoves remaining bogus elements, creating by the method _prepareLists()\r\n\t\t\tif(has(\"webkit\")){\r\n\t\t\t\tquery(\"table\", this.editor.editNode).forEach(function(x,ind,arr){\r\n\t\t\t\t\tvar sibling = x.nextSibling;\r\n\t\t\t\t\tif(this._hasTag(sibling,\"UL\") && domAttr.get(sibling,\"tempRole\") === \"true\"){\r\n\t\t\t\t\t\tsibling.parentNode.removeChild(sibling);\r\n\t\t\t\t\t}\r\n\t\t\t\t},this);\r\n\t\t\t\tquery(\"li[tempRole]\", this.editor.editNode).forEach(function(x,ind,arr){\r\n\t\t\t\t\tif(x.parentNode.childNodes.length == 1){\r\n\t\t\t\t\t\tx.parentNode.parentNode.removeChild(x.parentNode);\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tvar sel = rangeapi.getSelection(this.editor.window);\r\n\t\t\tvar reselect = sel && sel.rangeCount > 0;\r\n\t\t\tif(reselect){\r\n\t\t\t\tvar range = sel.getRangeAt(0).cloneRange();\r\n\t\t\t\tvar startContainer = range.startContainer, startOffset = range.startOffset,\r\n\t\t\t\t\tendContainer = range.endContainer, endOffset = range.endOffset;\r\n\t\t\t}\r\n\t\t\tvar wasMoved = false;\r\n\t\t\tquery(\"span[bogusDir]\", this.editor.editNode).forEach(function(x,ind,arr){\r\n\t\t\t\tvar node = x.firstChild, sibling = node;\r\n\t\t\t\tif(node.nodeType == 1){\r\n\t\t\t\t\twhile(node){\r\n\t\t\t\t\t\tsibling = node.nextSibling;\r\n\t\t\t\t\t\tdomConstruct.place(node,x,\"after\");\r\n\t\t\t\t\t\twasMoved = true;\r\n\t\t\t\t\t\tnode = sibling;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tx.parentNode.removeChild(x);\r\n\t\t\t},this);\r\n\t\t\tif(reselect && wasMoved){\r\n\t\t\t\t// Restore selection\r\n\t\t\t\tsel.removeAllRanges();\r\n\t\t\t\ttry{\r\n\t\t\t\t\trange.setStart(startContainer, startOffset);\r\n\t\t\t\t\trange.setEnd(endContainer, endOffset);\r\n\t\t\t\t\tsel.addRange(range);\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t}\t\t\t\t\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\t_Plugin.registry[\"bidiSupport\"] = _Plugin.registry[\"bidisupport\"] = function(args){\r\n\t\treturn new BidiSupport({\r\n\t\t});\r\n\t};\r\n\treturn BidiSupport;\r\n});\r\n"]}