{"version":3,"sources":["editor/plugins/TablePlugins.js"],"names":["define","declare","array","Color","aspect","domAttr","domStyle","_Plugin","_WidgetBase","_TemplatedMixin","_WidgetsInTemplateMixin","Dialog","Menu","MenuItem","MenuSeparator","ColorPalette","ColorPicker","insertTableTemplate","modifyTableTemplate","tableDialogStrings","dojo","experimental","TableHandler","tablesConnected","currentlyAvailable","alwaysAvailable","availableCurrentlySet","initialized","tableData","shiftKeyDown","editorDomNode","undoEnabled","refCount","doMixins","mixin","this","editor","getAncestorElement","tagName","_sCall","hasAncestorElement","selectElement","elem","byId","id","document","query","arg","scope","returnFirstOnly","ar","initialize","customUndo","_tablePluginHandler","onLoadDeferred","addCallback","hitch","editNode","iframe","body","firstChild","_myListeners","connect","_savedTableInfo","getTableInfo","connectDraggable","forceNewData","_tempStoreTableData","td","tr","parentNode","tbl","tds","forEach","d","i","tdIndex","trs","r","trIndex","cols","length","o","rows","colIndex","isIE","ondragstart","ondragend","onDragStart","e","window","event","srcElement","Date","getTime","onDragEnd","node","doc","toLowerCase","setTimeout","removeAttr","checkAvailable","focused","connectTableKeys","disconnectTableKeys","_tempAvailability","publish","_prepareTable","console","log","getTimeStamp","type","undefined","warn","cnKeyDn","cnKeyUp","push","disconnect","onKeyDown","evt","key","keyCode","tabTo","stopEvent","onDisplayChanged","onKeyUp","uninitialize","l","inherited","arguments","TablePlugins","iconClassPrefix","useDefaultCommand","buttonClass","dijit","form","Button","commandName","label","withinTable","available","button","set","setEditor","_availableTopic","subscribe","onEditorLoaded","selectTable","_initButton","command","name","commands","_makeTitle","modTable","cmd","args","focus","begEdit","adjustColWidth","isString","insertRow","insertCell","innerHTML","deleteRow","deleteCell","makeColumnsEven","endEdit","beginEditing","valBeforeUndo","getValue","endEditing","afterUndo","setValue","replaceValue","w","Math","floor","attr","str","_strings","i18n","getLocalization","getSelectedCells","cells","match","a","substring","charAt","sel","range","getSelection","rangeCount","getRangeAt","startContainer","nodeType","updateState","get","destroy","unsubscribe","TableContextMenu","constructor","_createContextMenu","domNode","style","display","menu","destroyRecursive","pMenu","targetNodeIds","messages","addChild","selectTableLabel","onClick","insertTableRowBeforeLabel","insertTableRowAfterLabel","insertTableColumnBeforeLabel","insertTableColumnAfterLabel","deleteTableRowLabel","deleteTableColumnLabel","EditorTableDialog","baseClass","templateString","postMixInProperties","postCreate","addClass","onInsert","selectRow","selectCol","width","selectWidth","widthType","selectWidthType","border","selectBorder","pad","selectPad","space","selectSpace","_id","t","c","cl","self","hide","onBuildTable","htmlText","onCancel","tableText","InsertTable","show","obj","execCommand","EditorModifyTableDialog","table","tableAtts","w1","colorPicker","params","color","_started","popup","close","setBrdColor","borderCol","brdColor","open","around","w2","setBkColor","backgroundCol","bkColor","own","pickers","p","indexOf","replace","selectAlign","startup","picker","onSet","onSetTable","ModifyTable","require","CellColorDropDown","widgetsInTemplate","_colorPicker","dialog","onChange","_cancelButton","_setValueAttr","value","priorityChange","_getValueAttr","ColorTableCell","closable","DropDownButton","pickerInit","dropDown","before","lastObject","fromString","toHex","target","registerGeneric","registry"],"mappings":"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","file":"../../../editor/plugins/TablePlugins.js","sourcesContent":["define([\r\n\t\"dojo/_base/declare\",\r\n\t\"dojo/_base/array\",\r\n\t\"dojo/_base/Color\",\r\n\t\"dojo/aspect\",\r\n\t\"dojo/dom-attr\",\r\n\t\"dojo/dom-style\",\r\n\t\"dijit/_editor/_Plugin\",\r\n\t\"dijit/_WidgetBase\",\r\n\t\"dijit/_TemplatedMixin\",\r\n\t\"dijit/_WidgetsInTemplateMixin\",\r\n\t\"dijit/Dialog\",\r\n\t\"dijit/Menu\",\r\n\t\"dijit/MenuItem\",\r\n\t\"dijit/MenuSeparator\",\r\n\t\"dijit/ColorPalette\",\r\n\t\"dojox/widget/ColorPicker\",\r\n\t\"dojo/text!./resources/insertTable.html\",\r\n\t\"dojo/text!./resources/modifyTable.html\",\r\n\t\"dojo/i18n!./nls/TableDialog\",\r\n\t\"dijit/_base/popup\",\r\n\t\"dijit/popup\",\r\n\t\"dojo/_base/connect\",\r\n\t\"dijit/TooltipDialog\",\r\n\t\"dijit/form/Button\",\r\n\t\"dijit/form/DropDownButton\",\r\n\t\"dijit/form/TextBox\",\r\n\t\"dijit/form/FilteringSelect\"\r\n], function(\r\n\tdeclare,\r\n\tarray,\r\n\tColor,\r\n\taspect,\r\n\tdomAttr,\r\n\tdomStyle,\r\n\t_Plugin,\r\n\t_WidgetBase,\r\n\t_TemplatedMixin,\r\n\t_WidgetsInTemplateMixin,\r\n\tDialog,\r\n\tMenu,\r\n\tMenuItem,\r\n\tMenuSeparator,\r\n\tColorPalette,\r\n\tColorPicker,\r\n\tinsertTableTemplate,\r\n\tmodifyTableTemplate,\r\n\ttableDialogStrings\r\n) {\r\n\r\ndojo.experimental(\"dojox.editor.plugins.TablePlugins\");\r\n\r\n// TODO:\r\n//\t\tCurrently not supporting merging or splitting cells\r\n//\r\n// FIXME:\tUndo is very buggy, and therefore unimplemented in all browsers\r\n//\t\t\texcept IE - which itself has only been lightly tested.\r\n//\r\n// FIXME:\tSelecting multiple table cells in Firefox looks to be impossible.\r\n//\t\t\tThis affect the 'colorTableCell' plugin. Cells can still be\r\n//\t\t\tcolored individually or in rows.\r\n\r\nvar TableHandler = declare(_Plugin, {\r\n\t// summary:\r\n\t//\t\tA global object that handles common tasks for all the plugins. Since\r\n\t//\t\tthere are several plugins that are all calling common methods, it's preferable\r\n\t//\t\tthat they call a centralized location that either has a set variable or a\r\n\t//\t\ttimeout to only repeat code-heavy calls when necessary.\r\n\t//\r\n\ttablesConnected:false,\r\n\tcurrentlyAvailable: false,\r\n\talwaysAvailable:false,\r\n\tavailableCurrentlySet:false,\r\n\tinitialized:false,\r\n\ttableData: null,\r\n\tshiftKeyDown:false,\r\n\teditorDomNode: null,\r\n\tundoEnabled: true, //Using custom undo for all browsers.\r\n\trefCount: 0,\r\n\t\r\n\tdoMixins: function(){\r\n\t\t\r\n\t\tdojo.mixin(this.editor,{\r\n\t\t\tgetAncestorElement: function(tagName){\r\n\t\t\t\treturn this._sCall(\"getAncestorElement\", [tagName]);\r\n\t\t\t},\r\n\t\t\thasAncestorElement: function(tagName){\r\n\t\t\t\treturn this._sCall(\"hasAncestorElement\", [tagName]);\r\n\t\t\t},\r\n\t\t\tselectElement: function(elem){\r\n\t\t\t\tthis._sCall(\"selectElement\", [elem]);\r\n\t\t\t},\r\n\t\t\tbyId: function(id){\r\n\t\t\t\treturn dojo.byId(id, this.document);\r\n\t\t\t},\r\n\t\t\tquery: function(arg, scope, returnFirstOnly){\r\n\t\t\t\t// this shortcut is dubious - not sure scoping is necessary\r\n\t\t\t\tvar ar = dojo.query(arg, scope || this.document);\r\n\t\t\t\treturn (returnFirstOnly) ? ar[0] : ar;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t},\r\n\tinitialize: function(editor){\r\n\t\t// summary:\r\n\t\t//\t\tInitialize the global handler upon a plugin's first instance of setEditor\r\n\t\t//\r\n\t\t\r\n\t\t// All plugins will attempt initialization. We only need to do so once.\r\n\t\t// But keep track so that it is cleaned up when all usage of it for an editor has\r\n\t\t// been removed.\r\n\t\tthis.refCount++;\r\n\t\t\r\n\t\t// Turn on custom undo for all.\r\n\t\teditor.customUndo = true;\r\n\r\n\t\tif(this.initialized){ return; }\r\n\t\t\r\n\t\tthis.initialized = true;\r\n\t\tthis.editor = editor;\r\n\r\n\t\tthis.editor._tablePluginHandler = this;\r\n\t\t\r\n\t\t//Editor loads async, can't assume doc is ready yet.  So, use the deferred of the\r\n\t\t//editor to init at the right time.\r\n\t\teditor.onLoadDeferred.addCallback(dojo.hitch(this, function(){\r\n\t\t\tthis.editorDomNode = this.editor.editNode || this.editor.iframe.document.body.firstChild;\r\n\r\n\t\t\t// RichText should have a mouseup connection to recognize drag-selections\r\n\t\t\t// Example would be selecting multiple table cells\r\n\t\t\tthis._myListeners = [\r\n\t\t\t\tdojo.connect(this.editorDomNode , \"mouseup\", this.editor, \"onClick\"),\r\n\t\t\t\tdojo.connect(this.editor, \"onDisplayChanged\", this, \"checkAvailable\"),\r\n\t\t\t\tdojo.connect(this.editor, \"onBlur\", this, \"checkAvailable\"),\r\n\t\t\t\tdojo.connect(this.editor, \"_saveSelection\", this, function(){\r\n\t\t\t\t\t// because on IE, the selection is lost when the iframe goes out of focus\r\n\t\t\t\t\tthis._savedTableInfo = this.getTableInfo();\r\n\t\t\t\t}),\r\n\t\t\t\tdojo.connect(this.editor, \"_restoreSelection\", this, function(){\r\n\t\t\t\t\tdelete this._savedTableInfo;\r\n\t\t\t\t})\r\n\t\t\t];\r\n\t\t\tthis.doMixins();\r\n\t\t\tthis.connectDraggable();\r\n\t\t}));\r\n\t},\r\n\t\r\n\tgetTableInfo: function(forceNewData){\r\n\t\t// summary:\r\n\t\t//\t\tGets the table in focus\r\n\t\t//\t\tCollects info on the table - see return params\r\n\t\t//\r\n\r\n\t\tif(this._savedTableInfo){\r\n\t\t\t// Avoid trying to query the table info when the iframe is blurred; doesn't work on IE.\r\n\t\t\treturn this._savedTableInfo;\r\n\t\t}\r\n\r\n\t\tif(forceNewData){ this._tempStoreTableData(false); }\r\n\t\tif(this.tableData){\r\n\t\t\t// tableData is set for a short amount of time, so that all\r\n\t\t\t// plugins get the same return without doing the method over\r\n\t\t\t//console.log(\"returning current tableData:\", this.tableData);\r\n\t\t\treturn this.tableData;\r\n\t\t}\r\n\t\tvar tr, trs, td, tds, tbl, cols, tdIndex, trIndex, o;\r\n\r\n\t\ttd = this.editor.getAncestorElement(\"td\");\r\n\t\tif(td){ tr = td.parentNode; }\r\n\t\t\r\n\t\ttbl = this.editor.getAncestorElement(\"table\");\r\n\t\t//console.log(\"td:\", td);console.log(\"tr:\", tr);console.log(\"tbl:\", tbl)\r\n\r\n\t\tif(tbl){\r\n\t\t\ttds = dojo.query(\"td\", tbl);\r\n\t\t\ttds.forEach(function(d, i){\r\n\t\t\t\tif(td==d){tdIndex = i;}\r\n\t\t\t});\r\n\t\t\ttrs = dojo.query(\"tr\", tbl);\r\n\t\t\ttrs.forEach(function(r, i){\r\n\t\t\t\tif(tr==r){trIndex = i;}\r\n\t\t\t});\r\n\t\t\tcols = tds.length/trs.length;\r\n\r\n\t\t\to = {\r\n\t\t\t\ttbl:tbl,\t\t// focused table\r\n\t\t\t\ttd:td,\t\t\t// focused TD\r\n\t\t\t\ttr:tr,\t\t\t// focused TR\r\n\t\t\t\ttrs:trs,\t\t// rows\r\n\t\t\t\ttds:tds,\t\t// cells\r\n\t\t\t\trows:trs.length,// row amount\r\n\t\t\t\tcols:cols,\t\t// column amount\r\n\t\t\t\ttdIndex:tdIndex,// index of focused cell\r\n\t\t\t\ttrIndex:trIndex,\t// index of focused row\r\n\t\t\t\tcolIndex:tdIndex%cols\r\n\t\t\t};\r\n\t\t}else{\r\n\t\t\t// Means there's no table in focus.   Use {} not null so that this._savedTableInfo is non-null\r\n\t\t\to = {};\r\n\t\t}\r\n\t\t//console.log(\"NEW tableData:\",o);\r\n\t\tthis.tableData = o;\r\n\t\tthis._tempStoreTableData(500);\r\n\t\treturn this.tableData;\r\n\t},\r\n\t\r\n\tconnectDraggable: function(){\r\n\t\t// summary:\r\n\t\t//\t\tDetects drag-n-drop in the editor (could probably be moved to there)\r\n\t\t//\t\tCurrently only checks if item dragged was a TABLE, and removes its align attr\r\n\t\t//\t\tDOES NOT WORK IN FF - it could - but FF's drag detection is a monster\r\n\t\t//\r\n\t\tif(!dojo.isIE){\r\n\t\t\t//console.warn(\"Drag and Drop is currently only detectable in IE.\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\t// IE ONLY\r\n\t\tthis.editorDomNode.ondragstart = dojo.hitch(this, \"onDragStart\");\r\n\t\tthis.editorDomNode.ondragend = dojo.hitch(this, \"onDragEnd\");\r\n\t\t\r\n\t\t//NOTES:\r\n\t\t// FF _ Able to detect the drag-over object (the editor.domNode)\r\n\t\t//\tNot able to detect an item's ondrag() event\r\n\t\t//\tDon't know why - I actually got it working when there was an error\r\n\t\t//\tSomething to do with different documents or windows I'm sure\r\n\t\t//\r\n\t\t//console.log(\"connectDraggable\", tbl);\r\n\t\t/*tbl.ondragstart=dojo.hitch(this, \"onDragStart\");\r\n\t\t\r\n\t\ttbl.addEventListener(\"dragstart\", dojo.hitch(this, \"onDragStart\"), false);\r\n\t\ttbl.addEventListener(\"drag\", dojo.hitch(this, \"onDragStart2\"), false);\r\n\t\ttbl.addEventListener(\"dragend\", dojo.hitch(this, \"onDragStart3\"), false);\r\n\t\r\n\t\tthis.editor._sCall(\"selectElement\", [tbl]);\r\n\t\t\r\n\t\ttbl.ondragstart = function(){\r\n\t\t\t//console.log(\"ondragstart\");\r\n\t\t};\r\n\t\ttbl.ondrag = function(){\r\n\t\t\talert(\"drag\")\r\n\t\t\t//console.log(\"ondrag\");\r\n\t\t*/\r\n\t},\r\n\tonDragStart: function(){\r\n\t\tvar e = window.event;\r\n\t\tif(!e.srcElement.id){\r\n\t\t\te.srcElement.id = \"tbl_\"+(new Date().getTime());\r\n\t\t}\r\n\t\t//console.log(\"onDragStart\", e.srcElement.id);\r\n\t},\r\n\tonDragEnd: function(){\r\n\t\t// summary:\r\n\t\t//\t\tDetects that an object has been dragged into place\r\n\t\t//\t\tCurrently, this code is only used for when a table is dragged\r\n\t\t//\t\tand clears the \"align\" attribute, so that the table will look\r\n\t\t//\t\tto be more in the place that the user expected.\r\n\t\t//\t\tTODO: This code can be used for other things, most\r\n\t\t//\t\tnotably UNDO, which currently is not quite usable.\r\n\t\t//\t\tThis code could also find itself in the Editor code when it is\r\n\t\t//\t\tcomplete.\r\n\t\t\r\n\t\t//console.log(\"onDragEnd\");\r\n\t\tvar e = window.event;\r\n\t\tvar node = e.srcElement;\r\n\t\tvar id = node.id;\r\n\t\tvar doc = this.editor.document;\r\n\t\t//console.log(\"NODE:\", node.tagName, node.id,  dojo.attr(node, \"align\"));\r\n\t\t\r\n\t\t// clearing a table's align attr\r\n\t\t// TODO: when ondrag becomes more robust, this code block\r\n\t\t//\tshould move to its own method\r\n\t\tif(node.tagName.toLowerCase()==\"table\"){\r\n\t\t\tsetTimeout(function(){\r\n\t\t\t\tvar node = dojo.byId(id, doc);\r\n\t\t\t\tdojo.removeAttr(node, \"align\");\r\n\t\t\t\t//console.log(\"set\", node.tagName, dojo.attr(node, \"align\"))\r\n\t\t\t}, 100);\r\n\t\t}\r\n\t},\r\n\tcheckAvailable: function(){\r\n\t\t// summary:\r\n\t\t//\t\tFor table plugs\r\n\t\t//\t\tChecking if a table or part of a table has focus so that\r\n\t\t//\t\tPlugs can change their status\r\n\t\t//\r\n\t\tif(this.availableCurrentlySet){\r\n\t\t\t// availableCurrentlySet is set for a short amount of time, so that all\r\n\t\t\t// plugins get the same return without doing the method over\r\n\t\t\t//console.log(\"availableCurrentlySet:\", this.availableCurrentlySet, \"currentlyAvailable:\", this.currentlyAvailable)\r\n\t\t\treturn this.currentlyAvailable;\r\n\t\t}\r\n\t\t//console.log(\"G - checkAvailable...\");\r\n\t\t\r\n\t\tif(!this.editor) {\r\n\t\t\t//console.log(\"editor not ready\")\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif(this.alwaysAvailable) {\r\n\t\t\t//console.log(\" return always available\")\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// Only return available if the editor is focused.\r\n\t\tthis.currentlyAvailable = this.editor.focused && (this._savedTableInfo ? this._savedTableInfo.tbl :\r\n\t\t\tthis.editor.hasAncestorElement(\"table\"));\r\n\r\n\t\tif(this.currentlyAvailable){\r\n\t\t\tthis.connectTableKeys();\r\n\t\t}else{\r\n\t\t\tthis.disconnectTableKeys();\r\n\t\t}\r\n\t\t\r\n\t\tthis._tempAvailability(500);\r\n\r\n\t\tdojo.publish(this.editor.id + \"_tablePlugins\", [ this.currentlyAvailable ]);\r\n\t\treturn this.currentlyAvailable;\r\n\t},\r\n\t\r\n\t_prepareTable: function(tbl){\r\n\t\t//\tFor IE's sake, we are adding IDs to the TDs if none is there\r\n\t\t//\tWe go ahead and use it for other code for convenience\r\n\t\t//\r\n\t\tvar tds = this.editor.query(\"td\", tbl);\r\n\t\tconsole.log(\"prep:\", tds, tbl);\r\n\t\tif(!tds[0].id){\r\n\t\t\ttds.forEach(function(td, i){\r\n\t\t\t\tif(!td.id){\r\n\t\t\t\t\ttd.id = \"tdid\"+i+this.getTimeStamp();\r\n\t\t\t\t}\r\n\t\t\t}, this);\r\n\t\t}\r\n\t\treturn tds;\r\n\t},\r\n\t\r\n\tgetTimeStamp: function(){\r\n\t\treturn new Date().getTime(); // Fixed the bug that this method always returns the same timestamp\r\n//\t\treturn Math.floor(new Date().getTime() * 0.00000001);\r\n\t},\r\n\t\r\n\t_tempStoreTableData: function(type){\r\n\t\t// caching or clearing table data, depending on the arg\r\n\t\t//\r\n\t\tif(type===true){\r\n\t\t\t//store indefinitely\r\n\t\t}else if(type===false){\r\n\t\t\t// clear object\r\n\t\t\tthis.tableData = null;\r\n\t\t}else if(type===undefined){\r\n\t\t\tconsole.warn(\"_tempStoreTableData must be passed an argument\");\r\n\t\t}else{\r\n\t\t\t// type is a number/ms\r\n\t\t\tsetTimeout(dojo.hitch(this, function(){\r\n\t\t\t\tthis.tableData = null;\r\n\t\t\t}), type);\r\n\t\t}\r\n\t},\r\n\t\r\n\t_tempAvailability: function(type){\r\n\t\t\t// caching or clearing availability, depending on the arg\r\n\t\tif(type===true){\r\n\t\t\t//store indefinitely\r\n\t\t\tthis.availableCurrentlySet = true;\r\n\t\t}else if(type===false){\r\n\t\t\t// clear object\r\n\t\t\tthis.availableCurrentlySet = false;\r\n\t\t}else if(type===undefined){\r\n\t\t\tconsole.warn(\"_tempAvailability must be passed an argument\");\r\n\t\t}else{\r\n\t\t\t// type is a number/ms\r\n\t\t\tthis.availableCurrentlySet = true;\r\n\t\t\tsetTimeout(dojo.hitch(this, function(){\r\n\t\t\t\tthis.availableCurrentlySet = false;\r\n\t\t\t}), type);\r\n\t\t}\r\n\t\t\r\n\t},\r\n\t\r\n\tconnectTableKeys: function(){\r\n\t\t// summary:\r\n\t\t//\t\tWhen a table is in focus, start detecting keys\r\n\t\t//\t\tMainly checking for the TAB key so user can tab\r\n\t\t//\t\tthrough a table (blocking the browser's desire to\r\n\t\t//\t\ttab away from teh editor completely)\r\n\t\tif(this.tablesConnected){ return; }\r\n\t\tthis.tablesConnected = true;\r\n\t\tvar node = (this.editor.iframe) ? this.editor.document : this.editor.editNode;\r\n\t\tthis.cnKeyDn = dojo.connect(node, \"onkeydown\", this, \"onKeyDown\");\r\n\t\tthis.cnKeyUp = dojo.connect(node, \"onkeyup\", this, \"onKeyUp\");\r\n\t\tthis._myListeners.push(dojo.connect(node, \"onkeypress\", this, \"onKeyUp\"));\r\n\t},\r\n\t\r\n\tdisconnectTableKeys: function(){\r\n\t\t//console.log(\"disconnect\")\r\n\t\tdojo.disconnect(this.cnKeyDn);\r\n\t\tdojo.disconnect(this.cnKeyUp);\r\n\t\tthis.tablesConnected = false;\r\n\t},\r\n\t\r\n\tonKeyDown: function(evt){\r\n\t\tvar key = evt.keyCode;\r\n\t\t//console.log(\" -> DOWN:\", key);\r\n\t\tif(key == 16){ this.shiftKeyDown = true;}\r\n\t\tif(key == 9) {\r\n\t\t\tvar o = this.getTableInfo();\r\n\t\t\t//console.log(\"TAB \", o.tdIndex, o);\r\n\t\t\t// modifying the o.tdIndex in the tableData directly, because we may save it\r\n\t\t\t// FIXME: tabTo is a global\r\n\t\t\to.tdIndex = (this.shiftKeyDown) ? o.tdIndex-1 : tabTo = o.tdIndex+1;\r\n\t\t\tif(o.tdIndex>=0 && o.tdIndex<o.tds.length){\r\n\t\t\t\t\r\n\t\t\t\tthis.editor.selectElement(o.tds[o.tdIndex]);\r\n\t\t\t\t\r\n\t\t\t\t// we know we are still within a table, so block the need\r\n\t\t\t\t//\tto run the method\r\n\t\t\t\tthis.currentlyAvailable = true;\r\n\t\t\t\tthis._tempAvailability(true);\r\n\t\t\t\t//\r\n\t\t\t\tthis._tempStoreTableData(true);\r\n\t\t\t\tthis.stopEvent = true;\r\n\t\t\t}else{\r\n\t\t\t\t//tabbed out of table\r\n\t\t\t\tthis.stopEvent = false;\r\n\t\t\t\tthis.onDisplayChanged();\r\n\t\t\t}\r\n\t\t\tif(this.stopEvent) {\r\n\t\t\t\tdojo.stopEvent(evt);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\t\r\n\tonKeyUp: function(evt){\r\n\t\tvar key = evt.keyCode;\r\n\t\t//console.log(\" -> UP:\", key)\r\n\t\tif(key == 16){ this.shiftKeyDown = false;}\r\n\t\tif(key == 37 || key == 38 || key == 39 || key == 40 ){\r\n\t\t\t// user can arrow or tab out of table - need to recheck\r\n\t\t\tthis.onDisplayChanged();\r\n\t\t}\r\n\t\tif(key == 9 && this.stopEvent){ dojo.stopEvent(evt);}\r\n\t},\r\n\t\r\n\tonDisplayChanged: function(){\r\n\t\t//console.log(\"onDisplayChanged\")\r\n\t\tthis.currentlyAvailable = false;\r\n\t\tthis._tempStoreTableData(false);\r\n\t\tthis._tempAvailability(false);\r\n\t\tthis.checkAvailable();\r\n\t},\r\n\r\n\tuninitialize: function(editor){\r\n\t\t// summary:\r\n\t\t//\t\tFunction to handle cleaning up of connects\r\n\t\t//\t\tand such.  It only finally destroys everything once\r\n\t\t//\t\tall 'references' to it have gone.  As in all plugins\r\n\t\t//\t\tthat called init on it destroyed their refs in their\r\n\t\t//\t\tcleanup calls.\r\n\t\t// editor:\r\n\t\t//\t\tThe editor to detach from.\r\n\t\tif(this.editor == editor){\r\n\t\t\tthis.refCount--;\r\n\t\t\tif(!this.refCount && this.initialized){\r\n\t\t\t\tif(this.tablesConnected){\r\n\t\t\t\t\tthis.disconnectTableKeys();\r\n\t\t\t\t}\r\n\t\t\t\tthis.initialized = false;\r\n\t\t\t\tdojo.forEach(this._myListeners, function(l){\r\n\t\t\t\t\tdojo.disconnect(l);\r\n\t\t\t\t});\r\n\t\t\t\tdelete this._myListeners;\r\n\t\t\t\tdelete this.editor._tablePluginHandler;\r\n\t\t\t\tdelete this.editor;\r\n\t\t\t}\r\n\t\t\tthis.inherited(arguments);\r\n\t\t}\r\n\t}\r\n});\r\n\r\nvar TablePlugins = declare(\"dojox.editor.plugins.TablePlugins\", _Plugin, {\r\n\t\t// summary:\r\n\t\t//\t\tA collection of Plugins for inserting and modifying tables in the Editor\r\n\t\t//\t\tSee end of this document for all available plugs\r\n\t\t//\t\tand dojox/editorPlugins/tests/editorTablePlugs.html for an example\r\n\t\t//\r\n\t\t//\t\tNOT IMPLEMENTED: Not handling cell merge, span or split\r\n\t\t//\r\n\t\t\r\n\t\ticonClassPrefix: \"editorIcon\",\r\n\t\tuseDefaultCommand: false,\r\n\t\tbuttonClass: dijit.form.Button,\r\n\t\tcommandName:\"\",\r\n\t\tlabel:\"\",\r\n\t\talwaysAvailable:false,\r\n\t\tundoEnabled:true,\r\n\t\t\r\n\t\tonDisplayChanged: function(withinTable){\r\n\t\t\t// summary:\r\n\t\t\t//\t \tsubscribed to from the global object's publish method\r\n\t\t\t\r\n\t\t\t//console.log(\"onDisplayChanged\", this.name);\r\n\t\t\tif(!this.alwaysAvailable){\r\n\t\t\t\tthis.available = withinTable;\r\n\t\t\t\tthis.button.set('disabled', !this.available);\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\tsetEditor: function(editor){\r\n\t\t\tthis.editor = editor;\r\n\t\t\tthis.editor.customUndo = true;\r\n\t\t\tthis.inherited(arguments);\r\n\t\t\tthis._availableTopic = dojo.subscribe(this.editor.id + \"_tablePlugins\", this, \"onDisplayChanged\");\r\n\t\t\tthis.onEditorLoaded();\r\n\t\t},\r\n\t\tonEditorLoaded: function(){\r\n\t\t\tif(!this.editor._tablePluginHandler){\r\n\t\t\t\t// Create it and init it off the editor.  This\r\n\t\t\t\t// will create the _tablePluginHandler reference on\r\n\t\t\t\t// the dijit.Editor instance.  This avoids a global.\r\n\t\t\t\tvar tablePluginHandler = new TableHandler();\r\n\t\t\t\ttablePluginHandler.initialize(this.editor);\r\n\t\t\t}else{\r\n\t\t\t\tthis.editor._tablePluginHandler.initialize(this.editor);\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\tselectTable: function(){\r\n\t\t\t// selects table that is in focus\r\n\t\t\tvar o = this.getTableInfo();\r\n\t\t\tif(o && o.tbl){\r\n\t\t\t\tthis.editor._sCall(\"selectElement\", [o.tbl]);\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\t_initButton: function(){\r\n\t\t\tthis.command = this.name;\r\n\t\t\t\r\n\t\t\tthis.label = this.editor.commands[this.command] = this._makeTitle(this.command);\r\n\t\t\tthis.inherited(arguments);\r\n\t\t\tdelete this.command;\r\n\r\n\t\t\tthis.connect(this.button, \"onClick\", \"modTable\");\r\n\r\n\t\t\tthis.onDisplayChanged(false);\r\n\t\t},\r\n\t\t\r\n\t\tmodTable: function(cmd, args){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tWhere each plugin performs its action.\r\n\t\t\t//\t\tNote: not using execCommand. In spite of their presence in the\r\n\t\t\t//\t\tEditor as query-able plugins, I was not able to find any evidence\r\n\t\t\t//\t\tthat they are supported (especially in NOT IE). If they are\r\n\t\t\t//\t\tsupported in other browsers, it may help with the undo problem.\r\n\r\n\t\t\tif(dojo.isIE){\r\n\t\t\t\t// IE can lose selections on focus changes, so focus back\r\n\t\t\t\t// in order to restore it.\r\n\t\t\t\tthis.editor.focus();\r\n\t\t\t}\r\n\r\n\t\t\tthis.begEdit();\r\n\t\t\tvar o = this.getTableInfo();\r\n\t\t\tvar sw = (dojo.isString(cmd))?cmd : this.name;\r\n\t\t\tvar r, c, i;\r\n\t\t\tvar adjustColWidth = false;\r\n\t\t\t//console.log(\"modTable:\", sw)\r\n\r\n\t\t\tswitch(sw){\r\n\t\t\t\tcase \"insertTableRowBefore\":\r\n\t\t\t\t\tr = o.tbl.insertRow(o.trIndex);\r\n\t\t\t\t\tfor(i=0;i<o.cols;i++){\r\n\t\t\t\t\t\tc = r.insertCell(-1);\r\n\t\t\t\t\t\tc.innerHTML = \"&nbsp;\";\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"insertTableRowAfter\":\r\n\t\t\t\t\tr = o.tbl.insertRow(o.trIndex+1);\r\n\t\t\t\t\tfor(i=0;i<o.cols;i++){\r\n\t\t\t\t\t\tc = r.insertCell(-1);\r\n\t\t\t\t\t\tc.innerHTML = \"&nbsp;\";\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"insertTableColumnBefore\":\r\n\t\t\t\t\to.trs.forEach(function(r){\r\n\t\t\t\t\t\tc = r.insertCell(o.colIndex);\r\n\t\t\t\t\t\tc.innerHTML = \"&nbsp;\";\r\n\t\t\t\t\t});\r\n\t\t\t\t\tadjustColWidth = true;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"insertTableColumnAfter\":\r\n\t\t\t\t\to.trs.forEach(function(r){\r\n\t\t\t\t\t\tc = r.insertCell(o.colIndex+1);\r\n\t\t\t\t\t\tc.innerHTML = \"&nbsp;\";\r\n\t\t\t\t\t});\r\n\t\t\t\t\tadjustColWidth = true;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"deleteTableRow\":\r\n\t\t\t\t\to.tbl.deleteRow(o.trIndex);\r\n\t\t\t\t\tconsole.log(\"TableInfo:\", this.getTableInfo());\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"deleteTableColumn\":\r\n\t\t\t\t\to.trs.forEach(function(tr){\r\n\t\t\t\t\t\ttr.deleteCell(o.colIndex);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tadjustColWidth = true;\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\tcase \"modifyTable\":\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"insertTable\":\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t\tif(adjustColWidth){\r\n\t\t\t\tthis.makeColumnsEven();\r\n\t\t\t}\r\n\t\t\tthis.endEdit();\r\n\t\t},\r\n\t\t\r\n\t\tbegEdit: function(){\r\n\t\t\tif(this.editor._tablePluginHandler.undoEnabled){\r\n\t\t\t\t//console.log(\"UNDO:\", this.editor.customUndo);\r\n\t\t\t\tif(this.editor.customUndo){\r\n\t\t\t\t\tthis.editor.beginEditing();\r\n\t\t\t\t}else{\r\n\t\t\t\t\tthis.valBeforeUndo = this.editor.getValue();\r\n\t\t\t\t\t//console.log(\"VAL:\", this.valBeforeUndo);\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tendEdit: function(){\r\n\t\t\tif(this.editor._tablePluginHandler.undoEnabled){\r\n\t\t\t\tif(this.editor.customUndo){\r\n\t\t\t\t\tthis.editor.endEditing();\r\n\t\t\t\t}else{\r\n\t\t\t\t\t// This code ALMOST works for undo -\r\n\t\t\t\t\t//\tIt seems to only work for one step\r\n\t\t\t\t\t//\tback in history however\r\n\t\t\t\t\tvar afterUndo = this.editor.getValue();\r\n\t\t\t\t\t//this.editor.execCommand(\"inserthtml\", \"<p>mike</p>\");\r\n\t\t\t\t\tthis.editor.setValue(this.valBeforeUndo);\r\n\t\t\t\t\tthis.editor.replaceValue(afterUndo);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tthis.editor.onDisplayChanged();\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\tmakeColumnsEven: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tAfter changing column amount, change widths to\r\n\t\t\t//\t\tkeep columns even\r\n\t\t\t\r\n\t\t\t// the timeout helps prevent an occasional snafu\r\n\t\t\tsetTimeout(dojo.hitch(this, function(){\r\n\t\t\t\tvar o = this.getTableInfo(true);\r\n\t\t\t\tvar w = Math.floor(100/o.cols);\r\n\t\t\t\to.tds.forEach(function(d){\r\n\t\t\t\t\tdojo.attr(d, \"width\", w+\"%\");\r\n\t\t\t\t});\r\n\t\t\t}), 10);\r\n\t\t},\r\n\t\t\r\n\t\tgetTableInfo: function(forceNewData){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tGets the table in focus\r\n\t\t\t//\t\tCollects info on the table - see return params\r\n\t\t\t//\r\n\t\t\treturn this.editor._tablePluginHandler.getTableInfo(forceNewData);\r\n\t\t},\r\n\t\t_makeTitle: function(str){\r\n\t\t\t// Uses the commandName to get the localized Title\r\n\t\t\tthis._strings = dojo.i18n.getLocalization(\"dojox.editor.plugins\", \"TableDialog\");\r\n\t\t\tvar title = this._strings[str+\"Title\"] || this._strings[str+\"Label\"] || str;\r\n\t\t\treturn title;\r\n\t\t},\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t\tgetSelectedCells: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tGets the selected cells from the passed table.\r\n\t\t\t// returns:\r\n\t\t\t//\t\tarray of TDs or empty array\r\n\t\t\tvar cells = [];\r\n\t\t\tvar tbl = this.getTableInfo().tbl;\r\n\t\t\tthis.editor._tablePluginHandler._prepareTable(tbl);\r\n\t\t\tvar e = this.editor;\r\n\r\n\t\t\t// Lets do this the way IE originally was (Looking up ids).  Walking the selection\r\n\t\t\t// is inconsistent in the browsers (and painful), so going by ids is simpler.\r\n\t\t\tvar text = e._sCall(\"getSelectedHtml\", [null]);\r\n\t\t\tvar str = text.match(/id=\"*\\w*\"*/g);\r\n\t\t\tdojo.forEach(str, function(a){\r\n\t\t\t\tvar id = a.substring(3, a.length);\r\n\t\t\t\tif(id.charAt(0) == \"\\\"\" && id.charAt(id.length - 1) == \"\\\"\"){\r\n\t\t\t\t\tid = id.substring(1, id.length - 1);\r\n\t\t\t\t}\r\n\t\t\t\tvar node = e.byId(id);\r\n\t\t\t\tif(node && node.tagName.toLowerCase() == \"td\"){\r\n\t\t\t\t\tcells.push(node);\r\n\t\t\t\t}\r\n\t\t\t}, this);\r\n\r\n\t\t\tif(!cells.length){\r\n\t\t\t\t//May just be in a cell (cursor point, or selection in a cell), so look upwards.\r\n\t\t\t\t//for a cell container.\r\n\t\t\t\tvar sel = dijit.range.getSelection(e.window);\r\n\t\t\t\tif(sel.rangeCount){\r\n\t\t\t\t\tvar r = sel.getRangeAt(0);\r\n\t\t\t\t\tvar node = r.startContainer;\r\n\t\t\t\t\twhile(node && node != e.editNode && node != e.document){\r\n\t\t\t\t\t\tif(node.nodeType === 1){\r\n\t\t\t\t\t\t\tvar tg = node.tagName ? node.tagName.toLowerCase() : \"\";\r\n\t\t\t\t\t\t\tif(tg === \"td\"){\r\n\t\t\t\t\t\t\t\treturn [node];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tnode = node.parentNode;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn cells;\r\n\t\t},\r\n\t\t\r\n\t\tupdateState: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tOver-ride for button state control for disabled to work.\r\n\t\t\tif(this.button){\r\n\t\t\t\tif((this.available || this.alwaysAvailable) && !this.get(\"disabled\")){\r\n\t\t\t\t\tthis.button.set(\"disabled\",false);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tthis.button.set(\"disabled\",true);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\tdestroy: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tOver-ridden destroy to do some cleanup.\r\n\t\t\tthis.inherited(arguments);\r\n\t\t\tdojo.unsubscribe(this._availableTopic);\r\n\r\n\t\t\t// Disconnect the editor from the handler\r\n\t\t\t// to clean up refs.  Moved to using a per-editor\r\n\t\t\t// 'handler' to avoid collisions on the old global.\r\n\t\t\tthis.editor._tablePluginHandler.uninitialize(this.editor);\r\n\t\t}\r\n\t\t\r\n\t}\r\n);\r\n\r\nvar TableContextMenu = declare(TablePlugins, {\r\n\t\tconstructor: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tInitialize certain plugins\r\n\t\t\t//\r\n\t\t\tthis.connect(this, \"setEditor\", function(editor){\r\n\t\t\t\teditor.onLoadDeferred.addCallback(dojo.hitch(this, function() {\r\n\t\t\t\t\tthis._createContextMenu();\r\n\t\t\t\t}));\r\n\t\t\t\tthis.button.domNode.style.display = \"none\";\r\n\t\t\t});\r\n\t\t},\r\n\r\n\t\tdestroy: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\tOver-ride to do menu cleanup.\r\n\t\t\tif(this.menu){\r\n\t\t\t\tthis.menu.destroyRecursive();\r\n\t\t\t\tdelete this.menu;\r\n\t\t\t}\r\n\t\t\tthis.inherited(arguments);\r\n\t\t},\r\n\t\r\n\t\t\r\n\t\t_initButton: function(){\r\n\t\t\tthis.inherited(arguments);\r\n\t\t\tif(this.name===\"tableContextMenu\"){ this.button.domNode.display = \"none\";}\r\n\t\t},\r\n\t\t\r\n\t\t_createContextMenu: function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tBuilding context menu for right-click shortcuts within a table\r\n\t\t\r\n\t\t\tvar pMenu = new Menu({targetNodeIds:[this.editor.iframe]});\r\n\t\t\tvar messages = tableDialogStrings;\r\n\t\t\tpMenu.addChild(new MenuItem({label: messages.selectTableLabel, onClick: dojo.hitch(this, \"selectTable\")}));\r\n\t\t\tpMenu.addChild(new MenuSeparator());\r\n\t\t\t\r\n\t\t\tpMenu.addChild(new MenuItem({label: messages.insertTableRowBeforeLabel, onClick: dojo.hitch(this, \"modTable\", \"insertTableRowBefore\" )}));\r\n\t\t\tpMenu.addChild(new MenuItem({label: messages.insertTableRowAfterLabel, onClick: dojo.hitch(this, \"modTable\", \"insertTableRowAfter\" )}));\r\n\t\t\tpMenu.addChild(new MenuItem({label: messages.insertTableColumnBeforeLabel, onClick: dojo.hitch(this, \"modTable\", \"insertTableColumnBefore\" )}));\r\n\t\t\tpMenu.addChild(new MenuItem({label: messages.insertTableColumnAfterLabel, onClick: dojo.hitch(this, \"modTable\", \"insertTableColumnAfter\" )}));\r\n\t\t\tpMenu.addChild(new MenuSeparator());\r\n\t\t\tpMenu.addChild(new MenuItem({label: messages.deleteTableRowLabel, onClick: dojo.hitch(this, \"modTable\", \"deleteTableRow\" )}));\r\n\t\t\tpMenu.addChild(new MenuItem({label: messages.deleteTableColumnLabel, onClick: dojo.hitch(this, \"modTable\", \"deleteTableColumn\" )}));\r\n\r\n\t\t\tthis.menu = pMenu;\r\n\t\t}\r\n});\r\n\r\nvar EditorTableDialog = declare(\"dojox.editor.plugins.EditorTableDialog\", [Dialog, _TemplatedMixin, _WidgetsInTemplateMixin], {\r\n\t// summary:\r\n\t//\t\tDialog box with options for table creation\r\n\r\n\tbaseClass:\"EditorTableDialog\",\r\n\r\n\ttemplateString: insertTableTemplate,\r\n\r\n\tpostMixInProperties: function(){\r\n\t\tdojo.mixin(this, tableDialogStrings);\r\n\t\tthis.inherited(arguments);\r\n\t},\r\n\r\n\tpostCreate: function(){\r\n\t\tdojo.addClass(this.domNode, this.baseClass); //FIXME - why isn't Dialog accepting the baseClass?\r\n\t\tthis.inherited(arguments);\r\n\t},\r\n\r\n\tonInsert: function(){\r\n\t\tconsole.log(\"insert\");\r\n\r\n\t\tvar rows =\t\tthis.selectRow.get(\"value\") || 1,\r\n\t\t\tcols =\t\tthis.selectCol.get(\"value\") || 1,\r\n\t\t\twidth =\t\tthis.selectWidth.get(\"value\"),\r\n\t\t\twidthType = this.selectWidthType.get(\"value\"),\r\n\t\t\tborder =\tthis.selectBorder.get(\"value\"),\r\n\t\t\tpad =\t\tthis.selectPad.get(\"value\"),\r\n\t\t\tspace =\t\tthis.selectSpace.get(\"value\"),\r\n\t\t\t_id =\t\t\"tbl_\"+(new Date().getTime()),\r\n\t\t\tt = '<table id=\"'+_id+'\"width=\"'+width+((widthType==\"percent\")?'%':'')+'\" border=\"'+border+'\" cellspacing=\"'+space+'\" cellpadding=\"'+pad+'\">\\n';\r\n\r\n\t\tfor(var r=0;r<rows;r++){\r\n\t\t\tt += '\\t<tr>\\n';\r\n\t\t\tfor(var c=0;c<cols;c++){\r\n\t\t\t\tt += '\\t\\t<td width=\"'+(Math.floor(100/cols))+'%\">&nbsp;</td>\\n';\r\n\t\t\t}\r\n\t\t\tt += '\\t</tr>\\n';\r\n\t\t}\r\n\t\tt += '</table><br />';\r\n\r\n\t\tvar cl = dojo.connect(this, \"onHide\", function(){\r\n\t\t\tdojo.disconnect(cl);\r\n\t\t\tvar self = this;\r\n\t\t\tsetTimeout(function(){\r\n\t\t\t\tself.destroyRecursive();\r\n\t\t\t}, 10);\r\n\t\t});\r\n\t\tthis.hide();\r\n\r\n\t\t//console.log(t);\r\n\t\tthis.onBuildTable({htmlText:t, id:_id});\r\n\t},\r\n\r\n\tonCancel: function(){\r\n\t\t// summary:\r\n\t\t//\t\tFunction to clean up memory so that the dialog is destroyed\r\n\t\t//\t\twhen closed.\r\n\t\tvar c = dojo.connect(this, \"onHide\", function(){\r\n\t\t\tdojo.disconnect(c);\r\n\t\t\tvar self = this;\r\n\t\t\tsetTimeout(function(){\r\n\t\t\t\tself.destroyRecursive();\r\n\t\t\t}, 10);\r\n\t\t});\r\n\t},\r\n\r\n\tonBuildTable: function(tableText){\r\n\t\t//stub\r\n\t}\r\n});\r\n\r\nvar InsertTable = declare(\"dojox.editor.plugins.InsertTable\", TablePlugins, {\r\n\talwaysAvailable: true,\r\n\r\n\tmodTable: function(){\r\n\t\tvar w = new EditorTableDialog({});\r\n\t\tw.show();\r\n\t\tvar c = dojo.connect(w, \"onBuildTable\", this, function(obj){\r\n\t\t\tdojo.disconnect(c);\r\n\r\n\t\t\tthis.editor.focus();\r\n\t\t\tvar res = this.editor.execCommand('inserthtml', obj.htmlText);\r\n\r\n\t\t\t// commenting this line, due to msg below\r\n\t\t\t//var td = this.editor.query(\"td\", this.editor.byId(obj.id));\r\n\r\n\t\t\t//HMMMM.... This throws a security error now. didn't used to.\r\n\t\t\t//this.editor.selectElement(td);\r\n\t\t});\r\n\t}\r\n});\r\n\r\nvar EditorModifyTableDialog = declare([Dialog, _TemplatedMixin, _WidgetsInTemplateMixin], {\r\n\r\n\t// summary:\r\n\t//\t\tDialog box with options for editing a table\r\n\t//\r\n\r\n\tbaseClass:\"EditorTableDialog\",\r\n\r\n\ttable:null, //html table to be modified\r\n\ttableAtts:{},\r\n\ttemplateString: modifyTableTemplate,\r\n\r\n\tpostMixInProperties: function(){\r\n\t\tdojo.mixin(this, tableDialogStrings);\r\n\t\tthis.inherited(arguments);\r\n\t},\r\n\r\n\tpostCreate: function(){\r\n\t\tdojo.addClass(this.domNode, this.baseClass); //FIXME - why isn't Dialog accepting the baseClass?\r\n\t\tthis.inherited(arguments);\r\n\t\tvar w1 = new this.colorPicker({params: this.params});\r\n\t\tthis.connect(w1, \"onChange\", function(color){\r\n\t\t\tif(!this._started){ return; } // not during startup()\r\n\t\t\tdijit.popup.close(w1);\r\n\t\t\tthis.setBrdColor(color);\r\n\t\t});\r\n\t\tthis.connect(w1, \"onBlur\", function(){\r\n\t\t\tdijit.popup.close(w1);\r\n\t\t});\r\n\t\tthis.connect(this.borderCol, \"click\", function(){\r\n\t\t\tw1.set('value', this.brdColor, false);\r\n\t\t\tdijit.popup.open({popup:w1, around:this.borderCol});\r\n\t\t\tw1.focus();\r\n\t\t});\r\n\t\tvar w2 = new this.colorPicker({params: this.params});\r\n\r\n\t\tthis.connect(w2, \"onChange\", function(color){\r\n\t\t\tif(!this._started){ return; } // not during startup()\r\n\t\t\tdijit.popup.close(w2);\r\n\t\t\tthis.setBkColor(color);\r\n\t\t});\r\n\t\tthis.connect(w2, \"onBlur\", function(){\r\n\t\t\tdijit.popup.close(w2);\r\n\t\t});\r\n\t\tthis.connect(this.backgroundCol, \"click\", function(){\r\n\t\t\tw2.set('value', this.bkColor, false);\r\n\t\t\tdijit.popup.open({popup:w2, around:this.backgroundCol});\r\n\t\t\tw2.focus();\r\n\t\t});\r\n\t\tthis.own(w1, w2);\r\n\t\tthis.pickers = [ w1, w2 ];\r\n\r\n\t\tthis.setBrdColor(domStyle.get(this.table, \"borderColor\"));\r\n\t\tthis.setBkColor(domStyle.get(this.table, \"backgroundColor\"));\r\n\t\tvar w = domAttr.get(this.table, \"width\");\r\n\t\tif(!w){\r\n\t\t\tw = this.table.style.width;\r\n\t\t}\r\n\t\tvar p = \"pixels\";\r\n\t\tif(dojo.isString(w) && w.indexOf(\"%\")>-1){\r\n\t\t\tp = \"percent\";\r\n\t\t\tw = w.replace(/%/, \"\");\r\n\t\t}\r\n\r\n\t\tif(w){\r\n\t\t\tthis.selectWidth.set(\"value\", w);\r\n\t\t\tthis.selectWidthType.set(\"value\", p);\r\n\t\t}else{\r\n\t\t\tthis.selectWidth.set(\"value\", \"\");\r\n\t\t\tthis.selectWidthType.set(\"value\", \"percent\");\r\n\t\t}\r\n\r\n\t\tthis.selectBorder.set(\"value\", domAttr.get(this.table, \"border\"));\r\n\t\tthis.selectPad.set(\"value\", domAttr.get(this.table, \"cellPadding\"));\r\n\t\tthis.selectSpace.set(\"value\", domAttr.get(this.table, \"cellSpacing\"));\r\n\t\tthis.selectAlign.set(\"value\", domAttr.get(this.table, \"align\"));\r\n\t},\r\n\tstartup: function() {\r\n\t\tarray.forEach(this.pickers, function(picker){ picker.startup(); });\r\n\t\tthis.inherited(arguments);\r\n\t},\r\n\r\n\tsetBrdColor: function(color){\r\n\t\tthis.brdColor = color;\r\n\t\tdomStyle.set(this.borderCol, \"backgroundColor\", color);\r\n\t},\r\n\r\n\tsetBkColor: function(color){\r\n\t\tthis.bkColor = color;\r\n\t\tdomStyle.set(this.backgroundCol, \"backgroundColor\", color);\r\n\t},\r\n\tonSet: function(){\r\n\t\tdomStyle.set(this.table, \"borderColor\", this.brdColor);\r\n\t\tdomStyle.set(this.table, \"backgroundColor\", this.bkColor);\r\n\t\tif(this.selectWidth.get(\"value\")){\r\n\t\t\t// Just in case, remove it from style since we're setting it as a table attribute.\r\n\t\t\tdomStyle.set(this.table, \"width\", \"\");\r\n\t\t\tdomAttr.set(this.table, \"width\", (this.selectWidth.get(\"value\") + ((this.selectWidthType.get(\"value\")==\"pixels\")?\"\":\"%\") ));\r\n\t\t}\r\n\t\tdomAttr.set(this.table, \"border\", this.selectBorder.get(\"value\"));\r\n\t\tdomAttr.set(this.table, \"cellPadding\", this.selectPad.get(\"value\"));\r\n\t\tdomAttr.set(this.table, \"cellSpacing\", this.selectSpace.get(\"value\"));\r\n\t\tdomAttr.set(this.table, \"align\", this.selectAlign.get(\"value\"));\r\n\t\tvar c = dojo.connect(this, \"onHide\", function(){\r\n\t\t\tdojo.disconnect(c);\r\n\t\t\tvar self = this;\r\n\t\t\tsetTimeout(function(){\r\n\t\t\t\tself.destroyRecursive();\r\n\t\t\t}, 10);\r\n\t\t});\r\n\t\tthis.hide();\r\n\t},\r\n\r\n\tonCancel: function(){\r\n\t\t// summary:\r\n\t\t//\t\tFunction to clean up memory so that the dialog is destroyed\r\n\t\t//\t\twhen closed.\r\n\t\tvar c = dojo.connect(this, \"onHide\", function(){\r\n\t\t\tdojo.disconnect(c);\r\n\t\t\tvar self = this;\r\n\t\t\tsetTimeout(function(){\r\n\t\t\t\tself.destroyRecursive();\r\n\t\t\t}, 10);\r\n\t\t});\r\n\t},\r\n\r\n\tonSetTable: function(tableText){\r\n\t\t//stub\r\n\t}\r\n});\r\n\r\nvar ModifyTable = declare(\"dojox.editor.plugins.ModifyTable\", TablePlugins, {\r\n\t// colorPicker: Constructor\r\n\t//\t\tThe color picker dijit to use, defaults to dijit/form/ColorPalette\r\n\tcolorPicker: ColorPalette,\r\n\r\n\tmodTable: function(){\r\n\t\tif (!this.editor._tablePluginHandler.checkAvailable()) {return;}\r\n\t\tvar o = this.getTableInfo();\r\n\t\t//console.log(\"LAUNCH DIALOG\");\r\n\r\n\t\tvar w = new EditorModifyTableDialog({\r\n\t\t\ttable:o.tbl,\r\n\t\t\tcolorPicker: typeof this.colorPicker === 'string' ? require(this.colorPicker) : this.colorPicker,\r\n\t\t\tparams: this.params\r\n\t\t});\r\n\t\tw.show();\r\n\t\tthis.connect(w, \"onSetTable\", function(color){\r\n\t\t\t// uhm... not sure whats going on here...\r\n\t\t\tvar o = this.getTableInfo();\r\n\t\t\t//console.log(\"set color:\", color);\r\n\t\t\tdomStyle.set(o.td, \"backgroundColor\", color);\r\n\t\t});\r\n\t}\r\n});\r\n\r\nvar CellColorDropDown = declare([_WidgetBase, _TemplatedMixin, _WidgetsInTemplateMixin], {\r\n\t// summary:\r\n\t//\t\tA simple widget that uses/creates a dropdown with a customisable color picker.  Also provides\r\n\t//\t\tpassthroughs to the value of the color picker and convenient hook points.\r\n\t// tags:\r\n\t//\t\tprivate\r\n\r\n\t// colorPicker: Constructor\r\n\t//\t\tThe color picker dijit to use, defaults to dojox/widget/ColorPicker\r\n\tcolorPicker: ColorPicker,\r\n\r\n\t// templateString: String\r\n\t//\t\tThe template used to create the ColorPicker.\r\n\ttemplateString:\r\n\t\t\"<div style='display: none; position: absolute; top: -10000; z-index: -10000'>\" +\r\n\t\t\t\"<div dojoType='dijit.TooltipDialog' dojoAttachPoint='dialog' class='dojoxEditorColorPicker'>\" +\r\n\t\t\t\t\"<div dojoAttachPoint='_colorPicker'></div>\" +\r\n\t\t\t\t\"<div style='margin: 0.5em 0em 0em 0em'>\" +\r\n\t\t\t\t\t\"<button dojoType='dijit.form.Button' type='submit' dojoAttachPoint='_setButton'>${buttonSet}</button>\" +\r\n\t\t\t\t\t\"&nbsp;\" +\r\n\t\t\t\t\t\"<button dojoType='dijit.form.Button' type='button' dojoAttachPoint='_cancelButton'>${buttonCancel}</button>\" +\r\n\t\t\t\t\"</div>\" +\r\n\t\t\t\"</div>\" +\r\n\t\t\"</div>\",\r\n\r\n\t// widgetsInTemplate: Boolean\r\n\t//\t\tFlag denoting widgets are contained in the template.\r\n\twidgetsInTemplate: true,\r\n\r\n\tconstructor: function(){\r\n\t\t// summary:\r\n\t\t//\t\tConstructor over-ride so that the translated strings are mixed in so\r\n\t\t//\t\tthe template fills out.\r\n\t\tdojo.mixin(this, tableDialogStrings);\r\n\t},\r\n\tpostCreate: function() {\r\n\t\t// summary:\r\n\t\t//\t\tCreate color picker dynamically rather than hardcode in template.\r\n\t\tvar ColorPicker = typeof this.colorPicker == \"string\" ? require(this.colorPicker) : this.colorPicker;\r\n\t\tthis._colorPicker = new ColorPicker({\r\n\t\t\tparams: this.params\r\n\t\t}, this._colorPicker);\r\n\t},\r\n\r\n\tstartup: function(){\r\n\t\t// summary:\r\n\t\t//\t\tOver-ride of startup to do the basic connect setups and such.\r\n\t\tif(!this._started){\r\n\t\t\tthis.inherited(arguments);\r\n\t\t\tthis.connect(this.dialog, \"execute\", function(){\r\n\t\t\t\tthis.onChange(this.get(\"value\"));\r\n\t\t\t});\r\n\t\t\tthis.connect(this._cancelButton, \"onClick\", function(){\r\n\t\t\t\tdijit.popup.close(this.dialog);\r\n\t\t\t});\r\n\t\t\tthis.connect(this.dialog, \"onCancel\", \"onCancel\");\r\n\r\n\t\t\t// Fully started, so go ahead and remove the hide.\r\n\t\t\tdojo.style(this.domNode, \"display\", \"block\");\r\n\t\t}\r\n\t},\r\n\r\n\t_setValueAttr: function(value, priorityChange){\r\n\t\t// summary:\r\n\t\t//\t\tPassthrough function for the color picker value.\r\n\t\t// value: String\r\n\t\t//\t\tThe value to set in the color picker\r\n\t\t// priorityChange:\r\n\t\t//\t\tValue to indicate whether or not to trigger an onChange event.\r\n\t\tthis._colorPicker.set(\"value\", value, priorityChange);\r\n\t},\r\n\r\n\t_getValueAttr: function(){\r\n\t\t// summary:\r\n\t\t//\t\tPassthrough function for the color picker value.\r\n\t\treturn this._colorPicker.get(\"value\");\r\n\t},\r\n\r\n\tonChange: function(value){\r\n\t\t// summary:\r\n\t\t//\t\tHook point to get the value when the color picker value is selected.\r\n\t\t// value: String\r\n\t\t//\t\tThe value from the color picker.\r\n\t},\r\n\r\n\tonCancel: function(){\r\n\t\t// summary:\r\n\t\t//\t\tHook point to get when the dialog is canceled.\r\n\t}\r\n});\r\n\r\nvar ColorTableCell = declare(\"dojox.editor.plugins.ColorTableCell\", TablePlugins, {\r\n\t// colorPicker: Constructor\r\n\t//\t\tThe color picker dijit to use, defaults to dojox/widget/ColorPicker\r\n\tcolorPicker: ColorPicker,\r\n\r\n\tconstructor: function(){\r\n\t\t// summary:\r\n\t\t//\t\tInitialize ColorTableCell plugin\r\n\t\tthis.closable = true;\r\n\t\tthis.buttonClass = dijit.form.DropDownButton;\r\n\r\n\t\tvar self = this,\r\n\t\t\tpicker,\r\n\t\t\tpickerInit = {\r\n\t\t\t\tcolorPicker: this.colorPicker,\r\n\t\t\t\tparams: this.params\r\n\t\t\t};\r\n\r\n\t\t// We may have been given the dropdown to use, or we can use a default.\r\n\t\tif(!this.dropDown){\r\n\t\t\t// Create our default dropdown dialog\r\n\t\t\tpicker = new CellColorDropDown(pickerInit);\r\n\t\t\tpicker.startup(); // we don't have startup so just invoke it now\r\n\r\n\t\t\t// In this case the dropdown isn't the thing firing events, its\r\n\t\t\t//  dialog is.\r\n\t\t\tthis.dropDown = picker.dialog;\r\n\t\t}else{\r\n\t\t\t// Assume the dropdown we've been given is the picker we should attach to.\r\n\t\t\tpicker = this.dropDown;\r\n\t\t\tpicker.set(pickerInit);\r\n\t\t}\r\n\t\tthis.connect(picker, \"onChange\", function(color){\r\n\t\t\tthis.editor.focus();\r\n\t\t\tthis.modTable(null, color);\r\n\t\t});\r\n\t\tthis.connect(picker, \"onCancel\", function(){\r\n\t\t\tthis.editor.focus();\r\n\t\t});\r\n\t\t// Calculate and assign value before onOpen fires, so onOpen may rely on\r\n\t\t//  having a value when it runs.\r\n\t\taspect.before(this.dropDown, \"onOpen\", function(){\r\n\t\t\tvar o = self.getTableInfo(),\r\n\t\t\t\ttds = self.getSelectedCells(o.tbl);\r\n\t\t\tif(tds && tds.length > 0){\r\n\t\t\t\tvar t = tds[0] === self.lastObject ? tds[0] : tds[tds.length - 1],\r\n\t\t\t\t\tcolor;\r\n\t\t\t\twhile(t && t !== self.editor.document && ((color = dojo.style(t, \"backgroundColor\")) === \"transparent\" || color.indexOf(\"rgba\") === 0)){\r\n\t\t\t\t\tt = t.parentNode;\r\n\t\t\t\t}\r\n\t\t\t\tif(color !== \"transparent\" && color.indexOf(\"rgba\") !== 0){\r\n\t\t\t\t\tpicker.set('value', Color.fromString(color).toHex());\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.connect(this, \"setEditor\", function(editor){\r\n\t\t\teditor.onLoadDeferred.addCallback(dojo.hitch(this, function(){\r\n\t\t\t\tthis.connect(this.editor.editNode, \"onmouseup\", function(evt){\r\n\t\t\t\t\tthis.lastObject = evt.target;\r\n\t\t\t\t});\r\n\t\t\t}));\r\n\t\t});\r\n\t},\r\n\t\r\n\t_initButton: function(){\r\n\t\tthis.command = this.name;\r\n\r\n\t\tthis.label = this.editor.commands[this.command] = this._makeTitle(this.command);\r\n\t\tthis.inherited(arguments);\r\n\t\tdelete this.command;\r\n\r\n\t\tthis.onDisplayChanged(false);\r\n\t},\r\n\r\n\tmodTable: function(cmd, args){\r\n\t\t// summary:\r\n\t\t//\t\tWhere each plugin performs its action.\r\n\t\t//\t\tNote: not using execCommand. In spite of their presence in the\r\n\t\t//\t\tEditor as query-able plugins, I was not able to find any evidence\r\n\t\t//\t\tthat they are supported (especially in NOT IE). If they are\r\n\t\t//\t\tsupported in other browsers, it may help with the undo problem.\r\n\r\n\t\tthis.begEdit();\r\n\t\tvar o = this.getTableInfo();\r\n\t\t// The one plugin that really needs use of the very verbose\r\n\t\t//\tgetSelectedCells()\r\n\t\tvar tds = this.getSelectedCells(o.tbl);\r\n\t\t//console.debug(\"SELECTED CELLS \", tds , \" FOR \", o);\r\n\t\tdojo.forEach(tds, function(td){\r\n\t\t\tdojo.style(td, \"backgroundColor\", args);\r\n\t\t});\r\n\t\tthis.endEdit();\r\n\t}\r\n});\r\n\r\n// Register these plugins.\r\nfunction registerGeneric(args) {\r\n\treturn new TablePlugins(args);\r\n}\r\n_Plugin.registry[\"insertTableRowBefore\"] = registerGeneric;\r\n_Plugin.registry[\"insertTableRowAfter\"] = registerGeneric;\r\n_Plugin.registry[\"insertTableColumnBefore\"] = registerGeneric;\r\n_Plugin.registry[\"insertTableColumnAfter\"] = registerGeneric;\r\n_Plugin.registry[\"deleteTableRow\"] = registerGeneric;\r\n_Plugin.registry[\"deleteTableColumn\"] = registerGeneric;\r\n_Plugin.registry[\"colorTableCell\"] = function(args) {\r\n\treturn new ColorTableCell(args);\r\n};\r\n_Plugin.registry[\"modifyTable\"] = function(args) {\r\n\treturn new ModifyTable(args);\r\n};\r\n_Plugin.registry[\"insertTable\"] = function(args) {\r\n\treturn new InsertTable(args);\r\n};\r\n_Plugin.registry[\"tableContextMenu\"] = function(args) {\r\n\treturn new TableContextMenu(args);\r\n};\r\n\r\nreturn TablePlugins;\r\n});\r\n"]}