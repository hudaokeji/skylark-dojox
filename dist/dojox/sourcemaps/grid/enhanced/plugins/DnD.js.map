{"version":3,"sources":["grid/enhanced/plugins/DnD.js"],"names":["define","dojo","declare","connect","array","lang","html","json","win","query","keys","Source","Avatar","_Plugin","EnhancedGrid","Manager","_joinToArray","arrays","a","i","length","concat","GridDnDElement","constructor","dndPlugin","this","plugin","node","create","_items","destroy","createDnDNodes","dndRegion","destroyDnDNodes","acceptType","type","itemNodeIdBase","grid","id","forEach","selected","range","data","appendChild","getDnDNodes","map","childNodes","empty","getItem","nodeId","GridDnDSource","accept","param","dndElem","dnd","sourcePlugin","inherited","arguments","checkAcceptance","source","nodes","item","j","_canAccept","rows","indexOf","rowData","fromJson","push","_dndRegion","onDraggingOver","onDraggingOut","onDndDrop","copy","target","onDndCancel","onDragIn","GridDnDAvatar","construct","_itemType","manager","_dndPlugin","_itemCount","_getItemCount","isA11y","hasClass","body","border","cellspacing","class","style","position","zIndex","margin","b","tr","td","innerHTML","_getGridDnDIconClass","generateText","_generateText","opacity","count","cells","layout","colCount","max","col","min","rowCount","row","hidden","cell","DnD","name","_targetAnchorBorderWidth","_copyOnly","_config","within","in","out","args","clone","isObject","setupConfig","dndConfig","copyOnly","_mixinGrid","selector","pluginMgr","getPlugin","rearranger","setArgs","_clear","_elem","_source","_container","domNode","_initEvents","setupDnDConfig","hitch","dndCopyOnly","config","firstLevel","secondLevel","cfg","t","mode","m","isCopyOnly","_isOutOfGrid","evt","gridPos","x","clientX","y","clientY","h","w","_onMouseMove","_dnding","_externalDnd","_isMouseDown","_oldCursor","isOut","_alreadyOut","_destroyDnDUI","_moveEvent","onOutEvent","_createDnDUI","onOverEvent","_startDnd","_onMouseUp","_extDnding","_isSource","isInner","_rearrange","_endDnd","g","s","doc","isSelecting","ctrlKey","_dndReady","isSelected","rowIndex","index","selectEnabled","_getDnDRegion","shiftKey","select","isVertical","isForward","view","_markTargetAnchor","keyCode","ESCAPE","CTRL","_isCopy","_target","_targetAnchor","colIndex","_selected","flag","Infinity","some","hiddenColCnt","getCount","every","inRange","handle","res","getSelected","sort","v1","v2","arr","_devideToArrays","destroySource","isMovingIn","viewPos","views","_createSource","_createMoveable","e","console","warn","isMovingOut","_destroySource","_unmarkTargetAnchor","_destroyMoveable","oldMakeAvatar","makeAvatar","avatar","startDrag","onMouseMove","publish","_markTagetAnchorHandler","disconnect","_calcColTargetAnchorPos","containerPos","headPos","left","ex","ltr","_isBodyLtr","headers","_getVisibleHeaders","ranges","getHeaderNode","_calcRowTargetAnchorPos","top","scroller","firstVisibleRow","cellNode","getNode","nodePos","_calcCellTargetAnchorPos","targetAnchor","minPos","maxPos","height","width","minCol","maxCol","leftTopDiv","rightBottomDiv","origin","preSpan","postSpan","minRow","maxRow","anchorBorderSize","marginBox","contentBox","leftTopCellPos","rightBottomCellPos","l","pos","cellPos","filter","_mapRegion","readyForAutoScroll","srcGrid","c","srcRange","srcCells","cnt","region","isCopy","success","changeCells","insertRows","onDragOut","isMove","clearCells","removeRows","srcRegion","colCnt","rowCnt","store","getFeatures","_allDnDItemsLoaded","cache","_by_idx","registerPlugin","dependency"],"mappings":"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","file":"../../../../grid/enhanced/plugins/DnD.js","sourcesContent":["define([\r\n\t\"dojo/_base/kernel\",\r\n\t\"dojo/_base/declare\",\r\n\t\"dojo/_base/connect\",\r\n\t\"dojo/_base/array\",\r\n\t\"dojo/_base/lang\",\r\n\t\"dojo/_base/html\",\r\n\t\"dojo/_base/json\",\r\n\t\"dojo/_base/window\",\r\n\t\"dojo/query\",\r\n\t\"dojo/keys\",\r\n\t\"dojo/dnd/Source\",\r\n\t\"dojo/dnd/Avatar\",\r\n\t\"../_Plugin\",\r\n\t\"../../EnhancedGrid\",\r\n\t\"dojo/dnd/Manager\",\r\n\t\"./Selector\",\r\n\t\"./Rearrange\"\r\n], function(dojo, declare, connect, array, lang, html, json, win, query, keys, Source, Avatar, _Plugin, EnhancedGrid, Manager){\r\n\r\nvar _devideToArrays = function(a){\r\n\t\ta.sort(function(v1, v2){\r\n\t\t\treturn v1 - v2;\r\n\t\t});\r\n\t\tvar arr = [[a[0]]];\r\n\t\tfor(var i = 1, j = 0; i < a.length; ++i){\r\n\t\t\tif(a[i] == a[i-1] + 1){\r\n\t\t\t\tarr[j].push(a[i]);\r\n\t\t\t}else{\r\n\t\t\t\tarr[++j] = [a[i]];\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn arr;\r\n\t},\r\n\t_joinToArray = function(arrays){\r\n\t\tvar a = arrays[0];\r\n\t\tfor(var i = 1; i < arrays.length; ++i){\r\n\t\t\ta = a.concat(arrays[i]);\r\n\t\t}\r\n\t\treturn a;\r\n\t};\r\nvar GridDnDElement = declare(\"dojox.grid.enhanced.plugins.GridDnDElement\", null, {\r\n\tconstructor: function(dndPlugin){\r\n\t\tthis.plugin = dndPlugin;\r\n\t\tthis.node = html.create(\"div\");\r\n\t\tthis._items = {};\r\n\t},\r\n\tdestroy: function(){\r\n\t\tthis.plugin = null;\r\n\t\thtml.destroy(this.node);\r\n\t\tthis.node = null;\r\n\t\tthis._items = null;\r\n\t},\r\n\tcreateDnDNodes: function(dndRegion){\r\n\t\tthis.destroyDnDNodes();\r\n\t\tvar acceptType = [\"grid/\" + dndRegion.type + \"s\"];\r\n\t\tvar itemNodeIdBase = this.plugin.grid.id + \"_dndItem\";\r\n\t\tarray.forEach(dndRegion.selected, function(range, i){\r\n\t\t\tvar id = itemNodeIdBase + i;\r\n\t\t\tthis._items[id] = {\r\n\t\t\t\t\"type\": acceptType,\r\n\t\t\t\t\"data\": range,\r\n\t\t\t\t\"dndPlugin\": this.plugin\r\n\t\t\t};\r\n\t\t\tthis.node.appendChild(html.create(\"div\", {\r\n\t\t\t\t\"id\": id\r\n\t\t\t}));\r\n\t\t}, this);\r\n\t},\r\n\tgetDnDNodes: function(){\r\n\t\treturn array.map(this.node.childNodes, function(node){\r\n\t\t\treturn node;\r\n\t\t});\r\n\t},\r\n\tdestroyDnDNodes: function(){\r\n\t\thtml.empty(this.node);\r\n\t\tthis._items = {};\r\n\t},\r\n\tgetItem: function(nodeId){\r\n\t\treturn this._items[nodeId];\r\n\t}\r\n});\r\nvar GridDnDSource = declare(\"dojox.grid.enhanced.plugins.GridDnDSource\", Source,{\r\n\taccept: [\"grid/cells\", \"grid/rows\", \"grid/cols\"],\r\n\tconstructor: function(node, param){\r\n\t\tthis.grid = param.grid;\r\n\t\tthis.dndElem = param.dndElem;\r\n\t\tthis.dndPlugin = param.dnd;\r\n\t\tthis.sourcePlugin = null;\r\n\t},\r\n\tdestroy: function(){\r\n\t\tthis.inherited(arguments);\r\n\t\tthis.grid = null;\r\n\t\tthis.dndElem = null;\r\n\t\tthis.dndPlugin = null;\r\n\t\tthis.sourcePlugin = null;\r\n\t},\r\n\tgetItem: function(nodeId){\r\n\t\treturn this.dndElem.getItem(nodeId);\r\n\t},\r\n\tcheckAcceptance: function(source, nodes){\r\n\t\tif(this != source && nodes[0]){\r\n\t\t\tvar item = source.getItem(nodes[0].id);\r\n\t\t\tif(item.dndPlugin){\r\n\t\t\t\tvar type = item.type;\r\n\t\t\t\tfor(var j = 0; j < type.length; ++j){\r\n\t\t\t\t\tif(type[j] in this.accept){\r\n\t\t\t\t\t\tif(this.dndPlugin._canAccept(item.dndPlugin)){\r\n\t\t\t\t\t\t\tthis.sourcePlugin = item.dndPlugin;\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}else if(\"grid/rows\" in this.accept){\r\n\t\t\t\tvar rows = [];\r\n\t\t\t\tarray.forEach(nodes, function(node){\r\n\t\t\t\t\tvar item = source.getItem(node.id);\r\n\t\t\t\t\tif(item.data && array.indexOf(item.type, \"grid/rows\") >= 0){\r\n\t\t\t\t\t\tvar rowData = item.data;\r\n\t\t\t\t\t\tif(typeof item.data == \"string\"){\r\n\t\t\t\t\t\t\trowData = json.fromJson(item.data);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif(rowData){\r\n\t\t\t\t\t\t\trows.push(rowData);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tif(rows.length){\r\n\t\t\t\t\tthis.sourcePlugin = {\r\n\t\t\t\t\t\t_dndRegion: {\r\n\t\t\t\t\t\t\ttype: \"row\",\r\n\t\t\t\t\t\t\tselected: [rows]\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t};\r\n\t\t\t\t}else{\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn this.inherited(arguments);\r\n\t},\r\n\tonDraggingOver: function(){\r\n\t\tthis.dndPlugin.onDraggingOver(this.sourcePlugin);\r\n\t},\r\n\tonDraggingOut: function(){\r\n\t\tthis.dndPlugin.onDraggingOut(this.sourcePlugin);\r\n\t},\r\n\tonDndDrop: function(source, nodes, copy, target){\r\n\t\t//this.inherited(arguments);\r\n\t\tthis.onDndCancel();\r\n\t\tif(this != source && this == target){\r\n\t\t\tthis.dndPlugin.onDragIn(this.sourcePlugin, copy);\r\n\t\t}\r\n\t}\r\n});\r\n\r\nvar GridDnDAvatar = declare(\"dojox.grid.enhanced.plugins.GridDnDAvatar\", Avatar, {\r\n\tconstruct: function(){\r\n\t\t// summary:\r\n\t\t//\t\tconstructor function;\r\n\t\t//\t\tit is separate so it can be (dynamically) overwritten in case of need\r\n\t\tthis._itemType = this.manager._dndPlugin._dndRegion.type;\r\n\t\tthis._itemCount = this._getItemCount();\r\n\t\t\t\r\n\t\tthis.isA11y = html.hasClass(win.body(), \"dijit_a11y\");\r\n\t\tvar a = html.create(\"table\", {\r\n\t\t\t\t\"border\": \"0\",\r\n\t\t\t\t\"cellspacing\": \"0\",\r\n\t\t\t\t\"class\": \"dojoxGridDndAvatar\",\r\n\t\t\t\t\"style\": {\r\n\t\t\t\t\tposition: \"absolute\",\r\n\t\t\t\t\tzIndex: \"1999\",\r\n\t\t\t\t\tmargin: \"0px\"\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tsource = this.manager.source,\r\n\t\t\tb = html.create(\"tbody\", null, a),\r\n\t\t\ttr = html.create(\"tr\", null, b),\r\n\t\t\ttd = html.create(\"td\", {\r\n\t\t\t\t\"class\": \"dojoxGridDnDIcon\"\r\n\t\t\t}, tr);\r\n\t\tif(this.isA11y){\r\n\t\t\thtml.create(\"span\", {\r\n\t\t\t\t\"id\" : \"a11yIcon\",\r\n\t\t\t\t\"innerHTML\" : this.manager.copy ? '+' : \"<\"\r\n\t\t\t}, td);\r\n\t\t}\r\n\t\ttd = html.create(\"td\", {\r\n\t\t\t\"class\" : \"dojoxGridDnDItemIcon \" + this._getGridDnDIconClass()\r\n\t\t}, tr);\r\n\t\ttd = html.create(\"td\", null, tr);\r\n\t\thtml.create(\"span\", {\r\n\t\t\t\"class\": \"dojoxGridDnDItemCount\",\r\n\t\t\t\"innerHTML\": source.generateText ? this._generateText() : \"\"\r\n\t\t}, td);\r\n\t\t// we have to set the opacity on IE only after the node is live\r\n\t\thtml.style(tr, {\r\n\t\t\t\"opacity\": 0.9\r\n\t\t});\r\n\t\tthis.node = a;\r\n\t},\r\n\t_getItemCount: function(){\r\n\t\tvar selected = this.manager._dndPlugin._dndRegion.selected,\r\n\t\t\tcount = 0;\r\n\t\tswitch(this._itemType){\r\n\t\t\tcase \"cell\":\r\n\t\t\t\tselected = selected[0];\r\n\t\t\t\tvar cells = this.manager._dndPlugin.grid.layout.cells,\r\n\t\t\t\t\tcolCount = selected.max.col - selected.min.col + 1,\r\n\t\t\t\t\trowCount = selected.max.row - selected.min.row + 1;\r\n\t\t\t\tif(colCount > 1){\r\n\t\t\t\t\tfor(var i = selected.min.col; i <= selected.max.col; ++i){\r\n\t\t\t\t\t\tif(cells[i].hidden){\r\n\t\t\t\t\t\t\t--colCount;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcount = colCount * rowCount;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"row\":\r\n\t\t\tcase \"col\":\r\n\t\t\t\tcount = _joinToArray(selected).length;\r\n\t\t}\r\n\t\treturn count;\r\n\t},\r\n\t_getGridDnDIconClass: function(){\r\n\t\treturn {\r\n\t\t\t\"row\": [\"dojoxGridDnDIconRowSingle\", \"dojoxGridDnDIconRowMulti\"],\r\n\t\t\t\"col\": [\"dojoxGridDnDIconColSingle\", \"dojoxGridDnDIconColMulti\"],\r\n\t\t\t\"cell\": [\"dojoxGridDnDIconCellSingle\", \"dojoxGridDnDIconCellMulti\"]\r\n\t\t}[this._itemType][this._itemCount == 1 ? 0 : 1];\r\n\t},\r\n\t_generateText: function(){\r\n\t\t// summary:\r\n\t\t//\t\tgenerates a proper text to reflect copying or moving of items\r\n\t\treturn \"(\" + this._itemCount + \")\";\r\n\t}\r\n});\r\nvar DnD = declare(\"dojox.grid.enhanced.plugins.DnD\", _Plugin, {\r\n\t// summary:\r\n\t//\t\tProvide drag and drop for grid columns/rows/cells within grid and out of grid.\r\n\t//\t\tThe store of grid must implement dojo.data.api.Write.\r\n\t//\r\n\t//\t\tDnD selected columns:\r\n\t//\t\tSupport moving within grid, moving/copying out of grid to a non-grid DnD target.\r\n\t//\r\n\t//\t\tDnD selected rows:\r\n\t//\t\tSupport moving within grid, moving/copying out of grid to any DnD target.\r\n\t//\r\n\t//\t\tDnD selected cells (in rectangle shape only):\r\n\t//\t\tSupport moving/copying within grid, moving/copying out of grid to any DnD target.\r\n\t\r\n\t// name: String,\r\n\t//\t\tplugin name;\r\n\tname: \"dnd\",\r\n\t\r\n\t_targetAnchorBorderWidth: 2,\r\n\t_copyOnly: false,\r\n\t_config: {\r\n\t\t\"row\":{\r\n\t\t\t\"within\":true,\r\n\t\t\t\"in\":true,\r\n\t\t\t\"out\":true\r\n\t\t},\r\n\t\t\"col\":{\r\n\t\t\t\"within\":true,\r\n\t\t\t\"in\":true,\r\n\t\t\t\"out\":true\r\n\t\t},\r\n\t\t\"cell\":{\r\n\t\t\t\"within\":true,\r\n\t\t\t\"in\":true,\r\n\t\t\t\"out\":true\r\n\t\t}\r\n\t},\r\n\tconstructor: function(grid, args){\r\n\t\tthis.grid = grid;\r\n\t\tthis._config = lang.clone(this._config);\r\n\t\targs = lang.isObject(args) ? args : {};\r\n\t\tthis.setupConfig(args.dndConfig);\r\n\t\tthis._copyOnly = !!args.copyOnly;\r\n\t\t\r\n\t\t//Get the plugins we are dependent on.\r\n\t\tthis._mixinGrid();\r\n\t\tthis.selector = grid.pluginMgr.getPlugin(\"selector\");\r\n\t\tthis.rearranger = grid.pluginMgr.getPlugin(\"rearrange\");\r\n\t\t//TODO: waiting for a better plugin framework to pass args to dependent plugins.\r\n\t\tthis.rearranger.setArgs(args);\r\n\t\t\r\n\t\t//Initialized the components we need.\r\n\t\tthis._clear();\r\n\t\tthis._elem = new GridDnDElement(this);\r\n\t\tthis._source = new GridDnDSource(this._elem.node, {\r\n\t\t\t\"grid\": grid,\r\n\t\t\t\"dndElem\": this._elem,\r\n\t\t\t\"dnd\": this\r\n\t\t});\r\n\t\tthis._container = query(\".dojoxGridMasterView\", this.grid.domNode)[0];\r\n\t\tthis._initEvents();\r\n\t},\r\n\tdestroy: function(){\r\n\t\tthis.inherited(arguments);\r\n\t\tthis._clear();\r\n\t\tthis._source.destroy();\r\n\t\tthis._elem.destroy();\r\n\t\tthis._container = null;\r\n\t\tthis.grid = null;\r\n\t\tthis.selector = null;\r\n\t\tthis.rearranger = null;\r\n\t\tthis._config = null;\r\n\t},\r\n\t_mixinGrid: function(){\r\n\t\t// summary:\r\n\t\t//\t\tProvide APIs for grid.\r\n\t\tthis.grid.setupDnDConfig = lang.hitch(this, \"setupConfig\");\r\n\t\tthis.grid.dndCopyOnly = lang.hitch(this, \"copyOnly\");\r\n\t},\r\n\tsetupConfig: function(config){\r\n\t\t// summary:\r\n\t\t//\t\tConfigure which DnD functionalities are needed.\r\n\t\t//\t\tCombination of any item from type set (\"row\", \"col\", \"cell\")\r\n\t\t//\t\tand any item from mode set(\"within\", \"in\", \"out\") is configurable.\r\n\t\t//\r\n\t\t//\t\t\"row\", \"col\", \"cell\" are straightforward, while the other 3 are explained below:\r\n\t\t//\r\n\t\t//\t\t- \"within\": DnD within grid, that is, column/row reordering and cell moving/copying.\r\n\t\t//\t\t- \"in\": Whether allowed to accept rows/cells (currently not support columns) from another grid.\r\n\t\t//\t\t- \"out\": Whether allowed to drag out of grid, to another grid or even to any other DnD target.\r\n\t\t//\r\n\t\t//\t\tIf not provided in the config, will use the default.\r\n\t\t//\t\tWhen declared together, Mode set has higher priority than type set.\r\n\t\t// config: Object\r\n\t\t//\t\tDnD configuration object.\r\n\t\t//\t\tSee the examples below.\r\n\t\t// example:\r\n\t\t//\t\tThe following code disables row DnD within grid,\r\n\t\t//\t\tbut still can drag rows out of grid or drag rows from other gird.\r\n\t\t//\t|\tsetUpConfig({\r\n\t\t//\t|\t\t\"row\": {\r\n\t\t//\t|\t\t\t\"within\": false\r\n\t\t//\t|\t\t}\r\n\t\t//\t|\t});\r\n\t\t//\r\n\t\t//\t\tThe opposite way is also okay:\r\n\t\t//\t|\tsetUpConfig({\r\n\t\t//\t|\t\t\"within\": {\r\n\t\t//\t|\t\t\t\"row\": false\r\n\t\t//\t|\t\t}\r\n\t\t//\t|\t});\r\n\t\t//\r\n\t\t//\t\tAnd if you'd like to disable/enable a whole set, here's a shortcut:\r\n\t\t//\t|\tsetUpConfig({\r\n\t\t//\t|\t\t\"cell\", true,\r\n\t\t//\t|\t\t\"out\": false\r\n\t\t//\t|\t});\r\n\t\t//\r\n\t\t//\t\tBecause mode has higher priority than type, the following will disable row dnd within grid:\r\n\t\t//\t|\tsetUpConfig({\r\n\t\t//\t|\t\t\"within\", {\r\n\t\t//\t|\t\t\t\"row\": false;\r\n\t\t//\t|\t\t},\r\n\t\t//\t|\t\t\"row\", {\r\n\t\t//\t|\t\t\t\"within\": true\r\n\t\t//\t|\t\t}\r\n\t\t//\t|\t});\r\n\t\tif(config && lang.isObject(config)){\r\n\t\t\tvar firstLevel = [\"row\", \"col\", \"cell\"],\r\n\t\t\t\tsecondLevel = [\"within\", \"in\", \"out\"],\r\n\t\t\t\tcfg = this._config;\r\n\t\t\tarray.forEach(firstLevel, function(type){\r\n\t\t\t\tif(type in config){\r\n\t\t\t\t\tvar t = config[type];\r\n\t\t\t\t\tif(t && lang.isObject(t)){\r\n\t\t\t\t\t\tarray.forEach(secondLevel, function(mode){\r\n\t\t\t\t\t\t\tif(mode in t){\r\n\t\t\t\t\t\t\t\tcfg[type][mode] = !!t[mode];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tarray.forEach(secondLevel, function(mode){\r\n\t\t\t\t\t\t\tcfg[type][mode] = !!t;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tarray.forEach(secondLevel, function(mode){\r\n\t\t\t\tif(mode in config){\r\n\t\t\t\t\tvar m = config[mode];\r\n\t\t\t\t\tif(m && lang.isObject(m)){\r\n\t\t\t\t\t\tarray.forEach(firstLevel, function(type){\r\n\t\t\t\t\t\t\tif(type in m){\r\n\t\t\t\t\t\t\t\tcfg[type][mode] = !!m[type];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tarray.forEach(firstLevel, function(type){\r\n\t\t\t\t\t\t\tcfg[type][mode] = !!m;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n\tcopyOnly: function(isCopyOnly){\r\n\t\t// summary:\r\n\t\t//\t\tSetter/getter of this._copyOnly.\r\n\t\tif(typeof isCopyOnly != \"undefined\"){\r\n\t\t\tthis._copyOnly = !!isCopyOnly;\r\n\t\t}\r\n\t\treturn this._copyOnly;\r\n\t},\r\n\t_isOutOfGrid: function(evt){\r\n\t\tvar gridPos = html.position(this.grid.domNode), x = evt.clientX, y = evt.clientY;\r\n\t\treturn y < gridPos.y || y > gridPos.y + gridPos.h ||\r\n\t\t\tx < gridPos.x || x > gridPos.x + gridPos.w;\r\n\t},\r\n\t_onMouseMove: function(evt){\r\n\t\tif(this._dndRegion && !this._dnding && !this._externalDnd){\r\n\t\t\tthis._dnding = true;\r\n\t\t\tthis._startDnd(evt);\r\n\t\t}else{\r\n\t\t\tif(this._isMouseDown && !this._dndRegion){\r\n\t\t\t\tdelete this._isMouseDown;\r\n\t\t\t\tthis._oldCursor = html.style(win.body(), \"cursor\");\r\n\t\t\t\thtml.style(win.body(), \"cursor\", \"not-allowed\");\r\n\t\t\t}\r\n\t\t\t//TODO: should implement as mouseenter/mouseleave\r\n\t\t\t//But we have an avatar under mouse when dnd, and this will cause a lot of mouseenter in FF.\r\n\t\t\tvar isOut = this._isOutOfGrid(evt);\r\n\t\t\tif(!this._alreadyOut && isOut){\r\n\t\t\t\tthis._alreadyOut = true;\r\n\t\t\t\tif(this._dnding){\r\n\t\t\t\t\tthis._destroyDnDUI(true, false);\r\n\t\t\t\t}\r\n\t\t\t\tthis._moveEvent = evt;\r\n\t\t\t\tthis._source.onOutEvent();\r\n\t\t\t}else if(this._alreadyOut && !isOut){\r\n\t\t\t\tthis._alreadyOut = false;\r\n\t\t\t\tif(this._dnding){\r\n\t\t\t\t\tthis._createDnDUI(evt, true);\r\n\t\t\t\t}\r\n\t\t\t\tthis._moveEvent = evt;\r\n\t\t\t\tthis._source.onOverEvent();\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\t_onMouseUp: function(){\r\n\t\tif(!this._extDnding && !this._isSource){\r\n\t\t\tvar isInner = this._dnding && !this._alreadyOut;\r\n\t\t\tif(isInner && this._config[this._dndRegion.type][\"within\"]){\r\n\t\t\t\tthis._rearrange();\r\n\t\t\t}\r\n\t\t\tthis._endDnd(isInner);\r\n\t\t}\r\n\t\thtml.style(win.body(), \"cursor\", this._oldCursor || \"\");\r\n\t\tdelete this._isMouseDown;\r\n\t},\r\n\t_initEvents: function(){\r\n\t\tvar g = this.grid, s = this.selector;\r\n\t\tthis.connect(win.doc, \"onmousemove\", \"_onMouseMove\");\r\n\t\tthis.connect(win.doc, \"onmouseup\", \"_onMouseUp\");\r\n\t\t\r\n\t\tthis.connect(g, \"onCellMouseOver\", function(evt){\r\n\t\t\tif(!this._dnding && !s.isSelecting() && !evt.ctrlKey){\r\n\t\t\t\tthis._dndReady = s.isSelected(\"cell\", evt.rowIndex, evt.cell.index);\r\n\t\t\t\ts.selectEnabled(!this._dndReady);\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.connect(g, \"onHeaderCellMouseOver\", function(evt){\r\n\t\t\tif(this._dndReady){\r\n\t\t\t\ts.selectEnabled(true);\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.connect(g, \"onRowMouseOver\", function(evt){\r\n\t\t\tif(this._dndReady && !evt.cell){\r\n\t\t\t\ts.selectEnabled(true);\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.connect(g, \"onCellMouseDown\", function(evt){\r\n\t\t\tif(!evt.ctrlKey && this._dndReady){\r\n\t\t\t\tthis._dndRegion = this._getDnDRegion(evt.rowIndex, evt.cell.index);\r\n\t\t\t\tthis._isMouseDown = true;\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.connect(g, \"onCellMouseUp\", function(evt){\r\n\t\t\tif(!this._dndReady && !s.isSelecting() && evt.cell){\r\n\t\t\t\tthis._dndReady = s.isSelected(\"cell\", evt.rowIndex, evt.cell.index);\r\n\t\t\t\ts.selectEnabled(!this._dndReady);\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.connect(g, \"onCellClick\", function(evt){\r\n\t\t\tif(this._dndReady && !evt.ctrlKey && !evt.shiftKey){\r\n\t\t\t\ts.select(\"cell\", evt.rowIndex, evt.cell.index);\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.connect(g, \"onEndAutoScroll\", function(isVertical, isForward, view, target, evt){\r\n\t\t\tif(this._dnding){\r\n\t\t\t\tthis._markTargetAnchor(evt);\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.connect(win.doc, \"onkeydown\", function(evt){\r\n\t\t\tif(evt.keyCode == keys.ESCAPE){\r\n\t\t\t\tthis._endDnd(false);\r\n\t\t\t}else if(evt.keyCode == keys.CTRL){\r\n\t\t\t\ts.selectEnabled(true);\r\n\t\t\t\tthis._isCopy = true;\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.connect(win.doc, \"onkeyup\", function(evt){\r\n\t\t\tif(evt.keyCode == keys.CTRL){\r\n\t\t\t\ts.selectEnabled(!this._dndReady);\r\n\t\t\t\tthis._isCopy = false;\r\n\t\t\t}\r\n\t\t});\r\n\t},\r\n\t_clear: function(){\r\n\t\tthis._dndRegion = null;\r\n\t\tthis._target = null;\r\n\t\tthis._moveEvent = null;\r\n\t\tthis._targetAnchor = {};\r\n\t\tthis._dnding = false;\r\n\t\tthis._externalDnd = false;\r\n\t\tthis._isSource = false;\r\n\t\tthis._alreadyOut = false;\r\n\t\tthis._extDnding = false;\r\n\t},\r\n\t_getDnDRegion: function(rowIndex, colIndex){\r\n\t\tvar s = this.selector,\r\n\t\t\tselected = s._selected,\r\n\t\t\tflag = (!!selected.cell.length) | (!!selected.row.length << 1) | (!!selected.col.length << 2),\r\n\t\t\ttype;\r\n\t\tswitch(flag){\r\n\t\t\tcase 1:\r\n\t\t\t\ttype = \"cell\";\r\n\t\t\t\tif(!this._config[type][\"within\"] && !this._config[type][\"out\"]){\r\n\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t\tvar cells = this.grid.layout.cells,\r\n\t\t\t\t\tgetCount = function(range){\r\n\t\t\t\t\t\tvar hiddenColCnt = 0;\r\n\t\t\t\t\t\tfor(var i = range.min.col; i <= range.max.col; ++i){\r\n\t\t\t\t\t\t\tif(cells[i].hidden){\r\n\t\t\t\t\t\t\t\t++hiddenColCnt;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn (range.max.row - range.min.row + 1) * (range.max.col - range.min.col + 1 - hiddenColCnt);\r\n\t\t\t\t\t},\r\n\t\t\t\t\tinRange = function(item, range){\r\n\t\t\t\t\t\treturn item.row >= range.min.row && item.row <= range.max.row &&\r\n\t\t\t\t\t\t\titem.col >= range.min.col && item.col <= range.max.col;\r\n\t\t\t\t\t},\r\n\t\t\t\t\trange = {\r\n\t\t\t\t\t\tmax: {\r\n\t\t\t\t\t\t\trow: -1,\r\n\t\t\t\t\t\t\tcol: -1\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tmin: {\r\n\t\t\t\t\t\t\trow: Infinity,\r\n\t\t\t\t\t\t\tcol: Infinity\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\tarray.forEach(selected[type], function(item){\r\n\t\t\t\t\tif(item.row < range.min.row){\r\n\t\t\t\t\t\trange.min.row = item.row;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(item.row > range.max.row){\r\n\t\t\t\t\t\trange.max.row = item.row;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(item.col < range.min.col){\r\n\t\t\t\t\t\trange.min.col = item.col;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(item.col > range.max.col){\r\n\t\t\t\t\t\trange.max.col = item.col;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tif(array.some(selected[type], function(item){\r\n\t\t\t\t\treturn item.row == rowIndex && item.col == colIndex;\r\n\t\t\t\t})){\r\n\t\t\t\t\tif(getCount(range) == selected[type].length && array.every(selected[type], function(item){\r\n\t\t\t\t\t\treturn inRange(item, range);\r\n\t\t\t\t\t})){\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\t\"type\": type,\r\n\t\t\t\t\t\t\t\"selected\": [range],\r\n\t\t\t\t\t\t\t\"handle\": {\r\n\t\t\t\t\t\t\t\t\"row\": rowIndex,\r\n\t\t\t\t\t\t\t\t\"col\": colIndex\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn null;\r\n\t\t\tcase 2: case 4:\r\n\t\t\t\ttype = flag == 2 ? \"row\" : \"col\";\r\n\t\t\t\tif(!this._config[type][\"within\"] && !this._config[type][\"out\"]){\r\n\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t\tvar res = s.getSelected(type);\r\n\t\t\t\tif(res.length){\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\"type\": type,\r\n\t\t\t\t\t\t\"selected\": _devideToArrays(res),\r\n\t\t\t\t\t\t\"handle\": flag == 2 ? rowIndex : colIndex\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\t\t\t\treturn null;\r\n\t\t}\r\n\t\treturn null;\r\n\t},\r\n\t_startDnd: function(evt){\r\n\t\tthis._createDnDUI(evt);\r\n\t},\r\n\t_endDnd: function(destroySource){\r\n\t\tthis._destroyDnDUI(false, destroySource);\r\n\t\tthis._clear();\r\n\t},\r\n\t_createDnDUI: function(evt, isMovingIn){\r\n\t\t//By default the master view of grid do not have height, because the children in it are all positioned absolutely.\r\n\t\t//But we need it to contain avatars.\r\n\t\tvar viewPos = html.position(this.grid.views.views[0].domNode);\r\n\t\thtml.style(this._container, \"height\", viewPos.h + \"px\");\r\n\t\ttry{\r\n\t\t\t//If moving in from out side, dnd source is already created.\r\n\t\t\tif(!isMovingIn){\r\n\t\t\t\tthis._createSource(evt);\r\n\t\t\t}\r\n\t\t\tthis._createMoveable(evt);\r\n\t\t\tthis._oldCursor = html.style(win.body(), \"cursor\");\r\n\t\t\thtml.style(win.body(), \"cursor\", \"default\");\r\n\t\t}catch(e){\r\n\t\t\tconsole.warn(\"DnD._createDnDUI() error:\", e);\r\n\t\t}\r\n\t},\r\n\t_destroyDnDUI: function(isMovingOut, destroySource){\r\n\t\ttry{\r\n\t\t\tif(destroySource){\r\n\t\t\t\tthis._destroySource();\r\n\t\t\t}\r\n\t\t\tthis._unmarkTargetAnchor();\r\n\t\t\tif(!isMovingOut){\r\n\t\t\t\tthis._destroyMoveable();\r\n\t\t\t}\r\n\t\t\thtml.style(win.body(), \"cursor\", this._oldCursor);\r\n\t\t}catch(e){\r\n\t\t\tconsole.warn(\"DnD._destroyDnDUI() error:\", this.grid.id, e);\r\n\t\t}\r\n\t},\r\n\t_createSource: function(evt){\r\n\t\tthis._elem.createDnDNodes(this._dndRegion);\r\n\t\tvar m = Manager.manager();\r\n\t\tvar oldMakeAvatar = m.makeAvatar;\r\n\t\tm._dndPlugin = this;\r\n\t\tm.makeAvatar = function(){\r\n\t\t\tvar avatar = new GridDnDAvatar(m);\r\n\t\t\tdelete m._dndPlugin;\r\n\t\t\treturn avatar;\r\n\t\t};\r\n\t\tm.startDrag(this._source, this._elem.getDnDNodes(), evt.ctrlKey);\r\n\t\tm.makeAvatar = oldMakeAvatar;\r\n\t\tm.onMouseMove(evt);\r\n\t},\r\n\t_destroySource: function(){\r\n\t\tconnect.publish(\"/dnd/cancel\");\r\n\t},\r\n\t_createMoveable: function(evt){\r\n\t\tif(!this._markTagetAnchorHandler){\r\n\t\t\tthis._markTagetAnchorHandler = this.connect(win.doc, \"onmousemove\", \"_markTargetAnchor\");\r\n\t\t}\r\n\t},\r\n\t_destroyMoveable: function(){\r\n\t\tthis.disconnect(this._markTagetAnchorHandler);\r\n\t\tdelete this._markTagetAnchorHandler;\r\n\t},\r\n\t_calcColTargetAnchorPos: function(evt, containerPos){\r\n\t\t// summary:\r\n\t\t//\t\tCalculate the position of the column DnD avatar\r\n\t\tvar i, headPos, left, target, ex = evt.clientX,\r\n\t\t\tcells = this.grid.layout.cells,\r\n\t\t\tltr = html._isBodyLtr(),\r\n\t\t\theaders = this._getVisibleHeaders();\r\n\t\tfor(i = 0; i < headers.length; ++i){\r\n\t\t\theadPos = html.position(headers[i].node);\r\n\t\t\tif(ltr ? ((i === 0 || ex >= headPos.x) && ex < headPos.x + headPos.w) :\r\n\t\t\t\t((i === 0 || ex < headPos.x + headPos.w) && ex >= headPos.x)){\r\n\t\t\t\tleft = headPos.x + (ltr ? 0 : headPos.w);\r\n\t\t\t\tbreak;\r\n\t\t\t}else if(ltr ? (i === headers.length - 1 && ex >= headPos.x + headPos.w) :\r\n\t\t\t\t(i === headers.length - 1 && ex < headPos.x)){\r\n\t\t\t\t++i;\r\n\t\t\t\tleft = headPos.x + (ltr ? headPos.w : 0);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(i < headers.length){\r\n\t\t\ttarget = headers[i].cell.index;\r\n\t\t\tif(this.selector.isSelected(\"col\", target) && this.selector.isSelected(\"col\", target - 1)){\r\n\t\t\t\tvar ranges = this._dndRegion.selected;\r\n\t\t\t\tfor(i = 0; i < ranges.length; ++i){\r\n\t\t\t\t\tif(array.indexOf(ranges[i], target) >= 0){\r\n\t\t\t\t\t\ttarget = ranges[i][0];\r\n\t\t\t\t\t\theadPos = html.position(cells[target].getHeaderNode());\r\n\t\t\t\t\t\tleft = headPos.x + (ltr ? 0 : headPos.w);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\ttarget = cells.length;\r\n\t\t}\r\n\t\tthis._target = target;\r\n\t\treturn left - containerPos.x;\r\n\t},\r\n\t_calcRowTargetAnchorPos: function(evt, containerPos){\r\n\t\t// summary:\r\n\t\t//\t\tCalculate the position of the row DnD avatar\r\n\t\tvar g = this.grid, top, i = 0,\r\n\t\t\tcells = g.layout.cells;\r\n\t\twhile(cells[i].hidden){ ++i; }\r\n\t\tvar cell = g.layout.cells[i],\r\n\t\t\trowIndex = g.scroller.firstVisibleRow,\r\n\t\t\tcellNode = cell.getNode(rowIndex);\r\n\t\tif(!cellNode){\r\n\t\t\t//if the target grid is empty, set to -1 \r\n\t\t\t//which will be processed in Rearrange\r\n\t\t    this._target = -1;\r\n\t\t    return 0; //position of the insert bar\r\n\t\t}\r\n\t\tvar nodePos = html.position(cellNode);\r\n\t\twhile(nodePos.y + nodePos.h < evt.clientY){\r\n\t\t\tif(++rowIndex >= g.rowCount){\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tnodePos = html.position(cell.getNode(rowIndex));\r\n\t\t}\r\n\t\tif(rowIndex < g.rowCount){\r\n\t\t\tif(this.selector.isSelected(\"row\", rowIndex) && this.selector.isSelected(\"row\", rowIndex - 1)){\r\n\t\t\t\tvar ranges = this._dndRegion.selected;\r\n\t\t\t\tfor(i = 0; i < ranges.length; ++i){\r\n\t\t\t\t\tif(array.indexOf(ranges[i], rowIndex) >= 0){\r\n\t\t\t\t\t\trowIndex = ranges[i][0];\r\n\t\t\t\t\t\tnodePos = html.position(cell.getNode(rowIndex));\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\ttop = nodePos.y;\r\n\t\t}else{\r\n\t\t\ttop = nodePos.y + nodePos.h;\r\n\t\t}\r\n\t\tthis._target = rowIndex;\r\n\t\treturn top - containerPos.y;\r\n\t},\r\n\t_calcCellTargetAnchorPos: function(evt, containerPos, targetAnchor){\r\n\t\t// summary:\r\n\t\t//\t\tCalculate the position of the cell DnD avatar\r\n\t\tvar s = this._dndRegion.selected[0],\r\n\t\t\torigin = this._dndRegion.handle,\r\n\t\t\tg = this.grid, ltr = html._isBodyLtr(),\r\n\t\t\tcells = g.layout.cells, headPos,\r\n\t\t\tminPos, maxPos, headers,\r\n\t\t\theight, width, left, top,\r\n\t\t\tminCol, maxCol, i,\r\n\t\t\tpreSpan = origin.col - s.min.col,\r\n\t\t\tpostSpan = s.max.col - origin.col,\r\n\t\t\tleftTopDiv, rightBottomDiv;\r\n\t\tif(!targetAnchor.childNodes.length){\r\n\t\t\tleftTopDiv = html.create(\"div\", {\r\n\t\t\t\t\"class\": \"dojoxGridCellBorderLeftTopDIV\"\r\n\t\t\t}, targetAnchor);\r\n\t\t\trightBottomDiv = html.create(\"div\", {\r\n\t\t\t\t\"class\": \"dojoxGridCellBorderRightBottomDIV\"\r\n\t\t\t}, targetAnchor);\r\n\t\t}else{\r\n\t\t\tleftTopDiv = query(\".dojoxGridCellBorderLeftTopDIV\", targetAnchor)[0];\r\n\t\t\trightBottomDiv = query(\".dojoxGridCellBorderRightBottomDIV\", targetAnchor)[0];\r\n\t\t}\r\n\t\tfor(i = s.min.col + 1; i < origin.col; ++i){\r\n\t\t\tif(cells[i].hidden){\r\n\t\t\t\t--preSpan;\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor(i = origin.col + 1; i < s.max.col; ++i){\r\n\t\t\tif(cells[i].hidden){\r\n\t\t\t\t--postSpan;\r\n\t\t\t}\r\n\t\t}\r\n\t\theaders = this._getVisibleHeaders();\r\n\t\t//calc width\r\n\t\tfor(i = preSpan; i < headers.length - postSpan; ++i){\r\n\t\t\theadPos = html.position(headers[i].node);\r\n\t\t\tif((evt.clientX >= headPos.x && evt.clientX < headPos.x + headPos.w) || //within in this column\r\n\t\t\t\t//prior to this column, but within range\r\n\t\t\t\t(i == preSpan && (ltr ? evt.clientX < headPos.x : evt.clientX >= headPos.x + headPos.w)) ||\r\n\t\t\t\t//post to this column, but within range\r\n\t\t\t\t(i == headers.length - postSpan - 1 && (ltr ? evt.clientX >= headPos.x + headPos.w : evt < headPos.x))){\r\n\t\t\t\t\tminCol = headers[i - preSpan];\r\n\t\t\t\t\tmaxCol = headers[i + postSpan];\r\n\t\t\t\t\tminPos = html.position(minCol.node);\r\n\t\t\t\t\tmaxPos = html.position(maxCol.node);\r\n\t\t\t\t\tminCol = minCol.cell.index;\r\n\t\t\t\t\tmaxCol = maxCol.cell.index;\r\n\t\t\t\t\tleft = ltr ? minPos.x : maxPos.x;\r\n\t\t\t\t\twidth = ltr ? (maxPos.x + maxPos.w - minPos.x) : (minPos.x + minPos.w - maxPos.x);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\t//calc height\r\n\t\ti = 0;\r\n\t\twhile(cells[i].hidden){ ++i; }\r\n\t\tvar cell = cells[i],\r\n\t\t\trowIndex = g.scroller.firstVisibleRow,\r\n\t\t\tnodePos = html.position(cell.getNode(rowIndex));\r\n\t\twhile(nodePos.y + nodePos.h < evt.clientY){\r\n\t\t\tif(++rowIndex < g.rowCount){\r\n\t\t\t\tnodePos = html.position(cell.getNode(rowIndex));\r\n\t\t\t}else{\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tvar minRow = rowIndex >= origin.row - s.min.row ? rowIndex - origin.row + s.min.row : 0;\r\n\t\tvar maxRow = minRow + s.max.row - s.min.row;\r\n\t\tif(maxRow >= g.rowCount){\r\n\t\t\tmaxRow = g.rowCount - 1;\r\n\t\t\tminRow = maxRow - s.max.row + s.min.row;\r\n\t\t}\r\n\t\tminPos = html.position(cell.getNode(minRow));\r\n\t\tmaxPos = html.position(cell.getNode(maxRow));\r\n\t\ttop = minPos.y;\r\n\t\theight = maxPos.y + maxPos.h - minPos.y;\r\n\t\tthis._target = {\r\n\t\t\t\"min\":{\r\n\t\t\t\t\"row\": minRow,\r\n\t\t\t\t\"col\": minCol\r\n\t\t\t},\r\n\t\t\t\"max\":{\r\n\t\t\t\t\"row\": maxRow,\r\n\t\t\t\t\"col\": maxCol\r\n\t\t\t}\r\n\t\t};\r\n\t\tvar anchorBorderSize = (html.marginBox(leftTopDiv).w - html.contentBox(leftTopDiv).w) / 2;\r\n\t\tvar leftTopCellPos = html.position(cells[minCol].getNode(minRow));\r\n\t\thtml.style(leftTopDiv, {\r\n\t\t\t\"width\": (leftTopCellPos.w - anchorBorderSize) + \"px\",\r\n\t\t\t\"height\": (leftTopCellPos.h - anchorBorderSize) + \"px\"\r\n\t\t});\r\n\t\tvar rightBottomCellPos = html.position(cells[maxCol].getNode(maxRow));\r\n\t\thtml.style(rightBottomDiv, {\r\n\t\t\t\"width\": (rightBottomCellPos.w - anchorBorderSize) + \"px\",\r\n\t\t\t\"height\": (rightBottomCellPos.h - anchorBorderSize) + \"px\"\r\n\t\t});\r\n\t\treturn {\r\n\t\t\th: height,\r\n\t\t\tw: width,\r\n\t\t\tl: left - containerPos.x,\r\n\t\t\tt: top - containerPos.y\r\n\t\t};\r\n\t},\r\n\t_markTargetAnchor: function(evt){\r\n\t\ttry{\r\n\t\tvar t = this._dndRegion.type;\r\n\t\tif(this._alreadyOut || (this._dnding && !this._config[t][\"within\"]) || (this._extDnding && !this._config[t][\"in\"])){\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tvar height, width, left, top,\r\n\t\t\ttargetAnchor = this._targetAnchor[t],\r\n\t\t\tpos = html.position(this._container);\r\n\t\tif(!targetAnchor){\r\n\t\t\ttargetAnchor = this._targetAnchor[t] = html.create(\"div\", {\r\n\t\t\t\t\"class\": (t == \"cell\") ? \"dojoxGridCellBorderDIV\" : \"dojoxGridBorderDIV\"\r\n\t\t\t});\r\n\t\t\thtml.style(targetAnchor, \"display\", \"none\");\r\n\t\t\tthis._container.appendChild(targetAnchor);\r\n\t\t}\r\n\t\tswitch(t){\r\n\t\t\tcase \"col\":\r\n\t\t\t\theight = pos.h;\r\n\t\t\t\twidth = this._targetAnchorBorderWidth;\r\n\t\t\t\tleft = this._calcColTargetAnchorPos(evt, pos);\r\n\t\t\t\ttop = 0;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"row\":\r\n\t\t\t\theight = this._targetAnchorBorderWidth;\r\n\t\t\t\twidth = pos.w;\r\n\t\t\t\tleft = 0;\r\n\t\t\t\ttop = this._calcRowTargetAnchorPos(evt, pos);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"cell\":\r\n\t\t\t\tvar cellPos = this._calcCellTargetAnchorPos(evt, pos, targetAnchor);\r\n\t\t\t\theight = cellPos.h;\r\n\t\t\t\twidth = cellPos.w;\r\n\t\t\t\tleft = cellPos.l;\r\n\t\t\t\ttop = cellPos.t;\r\n\t\t}\r\n\t\tif(typeof height == \"number\" && typeof width == \"number\" && typeof left == \"number\" && typeof top == \"number\"){\r\n\t\t\thtml.style(targetAnchor, {\r\n\t\t\t\t\"height\": height + \"px\",\r\n\t\t\t\t\"width\": width + \"px\",\r\n\t\t\t\t\"left\": left + \"px\",\r\n\t\t\t\t\"top\": top + \"px\"\r\n\t\t\t});\r\n\t\t\thtml.style(targetAnchor, \"display\", \"\");\r\n\t\t}else{\r\n\t\t\tthis._target = null;\r\n\t\t}\r\n\t\t}catch(e){\r\n\t\t\tconsole.warn(\"DnD._markTargetAnchor() error:\",e);\r\n\t\t}\r\n\t},\r\n\t_unmarkTargetAnchor: function(){\r\n\t\tif(this._dndRegion){\r\n\t\t\tvar targetAnchor = this._targetAnchor[this._dndRegion.type];\r\n\t\t\tif(targetAnchor){\r\n\t\t\t\thtml.style(this._targetAnchor[this._dndRegion.type], \"display\", \"none\");\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\t_getVisibleHeaders: function(){\r\n\t\treturn array.map(array.filter(this.grid.layout.cells, function(cell){\r\n\t\t\treturn !cell.hidden;\r\n\t\t}), function(cell){\r\n\t\t\treturn {\r\n\t\t\t\t\"node\": cell.getHeaderNode(),\r\n\t\t\t\t\"cell\": cell\r\n\t\t\t};\r\n\t\t});\r\n\t},\r\n\t_rearrange: function(){\r\n\t\tif(this._target === null){\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tvar t = this._dndRegion.type;\r\n\t\tvar ranges = this._dndRegion.selected;\r\n\t\tif(t === \"cell\"){\r\n\t\t\tthis.rearranger[(this._isCopy || this._copyOnly) ? \"copyCells\" : \"moveCells\"](ranges[0], this._target === -1 ? null : this._target);\r\n\t\t}else{\r\n\t\t\tthis.rearranger[t == \"col\" ? \"moveColumns\" : \"moveRows\"](_joinToArray(ranges), this._target === -1 ? null: this._target);\r\n\t\t}\r\n\t\tthis._target = null;\r\n\t},\r\n\tonDraggingOver: function(sourcePlugin){\r\n\t\tif(!this._dnding && sourcePlugin){\r\n\t\t\tsourcePlugin._isSource = true;\r\n\t\t\tthis._extDnding = true;\r\n\t\t\tif(!this._externalDnd){\r\n\t\t\t\tthis._externalDnd = true;\r\n\t\t\t\tthis._dndRegion = this._mapRegion(sourcePlugin.grid, sourcePlugin._dndRegion);\r\n\t\t\t}\r\n\t\t\tthis._createDnDUI(this._moveEvent,true);\r\n\t\t\tthis.grid.pluginMgr.getPlugin(\"autoScroll\").readyForAutoScroll = true;\r\n\t\t}\r\n\t},\r\n\t_mapRegion: function(srcGrid, dndRegion){\r\n\t\tif(dndRegion.type === \"cell\"){\r\n\t\t\tvar srcRange = dndRegion.selected[0];\r\n\t\t\tvar cells = this.grid.layout.cells;\r\n\t\t\tvar srcCells = srcGrid.layout.cells;\r\n\t\t\tvar c, cnt = 0;\r\n\t\t\tfor(c = srcRange.min.col; c <= srcRange.max.col; ++c){\r\n\t\t\t\tif(!srcCells[c].hidden){\r\n\t\t\t\t\t++cnt;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tfor(c = 0; cnt > 0; ++c){\r\n\t\t\t\tif(!cells[c].hidden){\r\n\t\t\t\t\t--cnt;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tvar region = lang.clone(dndRegion);\r\n\t\t\tregion.selected[0].min.col = 0;\r\n\t\t\tregion.selected[0].max.col = c - 1;\r\n\t\t\tfor(c = srcRange.min.col; c <= dndRegion.handle.col; ++c){\r\n\t\t\t\tif(!srcCells[c].hidden){\r\n\t\t\t\t\t++cnt;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tfor(c = 0; cnt > 0; ++c){\r\n\t\t\t\tif(!cells[c].hidden){\r\n\t\t\t\t\t--cnt;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tregion.handle.col = c;\r\n\t\t}\r\n\t\treturn dndRegion;\r\n\t},\r\n\tonDraggingOut: function(sourcePlugin){\r\n\t\tif(this._externalDnd){\r\n\t\t\tthis._extDnding = false;\r\n\t\t\tthis._destroyDnDUI(true, false);\r\n\t\t\tif(sourcePlugin){\r\n\t\t\t\tsourcePlugin._isSource = false;\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\tonDragIn: function(sourcePlugin, isCopy){\r\n\t\tvar success = false;\r\n\t\tif(this._target !== null){\r\n\t\t\tvar type = sourcePlugin._dndRegion.type;\r\n\t\t\tvar ranges = sourcePlugin._dndRegion.selected;\r\n\t\t\tswitch(type){\r\n\t\t\t\tcase \"cell\":\r\n\t\t\t\t\tthis.rearranger.changeCells(sourcePlugin.grid, ranges[0], this._target);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"row\":\r\n\t\t\t\t\tvar range = _joinToArray(ranges);\r\n\t\t\t\t\tthis.rearranger.insertRows(sourcePlugin.grid, range, this._target);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tsuccess = true;\r\n\t\t}\r\n\t\tthis._endDnd(true);\r\n\t\tif(sourcePlugin.onDragOut){\r\n\t\t\tsourcePlugin.onDragOut(success && !isCopy);\r\n\t\t}\r\n\t},\r\n\tonDragOut: function(isMove){\r\n\t\tif(isMove && !this._copyOnly){\r\n\t\t\tvar type = this._dndRegion.type;\r\n\t\t\tvar ranges = this._dndRegion.selected;\r\n\t\t\tswitch(type){\r\n\t\t\t\tcase \"cell\":\r\n\t\t\t\t\tthis.rearranger.clearCells(ranges[0]);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"row\":\r\n\t\t\t\t\tthis.rearranger.removeRows(_joinToArray(ranges));\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._endDnd(true);\r\n\t},\r\n\t_canAccept: function(sourcePlugin){\r\n\t\tif(!sourcePlugin){\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tvar srcRegion = sourcePlugin._dndRegion;\r\n\t\tvar type = srcRegion.type;\r\n\t\tif(!this._config[type][\"in\"] || !sourcePlugin._config[type][\"out\"]){\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tvar g = this.grid;\r\n\t\tvar ranges = srcRegion.selected;\r\n\t\tvar colCnt = array.filter(g.layout.cells, function(cell){\r\n\t\t\treturn !cell.hidden;\r\n\t\t}).length;\r\n\t\tvar rowCnt = g.rowCount;\r\n\t\tvar res = true;\r\n\t\tswitch(type){\r\n\t\t\tcase \"cell\":\r\n\t\t\t\tranges = ranges[0];\r\n\t\t\t\tres = g.store.getFeatures()[\"dojo.data.api.Write\"] &&\r\n\t\t\t\t\t(ranges.max.row - ranges.min.row) <= rowCnt &&\r\n\t\t\t\t\tarray.filter(sourcePlugin.grid.layout.cells, function(cell){\r\n\t\t\t\t\t\treturn cell.index >= ranges.min.col && cell.index <= ranges.max.col && !cell.hidden;\r\n\t\t\t\t\t}).length <= colCnt;\r\n\t\t\t\t//intentional drop through - don't break\r\n\t\t\tcase \"row\":\r\n\t\t\t\tif(sourcePlugin._allDnDItemsLoaded()){\r\n\t\t\t\t\treturn res;\r\n\t\t\t\t}\r\n\t\t}\r\n\t\treturn false;\r\n\t},\r\n\t_allDnDItemsLoaded: function(){\r\n\t\tif(this._dndRegion){\r\n\t\t\tvar type = this._dndRegion.type,\r\n\t\t\t\tranges = this._dndRegion.selected,\r\n\t\t\t\trows = [];\r\n\t\t\tswitch(type){\r\n\t\t\t\tcase \"cell\":\r\n\t\t\t\t\tfor(var i = ranges[0].min.row, max = ranges[0].max.row; i <= max; ++i){\r\n\t\t\t\t\t\trows.push(i);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"row\":\r\n\t\t\t\t\trows = _joinToArray(ranges);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\tvar cache = this.grid._by_idx;\r\n\t\t\treturn array.every(rows, function(rowIndex){\r\n\t\t\t\treturn !!cache[rowIndex];\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n});\r\n\r\nEnhancedGrid.registerPlugin(DnD/*name:'dnd'*/, {\r\n\t\"dependency\": [\"selector\", \"rearrange\"]\r\n});\r\n\r\nreturn DnD;\r\n});\r\n"]}