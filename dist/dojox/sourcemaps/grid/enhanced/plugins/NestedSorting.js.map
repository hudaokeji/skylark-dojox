{"version":3,"sources":["grid/enhanced/plugins/NestedSorting.js"],"names":["define","declare","array","connect","lang","html","evt","win","keys","query","string","_Plugin","EnhancedGrid","NestedSorting","name","_currMainSort","_currRegionIdx","_a11yText","dojoxGridDescending","dojoxGridAscending","dojoxGridAscendingTip","dojoxGridDescendingTip","dojoxGridUnsortedTip","constructor","this","_sortDef","_sortData","_headerNodes","_excludedColIdx","nls","grid","_nls","setSortInfo","setSortIndex","hitch","getSortIndex","getSortProps","sortFields","_setGridSortIndex","views","initCookieHandler","plugin","subscribe","id","layout","onStartUp","inherited","arguments","_onMoveColumn","sourceViewIndex","destViewIndex","cellIndex","targetIndex","before","sortIndex","data","cr","_getCurrentRegion","idx","_getRegionHeader","getAttribute","c","sortData","newSortData","_blurRegion","indexOf","_getRegions","firstChild","parseInt","_initSort","_onColumnDnD","type","mapping","p","m","obj","d","inIndex","inAsc","noRefresh","isArray","i","cell","length","getCellByField","attribute","console","warn","canSort","index","field","clearSort","forEach","setSortData","descending","isNaN","undefined","_updateSortDef","sort","postSort","g","n","domNode","len","toggleClass","excluded","_excludedCoIdx","viewsHeaderNode","style","cells","push","_initHeaderNode","_initFocus","_focusHeader","node","sortNode","addClass","a1","a2","className","innerHTML","removeClass","_connects","filter","conn","_sort","disconnect","create","title","substitute","sortingState","nestedSort","ascending","onmousedown","stop","singleSort","_updateHeaderNodeUI","_onHeaderCellClick","e","_focusRegion","target","hasClass","_onSortBtnClick","_onHeaderCellMouseOver","body","cellNode","singleSortBtn","nestedSortBtn","nestedIndex","setAttribute","isAsc","isDesc","_onHeaderCellMouseOut","cellIdx","_prepareSingleSort","_prepareNestedSort","_doSort","order","removeSortData","attr","value","sd","_getCellByNode","unsorted","_this","columnInfo","orderState","orderAction","a11ySingleLabel","a11yNestedLabel","a11ySingleLabelHover","a11yNestedLabelHover","handles","handle","setWaiState","a11y","addCookieHandler","onLoad","onSave","_loadNestedSortingProps","sortInfo","_saveNestedSortingProps","f","focus","_focusRegions","_headerArea","area","getArea","onFocus","focusHeader","onBlur","blurHeader","_blurHeader","onMove","onKeyDown","_regions","getRegions","_onMove","region","view","_getRegionView","scrollboxNode","scrollLeft","headerNode","rowStep","colStep","curr","_onKeyDown","isBubble","keyCode","ENTER","SPACE","header","parentNode","regions","currRegion","currentArea","blur","destroy","registerPlugin"],"mappings":"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","file":"../../../../grid/enhanced/plugins/NestedSorting.js","sourcesContent":["define([\r\n\t\"dojo/_base/declare\",\r\n\t\"dojo/_base/array\",\r\n\t\"dojo/_base/connect\",\r\n\t\"dojo/_base/lang\",\r\n\t\"dojo/_base/html\",\r\n\t\"dojo/_base/event\",\r\n\t\"dojo/_base/window\",\r\n\t\"dojo/keys\",\r\n\t\"dojo/query\",\r\n\t\"dojo/string\",\r\n\t\"../_Plugin\",\r\n\t\"../../EnhancedGrid\"\r\n], function(declare, array, connect, lang, html, evt, win, keys, query, string, _Plugin, EnhancedGrid){\r\n\r\nvar NestedSorting = declare(\"dojox.grid.enhanced.plugins.NestedSorting\", _Plugin, {\r\n\t// summary:\r\n\t//\t\tProvides nested sorting feature\r\n\t//\r\n\t// description:\r\n\t//\t\tA flexible way to control multiple column sorting, including\r\n\t//\r\n\t//\t\t1. Set default sorting order\r\n\t//\t\t2. Disable sorting for certain columns\r\n\t//\t\t3. Set sorting order dynamically with JS API\r\n\t//\r\n\t// example:\r\n\t// |\t<script type=\"text/javascript\">\r\n\t// |\t\tvar grid = new dojox.grid.EnhancedGrid({plugins : {nestedSorting: true}},\r\n\t// |\t               sortFields: [{attribute: 'col4', descending: false},...],//set default sorting order\r\n\t// |\t\t\t       canSort: function(index, field){ return true},//disable sorting for a column\r\n\t// |\t\t\t\t   ... }, dojo.byId('gridDiv'));\r\n\t// |\t\tgrid.startup();\r\n\t// |\t\t//set new sorting order\r\n\t// |\t\tgrid.setSortIndex([{attribute: 'col3', descending: true},...])\r\n\t// |\t</script>\r\n\t\r\n\t// name: String\r\n\t//\t\tPlugin name\r\n\tname: \"nestedSorting\",\r\n\t\r\n\t_currMainSort: 'none',//'none'|'asc'|'desc'\r\n\t\r\n\t_currRegionIdx: -1,\r\n\t\r\n\t_a11yText: {\r\n\t\t'dojoxGridDescending'   : '&#9662;',\r\n\t\t'dojoxGridAscending'    : '&#9652;',\r\n\t\t'dojoxGridAscendingTip' : '&#1784;',\r\n\t\t'dojoxGridDescendingTip': '&#1783;',\r\n\t\t'dojoxGridUnsortedTip'  : 'x' //'&#10006;'\r\n\t},\r\n\t\r\n\tconstructor: function(){\r\n\t\tthis._sortDef = [];\r\n\t\tthis._sortData = {};\r\n\t\tthis._headerNodes = {};\r\n\t\t//column index that are hidden, un-sortable or indirect selection etc.\r\n\t\tthis._excludedColIdx = [];\r\n\t\tthis.nls = this.grid._nls;\r\n\t\tthis.grid.setSortInfo = function(){};\r\n\t\tthis.grid.setSortIndex = lang.hitch(this, '_setGridSortIndex');\r\n\t\tthis.grid.getSortIndex = function(){};\r\n\t\tthis.grid.getSortProps = lang.hitch(this, 'getSortProps');\r\n\t\tif(this.grid.sortFields){\r\n\t\t\tthis._setGridSortIndex(this.grid.sortFields, null, true);\r\n\t\t}\r\n\t\tthis.connect(this.grid.views, 'render', '_initSort');//including column resize\r\n\t\tthis.initCookieHandler();\r\n\t\tif(this.grid.plugin('rearrange')){\r\n\t\t\tthis.subscribe(\"dojox/grid/rearrange/move/\" + this.grid.id, lang.hitch(this, '_onColumnDnD'));\r\n\t\t}else{\r\n\t\t\tthis.connect(this.grid.layout, 'moveColumn', '_onMoveColumn');\r\n\t\t}\r\n\t},\r\n\tonStartUp: function(){\r\n\t\t//overwrite base Grid functions\r\n\t\tthis.inherited(arguments);\r\n\t\tthis.connect(this.grid, 'onHeaderCellClick', '_onHeaderCellClick');\r\n\t\tthis.connect(this.grid, 'onHeaderCellMouseOver', '_onHeaderCellMouseOver');\r\n\t\tthis.connect(this.grid, 'onHeaderCellMouseOut', '_onHeaderCellMouseOut');\r\n\t},\r\n\t_onMoveColumn: function(sourceViewIndex, destViewIndex, cellIndex, targetIndex, before){\r\n\t\tvar cr = this._getCurrentRegion(),\r\n\t\t\tidx = cr && this._getRegionHeader(cr).getAttribute('idx'),\r\n\t\t\tc = this._headerNodes[idx],\r\n\t\t\tsortData = this._sortData,\r\n\t\t\tnewSortData = {},\r\n\t\t\tsortIndex, data;\r\n\t\tif(cr){\r\n\t\t\tthis._blurRegion(cr);\r\n\t\t\tthis._currRegionIdx = array.indexOf(this._getRegions(), c.firstChild);\r\n\t\t}\r\n\t\tif(targetIndex < cellIndex){\r\n\t\t\tfor(sortIndex in sortData){\r\n\t\t\t\tsortIndex = parseInt(sortIndex, 10);\r\n\t\t\t\tdata = sortData[sortIndex];\r\n\t\t\t\tif(data){\r\n\t\t\t\t\tif(sortIndex >= targetIndex && sortIndex < cellIndex){\r\n\t\t\t\t\t\tnewSortData[sortIndex + 1] = data;\r\n\t\t\t\t\t}else if(sortIndex == cellIndex){\r\n\t\t\t\t\t\tnewSortData[targetIndex] = data;\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tnewSortData[sortIndex] = data;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}else if(targetIndex > cellIndex + 1){\r\n\t\t\tif(!before){\r\n\t\t\t\ttargetIndex++;\r\n\t\t\t}\r\n\t\t\tfor(sortIndex in sortData){\r\n\t\t\t\tsortIndex = parseInt(sortIndex, 10);\r\n\t\t\t\tdata = sortData[sortIndex];\r\n\t\t\t\tif(data){\r\n\t\t\t\t\tif(sortIndex > cellIndex && sortIndex < targetIndex){\r\n\t\t\t\t\t\tnewSortData[sortIndex - 1] = data;\r\n\t\t\t\t\t}else if(sortIndex == cellIndex){\r\n\t\t\t\t\t\tnewSortData[targetIndex - 1] = data;\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tnewSortData[sortIndex] = data;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._sortData = newSortData;\r\n\t\tthis._initSort(false);\r\n\t},\r\n\t_onColumnDnD: function(type, mapping){\r\n\t\t// summary:\r\n\t\t//\t\tUpdate nested sorting after column moved\t\t\r\n\t\tif(type !== 'col'){return;}\r\n\t\tvar m = mapping, obj = {}, d = this._sortData, p;\r\n\t\tvar cr = this._getCurrentRegion();\r\n\t\tthis._blurRegion(cr);\r\n\t\tvar idx = this._getRegionHeader(cr).getAttribute('idx');\r\n\t\tfor(p in m){\r\n\t\t\tif(d[p]){\r\n\t\t\t\tobj[m[p]] = d[p];\r\n\t\t\t\tdelete d[p];\r\n\t\t\t}\r\n\t\t\tif(p === idx){\r\n\t\t\t\tidx = m[p];\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor(p in obj){\r\n\t\t\td[p] = obj[p];\r\n\t\t}\r\n\t\tvar c = this._headerNodes[idx];\r\n\t\tthis._currRegionIdx = array.indexOf(this._getRegions(), c.firstChild);\r\n\t\tthis._initSort(false);\r\n\t},\r\n\t_setGridSortIndex: function(inIndex, inAsc, noRefresh){\r\n\t\tif(lang.isArray(inIndex)){\r\n\t\t\tvar i, d, cell;\r\n\t\t\tfor(i = 0; i < inIndex.length; i++){\r\n\t\t\t\td = inIndex[i];\r\n\t\t\t\tcell = this.grid.getCellByField(d.attribute);\r\n\t\t\t\tif(!cell){\r\n\t\t\t\t\tconsole.warn('Invalid sorting option, column ', d.attribute, ' not found.');\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif(cell['nosort'] || !this.grid.canSort(cell.index, cell.field)){\r\n\t\t\t\t\tconsole.warn('Invalid sorting option, column ', d.attribute, ' is unsortable.');\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.clearSort();\r\n\t\t\tarray.forEach(inIndex, function(d, i){\r\n\t\t\t\tcell = this.grid.getCellByField(d.attribute);\r\n\t\t\t\tthis.setSortData(cell.index, 'index', i);\r\n\t\t\t\tthis.setSortData(cell.index, 'order', d.descending ? 'desc': 'asc');\r\n\t\t\t}, this);\r\n\t\t}else if(!isNaN(inIndex)){\r\n\t\t\tif(inAsc === undefined){ return; }//header click from base DataGrid\r\n\t\t\tthis.setSortData(inIndex, 'order', inAsc ? 'asc' : 'desc');\r\n\t\t}else{\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis._updateSortDef();\r\n\t\tif(!noRefresh){\r\n\t\t\tthis.grid.sort();\r\n\t\t}\r\n\t},\r\n\tgetSortProps: function(){\r\n\t\t// summary:\r\n\t\t//\t\tOverwritten, see DataGrid.getSortProps()\r\n\t\treturn this._sortDef.length ? this._sortDef : null;\r\n\t},\r\n\t_initSort: function(postSort){\r\n\t\t// summary:\r\n\t\t//\t\tInitiate sorting\r\n\t\tvar g = this.grid, n = g.domNode, len = this._sortDef.length;\r\n\t\thtml.toggleClass(n, 'dojoxGridSorted', !!len);\r\n\t\thtml.toggleClass(n, 'dojoxGridSingleSorted', len === 1);\r\n\t\thtml.toggleClass(n, 'dojoxGridNestSorted', len > 1);\r\n\t\tif(len > 0){\r\n\t\t\tthis._currMainSort = this._sortDef[0].descending ? 'desc' : 'asc';\r\n\t\t}\r\n\t\tvar idx, excluded = this._excludedCoIdx = [];//reset it\r\n\t\t//cache column index of hidden, un-sortable or indirect selection\r\n\t\tthis._headerNodes = query(\"th\", g.viewsHeaderNode).forEach(function(n){\r\n\t\t\tidx = parseInt(n.getAttribute('idx'), 10);\r\n\t\t\tif(html.style(n, 'display') === 'none' || g.layout.cells[idx]['nosort'] || (g.canSort && !g.canSort(idx, g.layout.cells[idx]['field']))){\r\n\t\t\t\texcluded.push(idx);\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis._headerNodes.forEach(this._initHeaderNode, this);\r\n\t\tthis._initFocus();\r\n\t\tif(postSort){\r\n\t\t\tthis._focusHeader();\r\n\t\t}\r\n\t},\r\n\t_initHeaderNode: function(node){\r\n\t\t// summary:\r\n\t\t//\t\tInitiate sort for each header cell node\r\n\t\thtml.toggleClass(node, 'dojoxGridSortNoWrap', true);\r\n\t\tvar sortNode = query('.dojoxGridSortNode', node)[0];\r\n\t\tif(sortNode){\r\n\t\t\thtml.toggleClass(sortNode, 'dojoxGridSortNoWrap', true);\r\n\t\t}\r\n\t\tif(array.indexOf(this._excludedCoIdx, node.getAttribute('idx')) >= 0){\r\n\t\t\thtml.addClass(node, 'dojoxGridNoSort');\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif(!query('.dojoxGridSortBtn', node).length){\r\n\t\t\t//clear any previous connects\r\n\t\t\tthis._connects = array.filter(this._connects, function(conn){\r\n\t\t\t\tif(conn._sort){\r\n\t\t\t\t\tconnect.disconnect(conn);\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t\treturn true;\r\n\t\t\t});\r\n\t\t\tvar n = html.create('a', {\r\n\t\t\t\tclassName: 'dojoxGridSortBtn dojoxGridSortBtnNested',\r\n\t\t\t\ttitle: string.substitute(this.nls.sortingState, [this.nls.nestedSort, this.nls.ascending]),\r\n\t\t\t\tinnerHTML: '1'\r\n\t\t\t}, node.firstChild, 'last');\r\n\t\t\tn.onmousedown = evt.stop;\r\n\t\t\tn = html.create('a', {\r\n\t\t\t\tclassName: 'dojoxGridSortBtn dojoxGridSortBtnSingle',\r\n\t\t\t\ttitle: string.substitute(this.nls.sortingState, [this.nls.singleSort, this.nls.ascending])\r\n\t\t\t}, node.firstChild, 'last');\r\n\t\t\tn.onmousedown = evt.stop;\r\n\t\t}else{\r\n\t\t\t//deal with small height grid which doesn't re-render the grid after refresh\r\n\t\t\tvar a1 = query('.dojoxGridSortBtnSingle', node)[0];\r\n\t\t\tvar a2 = query('.dojoxGridSortBtnNested', node)[0];\r\n\t\t\ta1.className = 'dojoxGridSortBtn dojoxGridSortBtnSingle';\r\n\t\t\ta2.className = 'dojoxGridSortBtn dojoxGridSortBtnNested';\r\n\t\t\ta2.innerHTML = '1';\r\n\t\t\thtml.removeClass(node, 'dojoxGridCellShowIndex');\r\n\t\t\thtml.removeClass(node.firstChild, 'dojoxGridSortNodeSorted');\r\n\t\t\thtml.removeClass(node.firstChild, 'dojoxGridSortNodeAsc');\r\n\t\t\thtml.removeClass(node.firstChild, 'dojoxGridSortNodeDesc');\r\n\t\t\thtml.removeClass(node.firstChild, 'dojoxGridSortNodeMain');\r\n\t\t\thtml.removeClass(node.firstChild, 'dojoxGridSortNodeSub');\r\n\t\t}\r\n\t\tthis._updateHeaderNodeUI(node);\r\n\t},\r\n\t_onHeaderCellClick: function(e){\r\n\t\t// summary:\r\n\t\t//\t\tSee dojox.grid.enhanced._Events._onHeaderCellClick()\r\n\t\tthis._focusRegion(e.target);\r\n\t\tif(html.hasClass(e.target, 'dojoxGridSortBtn')){\r\n\t\t\tthis._onSortBtnClick(e);\r\n\t\t\tevt.stop(e);\r\n\t\t\tthis._focusRegion(this._getCurrentRegion());\r\n\t\t}\r\n\t},\r\n\t_onHeaderCellMouseOver: function(e){\r\n\t\t// summary:\r\n\t\t//\t\tSee dojox.grid._Events._onHeaderCellMouseOver()\r\n\t\t//\t\tWhen user mouseover other columns than sorted column in a single sorted grid,\r\n\t\t//\t\tWe need to show 1 in the sorted column\r\n\t\tif(!e.cell){return; }\r\n\t\tif(this._sortDef.length > 1){ return; }\r\n\t\tif(this._sortData[e.cellIndex] && this._sortData[e.cellIndex].index === 0){ return; }\r\n\t\tvar p;\r\n\t\tfor(p in this._sortData){\r\n\t\t\tif(this._sortData[p] && this._sortData[p].index === 0){\r\n\t\t\t\thtml.addClass(this._headerNodes[p], 'dojoxGridCellShowIndex');\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(!html.hasClass(win.body(), 'dijit_a11y')){ return; }\r\n\t\t//a11y support\r\n\t\tvar i = e.cell.index, node = e.cellNode;\r\n\t\tvar singleSortBtn = query('.dojoxGridSortBtnSingle', node)[0];\r\n\t\tvar nestedSortBtn = query('.dojoxGridSortBtnNested', node)[0];\r\n\t\t\r\n\t\tvar sortMode = 'none';\r\n\t\tif(html.hasClass(this.grid.domNode, 'dojoxGridSingleSorted')){\r\n\t\t\tsortMode = 'single';\r\n\t\t}else if(html.hasClass(this.grid.domNode, 'dojoxGridNestSorted')){\r\n\t\t\tsortMode = 'nested';\r\n\t\t}\r\n\t\tvar nestedIndex = nestedSortBtn.getAttribute('orderIndex');\r\n\t\tif(nestedIndex === null || nestedIndex === undefined){\r\n\t\t\tnestedSortBtn.setAttribute('orderIndex', nestedSortBtn.innerHTML);\r\n\t\t\tnestedIndex = nestedSortBtn.innerHTML;\r\n\t\t}\r\n\t\tif(this.isAsc(i)){\r\n\t\t\tnestedSortBtn.innerHTML = nestedIndex + this._a11yText.dojoxGridDescending;\r\n\t\t}else if(this.isDesc(i)){\r\n\t\t\tnestedSortBtn.innerHTML = nestedIndex + this._a11yText.dojoxGridUnsortedTip;\r\n\t\t}else{\r\n\t\t\tnestedSortBtn.innerHTML = nestedIndex + this._a11yText.dojoxGridAscending;\r\n\t\t}\r\n\t\tif(this._currMainSort === 'none'){\r\n\t\t\tsingleSortBtn.innerHTML = this._a11yText.dojoxGridAscending;\r\n\t\t}else if(this._currMainSort === 'asc'){\r\n\t\t\tsingleSortBtn.innerHTML = this._a11yText.dojoxGridDescending;\r\n\t\t}else if(this._currMainSort === 'desc'){\r\n\t\t\tsingleSortBtn.innerHTML = this._a11yText.dojoxGridUnsortedTip;\r\n\t\t}\r\n\t},\r\n\t_onHeaderCellMouseOut: function(e){\r\n\t\t// summary:\r\n\t\t//\t\tSee dojox.grid.enhanced._Events._onHeaderCellMouseOut()\r\n\t\tvar p;\r\n\t\tfor(p in this._sortData){\r\n\t\t\tif(this._sortData[p] && this._sortData[p].index === 0){\r\n\t\t\t\thtml.removeClass(this._headerNodes[p], 'dojoxGridCellShowIndex');\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\t_onSortBtnClick: function(e){\r\n\t\t// summary:\r\n\t\t//\t\tIf the click target is single sort button, do single sort.\r\n\t\t//\t\tElse if the click target is nested sort button, do nest sort.\r\n\t\t//\t\tOtherwise return.\r\n\t\tvar cellIdx = e.cell.index;\r\n\t\tif(html.hasClass(e.target, 'dojoxGridSortBtnSingle')){\r\n\t\t\tthis._prepareSingleSort(cellIdx);\r\n\t\t}else if(html.hasClass(e.target, 'dojoxGridSortBtnNested')){\r\n\t\t\tthis._prepareNestedSort(cellIdx);\r\n\t\t}else{\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tevt.stop(e);\r\n\t\tthis._doSort(cellIdx);\r\n\t},\r\n\t_doSort: function(cellIdx){\r\n\t\tif(!this._sortData[cellIdx] || !this._sortData[cellIdx].order){\r\n\t\t\tthis.setSortData(cellIdx, 'order', 'asc');\t//no sorting data\r\n\t\t}else if(this.isAsc(cellIdx)){\r\n\t\t\tthis.setSortData(cellIdx, 'order', 'desc');\t//change to 'desc'\r\n\t\t}else if(this.isDesc(cellIdx)){\r\n\t\t\tthis.removeSortData(cellIdx); //remove from sorting sequence\r\n\t\t}\r\n\t\tthis._updateSortDef();\r\n\t\tthis.grid.sort();\r\n\t\tthis._initSort(true);\r\n\t},\r\n\tsetSortData: function(cellIdx, attr, value){\r\n\t\t// summary:\r\n\t\t//\t\tSet sorting data for a column.\r\n\t\tvar sd = this._sortData[cellIdx];\r\n\t\tif(!sd){\r\n\t\t\tsd = this._sortData[cellIdx] = {};\r\n\t\t}\r\n\t\tsd[attr] = value;\r\n\t},\r\n\tremoveSortData: function(cellIdx){\r\n\t\tvar d = this._sortData, i = d[cellIdx].index, p;\r\n\t\tdelete d[cellIdx];\r\n\t\tfor(p in d){\r\n\t\t\tif(d[p].index > i){\r\n\t\t\t\td[p].index--;\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\t_prepareSingleSort: function(cellIdx){\r\n\t\t// summary:\r\n\t\t//\t\tPrepare the single sort, also called main sort, this will clear any existing sorting and just sort the grid by current column.\r\n\t\tvar d = this._sortData, p;\r\n\t\tfor(p in d){\r\n\t\t\tdelete d[p];\r\n\t\t}\r\n\t\tthis.setSortData(cellIdx, 'index', 0);\r\n\t\tthis.setSortData(cellIdx, 'order', this._currMainSort === 'none' ? null : this._currMainSort);\r\n\t\tif(!this._sortData[cellIdx] || !this._sortData[cellIdx].order){\r\n\t\t\tthis._currMainSort = 'asc';\r\n\t\t}else if(this.isAsc(cellIdx)){\r\n\t\t\tthis._currMainSort = 'desc';\r\n\t\t}else if(this.isDesc(cellIdx)){\r\n\t\t\tthis._currMainSort = 'none';\r\n\t\t}\r\n\t},\r\n\t_prepareNestedSort: function(cellIdx){\r\n\t\t// summary:\r\n\t\t//\t\tPrepare the nested sorting, this will order the column on existing sorting result.\r\n\t\tvar i = this._sortData[cellIdx] ? this._sortData[cellIdx].index : null;\r\n\t\tif(i === 0 || !!i){ return; }\r\n\t\tthis.setSortData(cellIdx, 'index', this._sortDef.length);\r\n\t},\r\n\t_updateSortDef: function(){\r\n\t\tthis._sortDef.length = 0;\r\n\t\tvar d = this._sortData, p;\r\n\t\tfor(p in d){\r\n\t\t\tthis._sortDef[d[p].index] = {\r\n\t\t\t\tattribute: this.grid.layout.cells[p].field,\r\n\t\t\t\tdescending: d[p].order === 'desc'\r\n\t\t\t};\r\n\t\t}\r\n\t},\r\n\t_updateHeaderNodeUI: function(node){\r\n\t\t// summary:\r\n\t\t//\t\tUpdate the column header UI based on current sorting state.\r\n\t\t//\t\tShow indicator of the sorting order of the column, no order no indicator\r\n\t\tvar cell = this._getCellByNode(node);\r\n\t\tvar cellIdx = cell.index;\r\n\t\tvar data = this._sortData[cellIdx];\r\n\t\tvar sortNode = query('.dojoxGridSortNode', node)[0];\r\n\t\tvar singleSortBtn = query('.dojoxGridSortBtnSingle', node)[0];\r\n\t\tvar nestedSortBtn = query('.dojoxGridSortBtnNested', node)[0];\r\n\t\t\r\n\t\thtml.toggleClass(singleSortBtn, 'dojoxGridSortBtnAsc', this._currMainSort === 'asc');\r\n\t\thtml.toggleClass(singleSortBtn, 'dojoxGridSortBtnDesc', this._currMainSort === 'desc');\r\n\t\tif(this._currMainSort === 'asc'){\r\n\t\t\tsingleSortBtn.title = string.substitute(this.nls.sortingState, [this.nls.singleSort, this.nls.descending]);\r\n\t\t}else if(this._currMainSort === 'desc'){\r\n\t\t\tsingleSortBtn.title = string.substitute(this.nls.sortingState, [this.nls.singleSort, this.nls.unsorted]);\r\n\t\t}else{\r\n\t\t\tsingleSortBtn.title = string.substitute(this.nls.sortingState, [this.nls.singleSort, this.nls.ascending]);\r\n\t\t}\r\n\t\t\r\n\t\tvar _this = this;\r\n\t\tfunction setWaiState(){\r\n\t\t\tvar columnInfo = 'Column ' + (cell.index + 1) + ' ' + cell.field;\r\n\t\t\tvar orderState = 'none';\r\n\t\t\tvar orderAction = 'ascending';\r\n\t\t\tif(data){\r\n\t\t\t\torderState = data.order === 'asc' ? 'ascending' : 'descending';\r\n\t\t\t\torderAction = data.order === 'asc' ? 'descending' : 'none';\r\n\t\t\t}\r\n\t\t\tvar a11ySingleLabel = columnInfo + ' - is sorted by ' + orderState;\r\n\t\t\tvar a11yNestedLabel = columnInfo + ' - is nested sorted by ' + orderState;\r\n\t\t\tvar a11ySingleLabelHover = columnInfo + ' - choose to sort by ' + orderAction;\r\n\t\t\tvar a11yNestedLabelHover = columnInfo + ' - choose to nested sort by ' + orderAction;\r\n\t\t\t\r\n\t\t\tsingleSortBtn.setAttribute(\"aria-label\", a11ySingleLabel);\r\n\t\t\tnestedSortBtn.setAttribute(\"aria-label\", a11yNestedLabel);\r\n\t\t\t\r\n\t\t\tvar handles = [\r\n\t\t\t\t_this.connect(singleSortBtn, \"onmouseover\", function(){\r\n\t\t\t\t\tsingleSortBtn.setAttribute(\"aria-label\", a11ySingleLabelHover);\r\n\t\t\t\t}),\r\n\t\t\t\t_this.connect(singleSortBtn, \"onmouseout\", function(){\r\n\t\t\t\t\tsingleSortBtn.setAttribute(\"aria-label\", a11ySingleLabel);\r\n\t\t\t\t}),\r\n\t\t\t\t_this.connect(nestedSortBtn, \"onmouseover\", function(){\r\n\t\t\t\t\tnestedSortBtn.setAttribute(\"aria-label\", a11yNestedLabelHover);\r\n\t\t\t\t}),\r\n\t\t\t\t_this.connect(nestedSortBtn, \"onmouseout\", function(){\r\n\t\t\t\t\tnestedSortBtn.setAttribute(\"aria-label\", a11yNestedLabel);\r\n\t\t\t\t})\r\n\t\t\t];\r\n\t\t\tarray.forEach(handles, function(handle){ handle._sort = true; });\r\n\t\t}\r\n\t\tsetWaiState();\r\n\r\n\t\tvar a11y = html.hasClass(win.body(), \"dijit_a11y\");\r\n\t\tif(!data){\r\n\t\t\tnestedSortBtn.innerHTML = this._sortDef.length + 1;\r\n\t\t\tnestedSortBtn.title = string.substitute(this.nls.sortingState, [this.nls.nestedSort, this.nls.ascending]);\r\n\t\t\tif(a11y){sortNode.innerHTML = this._a11yText.dojoxGridUnsortedTip;}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif(data.index || (data.index === 0 && this._sortDef.length > 1)){\r\n\t\t\tnestedSortBtn.innerHTML = data.index + 1;\r\n\t\t}\r\n\t\thtml.addClass(sortNode, 'dojoxGridSortNodeSorted');\r\n\t\tif(this.isAsc(cellIdx)){\r\n\t\t\thtml.addClass(sortNode, 'dojoxGridSortNodeAsc');\r\n\t\t\tnestedSortBtn.title = string.substitute(this.nls.sortingState, [this.nls.nestedSort, this.nls.descending]);\r\n\t\t\tif(a11y){sortNode.innerHTML = this._a11yText.dojoxGridAscendingTip;}\r\n\t\t}else if(this.isDesc(cellIdx)){\r\n\t\t\thtml.addClass(sortNode, 'dojoxGridSortNodeDesc');\r\n\t\t\tnestedSortBtn.title = string.substitute(this.nls.sortingState, [this.nls.nestedSort, this.nls.unsorted]);\r\n\t\t\tif(a11y){sortNode.innerHTML = this._a11yText.dojoxGridDescendingTip;}\r\n\t\t}\r\n\t\thtml.addClass(sortNode, (data.index === 0 ? 'dojoxGridSortNodeMain' : 'dojoxGridSortNodeSub'));\r\n\t},\r\n\tisAsc: function(cellIndex){\r\n\t\treturn this._sortData[cellIndex].order === 'asc';\r\n\t},\r\n\tisDesc: function(cellIndex){\r\n\t\treturn this._sortData[cellIndex].order === 'desc';\r\n\t},\r\n\t_getCellByNode: function(node){\r\n\t\tvar i;\r\n\t\tfor(i = 0; i < this._headerNodes.length; i++){\r\n\t\t\tif(this._headerNodes[i] === node){\r\n\t\t\t\treturn this.grid.layout.cells[i];\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn null;\r\n\t},\r\n\tclearSort: function(){\r\n\t\tthis._sortData = {};\r\n\t\tthis._sortDef.length = 0;\r\n\t},\r\n\t\r\n\t//persistence\r\n\tinitCookieHandler: function(){\r\n\t\tif(this.grid.addCookieHandler){\r\n\t\t\tthis.grid.addCookieHandler({\r\n\t\t\t\tname: \"sortOrder\",\r\n\t\t\t\tonLoad: lang.hitch(this, '_loadNestedSortingProps'),\r\n\t\t\t\tonSave: lang.hitch(this, '_saveNestedSortingProps')\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n\t_loadNestedSortingProps: function(sortInfo, grid){\r\n\t\tthis._setGridSortIndex(sortInfo);\r\n\t},\r\n\t_saveNestedSortingProps: function(grid){\r\n\t\treturn this.getSortProps();\r\n\t},\r\n\t\r\n\t//focus & keyboard\r\n\t_initFocus: function(){\r\n\t\tvar f = this.focus = this.grid.focus;\r\n\t\tthis._focusRegions = this._getRegions();\r\n\t\tif(!this._headerArea){\r\n\t\t\tvar area = this._headerArea = f.getArea('header');\r\n\t\t\tarea.onFocus = f.focusHeader = lang.hitch(this, '_focusHeader');\r\n\t\t\tarea.onBlur = f.blurHeader = f._blurHeader = lang.hitch(this, '_blurHeader');\r\n\t\t\tarea.onMove = lang.hitch(this, '_onMove');\r\n\t\t\tarea.onKeyDown = lang.hitch(this, '_onKeyDown');\r\n\t\t\tarea._regions = [];\r\n\t\t\tarea.getRegions = null;\r\n\t\t\tthis.connect(this.grid, 'onBlur', '_blurHeader');\r\n\t\t}\r\n\t},\r\n\t_focusHeader: function(e){\r\n\t\t// summary:\r\n\t\t//\t\tOverwritten, see _FocusManager.focusHeader()\r\n\t\t// delayed: Boolean\r\n\t\t//\t\tIf called from \"this.focus._delayedHeaderFocus()\"\r\n\t\tif(this._currRegionIdx === -1){\r\n\t\t\tthis._onMove(0, 1, null);\r\n\t\t}else{\r\n\t\t\tvar region = this._getCurrentRegion();\r\n\t\t\tthis._focusRegion(region);\r\n\t\t\t//keep grid body scrolled by header\r\n\t\t\tvar view = this._getRegionView(region);\r\n\t\t\tview.scrollboxNode.scrollLeft = view.headerNode.scrollLeft;\r\n\t\t}\r\n\t\ttry{\r\n\t\t\tif(e){\r\n\t\t\t\tevt.stop(e);\r\n\t\t\t}\r\n\t\t}catch(e){}\r\n\t\treturn true;\r\n\t},\r\n\t_blurHeader: function(e){\r\n\t\tthis._blurRegion(this._getCurrentRegion());\r\n\t\treturn true;\r\n\t},\r\n\t_onMove: function(rowStep, colStep, e){\r\n\t\tvar curr = this._currRegionIdx || 0, regions = this._focusRegions;\r\n\t\tvar region = regions[curr + colStep];\r\n\t\tif(!region){\r\n\t\t\treturn;\r\n\t\t}else if(html.style(region, 'display') === 'none' || html.style(region, 'visibility') === 'hidden'){\r\n\t\t\t//if the region is invisible, keep finding next\r\n\t\t\tthis._onMove(rowStep, colStep + (colStep > 0 ? 1 : -1), e);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis._focusRegion(region);\r\n\t\t//keep grid body scrolled by header\r\n\t\tvar view = this._getRegionView(region);\r\n\t\tview.scrollboxNode.scrollLeft = view.headerNode.scrollLeft;\r\n\t},\r\n\t_onKeyDown: function(e, isBubble){\r\n\t\tif(isBubble){\r\n\t\t\tswitch(e.keyCode){\r\n\t\t\t\tcase keys.ENTER:\r\n\t\t\t\tcase keys.SPACE:\r\n\t\t\t\t\tif(html.hasClass(e.target, 'dojoxGridSortBtnSingle') ||\r\n\t\t\t\t\t\thtml.hasClass(e.target, 'dojoxGridSortBtnNested')){\r\n\t\t\t\t\t\tthis._onSortBtnClick(e);\r\n\t\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\t_getRegionView: function(region){\r\n\t\tvar header = region;\r\n\t\twhile(header && !html.hasClass(header, 'dojoxGridHeader')){ header = header.parentNode; }\r\n\t\tif(header){\r\n\t\t\treturn array.filter(this.grid.views.views, function(view){\r\n\t\t\t\treturn view.headerNode === header;\r\n\t\t\t})[0] || null;\r\n\t\t}\r\n\t\treturn null;\r\n\t},\r\n\t_getRegions: function(){\r\n\t\tvar regions = [], cells = this.grid.layout.cells;\r\n\t\tthis._headerNodes.forEach(function(n, i){\r\n\t\t\tif(html.style(n, 'display') === 'none'){return;}\r\n\t\t\tif(cells[i]['isRowSelector']){\r\n\t\t\t\tregions.push(n);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tquery('.dojoxGridSortNode,.dojoxGridSortBtnNested,.dojoxGridSortBtnSingle', n).forEach(function(node){\r\n\t\t\t\t\tnode.setAttribute('tabindex', 0);\r\n\t\t\t\t\tregions.push(node);\r\n\t\t\t});\r\n\t\t},this);\r\n\t\treturn regions;\r\n\t},\r\n\t_focusRegion: function(region){\r\n\t\t// summary:\r\n\t\t//\t\tFocus the given region\r\n\t\tif(!region){return;}\r\n\t\tvar currRegion = this._getCurrentRegion();\r\n\t\tif(currRegion && region !== currRegion){\r\n\t\t\tthis._blurRegion(currRegion);\r\n\t\t}\r\n\t\tvar header = this._getRegionHeader(region);\r\n\t\thtml.addClass(header, 'dojoxGridCellSortFocus');\r\n\t\tif(html.hasClass(region, 'dojoxGridSortNode')){\r\n\t\t\thtml.addClass(region, 'dojoxGridSortNodeFocus');\r\n\t\t}else if(html.hasClass(region, 'dojoxGridSortBtn')){\r\n\t\t\thtml.addClass(region, 'dojoxGridSortBtnFocus');\r\n\t\t}\r\n\t\t//For invisible nodes, IE will throw error when calling focus().\r\n\t\ttry{\r\n\t\t\tregion.focus();\r\n\t\t}catch(e){}\r\n\t\tthis.focus.currentArea('header');\r\n\t\tthis._currRegionIdx = array.indexOf(this._focusRegions, region);\r\n\t},\r\n\t_blurRegion: function(region){\r\n\t\tif(!region){return;}\r\n\t\tvar header = this._getRegionHeader(region);\r\n\t\thtml.removeClass(header, 'dojoxGridCellSortFocus');\r\n\t\tif(html.hasClass(region, 'dojoxGridSortNode')){\r\n\t\t\thtml.removeClass(region, 'dojoxGridSortNodeFocus');\r\n\t\t}else if(html.hasClass(region, 'dojoxGridSortBtn')){\r\n\t\t\thtml.removeClass(region, 'dojoxGridSortBtnFocus');\r\n\t\t}\r\n\t\tregion.blur();\r\n\t},\r\n\t_getCurrentRegion: function(){\r\n\t\treturn this._focusRegions ? this._focusRegions[this._currRegionIdx] : null;\r\n\t},\r\n\t_getRegionHeader: function(region){\r\n\t\twhile(region && !html.hasClass(region, 'dojoxGridCell')){\r\n\t\t\tregion = region.parentNode;\r\n\t\t}\r\n\t\treturn region;\r\n\t},\r\n\tdestroy: function(){\r\n\t\tthis._sortDef = this._sortData = null;\r\n\t\tthis._headerNodes = this._focusRegions = null;\r\n\t\tthis.inherited(arguments);\r\n\t}\r\n});\r\n\r\nEnhancedGrid.registerPlugin(NestedSorting);\r\n\r\nreturn NestedSorting;\r\n});\r\n"]}