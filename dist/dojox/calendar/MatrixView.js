/**
 * dojox - A version of dojox.js framework that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/dojox/
 * @license MIT
 */
define(["dojo/_base/declare","dojo/_base/array","dojo/_base/event","dojo/_base/lang","dojo/_base/sniff","dojo/_base/fx","dojo/_base/html","dojo/on","dojo/dom","dojo/dom-class","dojo/dom-style","dojo/dom-geometry","dojo/dom-construct","dojo/query","dojox/html/metrics","dojo/i18n","./ViewBase","dojo/text!./templates/MatrixView.html","dijit/_TemplatedMixin"],function(e,t,i,n,r,a,o,s,d,l,h,u,c,p,m,f,g,_,R){return e("dojox.calendar.MatrixView",[g,R],{templateString:_,baseClass:"dojoxCalendarMatrixView",_setTabIndexAttr:"domNode",viewKind:"matrix",renderData:null,startDate:null,refStartTime:null,refEndTime:null,columnCount:7,rowCount:5,horizontalRenderer:null,labelRenderer:null,expandRenderer:null,horizontalDecorationRenderer:null,percentOverlap:0,verticalGap:2,horizontalRendererHeight:17,labelRendererHeight:14,expandRendererHeight:15,cellPaddingTop:16,expandDuration:300,expandEasing:null,layoutDuringResize:!1,roundToDay:!0,showCellLabel:!0,scrollable:!1,resizeCursor:"e-resize",constructor:function(){this.invalidatingProperties=["columnCount","rowCount","startDate","horizontalRenderer","horizontalDecaorationRenderer","labelRenderer","expandRenderer","rowHeaderDatePattern","columnHeaderLabelLength","cellHeaderShortPattern","cellHeaderLongPattern","percentOverlap","verticalGap","horizontalRendererHeight","labelRendererHeight","expandRendererHeight","cellPaddingTop","roundToDay","itemToRendererKindFunc","layoutPriorityFunction","formatItemTimeFunc","textDir","items"],this._ddRendererList=[],this._ddRendererPool=[],this._rowHeaderHandles=[]},destroy:function(e){this._cleanupRowHeader(),this.inherited(arguments)},postCreate:function(){this.inherited(arguments),this._initialized=!0,this.invalidRendering||this.refreshRendering()},_createRenderData:function(){var e={};e.dateLocaleModule=this.dateLocaleModule,e.dateClassObj=this.dateClassObj,e.dateModule=this.dateModule,e.dates=[],e.columnCount=this.get("columnCount"),e.rowCount=this.get("rowCount"),e.sheetHeight=this.itemContainer.offsetHeight,this._computeRowsHeight(e);var t=this.get("startDate");null==t&&(t=new e.dateClassObj),t=this.floorToDay(t,!1,e),this.startDate=t;for(var i=0;i<e.rowCount;i++){e.dates.push([]);for(var n=0;n<e.columnCount;n++)e.dates[i].push(t),t=this.addAndFloor(t,"day",1)}return e.startTime=this.newDate(e.dates[0][0],e),e.endTime=this.newDate(e.dates[e.rowCount-1][e.columnCount-1],e),e.endTime=e.dateModule.add(e.endTime,"day",1),e.endTime=this.floorToDay(e.endTime,!0),this.displayedItemsInvalidated&&!this._isEditing?(this.displayedItemsInvalidated=!1,this._computeVisibleItems(e)):this.renderData&&(e.items=this.renderData.items),this.displayedDecorationItemsInvalidated?e.decorationItems=this.decorationStoreManager._computeVisibleItems(e):this.renderData&&(e.decorationItems=this.renderData.decorationItems),e.rtl=!this.isLeftToRight(),e},_validateProperties:function(){this.inherited(arguments),(this.columnCount<1||isNaN(this.columnCount))&&(this.columnCount=1),(this.rowCount<1||isNaN(this.rowCount))&&(this.rowCount=1),(isNaN(this.percentOverlap)||this.percentOverlap<0||this.percentOverlap>100)&&(this.percentOverlap=0),(isNaN(this.verticalGap)||this.verticalGap<0)&&(this.verticalGap=2),(isNaN(this.horizontalRendererHeight)||this.horizontalRendererHeight<1)&&(this.horizontalRendererHeight=17),(isNaN(this.labelRendererHeight)||this.labelRendererHeight<1)&&(this.labelRendererHeight=14),(isNaN(this.expandRendererHeight)||this.expandRendererHeight<1)&&(this.expandRendererHeight=15)},_setStartDateAttr:function(e){this.displayedItemsInvalidated=!0,this._set("startDate",e)},_setColumnCountAttr:function(e){this.displayedItemsInvalidated=!0,this._set("columnCount",e)},_setRowCountAttr:function(e){this.displayedItemsInvalidated=!0,this._set("rowCount",e)},__fixEvt:function(e){return e.sheet="primary",e.source=this,e},_formatRowHeaderLabel:function(e){return this.rowHeaderDatePattern?this.renderData.dateLocaleModule.format(e,{selector:"date",datePattern:this.rowHeaderDatePattern}):this.getWeekNumberLabel(e)},_formatColumnHeaderLabel:function(e){return this.renderData.dateLocaleModule.getNames("days",this.columnHeaderLabelLength?this.columnHeaderLabelLength:"wide","standAlone")[e.getDay()]},cellHeaderShortPattern:null,cellHeaderLongPattern:null,_formatGridCellLabel:function(e,t,i){var n;return n=0==t&&0==i||1==e.getDate()?this.cellHeaderLongPattern?this.cellHeaderLongPattern:f.getLocalization("dojo.cldr",this._calendar)["dateFormatItem-MMMd"]:this.cellHeaderShortPattern?this.cellHeaderShortPattern:f.getLocalization("dojo.cldr",this._calendar)["dateFormatItem-d"],this.renderData.dateLocaleModule.format(e,{selector:"date",datePattern:n})},refreshRendering:function(){if(this.inherited(arguments),this.domNode){this._validateProperties();var e=this.renderData,t=this.renderData=this._createRenderData();this._createRendering(t,e),this._layoutDecorationRenderers(t),this._layoutRenderers(t)}},_createRendering:function(e,t){if(e.rowHeight<=0)return e.columnCount=1,e.rowCount=1,void(e.invalidRowHeight=!0);if(t&&this.itemContainerTable){var i=p(".dojoxCalendarItemContainerRow",this.itemContainerTable);t.rowCount=i.length}this._buildColumnHeader(e,t),this._buildRowHeader(e,t),this._buildGrid(e,t),this._buildItemContainer(e,t),this.buttonContainer&&null!=this.owner&&this.owner.currentView==this&&h.set(this.buttonContainer,{right:0,left:0})},_buildColumnHeader:function(e,t){var i=this.columnHeaderTable;if(i){var a=e.columnCount-(t?t.columnCount:0);8==r("ie")&&(null==this._colTableSave?this._colTableSave=n.clone(i):a<0&&(this.columnHeader.removeChild(i),c.destroy(i),i=n.clone(this._colTableSave),this.columnHeaderTable=i,this.columnHeader.appendChild(i),a=e.columnCount));var s,d,h=p("tbody",i),u=p("tr",i);if(s=1==h.length?h[0]:o.create("tbody",null,i),d=1==u.length?u[0]:c.create("tr",null,s),a>0)for(var m=0;m<a;m++)c.create("td",null,d);else{a=-a;for(m=0;m<a;m++)d.removeChild(d.lastChild)}if(p("td",i).forEach(function(t,i){t.className="";var n=e.dates[0][i];this._setText(t,this._formatColumnHeaderLabel(n)),0==i?l.add(t,"first-child"):i==this.renderData.columnCount-1&&l.add(t,"last-child"),this.styleColumnHeaderCell(t,n,e)},this),this.yearColumnHeaderContent){var f=e.dates[0][0];this._setText(this.yearColumnHeaderContent,e.dateLocaleModule.format(f,{selector:"date",datePattern:"yyyy"}))}}},styleColumnHeaderCell:function(e,t,i){l.add(e,this._cssDays[t.getDay()]),this.isWeekEnd(t)&&l.add(e,"dojoxCalendarWeekend")},_rowHeaderHandles:null,_cleanupRowHeader:function(){for(;this._rowHeaderHandles.length>0;)for(var e=this._rowHeaderHandles.pop();e.length>0;)e.pop().remove()},_rowHeaderClick:function(e){var t=p("td",this.rowHeaderTable).indexOf(e.currentTarget);this._onRowHeaderClick({index:t,date:this.renderData.dates[t][0],triggerEvent:e})},_buildRowHeader:function(e,t){var i=this.rowHeaderTable;if(i){var a,o,d,u=p("tbody",i);a=1==u.length?u[0]:c.create("tbody",null,i);var m=e.rowCount-(t?t.rowCount:0);if(m>0)for(var f=0;f<m;f++){o=c.create("tr",null,a),d=c.create("td",null,o);var g=[];g.push(s(d,"click",n.hitch(this,this._rowHeaderClick))),r("touch")||(g.push(s(d,"mousedown",function(e){l.add(e.currentTarget,"Active")})),g.push(s(d,"mouseup",function(e){l.remove(e.currentTarget,"Active")})),g.push(s(d,"mouseover",function(e){l.add(e.currentTarget,"Hover")})),g.push(s(d,"mouseout",function(e){l.remove(e.currentTarget,"Hover")}))),this._rowHeaderHandles.push(g)}else{m=-m;for(f=0;f<m;f++){a.removeChild(a.lastChild);for(var _=this._rowHeaderHandles.pop();_.length>0;)_.pop().remove()}}p("tr",i).forEach(function(t,i){h.set(t,"height",this._getRowHeight(i)+"px");var n=e.dates[i][0],r=p("td",t)[0];r.className="",0==i&&l.add(r,"first-child"),i==this.renderData.rowCount-1&&l.add(r,"last-child"),this.styleRowHeaderCell(r,n,e),this._setText(r,this._formatRowHeaderLabel(n))},this)}},styleRowHeaderCell:function(e,t,i){},_buildGrid:function(e,t){var i=this.gridTable;if(i){var a=p("tr",i),o=e.rowCount-a.length,s=o>0,d=e.columnCount-(a?p("td",a[0]).length:0);8==r("ie")&&(null==this._gridTableSave?this._gridTableSave=n.clone(i):d<0&&(this.grid.removeChild(i),c.destroy(i),i=n.clone(this._gridTableSave),this.gridTable=i,this.grid.appendChild(i),d=e.columnCount,o=e.rowCount,s=!0));var u,m=p("tbody",i);if(u=1==m.length?m[0]:c.create("tbody",null,i),s)for(var f=0;f<o;f++)c.create("tr",null,u);else{o=-o;for(f=0;f<o;f++)u.removeChild(u.lastChild)}var g=e.rowCount-o,_=s||d>0;d=_?d:-d,p("tr",i).forEach(function(t,i){if(_){var n=i>=g?e.columnCount:d;for(i=0;i<n;i++){var r=c.create("td",null,t);c.create("span",null,r)}}else for(i=0;i<d;i++)t.removeChild(t.lastChild)}),p("tr",i).forEach(function(t,i){h.set(t,"height",this._getRowHeight(i)+"px"),t.className="",0==i&&l.add(t,"first-child"),i==e.rowCount-1&&l.add(t,"last-child"),p("td",t).forEach(function(t,n){t.className="",0==n&&l.add(t,"first-child"),n==e.columnCount-1&&l.add(t,"last-child");var r=e.dates[i][n],a=p("span",t)[0];this._setText(a,this.showCellLabel?this._formatGridCellLabel(r,i,n):null),this.styleGridCell(t,r,e)},this)},this)}},styleGridCellFunc:null,defaultStyleGridCell:function(e,t,i){l.add(e,this._cssDays[t.getDay()]);var n=this.dateModule;this.isToday(t)?l.add(e,"dojoxCalendarToday"):null!=this.refStartTime&&null!=this.refEndTime&&(n.compare(t,this.refEndTime)>=0||n.compare(n.add(t,"day",1),this.refStartTime)<=0)?l.add(e,"dojoxCalendarDayDisabled"):this.isWeekEnd(t)&&l.add(e,"dojoxCalendarWeekend")},styleGridCell:function(e,t,i){this.styleGridCellFunc?this.styleGridCellFunc(e,t,i):this.defaultStyleGridCell(e,t,i)},_buildItemContainer:function(e,t){var i=this.itemContainerTable;if(i){var a=[],o=e.rowCount-(t?t.rowCount:0);8==r("ie")&&(null==this._itemTableSave?this._itemTableSave=n.clone(i):o<0&&(this.itemContainer.removeChild(i),this._recycleItemRenderers(!0),this._recycleExpandRenderers(!0),c.destroy(i),i=n.clone(this._itemTableSave),this.itemContainerTable=i,this.itemContainer.appendChild(i),o=e.columnCount));var s,d,u,m,f=p("tbody",i);if(s=1==f.length?f[0]:c.create("tbody",null,i),o>0)for(var g=0;g<o;g++)d=c.create("tr",null,s),l.add(d,"dojoxCalendarItemContainerRow"),u=c.create("td",null,d),m=c.create("div",null,u),l.add(m,"dojoxCalendarContainerRow");else{o=-o;for(g=0;g<o;g++)s.removeChild(s.lastChild)}p(".dojoxCalendarItemContainerRow",i).forEach(function(e,t){h.set(e,"height",this._getRowHeight(t)+"px"),a.push(e.childNodes[0].childNodes[0])},this),e.cells=a}},resize:function(e){this.inherited(arguments),this._resizeHandler(null,!1)},_resizeHandler:function(e,t){var i=this.renderData;if(null!=i){if(i.sheetHeight!=this.itemContainer.offsetHeight)if(i.sheetHeight=this.itemContainer.offsetHeight,-1==this.getExpandedRowIndex()?(this._computeRowsHeight(),this._resizeRows()):this.expandRow(i.expandedRow,i.expandedRowCol,0,null,!0),i.invalidRowHeight)return delete i.invalidRowHeight,this.renderData=null,this.displayedItemsInvalidated=!0,void this.refreshRendering();this.layoutDuringResize||t?setTimeout(n.hitch(this,function(){this._layoutRenderers(this.renderData),this._layoutDecorationRenderers(this.renderData)}),20):(h.set(this.itemContainer,"opacity",0),this._recycleItemRenderers(),this._recycleExpandRenderers(),void 0!=this._resizeTimer&&clearTimeout(this._resizeTimer),this._resizeTimer=setTimeout(n.hitch(this,function(){delete this._resizeTimer,this._resizeRowsImpl(this.itemContainer,"tr"),this._layoutRenderers(this.renderData),this._layoutDecorationRenderers(this.renderData),0==this.resizeAnimationDuration?h.set(this.itemContainer,"opacity",1):a.fadeIn({node:this.itemContainer,curve:[0,1]}).play(this.resizeAnimationDuration)}),200))}else this.refreshRendering()},resizeAnimationDuration:0,getExpandedRowIndex:function(){return null==this.renderData.expandedRow?-1:this.renderData.expandedRow},collapseRow:function(e,t,i){var r=this.renderData;if(void 0==i&&(i=!0),void 0==e&&(e=this.expandDuration),r&&null!=r.expandedRow&&-1!=r.expandedRow)if(i&&e){var o=r.expandedRow,s=r.expandedRowHeight;delete r.expandedRow,this._computeRowsHeight(r);var d=this._getRowHeight(o);r.expandedRow=o,this._recycleExpandRenderers(),this._recycleItemRenderers(),h.set(this.itemContainer,"display","none"),this._expandAnimation=new a.Animation({curve:[s,d],duration:e,easing:t,onAnimate:n.hitch(this,function(e){this._expandRowImpl(Math.floor(e))}),onEnd:n.hitch(this,function(e){this._expandAnimation=null,this._collapseRowImpl(!1),this._resizeRows(),h.set(this.itemContainer,"display","block"),setTimeout(n.hitch(this,function(){this._layoutRenderers(r)}),100),this.onExpandAnimationEnd(!1)})}),this._expandAnimation.play()}else this._collapseRowImpl(i)},_collapseRowImpl:function(e){var t=this.renderData;delete t.expandedRow,delete t.expandedRowHeight,this._computeRowsHeight(t),(void 0==e||e)&&(this._resizeRows(),this._layoutRenderers(t))},expandRow:function(e,t,i,r,o){var s=this.renderData;if(!s||e<0||e>=s.rowCount)return-1;(void 0==t||t<0||t>=s.columnCount)&&(t=-1),void 0==o&&(o=!0),void 0==i&&(i=this.expandDuration),void 0==r&&(r=this.expandEasing);var d=this._getRowHeight(e),l=s.sheetHeight-Math.ceil(this.cellPaddingTop*(s.rowCount-1));s.expandedRow=e,s.expandedRowCol=t,s.expandedRowHeight=l,o&&(i?(this._recycleExpandRenderers(),this._recycleItemRenderers(),h.set(this.itemContainer,"display","none"),this._expandAnimation=new a.Animation({curve:[d,l],duration:i,delay:50,easing:r,onAnimate:n.hitch(this,function(e){this._expandRowImpl(Math.floor(e))}),onEnd:n.hitch(this,function(){this._expandAnimation=null,h.set(this.itemContainer,"display","block"),setTimeout(n.hitch(this,function(){this._expandRowImpl(l,!0)}),100),this.onExpandAnimationEnd(!0)})}),this._expandAnimation.play()):this._expandRowImpl(l,!0))},_expandRowImpl:function(e,t){var i=this.renderData;i.expandedRowHeight=e,this._computeRowsHeight(i,i.sheetHeight-e),this._resizeRows(),t&&this._layoutRenderers(i)},onExpandAnimationEnd:function(e){},_resizeRows:function(){this._getRowHeight(0)<=0||(this.rowHeaderTable&&this._resizeRowsImpl(this.rowHeaderTable,"tr"),this.gridTable&&this._resizeRowsImpl(this.gridTable,"tr"),this.itemContainerTable&&this._resizeRowsImpl(this.itemContainerTable,"tr"))},_computeRowsHeight:function(e,t){var i=null==e?this.renderData:e;if(t=t||i.sheetHeight,t--,7==r("ie")&&(t-=i.rowCount),1==i.rowCount)return i.rowHeight=t,i.rowHeightFirst=t,void(i.rowHeightLast=t);var n,a,o,s,d=null==i.expandedRow?i.rowCount:i.rowCount-1,l=t/d,h=t-Math.floor(l)*d,u=Math.abs(t-Math.ceil(l)*d),c=1;h<u?(o=Math.floor(l),s=h):(c=-1,o=Math.ceil(l),s=u),a=(n=o+c*Math.floor(s/2))+c*(s%2),i.rowHeight=o,i.rowHeightFirst=n,i.rowHeightLast=a},_getRowHeight:function(e){var t=this.renderData;return e==t.expandedRow?t.expandedRowHeight:0==t.expandedRow&&1==e||0==e?t.rowHeightFirst:t.expandedRow==this.renderData.rowCount-1&&e==this.renderData.rowCount-2||e==this.renderData.rowCount-1?t.rowHeightLast:t.rowHeight},_resizeRowsImpl:function(e,t){dojo.query(t,e).forEach(function(e,t){h.set(e,"height",this._getRowHeight(t)+"px")},this)},_setHorizontalRendererAttr:function(e){this._destroyRenderersByKind("horizontal"),this._set("horizontalRenderer",e)},_setLabelRendererAttr:function(e){this._destroyRenderersByKind("label"),this._set("labelRenderer",e)},_destroyExpandRenderer:function(e){e.destroyRecursive&&e.destroyRecursive(),o.destroy(e.domNode)},_setExpandRendererAttr:function(e){for(;this._ddRendererList.length>0;)this._destroyExpandRenderer(this._ddRendererList.pop());var t=this._ddRendererPool;if(t)for(;t.length>0;)this._destroyExpandRenderer(t.pop());this._set("expandRenderer",e)},_ddRendererList:null,_ddRendererPool:null,_getExpandRenderer:function(e,t,i,n,r){if(null==this.expandRenderer)return null;var a=this._ddRendererPool.pop();return null==a&&(a=new this.expandRenderer),this._ddRendererList.push(a),a.set("owner",this),a.set("date",e),a.set("items",t),a.set("rowIndex",i),a.set("columnIndex",n),a.set("expanded",r),a},_recycleExpandRenderers:function(e){for(var t=0;t<this._ddRendererList.length;t++){var i=this._ddRendererList[t];i.set("Up",!1),i.set("Down",!1),e&&i.domNode.parentNode.removeChild(i.domNode),h.set(i.domNode,"display","none")}this._ddRendererPool=this._ddRendererPool.concat(this._ddRendererList),this._ddRendererList=[]},_defaultItemToRendererKindFunc:function(e){return Math.abs(this.renderData.dateModule.difference(e.startTime,e.endTime,"minute"))>=1440?"horizontal":"label"},naturalRowsHeight:null,_roundItemToDay:function(e){var t=e.startTime,i=e.endTime;return this.isStartOfDay(t)||(t=this.floorToDay(t,!1,this.renderData)),this.isStartOfDay(i)||(i=this.renderData.dateModule.add(i,"day",1),i=this.floorToDay(i,!0)),{startTime:t,endTime:i}},_sortItemsFunction:function(e,t){this.roundToDay&&(e=this._roundItemToDay(e),t=this._roundItemToDay(t));var i=this.dateModule.compare(e.startTime,t.startTime);return 0==i&&(i=-1*this.dateModule.compare(e.endTime,t.endTime)),i},_overlapLayoutPass3:function(e){for(var t=0,i=0,n=[],r=u.position(this.gridTable).x,a=0;a<this.renderData.columnCount;a++){var o=!1,s=u.position(this._getCellAt(0,a));i=(t=s.x-r)+s.w;for(var d=e.length-1;d>=0&&!o;d--)for(var l=0;l<e[d].length;l++){var h=e[d][l];if(o=h.start<i&&t<h.end){n[a]=d+1;break}}o||(n[a]=0)}return n},applyRendererZIndex:function(e,t,i,n,r,a){h.set(t.container,{zIndex:r||n?t.renderer.mobile?100:0:void 0==e.lane?1:e.lane+1})},_layoutDecorationRenderers:function(e){null==e||null==e.decorationItems||e.rowHeight<=0||(this.gridTable&&null==this._expandAnimation&&null!=this.horizontalDecorationRenderer?(this._layoutStep=e.columnCount,this.renderData.gridTablePosX=u.position(this.gridTable).x,this.inherited(arguments)):this.decorationRendererManager.recycleItemRenderers())},_layoutRenderers:function(e){null==e||null==e.items||e.rowHeight<=0||(!this.gridTable||null!=this._expandAnimation||null==this.horizontalRenderer&&null==this.labelRenderer?this._recycleItemRenderers():(this.renderData.gridTablePosX=u.position(this.gridTable).x,this._layoutStep=e.columnCount,this._recycleExpandRenderers(),this._hiddenItems=[],this._offsets=[],this.naturalRowsHeight=[],this.inherited(arguments)))},_offsets:null,_layoutInterval:function(e,t,i,n,r,a){if(null!=this.renderData.cells)if("dataItems"===a){for(var o=[],s=[],d=0;d<r.length;d++){var l=r[d],h=this._itemToRendererKind(l);"horizontal"==h?o.push(l):"label"==h&&s.push(l)}var u=this.getExpandedRowIndex();if(-1!=u&&u!=t)return;var c,p=[],m=null,f=[];if(o.length>0&&this.horizontalRenderer){m=this._createHorizontalLayoutItems(t,i,n,o,a);var g=this._computeHorizontalOverlapLayout(m,f)}var _=[];s.length>0&&this.labelRenderer&&(c=this._createLabelLayoutItems(t,i,n,s),this._computeLabelOffsets(c,_));var R=this._computeColHasHiddenItems(t,f,_);null!=m&&this._layoutHorizontalItemsImpl(t,m,g,R,p,a),null!=c&&this._layoutLabelItemsImpl(t,c,R,p,f,a),this._layoutExpandRenderers(t,R,p),this._hiddenItems[t]=p}else{if(this.horizontalDecorationRenderer)null!=(m=this._createHorizontalLayoutItems(t,i,n,r,a))&&this._layoutHorizontalItemsImpl(t,m,null,!1,null,a)}},_createHorizontalLayoutItems:function(e,t,i,r,a){for(var o=this.renderData,s=o.dateModule,d=o.rtl?-1:1,l=[],h="decorationItems"===a,c=0;c<r.length;c++){var p=r[c],m=this.computeRangeOverlap(o,p.startTime,p.endTime,t,i),f=s.difference(t,this.floorToDay(m[0],!1,o),"day"),g=o.dates[e][f],_=u.position(this._getCellAt(e,f,!1)),R=_.x-o.gridTablePosX;o.rtl&&(R+=_.w),(h&&!p.isAllDay||!h&&!this.roundToDay&&!p.allDay)&&(R+=d*this.computeProjectionOnDate(o,g,m[0],_.w)),R=Math.ceil(R);var v,w=s.difference(t,this.floorToDay(m[1],!1,o),"day");if(w>o.columnCount-1?(_=u.position(this._getCellAt(e,o.columnCount-1,!1)),v=o.rtl?_.x-o.gridTablePosX:_.x-o.gridTablePosX+_.w):(g=o.dates[e][w],v=(_=u.position(this._getCellAt(e,w,!1))).x-o.gridTablePosX,o.rtl&&(v+=_.w),!h&&this.roundToDay?this.isStartOfDay(m[1])||(v+=d*_.w):v+=d*this.computeProjectionOnDate(o,g,m[1],_.w)),v=Math.floor(v),o.rtl){var C=v;v=R,R=C}if(v>R){var y=n.mixin({start:R,end:v,range:m,item:p,startOffset:f,endOffset:w},p);l.push(y)}}return l},_computeHorizontalOverlapLayout:function(e,t){for(var i=this.renderData,n=this.horizontalRendererHeight,r=this.computeOverlapping(e,this._overlapLayoutPass3),a=this.percentOverlap/100,o=0;o<i.columnCount;o++){var s=r.addedPassRes[o],d=i.rtl?i.columnCount-o-1:o;t[d]=0==a?0==s?0:1==s?n:n+(s-1)*(n+this.verticalGap):0==s?0:s*n-a*n*(s-1)+this.verticalGap,t[d]+=this.cellPaddingTop}return r},_createLabelLayoutItems:function(e,t,i,r){if(null!=this.labelRenderer){for(var a,o=this.renderData,s=o.dateModule,d=[],l=0;l<r.length;l++){var h=r[l];a=this.floorToDay(h.startTime,!1,o);for(var u=this.dateModule.compare;-1==u(a,h.endTime)&&-1==u(a,i);){var c=s.add(a,"day",1);c=this.floorToDay(c,!0);var p=this.computeRangeOverlap(o,h.startTime,h.endTime,a,c),m=s.difference(t,this.floorToDay(p[0],!1,o),"day");if(m>=this.columnCount)break;if(m>=0){var f=d[m];null==f&&(f=[],d[m]=f),f.push(n.mixin({startOffset:m,range:p,item:h},h))}a=s.add(a,"day",1),this.floorToDay(a,!0)}}return d}},_computeLabelOffsets:function(e,t){for(var i=0;i<this.renderData.columnCount;i++)t[i]=null==e[i]?0:e[i].length*(this.labelRendererHeight+this.verticalGap)},_computeColHasHiddenItems:function(e,t,i){for(var n,r=[],a=this._getRowHeight(e),o=0,s=0;s<this.renderData.columnCount;s++)n=null==t||null==t[s]?this.cellPaddingTop:t[s],(n+=null==i||null==i[s]?0:i[s])>o&&(o=n),r[s]=n>a;return this.naturalRowsHeight[e]=o,r},_layoutHorizontalItemsImpl:function(e,t,i,n,a,o){for(var s=this.renderData.cells[e],d=this._getRowHeight(e),l=this.horizontalRendererHeight,u=this.percentOverlap/100,p=0;p<t.length;p++){var m=t[p],f=m.lane;if("dataItems"===o){var g=this.cellPaddingTop;g+=0==u?f*(l+this.verticalGap):f*(l-u*l);var _=!1,R=d;if(this.expandRenderer){for(var v=m.startOffset;v<=m.endOffset;v++)if(n[v]){_=!0;break}R=_?d-this.expandRendererHeight:d}if(g+l<=R){var w=this._createRenderer(m,"horizontal",this.horizontalRenderer,"dojoxCalendarHorizontal"),C=this.isItemBeingEdited(m)&&!this.liveLayout&&this._isEditing,y=C?d-this.cellPaddingTop:l,x=m.end-m.start;r("ie")>=9&&m.start+x<this.itemContainer.offsetWidth&&x++,h.set(w.container,{top:(C?this.cellPaddingTop:g)+"px",left:m.start+"px",width:x+"px",height:y+"px"}),this._applyRendererLayout(m,w,s,x,y,"horizontal")}else for(var H=m.startOffset;H<m.endOffset;H++)null==a[H]?a[H]=[m.item]:a[H].push(m.item)}else{w=this.decorationRendererManager.createRenderer(m,"horizontal",this.horizontalDecorationRenderer,"dojoxCalendarDecoration"),y=d,x=m.end-m.start;r("ie")>=9&&m.start+x<this.itemContainer.offsetWidth&&x++,h.set(w.container,{top:"0",left:m.start+"px",width:x+"px",height:y+"px"}),c.place(w.container,s),h.set(w.container,"display","block")}}},_layoutLabelItemsImpl:function(e,t,i,r,a){for(var o,s,d=this.renderData,l=d.cells[e],c=this._getRowHeight(e),p=this.labelRendererHeight,m=u.getMarginBox(this.itemContainer).w,f=0;f<t.length;f++)if(null!=(o=t[f])){o.sort(n.hitch(this,function(e,t){return this.dateModule.compare(e.range[0],t.range[0])}));var g=this.expandRenderer&&i[f]?c-this.expandRendererHeight:c;s=null==a||null==a[f]?this.cellPaddingTop:a[f]+this.verticalGap;for(var _=u.position(this._getCellAt(e,f)),R=_.x-d.gridTablePosX,v=0;v<o.length&&s+p+this.verticalGap<=g;v++){var w=o[v];n.mixin(w,{start:R,end:R+_.w});var C=this._createRenderer(w,"label",this.labelRenderer,"dojoxCalendarLabel"),y=this.isItemBeingEdited(w)&&!this.liveLayout&&this._isEditing,x=y?this._getRowHeight(e)-this.cellPaddingTop:p;d.rtl&&(w.start=m-w.end,w.end=w.start+_.w),h.set(C.container,{top:(y?this.cellPaddingTop:s)+"px",left:w.start+"px",width:_.w+"px",height:x+"px"}),this._applyRendererLayout(w,C,l,_.w,x,"label"),s+=p+this.verticalGap}for(;v<o.length;v++)null==r[f]?r[f]=[o[v]]:r[f].push(o[v])}},_applyRendererLayout:function(e,t,i,n,r,a){var o=this.isItemBeingEdited(e),s=this.isItemSelected(e),d=this.isItemHovered(e),l=this.isItemFocused(e),u=t.renderer;u.set("hovered",d),u.set("selected",s),u.set("edited",o),u.set("focused",!!this.showFocus&&l),u.set("moveEnabled",this.isItemMoveEnabled(e._item,a)),u.set("storeState",this.getItemStoreState(e)),"label"!=a&&u.set("resizeEnabled",this.isItemResizeEnabled(e,a)),this.applyRendererZIndex(e,t,d,s,o,l),u.updateRendering&&u.updateRendering(n,r),c.place(t.container,i),h.set(t.container,"display","block")},_getCellAt:function(e,t,i){return void 0!=i&&1!=i||this.isLeftToRight()||(t=this.renderData.columnCount-1-t),this.gridTable.childNodes[0].childNodes[e].childNodes[t]},_layoutExpandRenderers:function(e,t,i){if(this.expandRenderer){var n=this.renderData;if(n.expandedRow==e)null!=n.expandedRowCol&&-1!=n.expandedRowCol&&this._layoutExpandRendererImpl(n.expandedRow,n.expandedRowCol,null,!0);else if(null==n.expandedRow)for(var r=0;r<n.columnCount;r++)t[r]&&this._layoutExpandRendererImpl(e,n.rtl?n.columnCount-1-r:r,i[r],!1)}},_layoutExpandRendererImpl:function(e,t,i,r){var a,o=this.renderData,s=n.clone(o.dates[e][t]),d=o.cells[e];a=this._getExpandRenderer(s,i,e,t,r);var l=u.position(this._getCellAt(e,t));l.x-=o.gridTablePosX,this.layoutExpandRenderer(a,s,i,l,this.expandRendererHeight),c.place(a.domNode,d),h.set(a.domNode,"display","block")},layoutExpandRenderer:function(e,t,i,n,r){h.set(e.domNode,{left:n.x+"px",width:n.w+"px",height:r+"px",top:n.h-r-1+"px"})},_onItemEditBeginGesture:function(e){var t=this._edProps,i=t.editedItem,n=e.dates,r=this.newDate("resizeEnd"==t.editKind?i.endTime:i.startTime);if("label"==t.rendererKind);else if("move"==e.editKind&&(i.allDay||this.roundToDay)){var a=this.renderData.dateModule;t.dayOffset=a.difference(this.floorToDay(n[0],!1,this.renderData),r,"day")}this.inherited(arguments)},_computeItemEditingTimes:function(e,t,i,n,r){var a=this.renderData.dateModule,o=this._edProps;if("label"==i);else if(e.allDay||this.roundToDay){var s=this.isStartOfDay(n[0]);switch(t){case"resizeEnd":!s&&e.allDay&&(n[0]=a.add(n[0],"day",1));case"resizeStart":s||(n[0]=this.floorToDay(n[0],!0));break;case"move":n[0]=a.add(n[0],"day",o.dayOffset);break;case"resizeBoth":s||(n[0]=this.floorToDay(n[0],!0)),this.isStartOfDay(n[1])||(n[1]=this.floorToDay(a.add(n[1],"day",1),!0))}}else n=this.inherited(arguments);return n},getTime:function(e,t,i,n){var r=this.renderData;if(null!=e){var a=u.position(this.itemContainer,!0);e.touches?(n=void 0==n?0:n,t=e.touches[n].pageX-a.x,i=e.touches[n].pageY-a.y):(t=e.pageX-a.x,i=e.pageY-a.y)}var o=u.getContentBox(this.itemContainer);t<0?t=0:t>o.w&&(t=o.w-1),i<0?i=0:i>o.h&&(i=o.h-1);var s,d=u.getMarginBox(this.itemContainer).w/r.columnCount;s=null==r.expandedRow?Math.floor(i/(u.getMarginBox(this.itemContainer).h/r.rowCount)):r.expandedRow;o=u.getContentBox(this.itemContainer);r.rtl&&(t=o.w-t);var l=Math.floor(t/d),h=Math.floor(1440*(t-l*d)/d),c=null;return s<r.dates.length&&l<this.renderData.dates[s].length&&(c=this.newDate(this.renderData.dates[s][l]),c=this.renderData.dateModule.add(c,"minute",h)),c},_onGridMouseUp:function(e){this.inherited(arguments),this._gridMouseDown&&(this._gridMouseDown=!1,this._onGridClick({date:this.getTime(e),triggerEvent:e}))},_onGridTouchEnd:function(e){this.inherited(arguments);var t=this._gridProps;t&&(this._isEditing||(t.fromItem||t.editingOnStart||this.selectFromEvent(e,null,null,!0),t.fromItem||(this._pendingDoubleTap&&this._pendingDoubleTap.grid?(this._onGridDoubleClick({date:this.getTime(this._gridProps.event),triggerEvent:this._gridProps.event}),clearTimeout(this._pendingDoubleTap.timer),delete this._pendingDoubleTap):(this._onGridClick({date:this.getTime(this._gridProps.event),triggerEvent:this._gridProps.event}),this._pendingDoubleTap={grid:!0,timer:setTimeout(n.hitch(this,function(){delete this._pendingDoubleTap}),this.doubleTapDelay)}))),this._gridProps=null)},_onRowHeaderClick:function(e){this._dispatchCalendarEvt(e,"onRowHeaderClick")},onRowHeaderClick:function(e){},expandRendererClickHandler:function(e,t){i.stop(e);var r=t.get("rowIndex"),a=t.get("columnIndex");this._onExpandRendererClick(n.mixin(this._createItemEditEvent(),{rowIndex:r,columnIndex:a,renderer:t,triggerEvent:e,date:this.renderData.dates[r][a]}))},onExpandRendererClick:function(e){},_onExpandRendererClick:function(e){this._dispatchCalendarEvt(e,"onExpandRendererClick"),e.isDefaultPrevented()||(-1!=this.getExpandedRowIndex()?this.collapseRow():this.expandRow(e.rowIndex,e.columnIndex))},snapUnit:"minute",snapSteps:15,minDurationUnit:"minute",minDurationSteps:15,triggerExtent:3,liveLayout:!1,stayInView:!0,allowStartEndSwap:!0,allowResizeLessThan24H:!1})});
//# sourceMappingURL=../sourcemaps/calendar/MatrixView.js.map
