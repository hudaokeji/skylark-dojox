/**
 * dojox - A version of dojox.js framework that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/dojox/
 * @license MIT
 */
define("dojox/rpc/JsonRest",["dojo","dojox","dojox/json/ref","dojox/rpc/Rest"],function(e,t){var r,i=[],n=t.rpc.Rest;function o(e,i,o,s){var c=i.ioArgs&&i.ioArgs.xhr&&i.ioArgs.xhr.getResponseHeader("Last-Modified");c&&n._timeStamps&&(n._timeStamps[s]=c);var a=e._schema&&e._schema.hrefProperty;return a&&(t.json.ref.refAttribute=a),o=o&&t.json.ref.resolveJson(o,{defaultId:s,index:n._index,timeStamps:c&&n._timeStamps,time:c,idPrefix:e._store.allowNoTrailingSlash?e.servicePath+"/":e.servicePath.replace(/[^\/]*$/,""),idAttribute:r.getIdAttribute(e),schemas:r.schemas,loader:r._loader,idAsRef:e.idAsRef,assignAbsoluteIds:!0}),t.json.ref.refAttribute="$ref",o}return r=t.rpc.JsonRest={serviceClass:t.rpc.Rest,conflictDateHeader:"If-Unmodified-Since",commit:function(t){t=t||{};for(var o=[],s={},c=[],a=0;a<i.length;a++){var d=i[a],h=d.object,f=d.old;if((!t.service||!h&&!f||!(h||f).__id.indexOf(t.service.servicePath))&&d.save){if(delete h.__isDirty,h)if(f){var u;if((u=h.__id.match(/(.*)#.*/))&&(h=n._index[u[1]]),!(h.__id in s)){if(s[h.__id]=h,t.incrementalUpdates&&!u)var l=("function"==typeof t.incrementalUpdates?t.incrementalUpdates:function(){for(var e in l={},h)if(h.hasOwnProperty(e))h[e]!==f[e]&&(l[e]=h[e]);else if(f.hasOwnProperty(e))return null;return l})(h,f);l?o.push({method:"post",target:h,content:l}):o.push({method:"put",target:h,content:h})}}else{var v=r.getServiceAndId(h.__id).service;r.getIdAttribute(v)in h&&!t.alwaysPostNewItems?o.push({method:"put",target:h,content:h}):o.push({method:"post",target:{__id:v.servicePath},content:h})}else f&&o.push({method:"delete",target:f});c.push(d),i.splice(a--,1)}}return e.connect(t,"onError",function(){if(!1!==t.revertOnError){var n=i;i=c;r.revert(),i=n}else e.forEach(c,function(e){r.changing(e.object,!e.object)})}),r.sendToServer(o,t),o},sendToServer:function(i,s){var c,a,d,h=e.xhr,f=i.length,u=this.conflictDateHeader;for(e.xhr=function(t,r){return r.headers=r.headers||{},r.headers.Transaction=i.length-1==c?"commit":"open",u&&d&&(r.headers[u]=d),a&&(r.headers["Content-ID"]="<"+a+">"),h.apply(e,arguments)},c=0;c<i.length;c++){var l=i[c];t.rpc.JsonRest._contentId=l.content&&l.content.__id;var v="post"==l.method;(d="put"==l.method&&n._timeStamps[l.content.__id])&&(n._timeStamps[l.content.__id]=new Date+""),a=v&&t.rpc.JsonRest._contentId;var _=r.getServiceAndId(l.target.__id),p=_.service,m=l.deferred=p[l.method](_.id.replace(/#/,""),t.json.ref.toJson(l.content,!1,p.servicePath,!0));!function(e,t,r){t.addCallback(function(c){try{var a=t.ioArgs.xhr&&t.ioArgs.xhr.getResponseHeader("Location");if(a){var d=a.match(/(^\w+:\/\/)/)&&a.indexOf(r.servicePath);a=d>0?a.substring(d):(r.servicePath+a).replace(/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,"$2$3"),e.__id=a,n._index[a]=e}c=o(r,t,c,e&&e.__id)}catch(e){}return--f||s.onComplete&&s.onComplete.call(s.scope,i),c})}(l.content,m,p),m.addErrback(function(e){f=-1,s.onError.call(s.scope,e)})}e.xhr=h},getDirtyObjects:function(){return i},revert:function(e){for(var r=i.length;r>0;){var n=i[--r],o=n.object,s=n.old,c=t.data._getStoreForItem(o||s);if(!e||!o&&!s||!(o||s).__id.indexOf(e.servicePath)){if(o&&s){for(var a in s)s.hasOwnProperty(a)&&o[a]!==s[a]&&(c&&c.onSet(o,a,o[a],s[a]),o[a]=s[a]);for(a in o)s.hasOwnProperty(a)||(c&&c.onSet(o,a,o[a]),delete o[a])}else s?c&&c.onNew(s):c&&c.onDelete(o);delete(o||s).__isDirty,i.splice(r,1)}}},changing:function(e,t){if(e.__id){e.__isDirty=!0;for(var r=0;r<i.length;r++){var n=i[r];if(e==n.object)return void(t&&(n.object=!1,this._saveNotNeeded||(n.save=!0)))}var o=e instanceof Array?[]:{};for(r in e)e.hasOwnProperty(r)&&(o[r]=e[r]);i.push({object:!t&&e,old:o,save:!this._saveNotNeeded})}},deleteObject:function(e){this.changing(e,!0)},getConstructor:function(o,s){if("string"==typeof o){var c=o;o=new t.rpc.Rest(o,!0),this.registerService(o,c,s)}return o._constructor?o._constructor:(o._constructor=function(s){var c,a,d=this,h=arguments;!function e(t){if(t)for(var r in e(t.extends),c=t.properties){var i=c[r];i&&"object"==typeof i&&"default"in i&&(d[r]=i.default)}t&&t.prototype&&t.prototype.initialize&&(a=!0,t.prototype.initialize.apply(d,h))}(o._schema),!a&&s&&"object"==typeof s&&e.mixin(d,s);var f=r.getIdAttribute(o);n._index[this.__id=this.__clientId=o.servicePath+(this[f]||Math.random().toString(16).substring(2,14)+"@"+(t.rpc.Client&&t.rpc.Client.clientId||"client"))]=this,t.json.schema&&c&&t.json.schema.mustBeValid(t.json.schema.validate(this,o._schema)),i.push({object:this,save:!0})},e.mixin(o._constructor,o._schema,{load:o}))},fetch:function(e){var t=r.getServiceAndId(e);return this.byId(t.service,t.id)},getIdAttribute:function(e){var t,r=e._schema;if(r&&!(t=r._idAttr))for(var i in r.properties)(r.properties[i].identity||"self"==r.properties[i].link)&&(r._idAttr=t=i);return t||"id"},getServiceAndId:function(e){var t="";for(var i in r.services)e.substring(0,i.length)==i&&i.length>=t.length&&(t=i);if(t)return{service:r.services[t],id:e.substring(t.length)};var n=e.match(/^(.*\/)([^\/]*)$/);return{service:new r.serviceClass(n[1],!0),id:n[2]}},services:{},schemas:{},registerService:function(e,t,i){t=e.servicePath=t||e.servicePath,e._schema=r.schemas[t]=i||e._schema||{},r.services[t]=e},byId:function(t,r){var i,o=n._index[(t.servicePath||"")+r];return o&&!o._loadObject?((i=new e.Deferred).callback(o),i):this.query(t,r)},query:function(e,t,r){var i=e(t,r);return i.addCallback(function(n){return n.nodeType&&n.cloneNode?n:o(e,i,n,"string"!=typeof t||r&&(r.start||r.count)?void 0:t)}),i},_loader:function(e){var t=r.getServiceAndId(this.__id),i=this;r.query(t.service,t.id).addBoth(function(t){t==i?(delete t.$ref,delete t._loadObject):i._loadObject=function(e){e(t)},e(t)})},isDirty:function(r,n){return r?r.__isDirty:n?e.some(i,function(e){return t.data._getStoreForItem(e.object||e.old)==n}):!!i.length}},t.rpc.JsonRest});
//# sourceMappingURL=../sourcemaps/rpc/JsonRest.js.map
