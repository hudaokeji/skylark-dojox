/**
 * dojox - A version of dojox.js framework that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/dojox/
 * @license MIT
 */
define(["require","dojo/_base/lang","dojo/_base/declare","dojo/on","dojo/Deferred","dojo/when","dojo/dom-style","../Controller"],function(require,e,i,t,a,o,r,n,l){return i("dojox.app.controllers.Load",n,{_waitingQueue:[],constructor:function(e,i){this.events={"app-init":this.init,"app-load":this.load}},init:function(e){o(this.createView(e.parent,null,null,{templateString:e.templateString,controller:e.controller},null,e.type),function(i){o(i.start(),e.callback)})},load:function(i){this.app.log("in app/controllers/Load event.viewId="+i.viewId+" event =",i);for(var t=[],r=(i.viewId||"").split("+");r.length>0;){var n=r.shift();t.push(n)}if(this.proceedLoadViewDef=new a,!(t&&t.length>1))return this.loadView(i);for(var l=0;l<t.length-1;l++){var s=e.clone(i);s.callback=null,s.viewId=t[l],this._waitingQueue.push(s)}this.proceedLoadView(this._waitingQueue.shift()),o(this.proceedLoadViewDef,e.hitch(this,function(){var a=e.clone(i);return a.viewId=t[l],this.loadView(a)}))},proceedLoadView:function(i){var t=this.loadView(i);o(t,e.hitch(this,function(){this.app.log("in app/controllers/Load proceedLoadView back from loadView for event",i);var e=this._waitingQueue.shift();e?(this.app.log("in app/controllers/Load proceedLoadView back from loadView calling this.proceedLoadView(nextEvt) for ",e),this.proceedLoadView(e)):(this._waitingQueue=[],this.proceedLoadViewDef.resolve())}))},loadView:function(i){var t=i.parent||this.app,a=(i.viewId||"").split(","),r=a.shift(),n=a.join(","),l=i.params||"";this._handleDefault=!1,this._defaultHasPlus=!1;var s=this.loadChild(t,r,n,l,i);return i.callback&&o(s,e.hitch(this,function(){this._handleDefault&&!i.initLoad&&(this.app.log("logTransitions:",""," emit app-transition this.childViews=["+this.childViews+"]"),this.app.emit("app-transition",{viewId:this.childViews,defaultView:!0,forceTransitionNone:i.forceTransitionNone,opts:{params:l}})),i.callback(this._handleDefault,this._defaultHasPlus)})),s},createChild:function(e,i,t,r){var n=e.id+"_"+i;!r&&e.views[i]&&e.views[i].defaultParams&&(r=e.views[i].defaultParams);var l=e.children[n];if(l)return r&&(l.params=r),this.app.log("in app/controllers/Load createChild view is already loaded so return the loaded view with the new parms ",l),l;var s=new a;return o(this.createView(e,n,i,null,r,e.views[i].type),function(i){e.children[n]=i,o(i.start(),function(e){s.resolve(e)})}),s},createView:function(i,t,o,r,n,l){var s=new a,d=this.app;return require([l||"../View"],function(a){var l=new a(e.mixin({app:d,id:t,name:o,parent:i},{params:n},r));s.resolve(l)}),s},loadChild:function(i,t,r,n,l){if(!i)throw Error("No parent for Child '"+t+"'.");if(!t){var s=i.defaultView?i.defaultView.split(","):"default";if(i.defaultView&&!l.initLoad){var d=this._getViewNamesFromDefaults(i);this.app.log("logTransitions:","Load:loadChild","setting _handleDefault true for parent.defaultView childViews=["+d+"]"),this._handleDefault=!0,i.defaultView.indexOf("+")>=0&&(this._defaultHasPlus=!0)}else t=s.shift(),r=s.join(",")}var h,c=new a;try{h=this.createChild(i,t,r,n)}catch(e){return console.warn("logTransitions:","","emit reject load exception for =["+t+"]",e),c.reject("load child '"+t+"' error."),c.promise}return o(h,e.hitch(this,function(e){if(!r&&e.defaultView){var i=this._getViewNamesFromDefaults(e);this.app.log("logTransitions:","Load:loadChild"," setting _handleDefault = true child.defaultView childViews=["+i+"]"),this._handleDefault=!0,e.defaultView.indexOf("+")>=0&&(this._defaultHasPlus=!0),this.childViews=i,c.resolve()}var a=r.split(",");if(t=a.shift(),r=a.join(","),t){var s=this.loadChild(e,t,r,n,l);o(s,function(){c.resolve()},function(){c.reject("load child '"+t+"' error.")})}else c.resolve()}),function(){console.warn("loadChildDeferred.REJECT() for ["+t+"] subIds=["+r+"]"),c.reject("load child '"+t+"' error.")}),c.promise},_getViewNamesFromDefaults:function(e){for(var i=e.parent,t=e.name;i!==this.app;)t=i.name+","+t,i=i.parent;var a=e.defaultView.split("+");for(var o in a)a[o]=t+","+a[o];return a.join("+")}})});
//# sourceMappingURL=../../sourcemaps/app/controllers/Load.js.map
