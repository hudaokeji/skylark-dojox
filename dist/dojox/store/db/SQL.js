/**
 * dojox - A version of dojox.js framework that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/dojox/
 * @license MIT
 */
define(["dojo/_base/declare","dojo/Deferred","dojo/when","dojo/store/util/QueryResults","dojo/_base/lang","dojo/promise/all"],function(e,t,i,r,n,s){var o=/(.*)\*$/;function u(e){return e&&n.mixin(e,JSON.parse(e.__extra))}return e([],{constructor:function(e){var t=e.dbConfig;this.database=openDatabase(e.dbName||"dojo-db","1.0","dojo-db",4194304);var i=this.indexPrefix=e.indexPrefix||"idx_",r=e.table||e.storeName;this.table=(e.table||e.storeName).replace(/[^\w]/g,"_");var n=[];for(var o in this.indices=t.stores[r],this.repeatingIndices={},this.indices)this.indices[o].multiEntry&&(this.repeatingIndices[o]=!0);if(!t.available){for(var r in t.stores){var u=t.stores[r],a=r.replace(/[^\w]/g,"_"),h=u[this.idProperty],c=["__extra",this.idProperty+" "+(h&&h.autoIncrement?"INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY")],d=[this.idProperty];for(var o in u)o!=this.idProperty&&c.push(o);for(var o in n.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+a+" ("+c.join(",")+")")),u)if(o!=this.idProperty)if(u[o].multiEntry){d.push(o);var l=a+"_repeating_"+o;n.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+l+" (id,value)")),n.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+l+"_id ON "+l+"(id)")),n.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+l+"_value ON "+l+"(value)"))}else n.push(this.executeSql("ALTER TABLE "+a+" ADD "+o).then(null,function(){})),!1!==u[o].indexed&&n.push(this.executeSql("CREATE INDEX IF NOT EXISTS "+i+a+"_"+o+" ON "+a+"("+o+")"))}t.available=s(n)}this.available=t.available},idProperty:"id",selectColumns:["*"],get:function(e){return i(this.executeSql("SELECT "+this.selectColumns.join(",")+" FROM "+this.table+" WHERE "+this.idProperty+"=?",[e]),function(e){return e.rows.length>0?u(e.rows.item(0)):void 0})},getIdentity:function(e){return e[this.idProperty]},remove:function(e){return this.executeSql("DELETE FROM "+this.table+" WHERE "+this.idProperty+"=?",[e])},identifyGeneratedKey:!0,add:function(e,t){var r=[],n=[],o=[],u={},a=[],h=this;for(var c in e)e.hasOwnProperty(c)&&(c in this.indices||c==this.idProperty?this.repeatingIndices[c]?a.push(function(t){var i=e[c];return s(i.map(function(e){return h.executeSql("INSERT INTO "+h.table+"_repeating_"+c+" (value, id) VALUES (?, ?)",[e,t])}))}):(o.push(c),n.push("?"),r.push(e[c])):u[c]=e[c]);o.push("__extra"),n.push("?"),r.push(JSON.stringify(u));var d=this.idProperty;this.identifyGeneratedKey&&(r.idColumn=d);var l="INSERT INTO "+this.table+" ("+o.join(",")+") VALUES ("+n.join(",")+")";return i(this.executeSql(l,r),function(t){var i=t.insertId;return e[d]=i,s(a.map(function(e){return e(i)})).then(function(){return i})})},put:function(e,t){var r=(t=t||{}).id||e[this.idProperty],n=t.overwrite;if(void 0===n){var s=this;return this.get(r).then(function(i){return(t.overwrite=!!i)?(t.overwrite=!0,s.put(e,t)):s.add(e,t)})}if(!n)return s.add(e,t);var o="UPDATE "+this.table+" SET ",u=[],a=[],h={};for(var c in e)if(e.hasOwnProperty(c))if(c in this.indices||c==this.idProperty)if(this.repeatingIndices[c]){this.executeSql("DELETE FROM "+this.table+"_repeating_"+c+" WHERE id=?",[r]);for(var d=e[c],l=0;l<d.length;l++)this.executeSql("INSERT INTO "+this.table+"_repeating_"+c+" (value, id) VALUES (?, ?)",[d[l],r])}else a.push(c+"=?"),u.push(e[c]);else h[c]=e[c];return a.push("__extra=?"),u.push(JSON.stringify(h)),o+=a.join(",")+" WHERE "+this.idProperty+"=?",u.push(e[this.idProperty]),i(this.executeSql(o,u),function(e){return r})},query:function(e,t){t=t||{};var i,s="FROM "+this.table,a=this,h=this.table,c=[];function d(e){var t=[];for(var i in e){var r=e[i];function n(e){var t=e&&e.match&&e.match(o);return t?(c.push(t[1]+"%")," LIKE ?"):(c.push(e),"=?")}if(r){if(r.contains){var s=a.table+"_repeating_"+i;t.push(r.contains.map(function(e){return a.idProperty+" IN (SELECT id FROM "+s+" WHERE value"+n(e)+")"}).join(" AND "));continue}if("object"==typeof r&&("from"in r||"to"in r)){var u=r.excludeFrom?">":">=",d=r.excludeTo?"<":"<=";"from"in r?(c.push(r.from),"to"in r?(c.push(r.to),t.push("("+h+"."+i+u+"? AND "+h+"."+i+d+"?)")):t.push(h+"."+i+u+"?")):(c.push(r.to),t.push(h+"."+i+d+"?"));continue}}t.push(h+"."+i+n(r))}return t.join(" AND ")}e.forEach?(i=e.map(d).join(") OR ("))&&(i="("+i+")"):i=d(e),i&&(i=" WHERE "+i),t.sort&&(i+=" ORDER BY "+t.sort.map(function(e){return h+"."+e.attribute+" "+(e.descending?"desc":"asc")}));var l=i;t.count&&(l+=" LIMIT "+t.count),t.start&&(l+=" OFFSET "+t.start);var p=n.delegate(this.executeSql("SELECT * "+s+l,c).then(function(e){for(var t=[],i=0;i<e.rows.length;i++)t.push(u(e.rows.item(i)));return t}));a=this;return p.total={then:function(e,t){return a.executeSql("SELECT COUNT(*) "+s+i,c).then(function(e){return e.rows.item(0)["COUNT(*)"]}).then(e,t)}},new r(p)},executeSql:function(e,i){var r,n,s=new t;if(this.database.transaction(function(t){t.executeSql(e,i,function(e,t){s.resolve(r=t)},function(e,t){s.reject(n=t)})}),r)return r;if(n)throw n;return s.promise}})});
//# sourceMappingURL=../../sourcemaps/store/db/SQL.js.map
