/**
 * dojox - A version of dojox.js framework that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/dojox/
 * @license MIT
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/when","dojo/promise/all","dojo/store/util/SimpleQueryEngine","dojo/store/util/QueryResults"],function(t,e,n,r,o,i,a){function u(t){var e=new n;return t.onsuccess=function(t){e.resolve(t.target.result)},t.onerror=function(){t.error.message=t.webkitErrorMessage,e.reject(t.error)},e.promise}var c=[],s=1,f=0,l=/(.*)\*$/;function h(t,e,n){if(f||c.length){if(t&&(c.push({cursor:t,priority:e,retry:n}),c.sort(function(t,e){return t.priority>e.priority?1:-1})),f>=s)return;var r=c.pop();t=r&&r.cursor}if(t)try{t.continue(),f++}catch(t){if("TransactionInactiveError"!==t.name&&0!==t.name||!r)throw t;r.retry()}}function d(){return!0}function v(t){var e,n,r=[];function o(o,i){return n?o&&e.then(function(t){t.forEach(o,i)}):(o&&r.push(o),e||(e=t.filter(function(t){n=!0;for(var e=0,o=r.length;e<o;e++)r[e].call(i,t);return!0}))),e}return{total:t.total,filter:function(t,e){var n;return o(function(r){n||(n=!t.call(e,r))})},forEach:o,map:function(t,e){var n=[];return o(function(r){n.push(t.call(e,r))}).then(function(){return n})},then:function(t,e){return o().then(t,e)}}}var p=window.IDBKeyRange||window.webkitIDBKeyRange;return t(null,{constructor:function(e){t.safeMixin(this,e);var n=this,r=this.dbConfig;for(var o in this.indices=r.stores[this.storeName],this.cachedCount={},n.indices){var i=n.indices[o];"number"==typeof i&&(n.indices[o]={preference:i})}if(this.db=this.db||r.db,!this.db){var a=r.openRequest;a||((a=r.openRequest=window.indexedDB.open(r.name||"dojo-db",parseInt(r.version,10))).onupgradeneeded=function(){var t=n.db=a.result;for(var e in r.stores){var o=r.stores[e];if(t.objectStoreNames.contains(e))u=a.transaction.objectStore(e);else var i=o.idProperty||"id",u=t.createObjectStore(e,{keyPath:i,autoIncrement:o[i]&&o[i].autoIncrement||!1});for(var c in o)u.indexNames.contains(c)||"autoIncrement"===c||!1===o[c].indexed||u.createIndex(c,c,o[c])}},r.available=u(a)),this.available=r.available.then(function(t){return n.db=t})}},idProperty:"id",storeName:"",indices:{},queryEngine:i,transaction:function(){var t=this;return this._currentTransaction=null,{abort:function(){t._currentTransaction.abort()},commit:function(){t._currentTransaction=null}}},_getTransaction:function(){if(!this._currentTransaction){this._currentTransaction=this.db.transaction([this.storeName],"readwrite");var t=this;this._currentTransaction.oncomplete=function(){t._currentTransaction=null},this._currentTransaction.onerror=function(t){console.error(t)}}return this._currentTransaction},_callOnStore:function(t,e,n,o){var i=this;return r(this.available,function r(){var a,c,s=i._currentTransaction;if(s)var f=!0;else s=i._getTransaction();if(f)try{c=s.objectStore(i.storeName),n&&(c=c.index(n)),a=c[t].apply(c,e)}catch(t){if("TransactionInactiveError"===t.name||"InvalidStateError"===t.name)return i._currentTransaction=null,r();throw t}else c=s.objectStore(i.storeName),n&&(c=c.index(n)),a=c[t].apply(c,e);return o?a:u(a)})},get:function(t){return this._callOnStore("get",[t])},getIdentity:function(t){return t[this.idProperty]},put:function(t,e){return e=e||{},this.cachedCount={},this._callOnStore(!1===e.overwrite?"add":"put",[t])},add:function(t,e){return(e=e||{}).overwrite=!1,this.put(t,e)},remove:function(t){return this.cachedCount={},this._callOnStore("delete",[t])},query:function(t,i){var u,c=(i=i||{}).start||0,s=i.count||1/0,y=i.sort,m=this;if(t.forEach){var g={sort:y},b=this.queryEngine({},g),_=[],w=0,j=0;return v({total:{then:function(){return o(_).then(function(t){return t.reduce(function(t,e){return t+e})*w/(j||1)}).then.apply(this,arguments)}},filter:function(e,n){var r,i=0,a=[],u={},f=[];return o(t.map(function(t,o){var l=a[o]=[];function h(t){l.push(t);for(var o=[],u=[];a.every(function(t){if(t.length>0){var e=t[0];return e&&u.push(e),o.push(e)}});){if(i>=c+s||0===u.length)return void(r=!0);var h=b(u)[0];if(a[o.indexOf(h)].shift(),i++>=c&&(f.push(h),!e.call(n,h)))return void(r=!0);o=[],u=[]}return!0}var d=m.query(t,g);return _[o]=d.total,d.filter(function(t){if(!r){var e=m.getIdentity(t);return j++,e in u?!0:(w++,u[e]=!0,h(t))}}).then(function(t){return h(null),t})})).then(function(){return f})}})}var O,x,T,S,I,E=JSON.stringify(t)+"-"+JSON.stringify(i.sort),R=0,q=0;function N(t,e,n){q++;var r=m.indices[t];if(r&&!1!==r.indexed&&(e=e||r.preference*(n||1)||.001)>R)return R=e,x=t,!0;q++}for(var k in t){var C,F=!1,P=null;if("boolean"!=typeof(T=t[k])){if(T)if(T.from||T.to)F=!0,function(t,e){P={test:function(n){return!t||t<=n&&(!e||e>=n)},keyRange:t?e?p.bound(t,e,T.excludeFrom,T.excludeTo):p.lowerBound(t,T.excludeFrom):p.upperBound(e,T.excludeTo)}}(T.from,T.to);else if("object"==typeof T&&T.contains)!function(t){var e,n=t[0],r=n&&n.match&&n.match(l);r?(n=r[1],e=p.bound(n,n+"~")):e=p.only(n),P={test:function(e){return t.every(function(t){var n=t&&t.match&&t.match(l);return n?(t=n[1],e&&e.some(function(e){return e.slice(0,t.length)===t})):e&&e.indexOf(t)>-1})},keyRange:e}}(T.contains);else if(C=T.match&&T.match(l)){var B=C[1];(P=new RegExp("^"+B)).keyRange=p.bound(B,B+"~")}P&&(t[k]=P),N(k,null,F?.1:1)}}if(y){var D=y[0];if(D.attribute===x||N(D.attribute,1))S=D.descending;else{var M=!0;c=0,s=1/0}}x?(x in t?(T=t[x],u=T&&T.keyRange?T.keyRange:p.only(T),x):u=null,I=[u,S?"prev":"next"]):I=[];var J=m.cachedPosition;J&&J.queryId===E&&J.offset<c&&q>1?(O=J.preFilterOffset+1,m.cachedPosition=J=e.mixin({},J)):(J=m.cachedPosition={offset:-1,preFilterOffset:-1,queryId:E},q<2&&(J.offset=J.preFilterOffset=(O=c)-1));var K=this.queryEngine(t),Q={total:{then:function(t){var e=m.cachedCount[E];if(e)return t(r(e));var n=u?m._callOnStore("count",[u],x):m._callOnStore("count");return(this.then=n.then(r)).then.apply(this,arguments);function r(t){return m.cachedCount[E]=t,Math.round((J.offset+1.01)/(J.preFilterOffset+1.01)*t)}}},filter:function(t,e){var o=new n,a=[];return function n(){r(m._callOnStore("openCursor",I,x,!0),function(u){f++,u.onsuccess=function(l){f--;var d=l.target.result;if(d){if(O)return d.advance(O),f++,void(O=!1);J.preFilterOffset++;try{var v=d.value;return i.join&&(v=i.join(v)),r(v,function(r){return K.matches(r)&&(J.offset++,J.offset>=c&&(a.push(r),!t.call(e,r)||J.offset>=c+s-1))?(u.lastCursor=d,o.resolve(a),void h()):h(d,i.priority,function(){O=J.preFilterOffset,n()})})}catch(t){o.reject(t)}}else o.resolve(a);h()},u.onerror=function(t){f--,o.reject(t),h()}})}(),o.promise}};if(M){b=this.queryEngine({},i);var $=e.delegate(Q.filter(d).then(function(t){return b(t)}));return $.total=Q.total,new a($)}return i.rawResults?Q:v(Q)}})});
//# sourceMappingURL=../../sourcemaps/store/db/IndexedDB.js.map
