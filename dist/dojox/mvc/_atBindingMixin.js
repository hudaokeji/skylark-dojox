/**
 * dojox - A version of dojox.js framework that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/dojox/
 * @license MIT
 */
define(["dojo/_base/array","dojo/_base/lang","dojo/_base/declare","dojo/has","dojo/Stateful","./resolve","./sync"],function(array,lang,declare,has,Stateful,resolve,sync){if(has("mvc-bindings-log-api")){function getLogContent(t,e){return[t._setIdAttr||!t.declaredClass?t:t.declaredClass,e].join(":")}function logResolveFailure(t,e){console.warn(e+" could not be resolved"+("string"==typeof t?" with "+t:"")+".")}}function getParent(t){var e;try{e=require("dijit/registry")}catch(t){return}for(var n,i=t.domNode&&t.domNode.parentNode;i;){if(n=e.getEnclosingWidget(i)){var a=n._relTargetProp||"target";if((lang.isFunction(n.get)?n.get(a):n[a])||a in n.constructor.prototype)return n}i=n&&n.domNode.parentNode}}function bind(t,e,n,i,a){var r={},o=getParent(n),s=o&&o._relTargetProp||"target";function l(){r.Two&&r.Two.unwatch(),delete r.Two;var l=o&&(lang.isFunction(o.get)?o.get(s):o[s]),c=resolve(t,l),d=resolve(n,l);has("mvc-bindings-log-api")&&(!c||/^rel:/.test(t)&&!o)&&logResolveFailure(t,e),has("mvc-bindings-log-api")&&(!d||/^rel:/.test(n)&&!o)&&logResolveFailure(n,i),c&&d&&(!/^rel:/.test(t)&&!/^rel:/.test(n)||o)&&(c.set&&c.watch||"*"!=e?null==e?(lang.isFunction(d.set)?d.set(i,c):d[i]=c,has("mvc-bindings-log-api")&&console.log("dojox/mvc/_atBindingMixin set "+c+" to: "+getLogContent(d,i))):r.Two=sync(c,e,d,i,a):has("mvc-bindings-log-api")&&logResolveFailure(t,e))}l(),(o&&/^rel:/.test(t)||/^rel:/.test(n)&&lang.isFunction(o.set)&&lang.isFunction(o.watch))&&(r.rel=o.watch(s,function(t,e,n){e!==n&&(has("mvc-bindings-log-api")&&console.log("Change in relative data binding target: "+o),l())}));var c={};return c.unwatch=c.remove=function(){for(var t in r)r[t]&&r[t].unwatch(),delete r[t]},c}var mixin={dataBindAttr:"data-mvc-bindings",_dbpostscript:function(t,e){var n=this._refs=(t||{}).refs||{};for(var i in t)if("dojox.mvc.at"==(t[i]||{}).atsignature){var a=t[i];delete t[i],n[i]=a}var r=new Stateful,o=this;for(var i in r.toString=function(){return"[Mixin value of widget "+o.declaredClass+", "+(o.id||"NO ID")+"]"},r.canConvertToLoggable=!0,this._startAtWatchHandles(r),n)void 0!==r[i]&&((t=t||{})[i]=r[i]);this._stopAtWatchHandles()},_startAtWatchHandles:function(t){this.canConvertToLoggable=!0;var e=this._refs;if(e){var n=this._atWatchHandles=this._atWatchHandles||{};for(var i in this._excludes=null,e)e[i]&&"*"!=i&&(n[i]=bind(e[i].target,e[i].targetProp,t||this,i,{bindDirection:e[i].bindDirection,converter:e[i].converter,equals:e[i].equalsCallback}));"dojox.mvc.at"==(e["*"]||{}).atsignature&&(n["*"]=bind(e["*"].target,e["*"].targetProp,t||this,"*",{bindDirection:e["*"].bindDirection,converter:e["*"].converter,equals:e["*"].equalsCallback}))}},_stopAtWatchHandles:function(){for(var t in this._atWatchHandles)this._atWatchHandles[t].unwatch(),delete this._atWatchHandles[t]},_setAtWatchHandle:function(t,e){if("ref"==t)throw new Error(this+": 1.7 ref syntax used in conjunction with 1.8 dojox/mvc/at syntax, which is not supported.");var n=this._atWatchHandles=this._atWatchHandles||{};n[t]&&(n[t].unwatch(),delete n[t]),this[t]=null,this._excludes=null,this._started?n[t]=bind(e.target,e.targetProp,this,t,{bindDirection:e.bindDirection,converter:e.converter,equals:e.equalsCallback}):this._refs[t]=e},_setBind:function(value){var list=eval("({"+value+"})");for(var prop in list){var h=list[prop];"dojox.mvc.at"!=(h||{}).atsignature?console.warn(prop+" in "+dataBindAttr+" is not a data binding handle."):this._setAtWatchHandle(prop,h)}},_getExcludesAttr:function(){if(this._excludes)return this._excludes;var t=[];for(var e in this._atWatchHandles)"*"!=e&&t.push(e);return t},_getPropertiesAttr:function(){if(this.constructor._attribs)return this.constructor._attribs;var t=["onClick"].concat(this.constructor._setterAttrs);return array.forEach(["id","excludes","properties","ref","binding"],function(e){var n=array.indexOf(t,e);n>=0&&t.splice(n,1)}),this.constructor._attribs=t}};mixin[mixin.dataBindAttr]="";var _atBindingMixin=declare("dojox/mvc/_atBindingMixin",null,mixin);return _atBindingMixin.mixin=mixin,_atBindingMixin});
//# sourceMappingURL=../sourcemaps/mvc/_atBindingMixin.js.map
