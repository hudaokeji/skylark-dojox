/**
 * dojox - A version of dojox.js framework that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/dojox/
 * @license MIT
 */
define(["dojo/_base/lang","dojo/_base/declare","dojo/has","dojo/on","dojo/aspect","dojo/touch","dojo/_base/Color","dojo/dom","dojo/dom-geometry","dojo/_base/window","./_base","./canvas","./shape","./matrix"],function(e,t,n,r,i,o,a,s,u,h,c,l,v,f){function d(t){var n={};for(var r in t)"function"==typeof t[r]?n[r]=e.hitch(t,r):n[r]=t[r];return n}n.add("dom-mutableEvents",function(){var e=document.createEvent("UIEvents");try{return Object.defineProperty?Object.defineProperty(e,"type",{value:"foo"}):e.type="foo","foo"===e.type}catch(e){return!1}});var g=c.canvasWithEvents={};g.Shape=t("dojox.gfx.canvasWithEvents.Shape",l.Shape,{_testInputs:function(e,t){if(this.clip||!this.canvasFill&&this.strokeStyle)this._hitTestPixel(e,t);else{this._renderShape(e);for(var n=t.length,r=this.getTransform(),i=0;i<n;++i){var o=t[i];if(!o.target){var a=o.x,s=o.y,u=r?f.multiplyPoint(f.invert(r),a,s):{x:a,y:s};o.target=this._hitTestGeometry(e,u.x,u.y)}}}},_hitTestPixel:function(e,t){for(var n=0;n<t.length;++n){var r=t[n];if(!r.target){var i=r.x,o=r.y;e.clearRect(0,0,1,1),e.save(),e.translate(-i,-o),this._render(e,!0),r.target=e.getImageData(0,0,1,1).data[0]?this:null,e.restore()}}},_hitTestGeometry:function(e,t,n){return e.isPointInPath(t,n)?this:null},_renderFill:function(e,t){e.pickingMode?"canvasFill"in this&&t&&e.fill():this.inherited(arguments)},_renderStroke:function(e){if(this.strokeStyle&&e.pickingMode){var t=this.strokeStyle.color;try{this.strokeStyle.color=new a(e.strokeStyle),this.inherited(arguments)}finally{this.strokeStyle.color=t}}else this.inherited(arguments)},getEventSource:function(){return this.surface.rawNode},on:function(e,t){var n=this.rawNode;return r(this.getEventSource(),e,function(e){s.isDescendant(e.target,n)&&t.apply(n,arguments)})},connect:function(t,n,r){return"on"==t.substring(0,2)&&(t=t.substring(2)),this.on(t,r?e.hitch(n,r):e.hitch(null,n))},disconnect:function(e){e.remove()}}),g.Group=t("dojox.gfx.canvasWithEvents.Group",[g.Shape,l.Group],{_testInputs:function(e,t){var n,r,i,o=this.children,a=this.getTransform();if(0!==o.length){var s=[];for(n=0;n<t.length;++n)if(i=t[n],s[n]={x:i.x,y:i.y},!i.target){var u=i.x,h=i.y,c=a?f.multiplyPoint(f.invert(a),u,h):{x:u,y:h};i.x=c.x,i.y=c.y}for(n=o.length-1;n>=0;--n){o[n]._testInputs(e,t);var l=!0;for(r=0;r<t.length;++r)if(null==t[r].target){l=!1;break}if(l)break}if(this.clip)for(n=0;n<t.length;++n)(i=t[n]).x=s[n].x,i.y=s[n].y,i.target&&(e.clearRect(0,0,1,1),e.save(),e.translate(-i.x,-i.y),this._render(e,!0),e.getImageData(0,0,1,1).data[0]||(i.target=null),e.restore());else for(n=0;n<t.length;++n)t[n].x=s[n].x,t[n].y=s[n].y}}}),g.Image=t("dojox.gfx.canvasWithEvents.Image",[g.Shape,l.Image],{_renderShape:function(e){var t=this.shape;e.pickingMode?e.fillRect(t.x,t.y,t.width,t.height):this.inherited(arguments)},_hitTestGeometry:function(e,t,n){var r=this.shape;return t>=r.x&&t<=r.x+r.width&&n>=r.y&&n<=r.y+r.height?this:null}}),g.Text=t("dojox.gfx.canvasWithEvents.Text",[g.Shape,l.Text],{_testInputs:function(e,t){return this._hitTestPixel(e,t)}}),g.Rect=t("dojox.gfx.canvasWithEvents.Rect",[g.Shape,l.Rect],{}),g.Circle=t("dojox.gfx.canvasWithEvents.Circle",[g.Shape,l.Circle],{}),g.Ellipse=t("dojox.gfx.canvasWithEvents.Ellipse",[g.Shape,l.Ellipse],{}),g.Line=t("dojox.gfx.canvasWithEvents.Line",[g.Shape,l.Line],{}),g.Polyline=t("dojox.gfx.canvasWithEvents.Polyline",[g.Shape,l.Polyline],{}),g.Path=t("dojox.gfx.canvasWithEvents.Path",[g.Shape,l.Path],{}),g.TextPath=t("dojox.gfx.canvasWithEvents.TextPath",[g.Shape,l.TextPath],{});var p=null;g.Surface=t("dojox.gfx.canvasWithEvents.Surface",l.Surface,{constructor:function(){this._elementUnderPointer=null},fixTarget:function(e){var t=this;return function(r){var i;if(p)if(n("dom-mutableEvents"))Object.defineProperties(r,p);else for(i in r=d(r),p)r[i]=p[i].value;else{var o=t.getEventSource()._dojoElementFromPoint((r.changedTouches?r.changedTouches[0]:r).pageX,(r.changedTouches?r.changedTouches[0]:r).pageY);n("dom-mutableEvents")?Object.defineProperties(r,{target:{value:o,configurable:!0,enumerable:!0},gfxTarget:{value:o.shape,configurable:!0,enumerable:!0}}):((r=d(r)).target=o,r.gfxTarget=o.shape)}if(n("touch")){if(r.changedTouches&&r.changedTouches[0]){var a=r.changedTouches[0];for(i in a)r[i]||(n("dom-mutableEvents")?Object.defineProperty(r,i,{value:a[i],configurable:!0,enumerable:!0}):r[i]=a[i])}r.corrected=r}return e.call(this,r)}},_checkPointer:function(e){function t(t,n,i){for(var o,a=e.bubbles,u=0;o=t[u];++u)p={target:{value:n,configurable:!0,enumerable:!0},gfxTarget:{value:n.shape,configurable:!0,enumerable:!0},relatedTarget:{value:i,configurable:!0,enumerable:!0}},Object.defineProperty(e,"bubbles",{value:o.bubbles,configurable:!0,enumerable:!0}),r.emit(s,o.type,e),p=null;Object.defineProperty(e,"bubbles",{value:a,configurable:!0,enumerable:!0})}var n=[{type:"mouseout",bubbles:!0},{type:"MSPointerOut",bubbles:!0},{type:"pointerout",bubbles:!0},{type:"mouseleave",bubbles:!1},{type:"dojotouchout",bubbles:!0}],i=[{type:"mouseover",bubbles:!0},{type:"MSPointerOver",bubbles:!0},{type:"pointerover",bubbles:!0},{type:"mouseenter",bubbles:!1},{type:"dojotouchover",bubbles:!0}],o=e.target,a=this._elementUnderPointer,s=this.getEventSource();a!==o&&(a&&a!==s&&t(n,a,o),this._elementUnderPointer=o,o&&o!==s&&t(i,o,a))},getEventSource:function(){return this.rawNode},on:function(e,t){return r(this.getEventSource(),e,t)},connect:function(t,n,r){return"on"==t.substring(0,2)&&(t=t.substring(2)),this.on(t,r?e.hitch(n,r):n)},disconnect:function(e){e.remove()},_initMirrorCanvas:function(){this._initMirrorCanvas=function(){};var t=this.getEventSource(),i=this.mirrorCanvas=t.ownerDocument.createElement("canvas");i.width=1,i.height=1,i.style.position="absolute",i.style.left=i.style.top="-99999px",t.parentNode.appendChild(i);var o="mousemove";n("pointer-events")?o="pointermove":n("MSPointer")?o="MSPointerMove":n("touch-events")&&(o="touchmove"),r(t,o,e.hitch(this,"_checkPointer"))},destroy:function(){this.mirrorCanvas&&(this.mirrorCanvas.parentNode.removeChild(this.mirrorCanvas),this.mirrorCanvas=null),this.inherited(arguments)}}),g.createSurface=function(e,t,n){if(!t&&!n){var r=u.position(e);t=t||r.w,n=n||r.h}"number"==typeof t&&(t+="px"),"number"==typeof n&&(n+="px");var i=new g.Surface,o=s.byId(e),a=o.ownerDocument.createElement("canvas");a.width=c.normalizedLength(t),a.height=c.normalizedLength(n),o.appendChild(a),i.rawNode=a,i._parent=o,i.surface=i,c._base._fixMsTouchAction(i);var h=a.addEventListener,l=a.removeEventListener,v=[],f=function(e,t,n){i._initMirrorCanvas();var r=i.fixTarget(t);v.push({original:t,actual:r}),h.call(this,e,r,n)},d=function(e,t,n){for(var r,i=0;r=v[i];++i)if(r.original===t){l.call(this,e,r.actual,n),v.splice(i,1);break}};try{Object.defineProperties(a,{addEventListener:{value:f,enumerable:!0,configurable:!0},removeEventListener:{value:d}})}catch(e){a.addEventListener=f,a.removeEventListener=d}return a._dojoElementFromPoint=function(e,t){if(!i.mirrorCanvas)return this;var n=u.position(this,!0);e-=n.x,t-=n.y;var r=i.mirrorCanvas,o=r.getContext("2d"),a=i.children;o.clearRect(0,0,r.width,r.height),o.save(),o.strokeStyle="rgba(127,127,127,1.0)",o.fillStyle="rgba(127,127,127,1.0)",o.pickingMode=!0;for(var s=[{x:e,y:t}],h=a.length-1;h>=0&&(a[h]._testInputs(o,s),!s[0].target);h--);return o.restore(),s[0]&&s[0].target?s[0].target.rawNode:this},i};var b={createObject:function(){var e=this.inherited(arguments),t={};return e.rawNode={shape:e,ownerDocument:e.surface.rawNode.ownerDocument,parentNode:e.parent?e.parent.rawNode:null,addEventListener:function(n,r){for(var o,a=t[n]=t[n]||[],s=0;o=a[s];++s)if(o.listener===r)return;a.push({listener:r,handle:i.after(this,"on"+n,e.surface.fixTarget(r),!0)})},removeEventListener:function(e,n){var r=t[e];if(r)for(var i,o=0;i=r[o];++o)if(i.listener===n)return i.handle.remove(),void r.splice(o,1)}},e}};return g.Group.extend(b),g.Surface.extend(b),g});
//# sourceMappingURL=../sourcemaps/gfx/canvasWithEvents.js.map
