/**
 * dojox - A version of dojox.js framework that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/dojox/
 * @license MIT
 */
define(["dojo/_base/kernel","dojo/_base/lang","./_base","dojo/_base/html","dojo/_base/array","dojo/_base/window","dojo/_base/json","dojo/_base/Deferred","dojo/_base/sniff","require","dojo/_base/config"],function(e,n,o,r,i,t,a,l,c,require,s){var f=o.utils={};return n.mixin(f,{forEach:function(n,r,t){t=t||e.global,r.call(t,n),(n instanceof o.Surface||n instanceof o.Group)&&i.forEach(n.children,function(e){f.forEach(e,r,t)})},serialize:function(e){var n,r={},t=e instanceof o.Surface;if(t||e instanceof o.Group){if(r.children=i.map(e.children,f.serialize),t)return r.children}else r.shape=e.getShape();return e.getTransform&&(n=e.getTransform())&&(r.transform=n),e.getStroke&&(n=e.getStroke())&&(r.stroke=n),e.getFill&&(n=e.getFill())&&(r.fill=n),e.getFont&&(n=e.getFont())&&(r.font=n),r},toJson:function(e,n){return a.toJson(f.serialize(e),n)},deserialize:function(e,o){if(o instanceof Array)return i.map(o,n.hitch(null,f.deserialize,e));var r="shape"in o?e.createShape(o.shape):e.createGroup();return"transform"in o&&r.setTransform(o.transform),"stroke"in o&&r.setStroke(o.stroke),"fill"in o&&r.setFill(o.fill),"font"in o&&r.setFont(o.font),"children"in o&&i.forEach(o.children,n.hitch(null,f.deserialize,r)),r},fromJson:function(e,n){return f.deserialize(e,a.fromJson(n))},toSvg:function(e){var n=new l;if("svg"===o.renderer)try{var i=f._cleanSvg(f._innerXML(e.rawNode));n.callback(i)}catch(e){n.errback(e)}else{f._initSvgSerializerDeferred||f._initSvgSerializer();var a=f.toJson(e),c=function(){try{var o=e.getDimensions(),i=o.width,l=o.height,c=f._gfxSvgProxy.document.createElement("div");f._gfxSvgProxy.document.body.appendChild(c),t.withDoc(f._gfxSvgProxy.document,function(){r.style(c,"width",i),r.style(c,"height",l)},this);var s=f._gfxSvgProxy[dojox._scopeName].gfx.createSurface(c,i,l);s.whenLoaded(null,function(e){try{f._gfxSvgProxy[dojox._scopeName].gfx.utils.fromJson(e,a);var o=f._cleanSvg(c.innerHTML);e.clear(),e.destroy(),f._gfxSvgProxy.document.body.removeChild(c),n.callback(o)}catch(e){n.errback(e)}})}catch(e){n.errback(e)}};f._initSvgSerializerDeferred.fired>0?c():f._initSvgSerializerDeferred.addCallback(c)}return n},_gfxSvgProxy:null,_initSvgSerializerDeferred:null,_svgSerializerInitialized:function(){f._initSvgSerializerDeferred.callback(!0)},_initSvgSerializer:function(){if(!f._initSvgSerializerDeferred){f._initSvgSerializerDeferred=new l;var n,o=t.doc.createElement("iframe");r.style(o,{display:"none",position:"absolute",width:"1em",height:"1em",top:"-10000px"}),c("ie")?o.onreadystatechange=function(){"complete"==o.contentWindow.document.readyState&&(o.onreadystatechange=function(){},n=setInterval(function(){o.contentWindow[e.scopeMap.dojo[1]._scopeName]&&o.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx&&o.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx.utils&&(clearInterval(n),o.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._gfxSvgProxy=o.contentWindow,o.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._svgSerializerInitialized())},50))}:o.onload=function(){o.onload=function(){},n=setInterval(function(){o.contentWindow[e.scopeMap.dojo[1]._scopeName]&&o.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx&&o.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx.utils&&(clearInterval(n),o.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._gfxSvgProxy=o.contentWindow,o.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._svgSerializerInitialized())},50)};var i=s.dojoxGfxSvgProxyFrameUrl||require.toUrl("dojox/gfx/resources/gfxSvgProxyFrame.html");o.setAttribute("src",i.toString()),t.body().appendChild(o)}},_innerXML:function(e){return e.innerXML?e.innerXML:e.xml?e.xml:"undefined"!=typeof XMLSerializer?(new XMLSerializer).serializeToString(e):null},_cleanSvg:function(e){return e&&(-1==e.indexOf('xmlns="http://www.w3.org/2000/svg"')&&(e='<svg xmlns="http://www.w3.org/2000/svg"'+(e=e.substring(4,e.length))),-1==e.indexOf('xmlns:xlink="http://www.w3.org/1999/xlink"')&&(e='<svg xmlns:xlink="http://www.w3.org/1999/xlink"'+(e=e.substring(4,e.length))),-1===e.indexOf("xlink:href")&&(e=e.replace(/href\s*=/g,"xlink:href=")),e=(e=(e=(e=(e=e.replace(/<img\b([^>]*)>/gi,"<image $1 />")).replace(/\bdojoGfx\w*\s*=\s*(['"])\w*\1/g,"")).replace(/\b__gfxObject__\s*=\s*(['"])\w*\1/g,"")).replace(/[=]([^"']+?)(\s|>)/g,'="$1"$2')).replace(/\bstroke-opacity\w*\s*=\s*(['"])undefined\1/g,"")),e}}),f});
//# sourceMappingURL=../sourcemaps/gfx/utils.js.map
