/**
 * dojox - A version of dojox.js framework that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/dojox/
 * @license MIT
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/xhr","dojo/data/util/simpleFetch","dojo/data/util/filter","dojo/_base/kernel"],function(t,e,i,s,r,a){var n=t("dojox.data.OpmlStore",null,{constructor:function(t){this._xmlData=null,this._arrayOfTopLevelItems=[],this._arrayOfAllItems=[],this._metadataNodes=null,this._loadFinished=!1,this.url=t.url,this._opmlData=t.data,t.label&&(this.label=t.label),this._loadInProgress=!1,this._queuedFetches=[],this._identityMap={},this._identCount=0,this._idProp="_I",t&&"urlPreventCache"in t&&(this.urlPreventCache=!!t.urlPreventCache)},label:"text",url:"",urlPreventCache:!1,_assertIsItem:function(t){if(!this.isItem(t))throw new Error("dojo.data.OpmlStore: a function was passed an item argument that was not an item")},_assertIsAttribute:function(t){if(!e.isString(t))throw new Error("dojox.data.OpmlStore: a function was passed an attribute argument that was not an attribute object nor an attribute name string")},_removeChildNodesThatAreNotElementNodes:function(t,e){var i=t.childNodes;if(0!==i.length){var s,r,a=[];for(s=0;s<i.length;++s)1!=(r=i[s]).nodeType&&a.push(r);for(s=0;s<a.length;++s)r=a[s],t.removeChild(r);if(e)for(s=0;s<i.length;++s)r=i[s],this._removeChildNodesThatAreNotElementNodes(r,e)}},_processRawXmlTree:function(t){this._loadFinished=!0,this._xmlData=t;var e=t.getElementsByTagName("head")[0];e&&(this._removeChildNodesThatAreNotElementNodes(e),this._metadataNodes=e.childNodes);var i=t.getElementsByTagName("body"),s=i[0];if(s){this._removeChildNodesThatAreNotElementNodes(s,!0);for(var r=i[0].childNodes,a=0;a<r.length;++a){var n=r[a];"outline"==n.tagName&&(this._identityMap[this._identCount]=n,this._identCount++,this._arrayOfTopLevelItems.push(n),this._arrayOfAllItems.push(n),this._checkChildNodes(n))}}},_checkChildNodes:function(t){if(t.firstChild)for(var e=0;e<t.childNodes.length;e++){var i=t.childNodes[e];"outline"==i.tagName&&(this._identityMap[this._identCount]=i,this._identCount++,this._arrayOfAllItems.push(i),this._checkChildNodes(i))}},_getItemsArray:function(t){return t&&t.deep?this._arrayOfAllItems:this._arrayOfTopLevelItems},getValue:function(t,e,i){if(this._assertIsItem(t),this._assertIsAttribute(e),"children"==e)return t.firstChild||i;var s=t.getAttribute(e);return void 0!==s?s:i},getValues:function(t,e){this._assertIsItem(t),this._assertIsAttribute(e);var i=[];if("children"==e)for(var s=0;s<t.childNodes.length;++s)i.push(t.childNodes[s]);else null!==t.getAttribute(e)&&i.push(t.getAttribute(e));return i},getAttributes:function(t){this._assertIsItem(t);for(var e=[],i=t,s=i.attributes,r=0;r<s.length;++r){var a=s.item(r);e.push(a.nodeName)}return i.childNodes.length>0&&e.push("children"),e},hasAttribute:function(t,e){return this.getValues(t,e).length>0},containsValue:function(t,e,i){var s=void 0;return"string"==typeof i&&(s=r.patternToRegExp(i,!1)),this._containsValue(t,e,i,s)},_containsValue:function(t,e,i,s){for(var r=this.getValues(t,e),a=0;a<r.length;++a){var n=r[a];if("string"==typeof n&&s)return null!==n.match(s);if(i===n)return!0}return!1},isItem:function(t){return t&&1==t.nodeType&&"outline"==t.tagName&&t.ownerDocument===this._xmlData},isItemLoaded:function(t){return this.isItem(t)},loadItem:function(t){},getLabel:function(t){if(this.isItem(t))return this.getValue(t,this.label)},getLabelAttributes:function(t){return[this.label]},_fetchItems:function(t,e,s){var a=this,n=function(t,i){var s=null;if(t.query){s=[];var n=!!t.queryOptions&&t.queryOptions.ignoreCase,o={};for(var l in t.query){"string"==typeof(c=t.query[l])&&(o[l]=r.patternToRegExp(c,n))}for(var h=0;h<i.length;++h){var u=!0,d=i[h];for(var l in t.query){var c=t.query[l];a._containsValue(d,l,c,o[l])||(u=!1)}u&&s.push(d)}}else i.length>0&&(s=i.slice(0,i.length));e(s,t)};if(this._loadFinished)n(t,this._getItemsArray(t.queryOptions));else if(this._loadInProgress)this._queuedFetches.push({args:t,filter:n});else if(""!==this.url){this._loadInProgress=!0;var o={url:a.url,handleAs:"xml",preventCache:a.urlPreventCache},l=i.get(o);l.addCallback(function(e){a._processRawXmlTree(e),n(t,a._getItemsArray(t.queryOptions)),a._handleQueuedFetches()}),l.addErrback(function(t){throw t})}else{if(!this._opmlData)throw new Error("dojox.data.OpmlStore: No OPML source data was provided as either URL or XML data input.");this._processRawXmlTree(this._opmlData),this._opmlData=null,n(t,this._getItemsArray(t.queryOptions))}},getFeatures:function(){return{"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0}},getIdentity:function(t){if(this.isItem(t))for(var e in this._identityMap)if(this._identityMap[e]===t)return e;return null},fetchItemByIdentity:function(t){if(this._loadFinished){n=this._identityMap[t.identity];if(this.isItem(n)||(n=null),t.onItem){o=t.scope?t.scope:a.global;t.onItem.call(o,n)}}else{var e=this;if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:t});else{this._loadInProgress=!0;var s={url:e.url,handleAs:"xml"},r=i.get(s);r.addCallback(function(i){var s=t.scope?t.scope:a.global;try{e._processRawXmlTree(i);var r=e._identityMap[t.identity];e.isItem(r)||(r=null),t.onItem&&t.onItem.call(s,r),e._handleQueuedFetches()}catch(e){t.onError&&t.onError.call(s,e)}}),r.addErrback(function(e){if(this._loadInProgress=!1,t.onError){var i=t.scope?t.scope:a.global;t.onError.call(i,e)}})}else if(this._opmlData){this._processRawXmlTree(this._opmlData),this._opmlData=null;var n=this._identityMap[t.identity];if(e.isItem(n)||(n=null),t.onItem){var o=t.scope?t.scope:a.global;t.onItem.call(o,n)}}}},getIdentityAttributes:function(t){return null},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var t=0;t<this._queuedFetches.length;t++){var e=this._queuedFetches[t],i=e.args,s=e.filter;s?s(i,this._getItemsArray(i.queryOptions)):this.fetchItemByIdentity(i)}this._queuedFetches=[]}},close:function(t){}});return e.extend(n,s),n});
//# sourceMappingURL=../sourcemaps/data/OpmlStore.js.map
